<link rel="import" href="../parts.html">
<link rel="import" href="../ui.html">
<script>
    (function (Kano) {

        let talkingFace = {
            partType: 'ui',
            type: 'talking-face',
            label: 'Talking face',
            image: '/assets/part/pixels-animation.svg',
            colour: '#249afb',
            component: 'kano-part-talking-face',
            restrict: 'workspace',
            customizable: {
                properties: [],
                style: []
            },
            userProperties: {
            },
            blocks: [
            {
                    block: (ui) => {
                    return {
                            id: 'part_event',
                            message0: 'When %1',
                            args0: [{
                                type: "field_dropdown",
                                name: "EVENT",
                                options: [['mouse clicked', 'simple.click']]
                            }],
                            message1: '%1',
                            args1: [{
                                type: "input_statement",
                                name: "DO"
                            }]
                        };
                },             
                javascript: (ui) => {
                    return function (block) {
                        block.setDeletable(false);
                        let ev = block.getFieldValue('EVENT'),
                        statement = Blockly.JavaScript.statementToCode(block, 'DO'),
                        pieces = ev.split('.'),
                        emitter = pieces[0],
                        eventId = pieces[1],
                        code = `devices.get('${emitter}')`;
                       
                        if (emitter === 'global') {
                                code = 'global';
                            }
                        code += `.when('${eventId}', function () {\n${statement}});\n`;
                        return code;
                            };
                },
                pseudo: (ui) => {
                    return function (block) {
                        block.setDeletable(false);
                        let ev = block.getFieldValue('EVENT'),
                            statement = Blockly.JavaScript.statementToCode(block, 'DO'),
                            pieces = ev.split('.'),
                            emitter = pieces[0],
                            eventId = pieces[1],
                            code = `devices.get('${emitter}')`;
                        if (emitter === 'global') {
                            code = 'global';
                        }
                        code += `.when('${eventId}', function () {\n${statement}});\n`;
                        return code;
                    };
                }
            }
            ,{
                block: (ui) => {
                    return {
                        id: 'say',
                        message0: 'Say %1',
                        previousStatement: null,
                        args0: [{
                            type: 'input_value',
                            name: 'FLAG'
                        }]
                    };
                },
                javascript: (part) => {
                    return function (block) {
                        block.setDeletable(false);
                        let flag = Blockly.JavaScript.valueToCode(block, 'FLAG');
                        return `devices.get('${part.id}').runAnimation(${flag});`;
                    };
                },
                pseudo: (part) => {
                    return function (block) {
                        block.setDeletable(false);
                        let flag = Blockly.JavaScript.valueToCode(block, 'FLAG');
                        return `devices.get('${part.id}').runAnimation(${flag});`;
                    };
                }
            }, {
                block: (part) => {
                    return {
                        id: 'superpowers',
                        message0: 'I now have computer superpowers!',
                        output: null
                    };
                },
                javascript: (part) => {
                    return function (block) {
                        block.setDeletable(false);
                        return [`true`];
                    };
                },
                pseudo: (part) => {
                    return function (block) {
                        block.setDeletable(false);
                        return [`true`];
                    };
                }
            }]
        };

        Kano.MakeApps.Parts.registerPart(talkingFace);
    })(window.Kano = window.Kano || {});
</script>

