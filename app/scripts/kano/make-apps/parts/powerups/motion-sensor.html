<link rel="import" href="../parts.html">
<link rel="import" href="../hardware.html">
<link rel="import" href="../../blockly/inputs/motion-zone.html">
<script>
    (function (Kano) {

        const COLOR = '#FFB347';

        let motionSensor = {
            partType: 'hardware',
            type: 'motion-sensor',
            label: Kano.MakeApps.Msg.PART_MOTION_SENSOR_NAME,
            image: '/assets/part/motion.svg',
            colour: COLOR,
            component: 'kano-part-motion-sensor',
            customizable: {
                properties: [],
                style: []
            },
            supportedHardware: ['motion-sensor', /* Old name */'proximity-sensor'],
            userProperties: {},
            events: [{
                label: Kano.MakeApps.Msg.PART_GYRO_ACCELEROMETER_READ_DATA,
                id: 'proximity-update'
            },{
                label: Kano.MakeApps.Msg.PART_MOTION_SENSOR_UP,
                id: 'gesture-up'
            },
            {
                label: Kano.MakeApps.Msg.PART_MOTION_SENSOR_DOWN,
                id: 'gesture-down'
            },
            {
                label: Kano.MakeApps.Msg.PART_MOTION_SENSOR_LEFT,
                id: 'gesture-left'
            },
            {
                label: Kano.MakeApps.Msg.PART_MOTION_SENSOR_RIGHT,
                id: 'gesture-right'
            }],
            blocks: [{
                block: (part) => {
                    const id = 'motion_when';
                    Blockly.Blocks[`${part.id}#${id}`] = {
                        init: function () {
                            const options = [
                                ['1', '1'],
                                ['2', '2'],
                                ['3', '3'],
                                ['4', '4'],
                                ['5', '5']
                            ];
                            this.appendDummyInput()
                                .appendField(`${part.name}: ${Blockly.Msg.BLOCK_MOTION_WHEN}`)
                                // .appendField(new Blockly.FieldMotionZone())
                                .appendField(new Blockly.FieldDropdown(options), 'ZONE')
                                .appendField(Blockly.Msg.BLOCK_MOTION_IS_TRIGGERED);

                            this.appendStatementInput('DO');

                            this.setColour(part.colour);
                        }
                    };
                    return {
                        id,
                        doNotRegister: true
                    };
                },
                javascript: (part) => {
                    return (block) => {
                        let zone = block.getFieldValue('ZONE'),
                            statement = Blockly.JavaScript.statementToCode(block, 'DO'),
                            code = `devices.get('${part.id}').whenEntersZone(${zone}, function () {\n${statement}\n})`;
                        return code;
                    };
                },
                pseudo: (part) => {
                    return (block) => {
                        let zone = block.getFieldValue('ZONE'),
                            statement = Blockly.Pseudo.statementToCode(block, 'DO'),
                            code = `devices.get('${part.id}').whenEntersZone(${zone}, function () {\n${statement}\n})`;
                        return code;
                    };
                }
            },{
                block: (part) => {
                    return {
                        id: 'motion_sensor_value',
                        message0: `${part.name} ${Blockly.Msg.BLOCK_VALUE}`,
                        inputsInline: false,
                        output: 'Number'
                    };
                },
                javascript: (part) => {
                    return (block) => {
                        let code = `devices.get('${part.id}').getValue()`;
                        return [code];
                    };
                },
                pseudo: (part) => {
                    return (block) => {
                        let code = `devices.get('${part.id}').getValue()`;
                        return [code];
                    };
                }
            }]
        };

        Kano.MakeApps.Parts.registerPart(motionSensor);
    })(window.Kano = window.Kano || {});
</script>
