<script>
    Kano.MakeApps = Kano.MakeApps || {};

    Kano.MakeApps.Store = FlowDown.createStore({
        editor: {
            app: null,
            logoutEnabled: !Kano.MakeApps.config.DISABLE_LOGOUT,
            remixLoadingAlertOpened: false,
        },
        challenge: {
            banner: null,
            history: {
                backBuffer: [],
                forwardBuffer: [],
                ignoreNextStepChange: false,
            },
        },
        story: {},
        routing: {
            context: {},
        },
        user: null,
        config: Kano.MakeApps.config,
    });

    Kano.MakeApps.Store.types = function types (constants) {
        return Object.freeze(constants.reduce((acc, constant) => {
            acc[constant] = constant;
            return acc;
        }, {}))
    };

    const { getStoreId } = Kano.MakeApps.Store.ReceiverBehavior;

    // If a store id is declared in the element, it is used as a library and the store is managed by the library API
    const EnhancedBehavior = {
        properties: {
            storeId: Number,
        },
        getStoreId() {
            return this.storeId || getStoreId();
        }
    };


    const EnhancedMixin = parent => class extends parent {
        getStoreId() {
            return this.storeId || getStoreId();
        }
    };

    const { StateReceiver } = Kano.MakeApps.Store;

    Kano.MakeApps.Store.ReceiverBehavior = [Kano.MakeApps.Store.ReceiverBehavior, EnhancedBehavior];
    Kano.MakeApps.Store.StateReceiver = parent => EnhancedMixin(StateReceiver(parent));

    const KanoCodeStoreElement = Polymer({ is: 'kc-store', behaviors: [Kano.MakeApps.Store.ProviderBehavior] });

    Kano.MakeApps.Store.storeElement = new KanoCodeStoreElement();
    Kano.MakeApps.Store.getState = () => Kano.MakeApps.Store.storeElement.getState();

    document.body.appendChild(Kano.MakeApps.Store.storeElement);

</script>
