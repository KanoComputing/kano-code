<link rel="import" type="" href="../../../../../bower_components/kwc-color-picker/kwc-color-picker.html">
<link rel="import" type="" href="../../../../../bower_components/kwc-color-picker/palettes/material.html">
<script>
    Blockly.FieldCustomColor = function (colour, opt_validator) {
        Blockly.FieldCustomColor.superClass_.constructor.call(this, colour, opt_validator);
    };
    goog.inherits(Blockly.FieldCustomColor, Blockly.FieldColour);

    Blockly.FieldCustomColor.prototype.showEditor_ = function () {
        Blockly.WidgetDiv.show(this, this.sourceBlock_.RTL, Blockly.FieldCustomColor.widgetDispose_);

        var div = Blockly.WidgetDiv.DIV;
        
        customEl = document.createElement('kwc-color-picker');
        customEl.updateStyles({
            '--kwc-color-picker-size': '22px',
            '--kwc-color-picker-margin': '0px'
        });
        customEl.colors = KwcColorPickerPalette.Material.colors;
        customEl.rowSize = KwcColorPickerPalette.Material.rowSize;
        customEl.style.background = '#282F34';
        customEl.style.padding = '12px';
        customEl.style.boxSizing = 'border-box';
        customEl.style.borderRadius = '6px';
        customEl.value = this.getValue();

        customEl.addEventListener('value-changed', (e) => {
            this.setValue(e.detail.value);
        });

        div.appendChild(customEl);

        let isUnder = this.position();
        if ('animate' in HTMLElement.prototype) {
            div.style.transformOrigin = isUnder ? '0 bottom' : '0 0';
            div.animate({
                transform: ['scale(0, 0)', 'scale(1, 1)'],
                opacity: [0, 1]
            }, {
                duration: 100,
                easing: 'ease-out'
            }).onfinish = function () {
                customEl.resize();
            };
        }
    };

    Blockly.FieldCustomColor.prototype.position = function () {
        // Position the palette to line up with the field.
        // Record windowSize and scrollOffset before adding the palette.
        var windowSize = goog.dom.getViewportSize();
        var scrollOffset = goog.style.getViewportPageOffset(document);
        var xy = this.getAbsoluteXY_();
        var borderBBox = this.getScaledBBox_();
        var div = Blockly.WidgetDiv.DIV;
        var size = { width: 442, height: 266 };
        var isUnder = true;

        // Flip the palette vertically if off the bottom.
        if (xy.y + size.height + borderBBox.height >= windowSize.height + scrollOffset.y) {
            xy.y -= size.height - 1;
        } else {
            xy.y += borderBBox.height - 1;
            isUnder = false;
        }
        if (this.sourceBlock_.RTL) {
            xy.x += borderBBox.width;
            xy.x -= size.width;
            // Don't go offscreen left.
            if (xy.x < scrollOffset.x) {
                xy.x = scrollOffset.x;
            }
        } else {
            // Don't go offscreen right.
            if (xy.x > windowSize.width + scrollOffset.x - size.width) {
                xy.x = windowSize.width + scrollOffset.x - size.width;
            }
        }
        Blockly.WidgetDiv.position(xy.x, xy.y, windowSize, scrollOffset, this.sourceBlock_.RTL);
        div.style.height = size.height + 'px';
        return isUnder;
    };

</script>