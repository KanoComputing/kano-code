<script>
    (function (Kano) {

        let stories = [];

        Kano.MakeApps = Kano.MakeApps || {};

        Kano.MakeApps.Stories = Kano.MakeApps.Stories || {};

        /**
         * Get a story from a given id
         * @param  {String} id Id of the story requested
         * @return {Promise}   promise that will resolve with the story requested
         */
        Kano.MakeApps.Stories.getById = function (id) {
            let storyBase;
            // Lookup the cache and return if exists
            if (cache[id]) {
                return Promise.resolve(cache[id]);
            }
            // Get the base definition from the stories list
            for (let index in stories) {
                if (stories[index].id === id) {
                    storyBase = stories[index];
                    break;
                }
            }
            // Fetch the story definition from the assets
            return fetch(`/assets/stories/${id}/index.json`)
                .then(r => r.json())
                .then(data => {
                    // Merge the base and definition, store in cache and return it
                    let story = Object.assign({}, storyBase, data);
                    cache[id] = story;
                    return story;
                });
        };
        /**
         * Get a scene from a story and a scene index
         * @param  {Object} story A story object definition, must contain an array of scenes
         * @param  {Number} index Index of the requested scene in the story
         * @return {Promise}      Promise that will resolve with the requested scene definition
         */
        Kano.MakeApps.Stories.getSceneByIndex = function (story, index) {
            // Grab the scene object from the story
            let scene = story.scenes[index];
            // Check if there is remote data to fetch
            if (!scene.data && scene.data_path) {
                // Fetch the additional data
                return fetch(`/assets/stories/${story.id}/${scene.data_path}`)
                    .then(r => r.json())
                    .then((data) => {
                        // Update the scene definition
                        scene.data = data;
                        // Delete the remote data definition key
                        delete scene.data_path;
                        return scene;
                    });
            }
            // Return the scene definition if no additional data is required
            return Promise.resolve(scene);
        };

    })(window.Kano = window.Kano || {});
</script>