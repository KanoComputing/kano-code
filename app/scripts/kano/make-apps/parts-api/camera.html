<link rel="import" href="./kaleidoscope.html">
<link rel="import" href="./filters.html">
<script>
    (function (Kano) {
        let Camera, PartsAPI;

        Kano.MakeApps = Kano.MakeApps || {};
        PartsAPI = Kano.MakeApps.PartsAPI = Kano.MakeApps.PartsAPI || {};

        Camera = {
            addFilter () {
                let args = Array.prototype.slice.call(arguments),
                    name = args.shift();
                PartsAPI.filters.addFilter.call(this, name, args);
                this._paintFrame();
            },
            takePicture () {
                Kano.AppModules.getModule('camera').takePicture()
                    .then((pictureUrl) => {
                        let filename = pictureUrl.split('/').pop();
                        this._onPictureTaken(Kano.AppModules.getModule('camera').getPicture(filename));
                    });
            },
            _onPictureTaken (src) {
                this.lastPictureUrl = src;
                this.fire('picture-taken', src);
                this._paintFrame();
            },
            lastPicture () {
                return this.lastPictureUrl;
            },
            flash (color, length) {
                Kano.AppModules.getModule('camera').flash(color, length);
            },
            onShutterDown (cb) {
                this.onKeyDown('shutter-button', cb);
            },
            onShutterTurns (key, callback) {
                let cb = this._shutterCheck(key, callback);
                this.socketListeners.push({
                    name: 'timer-changed',
                    cb
                });
                Kano.AppModules.getModule('camera').on('timer-changed', cb);
            },
            _shutterCheck (key, callback) {
                return (data) => {
                    if (data.direction === key) {
                        callback();
                    }
                };
            },
            onKeyDown (key, callback) {
                let cb = this._keyDownCheck(key, callback);
                this.socketListeners.push({
                    name: 'button-down',
                    cb
                });
                Kano.AppModules.getModule('camera').on('button-down', cb);
            },
            _keyDownCheck (key, callback) {
                return (data) => {
                    if (data['button-id'] === key) {
                        callback();
                    }
                };
            },
            _paintFrame (src) {
                if (!this.lastPictureUrl) {
                    return;
                }
                this.debounce('paintFrame', () => {
                    let img = new Image(),
                        width = this.canvas.width,
                        height = this.canvas.height,
                        finalHeight,
                        heightDiff;
                    img.crossOrigin = "Anonymous";
                    img.onload = () => {
                        let tmpCanvas = document.createElement('canvas'),
                            tmpCtx;
                        tmpCanvas.width = width;
                        tmpCanvas.height =  height;
                        tmpCtx = tmpCanvas.getContext('2d');
                        finalHeight = width * (img.naturalHeight / img.naturalWidth);
                        heightDiff = height - finalHeight;
                        tmpCtx.drawImage(img, 0, heightDiff / 2, width, finalHeight);
                        this.applyFilters(tmpCanvas)
                            .then(data => {
                                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                                tmpCtx.putImageData(data, 0, 0);
                                return this.applyKaleidoscope(tmpCanvas);
                            });
                    };
                    img.src = this.lastPictureUrl;
                }, 32);
            },
            applyKaleidoscope (canvas) {
                if (this.kaleidoscope) {
                    this.transform(this.ctx,
                                    canvas,
                                    this.canvas.width,
                                    this.canvas.height,
                                    this.canvas.width, 
                                    this.canvas.height,
                                    this.kaleidoscope.slices,
                                    this.kaleidoscope.zoom,
                                    0,
                                    1,
                                    this.kaleidoscope.offset,
                                    this.kaleidoscope.offset);
                } else {
                    this.ctx.putImageData(canvas.getContext('2d').getImageData(0, 0, this.canvas.width, this.canvas.height), 0, 0);
                }
            },
            enableKaleidoscope (offset, slices, zoom) {
                this.kaleidoscope = {
                    offset,
                    slices,
                    zoom
                };
                this._paintFrame();
            },
            start () {
                PartsAPI.kaleidoscope.start.apply(this, arguments);
                PartsAPI.filters.start.apply(this, arguments);
                this.socketListeners = [];
                this.kaleidoscope = null;
                this.ctx = this.canvas.getContext('2d');
            },
            stop () {
                PartsAPI.kaleidoscope.stop.apply(this, arguments);
                PartsAPI.filters.stop.apply(this, arguments);
                this.reset();
            },
            reset () {
                if (this.socketListeners) {
                    // Remove all the listeners and reset the listeners array
                    this.socketListeners.forEach((listener) => {
                        Kano.AppModules.getModule('camera').removeListener(listener.name, listener.cb);
                    });
                }
                this.socketListeners = [];
            }
        };

        PartsAPI['camera'] = Object.assign({}, PartsAPI.kaleidoscope, PartsAPI.filters, Camera);
    })(window.Kano = window.Kano || {});
</script>