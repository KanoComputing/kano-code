<link rel="import" href="./dongle-base.html">
<link rel="import" href="../spring.html">
<script>
    (function (Kano) {
        let Wand, PartsAPI;

        Kano.MakeApps = Kano.MakeApps || {};
        PartsAPI = Kano.MakeApps.PartsAPI = Kano.MakeApps.PartsAPI || {};

        Wand = {
            module: 'wand',
            onCreated () {
                this._onPositionChanged = this._onPositionChanged.bind(this);
                this._update = this._update.bind(this);
                this.handlers = {
                    'position': this._onPositionChanged,
                    'update': this._update
                };
                Kano.MakeApps.PartsAPI.DongleBase.onCreated.apply(this);
                this.reset();
            },
            start () {
                PartsAPI.DongleBase.start.apply(this, arguments);
            },
            stop () {
                PartsAPI.DongleBase.stop.apply(this, arguments);
                this.reset();
            },
            _update (opts) {
                this.set('model.device', opts);
                this.set('model.connected', opts && opts.connected);
            },
            reset () {
                if (this.model && this.model.lastX) {
                    this.set('model.lastX', 0);
                }
                if (this.model && this.model.lastY) {
                    this.set('model.lastY', 0);
                }
                if (this.model && this.model.lastZ) {
                    this.set('model.lastZ', 0);
                }
                this._listeners = [];
            },
            _onPositionChanged (e) {
                this.model.xSpeed = Math.abs((this.model.lastX || e[0]) - e[0]);
                this.model.ySpeed = Math.abs((this.model.lastY || e[1]) - e[1]);
                this.model.zSpeed = Math.abs((this.model.lastZ || e[2]) - e[2]);
                this.model.lastX = e[0];
                this.model.lastY = e[1];
                this.model.lastZ = e[2];
            },
            _triggerListeners (newValue, oldValue) {
                const zoneSize = 100 / 5;                 // 100 is the whole span, 5 is the number of zones
                this._listeners.forEach(listener => {
                    let zoneClamp = [(listener.zone - 1) * zoneSize, listener.zone * zoneSize];
                    // Was outside of the clamp and now is inside
                    if ((oldValue < zoneClamp[0] || oldValue > zoneClamp[1]) &&
                        (newValue >= zoneClamp[0] && newValue <= zoneClamp[1])) {
                            listener.callback();
                        }
                });
            },
            whenEntersZone (zone, callback) {
                this._listeners.push({ zone, callback });
            },
            _lerp (from, to, percent) {
                const span = to - from;
                percent = Math.max(0, Math.min(percent, 100));

                return from + (span * (percent * 0.01));
            },
            getX () {
                const value = this._lerp(this.lastQueriedX || this.model.lastX, this.model.lastX, 50);
                this.lastQueriedX = this.model.lastX;
                return value;
            },
            getY () {
                const value = this._lerp(this.lastQueriedY || this.model.lastY, this.model.lastY, 50);
                this.lastQueriedY = this.model.lastY;
                return value;
            },
            getZ () {
                const value = this._lerp(this.lastQueriedZ || this.model.lastZ, this.model.lastZ, 50);
                this.lastQueriedZ = this.model.lastZ;
                return value;
            },
            getXSpeed () {
                return this.model.xSpeed;
            },
            getYSpeed () {
                return this.model.ySpeed;
            },
            getZSpeed () {
                return this.model.zSpeed;
            },
            dataToPercentage (value) {
                return Math.round((value / 255) * 100);
            }
        };

        // @polymerBehavior
        Kano.MakeApps.PartsAPI['wand'] = Object.assign({}, PartsAPI.DongleBase, Wand);
    })(window.Kano = window.Kano || {});
</script>
