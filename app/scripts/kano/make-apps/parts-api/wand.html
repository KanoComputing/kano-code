<link rel="import" href="./dongle-base.html">
<link rel="import" href="../spring.html">
<script>
    (function (Kano) {
        let Wand, PartsAPI;

        Kano.MakeApps = Kano.MakeApps || {};
        PartsAPI = Kano.MakeApps.PartsAPI = Kano.MakeApps.PartsAPI || {};

        Wand = {
            module: 'wand',
            onCreated () {
                this._onPositionChanged = this._onPositionChanged.bind(this);
                this._update = this._update.bind(this);
                this.handlers = {
                    'position': this._onPositionChanged,
                    'update': this._update
                };
                Kano.MakeApps.PartsAPI.DongleBase.onCreated.apply(this);
                this.reset();
            },
            start () {
                PartsAPI.DongleBase.start.apply(this, arguments);
            },
            stop () {
                PartsAPI.DongleBase.stop.apply(this, arguments);
                this.reset();
            },
            _update (opts) {
                this.set('model.device', opts);
                this.set('model.connected', opts && opts.connected);
            },
            reset () {
                if (this.model && this.model.lastX) {
                    this.set('model.lastX', 0);
                }
                if (this.model && this.model.lastY) {
                    this.set('model.lastY', 0);
                }
                if (this.model && this.model.lastZ) {
                    this.set('model.lastZ', 0);
                }
                this._listeners = [];
            },
            _onPositionChanged (e) {
                this.model.lastX = e[0];
                this.model.lastY = e[1];
                this.model.lastZ = e[2];
            },
            _triggerListeners (newValue, oldValue) {
                const zoneSize = 100 / 5;                 // 100 is the whole span, 5 is the number of zones
                this._listeners.forEach(listener => {
                    let zoneClamp = [(listener.zone - 1) * zoneSize, listener.zone * zoneSize];
                    // Was outside of the clamp and now is inside
                    if ((oldValue < zoneClamp[0] || oldValue > zoneClamp[1]) &&
                        (newValue >= zoneClamp[0] && newValue <= zoneClamp[1])) {
                            listener.callback();
                        }
                });
            },
            whenEntersZone (zone, callback) {
                this._listeners.push({ zone, callback });
            },
            getX () {
                return this.model.lastX;
            },
            getY () {
                return this.model.lastY;
            },
            getZ () {
                return this.model.lastZ;
            },
            dataToPercentage (value) {
                return Math.round((value / 255) * 100);
            }
        };

        // @polymerBehavior
        Kano.MakeApps.PartsAPI['wand'] = Object.assign({}, PartsAPI.DongleBase, Wand);
    })(window.Kano = window.Kano || {});
</script>
