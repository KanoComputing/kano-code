<script>
    (function (Kano) {

        var Base, PartsAPI;

        Kano.MakeApps = Kano.MakeApps || {};
        PartsAPI = Kano.MakeApps.PartsAPI = Kano.MakeApps.PartsAPI || {};

        Base = PartsAPI.Base = {
            start () {
                if (this.model) {
                    this.savedState = {
                        position: {
                            x: this.model.position.x,
                            y: this.model.position.y
                        },
                        rotation: this.model.rotation,
                        scale: this.model.scale,
                        visible: this.model.visible,
                        userProperties: Object.assign({}, this.model.userProperties),
                        userStyle: Object.assign({}, this.model.userStyle)
                    };
                }
                this.isRunning = true;
            },
            when (name, callback) {
                this.userListeners = this.userListeners || {};
                if (!this.userListeners[name]) {
                    this.userListeners[name] = [];
                }
                this.userListeners[name].push(callback);
                this.addEventListener(name, callback);
            },
            stop () {
                if (this.userListeners) {
                    Object.keys(this.userListeners).forEach((name) => {
                        if (Array.isArray(this.userListeners[name])) {
                            this.userListeners[name].forEach((callback) => {
                                this.removeEventListener(name, callback);
                            });
                        }
                    });
                }
                this.userListeners = {};
                if (this.savedState) {
                    let savedState = this.savedState || {};
                    savedState.position = savedState.position || { x: 0, y: 0 };
                    this.set('model.position.x', savedState.position.x);
                    this.set('model.position.y', savedState.position.y);
                    this.set('model.rotation', savedState.rotation);
                    this.set('model.scale', savedState.scale);
                    this.set('model.visible', savedState.visible);
                    this.set('model.userProperties', savedState.userProperties);
                    this.set('model.userStyle', savedState.userStyle);
                }
                this.isRunning = false;
            },
            moveAlong (distance) {
                let direction = (this.get('model.rotation') || 0) * Math.PI / 180,
                    alongY = Math.round(parseInt(distance) * Math.sin(direction)),
                    alongX = Math.round(parseInt(distance) * Math.cos(direction));
                this.move(alongX, alongY);
            },
            move (x, y) {
                let position = this.model.position;
                // Set separate values otherwise, the reference is compared and
                // change triggers are not fired
                this.set('model.position.x', position.x + x);
                this.set('model.position.y', position.y + y);
            },
            setXY (x, y) {
                this.setX(x);
                this.setY(y);
            },
            setX (x) {
                this.set('model.position.x', x);
            },
            setY (y) {
                this.set('model.position.y', y);
            },
            getX () {
                return this.get('model.position.x');
            },
            getY () {
                return this.get('model.position.y');
            },
            getSize () {
                return this.get('model.scale');
            },
            getRotation () {
                return this.get('model.rotation');
            },
            rotate (deg) {
                let rotation = this.model.rotation;
                this.set('model.rotation', parseInt(rotation) + parseInt(deg));
            },
            absolute_rotate (deg) {
                this.set('model.rotation', parseInt(deg));
            },
            scale (factor) {
                this.set('model.scale', factor);
            },
            resize (factor) {
                let curFactor = this.get('model.scale') || 100;
                this.set('model.scale', curFactor * factor / 100);
            },
            show (visibility) {
                this.set('model.visible', visibility);
            },
            toggleVisibility () {
                this.set('model.visible', !this.model.visible);
            },
            hexToRgb (hex) {
                hex = hex.substr(1);
                var bigint = parseInt(hex, 16);
                var r = (bigint >> 16) & 255;
                var g = (bigint >> 8) & 255;
                var b = bigint & 255;

                return { r, g, b };
            }
        };

    })(window.Kano = window.Kano || {});
</script>