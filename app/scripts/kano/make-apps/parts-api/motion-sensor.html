<link rel="import" href="./dongle-base.html">
<script>
    (function (Kano) {
        let MotionSensor, PartsAPI;

        Kano.MakeApps = Kano.MakeApps || {};
        PartsAPI = Kano.MakeApps.PartsAPI = Kano.MakeApps.PartsAPI || {};

        MotionSensor = {
            start () {
                this.module = 'motionSensor';

                this.reset();

                this.handlers = {
                    'proximity-data': (e) => {
                        const newValue = this.dataToPercentage(e.proximity);
                        this._triggerListeners(newValue, this.model.lastProximityValue);
                        this.model.lastProximityValue = newValue;
                        this.fire('proximity-update');
                    },
                    'gesture': (e) => {
                        if (e.type) {
                            let fireString = 'gesture-' + e.type;
                            this.fire(fireString);
                        }
                    }
                };

                PartsAPI.DongleBase.start.apply(this, arguments);
            },
            stop () {
                PartsAPI.DongleBase.stop.apply(this, arguments);

                this.reset();
            },
            reset () {
                this.model.lastProximityValue = 0;
                this._listeners = [];
            },
            _triggerListeners (newValue, oldValue) {
                let value = this.model.lastProximityValue,
                    zoneSize = 100 / 5;                 // 100 is the whole span, 5 is the number of zones

                this._listeners.forEach(listener => {
                    let zoneClamp = [(listener.zone - 1) * zoneSize, listener.zone * zoneSize];
                    // Was outside of the clamp and now is inside
                    if ((oldValue < zoneClamp[0] || oldValue > zoneClamp[1]) &&
                        (newValue >= zoneClamp[0] && newValue <= zoneClamp[1])) {
                            listener.callback();
                        }
                });
            },
            whenEntersZone (zone, callback) {
                this._listeners.push({ zone, callback });
            },
            getValue () {
                return this.model.lastProximityValue;
            },
            dataToPercentage (value) {
                return Math.round((value / 255) * 100);
            }
        };

        // @polymerBehavior
        Kano.MakeApps.PartsAPI['motion-sensor'] = Object.assign({}, PartsAPI.DongleBase, MotionSensor);
    })(window.Kano = window.Kano || {});
</script>
