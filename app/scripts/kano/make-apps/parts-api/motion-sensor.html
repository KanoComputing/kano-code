<link rel="import" href="./dongle-base.html">
<script>
    (function (Kano) {
        let MotionSensor, PartsAPI;

        Kano.MakeApps = Kano.MakeApps || {};
        PartsAPI = Kano.MakeApps.PartsAPI = Kano.MakeApps.PartsAPI || {};

        MotionSensor = {
            start () {
                this.reset();
                PartsAPI.DongleBase.start.apply(this, arguments);
            },
            stop () {
                PartsAPI.DongleBase.stop.apply(this, arguments);
                this.reset();
            },
            reset () {
                this.model.lastProximityValue = 0;
                this._listeners = [];
            },
            _onProximityDataChanged (e) {
                const newValue = this.dataToPercentage(e.proximity);
                this._triggerListeners(newValue, this.model.lastProximityValue);
                this.set('model.lastProximityValue', newValue);
                this.fire('proximity-update');
            },
            _onGestureChanged (e) {
                if (e.type) {
                    let fireString = 'gesture-' + e.type;
                    this.fire(fireString);
                }
            },
            _triggerListeners (newValue, oldValue) {
                const zoneSize = 100 / 5;                 // 100 is the whole span, 5 is the number of zones
                this._listeners.forEach(listener => {
                    let zoneClamp = [(listener.zone - 1) * zoneSize, listener.zone * zoneSize];
                    // Was outside of the clamp and now is inside
                    if ((oldValue < zoneClamp[0] || oldValue > zoneClamp[1]) &&
                        (newValue >= zoneClamp[0] && newValue <= zoneClamp[1])) {
                            listener.callback();
                        }
                });
            },
            whenEntersZone (zone, callback) {
                this._listeners.push({ zone, callback });
            },
            getValue () {
                return this.model.lastProximityValue;
            },
            dataToPercentage (value) {
                return Math.round((value / 255) * 100);
            }
        };

        // @polymerBehavior
        Kano.MakeApps.PartsAPI['motion-sensor'] = Object.assign({}, PartsAPI.DongleBase, MotionSensor);
    })(window.Kano = window.Kano || {});
</script>
