<link rel="import" href="./base.html">
<script>
    (function (Kano) {
        let Lightboard, PartsAPI;

        Kano.MakeApps = Kano.MakeApps || {};
        PartsAPI = Kano.MakeApps.PartsAPI = Kano.MakeApps.PartsAPI || {};

        Lightboard = {
            listeners: {
                'update-shape': '_updateShape'
            },
            start () {
                PartsAPI.Base.start.apply(this, arguments);
                Kano.AppModules.getModule('lightboard').on('button-down', this._propagateButtonEvent.bind(this));

                this.iterator = {
                    currentColumn: 1,
                    currentRow: 1
                };
            },
            stop () {
                PartsAPI.Base.stop.apply(this, arguments);
                if (Kano.AppModules) {
                    Kano.AppModules.getModule('lightboard').removeListener('button-down', this._propagateButtonEvent);
                }
            },
            clear () {
                return Kano.AppModules.getModule('lightboard').clear(this.render.bind(this));
            },
            turnOn (light, color) {
                return Kano.AppModules.getModule('lightboard').turnOn(light, color, this.render.bind(this));
            },
            turnOff (light) {
                return Kano.AppModules.getModule('lightboard').turnOff(light, this.render.bind(this));
            },
            text (text, color, backgroundColor) {
                return Kano.AppModules.getModule('lightboard').text(text.toString(), color, backgroundColor, this.render.bind(this));
            },
            render () {},
            getBitmap () {
                return Kano.AppModules.getModule('lightboard').getBitmap();
            },
            scroll (text, color, backgroundColor, speed) {
                return Kano.AppModules.getModule('lightboard').scroll(text.toString(), color, backgroundColor, speed, this.render.bind(this));
            },
            forEach (direction, callback) {
                if (direction === 'column') {
                    for (this.iterator.currentColumn = 1;
                         this.iterator.currentColumn <= 16;
                         this.iterator.currentColumn++) {
                        callback();
                    }
                } else {
                    for (this.iterator.currentRow = 1;
                         this.iterator.currentRow <= 8;
                         this.iterator.currentRow++) {
                        callback();
                    }
                }
            },
            _propagateButtonEvent (data) {
                this.fire("lightboard-" + data['button-id']);
            },
            _updateShape (e) {
                this.debounce("updateShape-" + e.detail.id, () => {
                    let shape = e.detail;
                    Kano.AppModules.getModule('lightboard').updateOrCreateShape(shape.id, shape, this.render.bind(this));
                });
            }
        };

        // @polymerBehavior
        Kano.MakeApps.PartsAPI.lightboard = Object.assign({}, PartsAPI.Base, Lightboard);
    })(window.Kano = window.Kano || {});
</script>
