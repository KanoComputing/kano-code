<script>
    (function (Kano) {

        const AppModules = {
            config (config) {
                Object.keys(AppModules.modules).forEach(name => {
                    AppModules.modules[name].config(config);
                });
            },
            /**
             * Support legacy API
             */
            init () {
                this.config.apply(this, arguments);
            },
            getModule (name) {
                if (AppModules.modules[name]) {
                    return AppModules.modules[name].methods;
                }
                return {};
            },
            createAppCode (prefix, code) {
                let moduleNames = Object.keys(AppModules.modules),
                    moduleImports = moduleNames.map(name => `${prefix}.getModule('${name}')`);
                // This adds a module called devices that returns the part module. Used for older apps support
                moduleNames.push('devices');
                moduleImports.push(`${prefix}.getModule('parts')`);
                return `(function (${moduleNames.join(', ')}) {\n${code}\nglobal.emit('start');\n})(${moduleImports.join(', ')});\n`;
            },
            generateStandaloneComponent (componentName, parts, background, mode, codes) {
                let template = [],
                    // TODO find a better way to avoid having this script tag swallowed by crisper
                    scriptTagName = 'script',
                    tagName,
                    components,
                    code = this.createAppCode('Kano.AppModules', codes.snapshot.javascript),
                    component,
                    partsString;

                parts = parts || [];

                components = parts.reduce((acc, part) => {
                    tagName = part.tagName || `kano-ui-${part.type}`;
                    acc[part.id] = part.toJSON();
                    template.push(`<${tagName} id="${part.id}" model="{{parts.${part.id}}}"></${tagName}>`);
                    return acc;
                }, {});
                partsString = JSON.stringify(components);

                template = template.join('\n');

                component = `
                    <dom-module id="kano-${componentName}">
                        <style>
                            :host {
                                position: relative;
                            }
                            kano-ui-viewport {
                                position: absolute;
                                top: 0px;
                                left: 0px;
                                width: 100%;
                                height: 100%;
                            }
                            kano-ui-viewport * {
                                position: absolute;
                            }
                            kano-workspace-lightboard {
                                margin-top: 35px;
                            }
                            .workspace {
                                width: 100%;
                                height: 100%;
                            }
                        </style>
                        <template>
                            <kano-ui-viewport mode="scaled"
                                        view-width="${mode.workspace.viewport.width}"
                                        view-height="${mode.workspace.viewport.height}"
                                        no-overflow>
                                <${mode.workspace.component} id="${mode.id}" class="workspace" width="${mode.workspace.viewport.width}" height="${mode.workspace.viewport.height}">
                                    ${template}
                                </${mode.workspace.component}>
                            </kano-ui-viewport>
                        </template>
                        <${scriptTagName}>
                            Polymer({
                                is: 'kano-${componentName}',
                                properties: {
                                    parts: {
                                        type: Object,
                                        value: ${partsString}
                                    }
                                },
                                attached: function () {
                                    Kano.AppModules.loadParts(this.$);
                                    this.workspace = this.$['${mode.id}'];

                                    if (this.workspace.setBackgroundColor) {
                                        this.workspace.setBackgroundColor('${background}');
                                    }

                                    ${code}

                                    Kano.AppModules.start();
                                }
                            });
                        </${scriptTagName}>
                    </dom-module>
                `;

                return component;
            },
            loadParts (parts) {
                // Give a reference to the app modules to every part
                Object.keys(parts).forEach(id => {
                    parts[id].appModules = this;
                });
                AppModules.modules.parts.loadParts(parts);
            },
            _runModuleLifecycleStep (name) {
                Object.keys(AppModules.modules).forEach(key => {
                    AppModules.modules[key].executeLifecycleStep(name);
                });
            },
            start () {
                this._runModuleLifecycleStep('start');
            },
            stop () {
                this._runModuleLifecycleStep('stop');
            }
        };

        AppModules.enablePreviousVersionsSupport = () => {
            Kano.MakeApps = Kano.MakeApps || {};
            Kano.MakeApps.Modules = AppModules.modules;
            KanoModules = AppModules.modules;
            KanoModules.init = { methods: {} };
        };

        AppModules.modules = {};

        Kano.AppModules = AppModules;

    })(window.Kano = window.Kano || {});
</script>
