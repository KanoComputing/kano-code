<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../elements/behaviors/kano-scene-component-behavior.html">
<link rel="import" href="../../../../elements/kano-power-up-modal/kano-power-up-modal.html">
<link rel="import" href="../../../../elements/kano-app-challenge/kano-app-challenge.html">
<link rel="import" href="../../../../elements/kano-app-editor/kano-app-editor.html">
<link rel="import" href="../../../../elements/kano-challenge-progress/kano-challenge-progress.html">
<dom-module id="kano-scene-editor">
  <style>
    :host {
      display: block;
      @apply(--layout-vertical);
    }
    :host kano-app-challenge {
        @apply(--layout-flex);
    }
    :host kano-app-editor {
        @apply(--layout-flex);
    }
    :host kano-challenge-progress {
        position: absolute;
        top: 20px;
        right: 20px;
    }
  </style>
  <template>
      <kano-app-challenge id="challenge"
                            steps="[[scene.steps]]"
                            on-save="saveApp"
                            on-save-to-storage="saveToStorage"
                            on-load="loadApp"
                            current-step="{{currentStep}}"
                            started="[[scene.started]]">
          <kano-app-editor id="editor"
                            parts="[[computeParts(scene.*)]]"
                            default-categories="[[computeCategories(scene.*)]]"
                            class="editor"
                            ws-size="[[size]]"
                            running="{{running}}"
                            title="[[storyName]]"
                            code="{{code}}">
              <kano-challenge-progress id="challenge-progress" progress="[[progress]]" title="[[storyName]]" next-challenge="[[nextStory.id]]" on-share-app="shareApp" remix-mode="[[remix]]"></kano-challenge-progress>
          </kano-app-editor>
      </kano-app-challenge>
      <kano-power-up-modal id="challenge-completed"
                            options="[[extensions]]"
                            app-preview="[[appPreview]]"
                            story-name="[[storyName]]"
                            next-story="[[nextStory]]"
                            on-close="goToRemixChallenge"
                            on-power-up="powerUp"
                            on-share-app="shareApp"></kano-power-up-modal>
      </paper-dialog>
  </template>
</dom-module>
<script type="text/javascript">

    /* globals app, Polymer, Kano */

    class KanoSceneEditor {

        get behaviors () {
            return [Kano.Behaviors.SceneComponentBehavior];
        }

        beforeRegister () {
            this.is = 'kano-scene-editor';
            this.properties = {
                running: {
                    type: Boolean,
                    observer: 'runningChanged'
                },
                storyName: {
                    type: String
                },
                nextStory: {
                    type: String
                },
                currentStep: {
                    type: Number,
                    value: 0
                },
                progress: {
                    type: Number,
                    computed: "computeProgress(currentStep, scene)"
                },
                extensions: {
                    type: Array
                }
            };
            this.observers = [
                'endedChanged(scene.ended)'
            ];
        }

        endedChanged () {
            if (this.scene.ended) {
                this.$.editor.generateCover().then((image) => {
                    this.appPreview = image.src;
                    this.$['challenge-completed'].open();
                });
            }
        }

        computeProgress (currentStep, scene) {
            return currentStep / scene.steps.length;
        }

        ready () {
            this.remix = false;
            this.code = {};
        }

        attached () {
            this.set('size', Kano.MakeApps.config.WORKSPACE_FULL_SIZE);
        }

        shareApp () {
            this.$.editor.share();
        }

        computeParts () {
            return Kano.MakeApps.part.filter(part => this.scene.parts.indexOf(part.type) !== -1);
        }

        computeCategories () {
            let cats = {};
            this.scene.modules.forEach(id => {
                cats[id] = Kano.MakeApps.defaultCategories[id];
            });
            cats.events = Kano.MakeApps.defaultCategories.events;
            return cats;
        }

        runningChanged () {
            let editor = this.$.editor;
            if (this.running) {
                Kano.MakeApps.components.run(editor.addedParts, editor.code);
            } else {
                Kano.MakeApps.components.stop(editor.addedParts, editor.code);
            }
        }
        saveApp (e) {
            let id = e.detail.id,
                blockIds = e.detail.blockIds,
                stepIds = e.detail.stepIds,
                app = this.$.editor.save(true);
            this.addToStore(id, {
                app,
                blockIds,
                stepIds
            });
        }
        saveToStorage () {
            let app = this.$.editor.save();
            localStorage.setItem('savedApp', JSON.stringify(app));
        }
        loadApp (e) {
            let id = e.detail,
                savedState,
                challenge;
            savedState = this.fromStore(id);
            challenge = this.$.challenge;
            this.$.editor.load(savedState.app, this.computeParts());
            challenge.set('stepIds', savedState.stepIds);
            challenge.set('blockIds', savedState.blockIds);
        }
        goToRemixChallenge () {
            this.remix = true;
        }
        powerUp (e) {
            let extensionId = e.detail.id;
            this.fire('extend-story', extensionId);
            e.stopPropagation();
        }
    }
    Polymer(KanoSceneEditor);
</script>
