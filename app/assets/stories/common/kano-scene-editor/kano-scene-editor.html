<dom-module id="kano-scene-editor">
  <style>
    :host {
      display: block;
      @apply(--layout-vertical);
    }
    :host kano-app-challenge {
        @apply(--layout-flex);
    }
    :host kano-app-editor {
        @apply(--layout-flex);
    }
    :host kano-challenge-progress {
        position: absolute;
        top: 20px;
        right: 20px;
    }
    :host #challenge-completed .buttons {
        @apply(--layout-horizontal);
        @apply(--layout-around-justified);
    }
    :host #challenge-completed .buttons button {
        @apply(--kano-button);
        min-height: 45px;
        font-weight: bold;
    }

    :host #challenge-completed .buttons .remix {
        background: var(--color-orange);
    }

    :host #challenge-completed .buttons .share {
        background: var(--color-kw-blue);
    }

    :host #challenge-completed .buttons .next-challenge {
        background: var(--color-green);
    }

    :host #challenge-completed h2 {
        color: var(--color-green);
    }
    :host .completed-message,
    :host .completed-options {
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
    }
  </style>
  <template>
      <kano-app-challenge id="challenge"
                            steps="[[scene.steps]]"
                            on-save="saveApp"
                            on-save-to-storage="saveToStorage"
                            on-load="loadApp"
                            current-step="{{currentStep}}"
                            started="[[scene.started]]">
          <kano-app-editor id="editor"
                            parts="[[computeParts(scene.*)]]"
                            default-categories="[[computeCategories(scene.*)]]"
                            class="editor"
                            ws-size="[[size]]"
                            running="{{running}}"
                            title="[[storyName]]">
              <kano-challenge-progress id="challenge-progress" progress="[[progress]]" title="[[storyName]]" next-challenge="[[nextStory]]" on-share-app="shareApp" remix-mode="[[remix]]" on-next-story="goToNextStory"></kano-challenge-progress>
          </kano-app-editor>
      </kano-app-challenge>
      <paper-dialog id="challenge-completed" with-backdrop on-iron-overlay-closed="goToRemixChallenge">
          <div class="dialog pure-g">
              <div class="pure-u-1 pure-u-md-1-3 completed-message">
                  <div class="p-box">
                      <h2>High five!</h2>
                      <p> You have completed the [[storyName]] challenge </p>
                  </div>
              </div>
              <div class="pure-u-1 pure-u-md-2-3 completed-options">
                  <div class="buttons">
                      <button class="share" on-tap="shareApp">Share</button>
                      <button class="remix" on-tap="goToRemixChallenge">Remix</button>
                      <template is="dom-if" if="[[nextStory]]">
                          <button type="button" class="next-challenge" on-tap="goToNextStory">Next Challenge</button>
                      </template>
                  </div>
              </div>
          </div>
      </paper-dialog>
  </template>
</dom-module>
<script type="text/javascript">

    /* globals app, Polymer, KanoBehaviors */

    class KanoSceneEditor {

        get behaviors () {
            return [KanoBehaviors.SceneComponentBehavior];
        }

        beforeRegister () {
            this.is = 'kano-scene-editor';
            this.properties = {
                running: {
                    type: Boolean,
                    observer: 'runningChanged'
                },
                storyName: {
                    type: String
                },
                nextStory: {
                    type: String
                },
                currentStep: {
                    type: Number,
                    value: 0
                },
                progress: {
                    type: Number,
                    computed: "computeProgress(currentStep, scene)"
                }
            };
            this.observers = [
                'endedChanged(scene.ended)'
            ];
        }

        endedChanged () {
            if (this.scene.ended) {
                this.$['challenge-completed'].open();
            }
        }

        computeProgress (currentStep, scene) {
            return currentStep / scene.steps.length;
        }

        ready () {
            this.remix = false;
        }

        attached () {
            this.set('size', app.config.WORKSPACE_FULL_SIZE);
        }

        shareApp () {
            this.$.editor.share();
        }

        computeParts () {
            return app.part.filter(part => this.scene.parts.indexOf(part.type) !== -1);
        }

        computeCategories () {
            let cats = {};
            this.scene.modules.forEach(id => {
                cats[id] = app.defaultCategories[id];
            });
            cats.events = app.defaultCategories.events;
            return cats;
        }

        runningChanged () {
            let editor = this.$.editor;
            if (this.running) {
                app.components.run(editor.addedParts, editor.code);
            } else {
                app.components.stop(editor.addedParts, editor.code);
            }
        }
        saveApp (e) {
            let id = e.detail.id,
                blockIds = e.detail.blockIds,
                stepIds = e.detail.stepIds,
                app = this.$.editor.save(true);
            this.addToStore(id, {
                app,
                blockIds,
                stepIds
            });
        }
        saveToStorage () {
            let app = this.$.editor.save();
            localStorage.setItem('savedApp', JSON.stringify(app));
        }
        loadApp (e) {
            let id = e.detail,
                savedState,
                challenge;
            savedState = this.fromStore(id);
            challenge = this.$.challenge;
            this.$.editor.load(savedState.app, this.computeParts());
            challenge.set('stepIds', savedState.stepIds);
            challenge.set('blockIds', savedState.blockIds);
        }
        goToRemixChallenge () {
            this.$['challenge-completed'].close();
            this.remix = true;
        }
        goToNextStory () {
            if (!this.nextStory) {
                return;
            }
            window.location = `/story/${this.nextStory}`;
        }
    }
    Polymer(KanoSceneEditor);
</script>
