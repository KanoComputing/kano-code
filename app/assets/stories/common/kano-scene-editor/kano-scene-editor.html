<dom-module id="kano-scene-editor">
  <style>
    :host {
      display: block;
      @apply(--layout-vertical);
    }
    :host kano-app-challenge {
        @apply(--layout-flex);
    }
    :host kano-app-editor {
        @apply(--layout-flex);
    }
  </style>
  <template>
      <kano-app-challenge id="challenge"
                            steps="[[scene.steps]]"
                            on-save="saveApp"
                            on-save-to-storage="saveToStorage"
                            on-load="loadApp"
                            story-name="[[storyName]]"
                            next-story="[[nextStory]]">
          <kano-app-editor id="editor"
                            parts="[[computeParts(scene.*)]]"
                            default-categories="[[computeCategories(scene.*)]]"
                            class="editor"
                            ws-size="[[size]]"
                            running="{{running}}"></kano-app-editor>
      </kano-app-challenge>
  </template>
</dom-module>
<script type="text/javascript">

    /* globals app, Polymer, KanoBehaviors */

    class KanoSceneVideo {

        get behaviors () {
            return [KanoBehaviors.SceneComponentBehavior];
        }

        beforeRegister () {
            this.is = 'kano-scene-editor';
            this.properties = {
                running: {
                    type: Boolean,
                    observer: 'runningChanged'
                }
            };
        }

        attached () {
            this.set('size', app.config.WORKSPACE_FULL_SIZE);
            document.addEventListener('shareApp', (e) => {
                this.$['editor'].share();
            })
        }

        computeParts () {
            return app.part.filter(part => this.scene.parts.indexOf(part.type) !== -1);
        }

        computeCategories () {
            let cats = {};
            this.scene.modules.forEach(id => {
                cats[id] = app.defaultCategories[id];
            });
            cats.events = app.defaultCategories.events;
            return cats;
        }

        runningChanged () {
            let editor = this.$.editor;
            if (this.running) {
                app.components.run(editor.addedParts, editor.codes);
            } else {
                app.components.stop(editor.addedParts, editor.codes);
            }
        }
        saveApp (e) {
            let id = e.detail.id,
                blockIds = e.detail.blockIds,
                stepIds = e.detail.stepIds,
                app = this.$.editor.save(true);
            this.addToStore(id, {
                app,
                blockIds,
                stepIds
            });
        }
        saveToStorage () {
            let app = this.$.editor.save();
            localStorage.setItem('savedApp', JSON.stringify(app));
        }
        loadApp (e) {
            let id = e.detail,
                savedState,
                challenge;
            savedState = this.fromStore(id);
            challenge = this.$.challenge;
            this.$.editor.load(savedState.app, this.computeParts());
            challenge.set('stepIds', savedState.stepIds);
            challenge.set('blockIds', savedState.blockIds);
        }
    }
    Polymer(KanoSceneVideo);
</script>
