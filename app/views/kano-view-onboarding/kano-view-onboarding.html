<link rel="import" href="../../scripts/kano/make-apps/hardware-api.html">
<link rel="import" href="../../scripts/kano/make-apps/utils.html">
<link rel="import" href="../../scripts/kano/make-apps/parts/parts.html">
<link rel="import" href="../../scripts/kano/util/router.html">
<link rel="import" href="../../scripts/kano/make-apps/blockly/blockly.html">
<link rel="import" href="../../scripts/kano/app-modules/index.html">

<link rel="import" href="../../elements/kano-app-editor/kano-app-editor.html">
<link rel="import" href="../../elements/kano-reward-modal/kano-reward-modal.html">
<link rel="import" href="../../elements/behaviors/kano-editor-view-behavior.html">

<dom-module id="kano-view-onboarding">
    <style>
    :host {
        display: block;
        @apply(--layout-vertical);
    }
    :host kano-app-editor {
        @apply(--layout-flex);
    }
    :host paper-dialog {
        background: transparent;
        overflow: hidden;
    }
    </style>
    <template>
        <kano-app-editor
            id="editor"
            running="{{running}}"
            parts="{{parts}}"
            code="{{code}}"
            added-parts="{{addedParts}}"
            default-categories="[[defaultCategories]]"
            mode="[[mode]]"
            banner="[[banner]]"></kano-app-editor>
        <paper-dialog
            id="reward-modal"
            with-backdrop>
            <kano-reward-modal
                on-interaction='_handleModalAction'
                content='[[_currentReward(rewardContent, context.params.stage)]]'></kano-reward-modal>
        </paper-dialog>
    </template>
</dom-module>

<script type="text/javascript">
    /* globals Polymer, Kano */
    Polymer({
        is: 'kano-view-onboarding',
        behaviors: [Kano.Behaviors.EditorViewBehavior],
        properties: {
            context: Object,
            addedParts: {
                type: Array,
                value: () => {
                    return [];
                }
            },
            code: {
                type: Object,
                value: () => {
                    return {};
                }
            },
            usedBlocks: {
                type: Object
            },
            banner: {
                type: Object
            },
            rewardContent: {
                type: Object,
                value: () => {
                    return {
                        1: {
                            icon: 'star',
                            color: 'yellow',
                            title: 'You completed a challenge!',
                            body: 'Now try another: get more powers',
                            links: [{
                                text: 'Try second challenge',
                                type: 'progress'
                            }, {
                                text: 'Save',
                                type: 'save'
                            }],
                            xp: 100
                        },
                        2: {
                            icon: 'tick',
                            color: 'green',
                            title: 'Don’t your new powers feel good?',
                            body: 'Last challenge: try it',
                            links: [{
                                text: 'Try last challenge',
                                type: 'progress'
                            }, {
                                text: 'Save',
                                type: 'save'
                            }],
                            xp: 200
                        },
                        3: {
                            icon: 'heart',
                            color: 'red',
                            title: 'Save your XP!',
                            body: 'You’ve earned 300 XP – keep it safe.',
                            links: [{
                                text: 'Save now',
                                type: 'save'
                            }, {
                                text: 'Try more challenges',
                                type: 'progress'
                            }],
                            xp: 300
                        }
                    }
                }
            }
        },
        attached () {
        },
        detached () {
        },
        _registerBlockly () {
            let stage = this.context.params.stage;

            Kano.Behaviors.EditorViewBehavior._registerBlockly.apply(this, arguments);

            if (this.loaded) {
                return;
            }
            this.loaded = true;

            this.set('defaultCategories', {});
            this.parts = [];
            console.log(this.defaultCategories, this.parts);
        },
        ready () {
            this.$['reward-modal'].open();
            let hardwareAPI = new Kano.MakeApps.HardwareAPI();
            this.loaded = false;
            this.editor = this.$.editor;
            this.editor.addEventListener('ws-update', this.updateWorkspaceRect.bind(this));

            Kano.MakeApps.config.HOST = Kano.Util.Router.parseQsParam(this.context.querystring, 'host') || Kano.MakeApps.config.HOST;
            Kano.MakeApps.config.PORT = Kano.Util.Router.parseQsParam(this.context.querystring, 'port') || Kano.MakeApps.config.PORT;

            hardwareAPI.config(Kano.MakeApps.config);

            Kano.MakeApps.Mode.init(Kano.MakeApps.config);
            Kano.MakeApps.Blockly.init(Kano.MakeApps.config);
            Kano.MakeApps.Parts.init(Kano.MakeApps.config);
            Kano.AppModules.init(Object.assign({ hardwareAPI }, Kano.MakeApps.config));

            this.mode = Kano.MakeApps.Mode.modes.simple;
            this.banner = {
                head: 'Part Two',
                text: 'That code you wrote had two parts: a command and a parameter. Can you connect them together?'
            };
        },
        updateWorkspaceRect (rect) {
            Kano.MakeApps.dragAndDrop.setWorkspaceRect(rect);
        },
        _currentReward (content, stage) {
            return content[stage];
        },
        _handleModalAction (e) {
            console.log('Modal interaction');
            console.log(e.detail.type);
            this.$['reward-modal'].close();
        }
    });
</script>
