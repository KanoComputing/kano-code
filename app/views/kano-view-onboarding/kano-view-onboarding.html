<link rel="import" href="../../scripts/kano/make-apps/hardware-api.html">
<link rel="import" href="../../scripts/kano/make-apps/utils.html">
<link rel="import" href="../../scripts/kano/make-apps/parts/parts.html">
<link rel="import" href="../../scripts/kano/util/router.html">
<link rel="import" href="../../scripts/kano/make-apps/blockly/blockly.html">
<link rel="import" href="../../scripts/kano/app-modules/index.html">

<link rel="import" href="../../elements/kano-app-editor/kano-app-editor.html">
<link rel="import" href="../../elements/behaviors/kano-editor-view-behavior.html">

<dom-module id="kano-view-onboarding">
    <style>
    :host {
        display: block;
        @apply(--layout-vertical);
    }
    :host kano-app-editor {
        @apply(--layout-flex);
    }
    </style>
    <template>
        <kano-app-editor
            id="editor"
            running="{{running}}"
            parts="{{parts}}"
            code="{{code}}"
            added-parts="{{addedParts}}"
            default-categories="[[defaultCategories]]"
            mode="[[mode]]"
            banner="[[banner]]"
            challenge-state="{{challengeState}}"
            on-blockly-ready="_onBlocklyReady"></kano-app-editor>
    </template>
</dom-module>

<script type="text/javascript">
    /* globals Polymer, Kano */
    Polymer({
        is: 'kano-view-onboarding',
        behaviors: [Kano.Behaviors.EditorViewBehavior],
        properties: {
            context: Object,
            addedParts: {
                type: Array,
                value: () => {
                    return [];
                }
            },
            code: {
                type: Object,
                value: () => {
                    return {};
                }
            },
            usedBlocks: {
                type: Object
            },
            banner: {
                type: Object
            }
        },
        observers: [
        ],
        attached () {
        },
        detached () {
        },
        _registerBlockly () {
            let stage = this.context.params.stage;

            Kano.Behaviors.EditorViewBehavior._registerBlockly.apply(this, arguments);

            if (this.loaded) {
                return;
            }
            this.loaded = true;

            this.set('defaultCategories', {});

            this._filterParts();
        },
        _filterParts () {
            // Only include the parts defined in the mode
            if (this.mode.parts) {
                this.set('parts', Kano.MakeApps.Parts.list.filter((part) => {
                    return this.mode.parts.indexOf(part.type) !== -1;
                }));

                let part = Kano.MakeApps.Parts.create(this.parts[0], this.mode.workspace.viewport);
                this.push('addedParts', part);
            }
        },
        ready () {
            let hardwareAPI = new Kano.MakeApps.HardwareAPI();
            this.loaded = false;
            this.editor = this.$.editor;
            this.editor.addEventListener('ws-update', this.updateWorkspaceRect.bind(this));

            Kano.MakeApps.config.HOST = Kano.Util.Router.parseQsParam(this.context.querystring, 'host') || Kano.MakeApps.config.HOST;
            Kano.MakeApps.config.PORT = Kano.Util.Router.parseQsParam(this.context.querystring, 'port') || Kano.MakeApps.config.PORT;

            hardwareAPI.config(Kano.MakeApps.config);

            Kano.MakeApps.Mode.init(Kano.MakeApps.config);
            Kano.MakeApps.Blockly.init(Kano.MakeApps.config);
            Kano.MakeApps.Parts.init(Kano.MakeApps.config);
            Kano.AppModules.init(Object.assign({ hardwareAPI }, Kano.MakeApps.config));

            this.mode = Kano.MakeApps.Mode.modes.simple;
            this.banner = {
                head: 'Part Two',
                text: 'That code you wrote had two parts: a command and a parameter. Can you connect them together?'
            };

        },
        updateWorkspaceRect (rect) {
            Kano.MakeApps.dragAndDrop.setWorkspaceRect(rect);
        }
    });
</script>
