<link rel="import" href="../../elements/share-bundle.html">
<link rel="import" href="../../elements/story-bundle.html">
<link rel="import" href="../../elements/editor-bundle.html">
<link rel="import" href="../../elements/external-play-bundle.html">
<dom-module id="kano-view-story">
    <style>
        :host {
            display: block;
            position: relative;
            @apply(--layout-vertical);
        }
        :host kano-story-scene {
            @apply(--layout-flex);
        }
        paper-dialog {
            border-radius: 5px;
        }
    </style>
    <template>
        <kano-story-scene id="story-scene" scene="{{scene}}" on-scene-done="nextScene" on-share="share" story-name="{{story.name}}" next-story="{{story.next}}" extensions="[[story.extensions]]" on-extend-story="extendStory" on-next-story="nextStory"></kano-story-scene>
        <paper-dialog id="share-modal" with-backdrop>
            <kano-share-modal on-confirm="confirmShare"
                              on-dismiss="dismissShare"
                              share-info="{{shareInfo}}"></kano-share-modal>
        </paper-dialog>
    </template>
</dom-module>

<script>
    /* globals Polymer, Kano, page */
    Polymer({
        is: 'kano-view-story',
        behaviors: [Kano.Behaviors.SharingBehavior],
        properties: {
            selected: {
                type: Number,
                value: 0,
                observer: 'selectedChanged'
            },
            story: {
                type: Object,
                observer: 'selectedChanged'
            }
        },
        listeners: {
            'blockly-ready': '_registerBlockly'
        },
        ready () {
            Kano.AppModules.init(Kano.MakeApps.config);
            Kano.MakeApps.Parts.init(Kano.MakeApps.config);
            Kano.MakeApps.blockly.init(Kano.MakeApps.config);
            Kano.MakeApps.Mode.init(Kano.MakeApps.config);
        },
        attached () {
            this.modal = this.$['share-modal'];
            Kano.MakeApps.stories.getById(this.context.params.id)
                .then((story) => {
                    if (typeof story.next === 'string') {
                        return Kano.MakeApps.stories.getById(story.next)
                            .then((nextStory) => {
                                story.next = nextStory;
                                return story;
                            });
                    }
                    return story;
                })
                .then((story) => {
                    this.story = story;
                    return Kano.MakeApps.progress.loadProgress(story.progress.group);
                })
                .then((progress) => this.updateExtensions(progress));

            this.async(function() {
                trackPage();
            });
        },
        _registerBlockly () {
            Kano.MakeApps.blockly.register(window.Blockly);
        },
        updateExtensions (progress) {
            let story = this.story,
                extensions = story.extensions,
                progressGroup = progress[story.progress.group] || {},
                progressExtensions = progressGroup.extensions;
            if (story.extensions && progressExtensions) {
                for (let i = 0, len = extensions.length; i < len; i++) {
                    if (progressExtensions.indexOf(extensions[i].id) !== -1) {
                        this.set(`story.extensions.${i}.completed`, true);
                    }
                }
            }
        },
        isSelected (index) {
            return index === this.selected;
        },
        nextScene () {
            if (this.selected < this.story.scenes.length - 1) {
                this.selected++;
            } else {
                //story completed!!!
                let progress = this.story.progress,
                    extension = this.story.extension ? this.story.id : null;
                Kano.MakeApps.progress.updateProgress(progress.group, progress.storyNo, extension)
                    .then((progress) => this.updateExtensions(progress));
            }
        },
        selectedChanged () {
            if (!this.story) {
                return;
            }
            Kano.MakeApps.stories.getSceneByIndex(this.story, this.selected)
                .then((scene) => {
                    this.set('scene', scene);
                    this.set('scene.modeConfig', {
                        HOST: window.RouterUtil.parseQsParam(this.context.querystring, 'host'),
                        PORT: window.RouterUtil.parseQsParam(this.context.querystring, 'port')
                    });
                });
        },
        extendStory (e) {
            let extensionId = e.detail;
            page.redirect(`/story/${extensionId}`);
        },
        nextStory (e) {
            let storyId;
            if (!this.story.next) {
                return;
            }
            storyId = this.story.next.id;
            page.redirect(`/story/${storyId}`);
        }
    });
</script>
