<dom-module id="kano-view-workshop">
    <style>
    :host {
        display: block;
        @apply(--layout-vertical);
    }
    :host button {
        @apply(--kano-button);
        background-color: var(--primary-color);
    }
    :host section {
        @apply(--layout-horizontal);
        @apply(--layout-align-stretch);
    }
    :host header {
        background-color: var(--color-header, black);
        color: white;
        @apply(--kano-header);
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        @apply(--layout-center);
        height: 62px;
    }
    :host header div {
        @apply(--layout-flex);
    }
    :host .user-info {
        margin-left: 5px;
    }
    :host header iron-image {
        height: 42px;
        width: 155px;
        margin-left: 15px;
    }
    :host header button {
        margin-right: 15px;
    }
    :host section {
        @apply(--layout-horizontal);
        @apply(--layout-flex);
    }
    :host section .ui-edition {
        position: relative;
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    :host section .blocks-edition {
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    :host .ui-edition kano-workspace {
        /*width: 1024px;
        height: 768px;*/
        @apply(--layout-flex);
    }
    :host .ui-edition .controls {
        position: relative;
        max-height: 40%;
        min-height: 70px;
        @apply(--layout-vertical);
    }
    :host .controls .text-filler {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        background-color: var(--color-black, black);
    }
    :host .text-filler .toolbar {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        padding: 5px;
    }
    :host .make-button {
        @apply(--kano-button-small);
    }
    :host .make-button.running {
        background-color: var(--color-red, red);
    }
    :host .add-ui {
        @apply(--kano-round-button);
        background-color: var(--color-green, green);
        color: var(--color-white, white);
        position: absolute;
        top: -25px;
        left: 5px;
    }
    :host kano-ui-editor {
        @apply(--layout-flex);
    }
    :host #ui-drawer {
        z-index: 10;
    }
    </style>
    <template>
        <header>
            <div class="user-info">
                <h1 hidden$="{{!user}}">{{user}}</h1>
                <button type="button"
                    class="login-button"
                    on-tap="toggleLogin">{{buttonLogin}}</button>
            </div>
            <iron-image src="../../assets/make-apps-logo.png"
                        preload
                        sizing="contain"></iron-image>
            <div class=""></div>
        </header>
        <section id="section">
            <div class="blocks-edition">
                <kano-ui-editor
                    id="block-editor"
                    ui-elements="{{workspaceUiElements}}"
                    selected-ui="{{selectedUi}}"></kano-ui-editor>
            </div>
            <div class="ui-edition">
                <kano-workspace id="workspace"
                                on-ui-ready="workspaceUiReady"
                                ui-elements="{{workspaceUiElements}}"
                                selected="{{selectedUi}}"
                                running="{{isRunning}}"></kano-workspace>
                <div class="controls">
                    <button type="button" class="add-ui" on-tap="openUiDrawer">+</button>
                    <div class="text-filler">
                        <div class="toolbar">
                            <button type="button"
                                class$="make-button {{running}}"
                                on-tap="toggleMake">{{buttonAction}}</button>
                        </div>
                    </div>
                </div>
            </div>
            <kano-drawer position="left" overlap="48" id="ui-drawer">
                <kano-sidebar class="drawer-content"
                            ui-elements="{{uiElements}}"
                            on-ui-ready="sidebarUiReady"
                            on-close="closeUiDrawer"></kano-sidebar>
            </kano-drawer>
        </section>
        <kano-modal id="login-modal"></kano-modal>
    </template>
</dom-module>

<script type="text/javascript">
    class KanoViewWorkshop {
        beforeRegister () {
            this.is = 'kano-view-workshop';
            this.properties = {
                running: {
                    type: String,
                    computed: 'computeRunning(isRunning)'
                },
                buttonAction: {
                    type: String,
                    computed: 'computeButtonAction(isRunning)'
                },
                slave: {
                    type: Boolean,
                    value: false
                },
                user: {
                  type: String,
                  value: ''
                },
                buttonLogin: {
                  type: String,
                  computed: 'computeButtonLogin(user)'
              },
              selectedUi: {
                  type: Object,
                  observer: 'selectedUiChanged'
              }
            };
        }
        selectedUiChanged (newValue, oldValue) {
            let editor = this.$['block-editor'];
            if (!oldValue) {
                return;
            }
            if (editor.code && editor.code.trim().length) {
                // Add the new code and its rule to the components store
                app.components.setCode(editor.selectedTrigger.id, editor.event,
                    editor.code, editor.rule, editor.getBlocklyXml());
                /*e.detail.rules = app.components.getRulesFor(
                    this.selectedUi.id);*/
            }
        }
        openUiDrawer () {
            this.$['ui-drawer'].opened = true;
        }
        closeUiDrawer () {
            this.$['ui-drawer'].opened = false;
        }
        computeRunning (running) {
            return running ? 'running' : '';
        }
        computeButtonAction (running) {
            return running ? 'stop' : 'make';
        }
        computeButtonLogin (user) {
            return user ? 'Logout' : 'Login';
        }
        attached () {
            let trash = this.$.workspace.getTrashElement();
            this.workspaceUiElements = [];
            this.isRunning = false;
            this.set('uiElements', app.ui.getAll());
            app.Interact(this.$.workspace).dropzone({
                accept: 'kano-ui-item',
                ondragenter: () => {
                    this.$.workspace.pulsing = true;
                },
                ondragleave: () => {
                    this.$.workspace.pulsing = false;
                },
                ondrop: (e) => {
                    let rect = e.relatedTarget.getBoundingClientRect(),
                        elemCenter = {
                            x: rect.left + (rect.width / 2),
                            y: rect.top + (rect.height / 2)
                        },
                        model = app.ui.create(e.relatedTarget.model.type);
                    app.components.add(model);
                    this.$.workspace.addUi(model, elemCenter);
                    this.$.workspace.pulsing = false;
                }
            });
            /*app.Interact(trash).dropzone({
                accept: 'kano-ui',
                overlap: 0.01,
                ondrop: (e) => {
                    let id = e.relatedTarget.model.id
                    this.$.workspace.removeUi(id);
                    app.components.remove(id);
                    app.codes.remove(id);
                }
            });*/
            app.registerBlockly(window.Blockly);
            this.$['block-editor'].defaultCategories = app.defaultCategories;
        }
        createId (type) {
            let ids = this.uiElements.map((ui) => ui.id);
            if (ids.indexOf(type) !== -1) {
                return this.createId(`${type}-1`);
            }
            return type;
        }
        sidebarUiReady (e) {
            let clone;
            app.Interact(e.detail).draggable({
                onmove: app.dragMoveListener,
                restrict: {
                    restriction: this.$.section
                },
                onend: () => {
                    this.$.section.removeChild(clone);
                }
            }).on('move', (event) => {
                let interaction = event.interaction;

                // if the pointer was moved while being held down
                // and an interaction hasn't started yet
                if (interaction.pointerIsDown && !interaction.interacting()) {
                    let original = event.currentTarget,
                    rect = original.getBoundingClientRect();

                    // create a clone of the currentTarget element
                    clone = Polymer.dom(original).cloneNode(true);
                    clone.model = original.model;
                    clone.style.position = 'absolute';
                    clone.style.top = `${rect.top}px`;
                    clone.style.left = `${rect.left}px`;
                    clone.style.zIndex = 11;

                    // insert the clone to the page
                    this.$.section.appendChild(clone);

                    // start a drag interaction targeting the clone
                    interaction.start({ name: 'drag' },
                                        event.interactable,
                                        clone);
                }
            });
        }
        workspaceUiReady (e) {
            let element = e.detail,
                gridTarget = app.Interact.createSnapGrid({
                    x: 32,
                    y: 32
                });
            // Register the element in the service
            app.components.setElement(element.model.id, element.getUIElement());
            app.Interact(element).draggable({
                onmove: app.dragMoveListener,
                snap: {
                    targets: [gridTarget]
                },
                restrict: {
                    restriction: this.$.workspace,
                    elementRect: { top: 0, left: 0, bottom: 1, right: 1 }
                }
            });
        }
        toggleMake () {
            this.isRunning = !this.isRunning;
            if (this.isRunning) {
                if (this.selectedUi) {
                    this.selectedUiChanged(null, this.selectedUi);
                }
                app.components.run();
            } else {
                app.components.stop();
            }
        }
        toggleLogin () {
          let modal;

          if (this.user) {
            app.modelManager.unset('user');
            this.user = app.modelManager.get('user');
            return;
          }

          const handleSwitch = (ev) => {
            if (ev.target.localName === 'kano-login-form') {
              modal.setContent(document.createElement('kano-signup-form'));
              document.querySelector('#already-signedup-button').addEventListener('click', handleSwitch);
            }
            if (ev.target.id === 'already-signedup-button') {
              modal.setContent(document.createElement('kano-login-form'));
              document.querySelector('kano-login-form').addEventListener('signup-click', handleSwitch);
            }
          }

          const handleLogin = (data) => {
            app.modelManager.set('user', data.details)
            this.user = data.details.user.username;
            modal.close();
          }

          modal = document.createElement('kano-modal');
          modal.setContent(document.createElement('kano-login-form'));
          modal.show(() => {
            let loginForm = document.querySelector('kano-login-form');
            loginForm.addEventListener('signup-click', handleSwitch);
            loginForm.addEventListener('success', handleLogin);
          });

          modal.addEventListener('modal-close', () => {
            document.body.removeChild(modal)
          })
          document.body.appendChild(modal);


        }
    }
    Polymer(KanoViewWorkshop);
</script>
