<dom-module id="kano-view-workshop">
    <style>
    :host {
        display: block;
        @apply(--layout-vertical);
    }
    :host kano-app-editor {
        @apply(--layout-flex);
    }
    </style>
    <template>
        <kano-app-editor
            id="editor"
            running="{{running}}"
            parts="{{parts}}"
            added-parts="{{addedParts}}"
            default-categories="[[defaultCategories]]"
            ws-size="[[size]]"></kano-app-editor>
    </template>
</dom-module>

<script type="text/javascript">
    class KanoViewWorkshop {
        beforeRegister () {
            this.is = 'kano-view-workshop';
            this.properties = {
                addedParts: {
                    type: Array,
                    value: () => {
                        return [];
                    }
                },
                running: {
                    type: Boolean,
                    observer: 'runningChanged'
                },
                usedBlocks: {
                    type: Object
                }
            };
        }
        attached () {
            let editor = this.$.editor;
            this.set('parts', app.part);
            this.set('user', app.sdk.auth.getUser());
            this.set('size', app.config.WORKSPACE_FULL_SIZE);
            app.registerBlockly(window.Blockly);
            this.set('defaultCategories', app.defaultCategories);
            editor.addEventListener('ws-update', this.updateWorkspaceRect.bind(this));
            editor.addEventListener('share', this.shareApp.bind(this));
            editor.addEventListener('new-part', this.addPart.bind(this));
            editor.load();
        }
        addPart (e) {
            let model = app.part.create(e.detail);
            app.components.add(model);
            this.push('addedParts', model);
        }
        updateWorkspaceRect (rect) {
            app.dragAndDrop.setWorkspaceRect(rect);
        }
        shareApp () {
            // Generates the standalone component
            let workspaceRect = app.dragAndDrop.workspaceRect,
                savedApp = `${app.components.generateStandaloneComponent(workspaceRect)}`,
                file = new Blob([savedApp], { type: 'text/html' });

            file.filename = 'code.html';
            // Share by calling the API
            app.sdk.api.share.post({
                app: 'make-apps',
                title: e.detail.title,
                description: e.detail.description,
                files: {
                    attachment: file
                }
            }).then(() => {
                modal.close();
            });
        }
        removePart (e) {
            let model = e.detail,
                parts = this.addedParts;
            if (model.id === 'background') {
                return;
            }
            for (let i = 0, len = parts.length; i < len; i++) {
                if (parts[i].id === model.id) {
                    this.splice('addedParts', i, 1);
                    app.components.remove(model.id);
                    if (model.partType === 'module') {
                        this.push('parts', model);
                    }
                    if (!this.addedParts.length) {
                        this.set('leftPanelView', 'parts');
                    }
                    return;
                }
            }
        }
        uiAddedParts () {
            return this.addedParts.filter((part) => {
                return part.partType === 'ui';
            });
        }
        /**
         * When the current code changes, save it in the components store
         * @param  {Event} e  Informations about the code updated
         */
        codeChanged (e) {
            let data = e.detail;
            // Add the new code and its rule to the components store
            app.components.setCode(data.id, data.emitter, data.event, data.code);
        }
        detached () {
            window.removeEventListener('resize', this.updateWorkspaceRect.bind(this));
        }
        runningChanged () {
            if (this.running) {
                app.components.run(this.addedParts, this.$.editor.modules);
            } else {
                app.components.stop(this.addedParts, this.$.editor.modules);
            }
        }
    }
    Polymer(KanoViewWorkshop);
</script>
