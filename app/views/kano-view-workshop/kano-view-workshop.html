<link rel="import" href="../../elements/kano-app-editor/kano-app-editor.html">
<link rel="import" href="../../elements/kano-share-modal/kano-share-modal.html">
<dom-module id="kano-view-workshop">
    <style>
    :host {
        display: block;
        @apply(--layout-vertical);
    }
    :host kano-app-editor {
        @apply(--layout-flex);
    }
    :host #error-dialog .title {
        color: red;
    }
    :host #error-dialog .description {
        text-align: center;
    }
    :host #share-modal {
        overflow: scroll;
    }
    </style>
    <template>
        <kano-app-editor
            id="editor"
            running="{{running}}"
            parts="{{parts}}"
            codes="{{codes}}"
            added-parts="{{addedParts}}"
            default-categories="[[defaultCategories]]"
            ws-size="[[size]]"
            on-share="share"></kano-app-editor>
        <paper-dialog id='error-dialog' with-backdrop>
            <h2 class="title">{{error.title}}</h2>
            <p class="description">{{error.description}}</p>
        </paper-dialog>
        <paper-dialog id="share-modal" with-backdrop>
            <kano-share-modal on-confirm="confirmShare"
                              on-dismiss="dismissShare"
                              share-info="{{shareInfo}}"></kano-share-modal>
        </paper-dialog>
    </template>
</dom-module>

<script type="text/javascript">
    /* globals Polymer */
    /* globals app */
    class KanoViewWorkshop {
        beforeRegister () {
            this.is = 'kano-view-workshop';
            this.properties = {
                addedParts: {
                    type: Array,
                    value: () => {
                        return [];
                    }
                },
                codes: {
                    type: Object,
                    value: () => {
                        return {};
                    }
                },
                running: {
                    type: Boolean,
                    observer: 'runningChanged'
                },
                usedBlocks: {
                    type: Object
                },
                remixMode: {
                    type: Boolean,
                    value: false
                },
                error: {
                    type: Object,
                    value: {
                        title: '',
                        description: ''
                    },
                    notify: true
                },
                shareInfo: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                    notify: true
                }
            };
        }
        attached () {
            let editor = this.$.editor,
                appToLoad,
                slug = app.ctx.params.slug;

            this.set('parts', app.part);
            this.set('user', app.sdk.auth.getUser());
            this.set('size', app.config.WORKSPACE_FULL_SIZE);
            app.registerBlockly(window.Blockly);
            this.set('defaultCategories', app.defaultCategories);
            editor.addEventListener('ws-update', this.updateWorkspaceRect.bind(this));
            editor.addEventListener('change', this.save.bind(this));

            if (slug) {
                this.remixMode = true;
                //loading component for remixing, we need to get data from the slug
                app.sdk.api.share.get.bySlug({ slug }).then(res => {
                    //getting the workspace info from the share
                    if (res.body.item.workspace_info_url) {
                        fetch(res.body.item.workspace_info_url)
                        .then(response => {
                            return response.json();
                        }).then(json => {
                            editor.load(json, app.part);
                        }).catch(err => {
                            console.error('loading failed', err);
                            this.set('error.title', 'Loading failed');
                            this.set('error.description', 'Couldn\'t load share');
                            this.$['error-dialog'].open();
                        })
                    }
                });
            } else {
                appToLoad = JSON.parse(localStorage.getItem('savedApp'))
                editor.load(appToLoad, app.part);
            }

        }
        updateWorkspaceRect (rect) {
            app.dragAndDrop.setWorkspaceRect(rect);
        }
        save () {
            // Save after 3secs without changes
            if (!this.remixMode) {
                this.debounce('save', () => {
                    let editor = this.$.editor,
                        savedApp = editor.save();
                    localStorage.setItem('savedApp', JSON.stringify(savedApp));
                }, 3000);
            }
        }
        shareApp () {
            // Generates the standalone component
            let editor = this.$.editor,
                savedApp = app.components.generateStandaloneComponent(
                    this.addedParts,
                    editor.computeBackground(),
                    this.size,
                    this.codes
                ),
                attachment = new Blob([savedApp], { type: 'text/html' }),
                cover = app.file_utils.dataURItoBlob(this.shareInfo.image.src),
                workspaceInfo = new Blob([this.shareInfo.workspaceInfo], { type: 'application/json' });

            attachment.filename = 'code.html';
            cover.filename = 'cover.png';
            workspaceInfo.filename = 'workspace_info.json';

            //Share by calling the API
            app.sdk.api.share.post({
                app: 'make-apps',
                title: this.shareInfo.title,
                description: this.shareInfo.description,
                files: {
                    attachment: attachment,
                    cover: cover,
                    workspace_info: workspaceInfo
                }
            }).then((res) => {
                if (res.status == 200) {
                    this.set('shareInfo.page', 2);
                    this.set('shareInfo.id', res.body.item.id);
                } else {
                    this.set('shareInfo.page', 3);
                }
            });
        }
        /**
         * Opens the sharing modal and share the app
         */
        share (e) {
            let modal = this.$['share-modal'],
                shareInfo = {
                    image: e.detail.cover,
                    workspaceInfo: e.detail.workspaceInfo,
                    page: 0,
                    title: '',
                    description: '',
                    id: null
                };

            this.set('shareInfo', shareInfo);
            modal.open();
        }
        confirmShare () {
            this.set('shareInfo.page', 1);
            this.shareApp();
        }
        dismissShare () {
            let modal = this.$['share-modal'];
            modal.close();
        }
        uiAddedParts () {
            return this.addedParts.filter((part) => {
                return part.partType === 'ui';
            });
        }
        /**
         * When the current code changes, save it in the components store
         * @param  {Event} e  Informations about the code updated
         */
        codeChanged (e) {
            let data = e.detail;
            // Add the new code and its rule to the components store
            app.components.setCode(data.id, data.emitter, data.event, data.code);
        }
        detached () {
            window.removeEventListener('resize', this.updateWorkspaceRect.bind(this));
        }
        runningChanged () {
            if (this.running) {
                app.components.run(this.addedParts, this.codes);
            } else {
                app.components.stop(this.addedParts, this.codes);
            }
        }
    }
    Polymer(KanoViewWorkshop);
</script>
