<link rel="import" href="../../bower_components/web-components/kano-alert/kano-alert.html">

<link rel="import" href="../../scripts/kano/make-apps/store.html">
<link rel="import" href="../../scripts/kano/make-apps/actions/app.html">

<link rel="import" href="../../scripts/kano/make-apps/mode/mode.html">
<link rel="import" href="../../scripts/kano/make-apps/hardware-api.html">
<link rel="import" href="../../scripts/kano/make-apps/utils.html">
<link rel="import" href="../../scripts/kano/make-apps/parts/parts.html">
<link rel="import" href="../../scripts/kano/util/router.html">
<link rel="import" href="../../scripts/kano/make-apps/blockly/blockly.html">
<link rel="import" href="../../scripts/kano/app-modules/index.html">
<link rel="import" href="../../scripts/kano/make-apps/sdk.html">
<link rel="import" href="../../elements/behaviors/kano-i18n-behavior.html">
<link rel="import" href="../../elements/kano-app-editor/kano-app-editor.html">
<link rel="import" href="../../elements/kano-share-modal/kano-share-modal.html">
<link rel="import" href="../../elements/kano-editor-topbar/kano-editor-topbar.html">
<link rel="import" href="../../elements/behaviors/kano-view-drop-file-behavior.html">
<link rel="import" href="../../elements/behaviors/kano-sharing-behavior.html">
<link rel="import" href="../../bower_components/web-components/kano-reward-modal/kano-reward-modal.html">

<script src="../../scripts/kano/vm.js"></script>

<dom-module id="kano-view-editor">
    <style>
        :host {
            display: block;
            @apply(--layout-vertical);
        }
        :host kano-app-editor {
            @apply(--layout-flex);
        }
        :host #error-dialog .title {
            color: red;
        }
        :host #error-dialog .description {
            text-align: center;
        }
        paper-dialog {
            border-radius: 5px;
            overflow: hidden;
            background: transparent;
        }
        paper-dialog#share-modal kano-share-modal {
            padding: 0px;
            margin: 0px;
        }
        :host(.dragging) * {
            pointer-events: none;
        }
        .dragoverlay {
            @apply(--layout-vertical);
            @apply(--layout-center);
            @apply(--layout-center-justified);
            position: fixed;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            display: none;
            background-color: rgba(255, 255, 255, 0.75);
            box-sizing: border-box;
            overflow: hidden;
            text-align: center;
        }
        .dragoverlay * {
            pointer-events: none;
        }
        #overlay-character {
            transform-origin: center bottom;
        }
        #overlay-text {
            opacity: 0;
            font-size: 32px;
            font-weight: 400;
        }
    </style>
    <template>
        <!-- <kano-app-editor
            id="editor"
            running="{{running}}"
            parts="{{parts}}"
            code="{{code}}"
            added-parts="{{addedParts}}"
            default-categories="[[defaultCategories]]"
            mode="[[mode]]"
            remix-mode="[[remixMode]]"
            unsaved-changes="{{showSavePrompt}}"
            on-share="share"
            on-exit="_exit"
            show-share-button>
        </kano-app-editor> -->
        <kano-alert id="save-prompt"
                    heading="[[localize('DO_YOU_SAVE', 'Do you want to save your creation?')]]"
                    text="[[localize('ABOUT_TO_RESET', 'You\'ll lose any unsaved changes')]]"
                    entry-animation="from-big-animation"
                    with-backdrop>
                <button class="kano-alert-primary" on-tap="_launchShare" dialog-confirm slot="actions">[[localize('SAVE_IT', 'Save it!')]]</button>
                <button class="kano-alert-secondary" on-tap="_confirmExit" dialog-dismiss slot="actions">[[localize('NO_THANKS', 'No\, thanks')]]</button>
                <button class="kano-alert-secondary" dialog-dismiss slot="actions">[[localize('CANCEL', 'Cancel')]]</button>
        </kano-alert>
        <kano-alert opened="[[remixLoadingAlertOpened]]"
                    heading="[[localize('LOADING_REMIX', 'Loading creation for remixing')]]"
                    text="[[localize('PLEASE_WAIT', 'Please wait...')]]"
                    modal>
        </kano-alert>
        <paper-dialog id="error-dialog" with-backdrop>
            <h2 class="title">{{error.title}}</h2>
            <p class="description">{{error.description}}</p>
        </paper-dialog>
        <paper-dialog id="share-modal" opened="{{shareOpened}}" modal>
            <kano-share-modal id="share-modal-content"
                              on-confirm="confirmShare"
                              on-dismiss="dismissShare"
                              opened="[[shareOpened]]"
                              share-info="{{shareInfo}}"
                              world-url="[[config.WORLD_URL]]"
                              is-authenticated="[[user]]"></kano-share-modal>
        </paper-dialog>
        <div class="dragoverlay" id="dropoverlay">
            <p id="overlay-text">Drop a file here to load the app</p>
            <iron-image
                id="overlay-character"
                src="/assets/stories/background_color/color-character.png"
                preload
                sizing="contain"
                width="300"
                height="400"></iron-image>
        </div>
        <kano-reward-modal id="reward-modal" on-second-action="_openSignup"></kano-reward-modal>
    </template>
</dom-module>

<script type="text/javascript">
    /* globals Polymer, Kano */
    Polymer({
        is: 'kano-view-editor',
        behaviors: [
            Kano.Behaviors.SharingBehavior,
            Kano.Behaviors.ViewDropFileBehavior,
            Kano.Behaviors.I18nBehavior,
            Kano.MakeApps.Store.ReceiverBehavior,
        ],
        properties: {
            context: Object,
            addedParts: {
                type: Array,
                value: () => {
                    return [];
                }
            },
            code: {
                type: Object,
                value: () => {
                    return {};
                }
            },
            usedBlocks: {
                type: Object
            },
            remixMode: {
                type: Boolean,
                value: false
            },
            error: {
                type: Object,
                value: {
                    title: '',
                    description: ''
                },
                notify: true
            },
            showSavePrompt: {
                type: Boolean,
                value: false,
                notify: true
            },
            app: {
                type: Object,
                linkState: 'editor.app',
                observer: '_appChanged'
            },
            remixLoadingAlertOpened: {
                type: Boolean,
                linkState: 'editor.remixLoadingAlertOpened',
            }
        },
        observers: [
            '_setupHardwareParts(addedParts.splices)',
            '_setupHardwareParts(hardwareAPI)',
            '_pauseApp(shareOpened)'
        ],
        listeners: {
            'parts-changed': '_partsChanged',
            'share-successful': '_deactivateSavePrompt',
            'share-attempted': '_deactivateSavePrompt'
        },
        ready () {
            const { config } = this.getState();
            this.modal = this.$['share-modal'];

            this.hardwareAPI = new Kano.MakeApps.HardwareAPI(config);
            this.hardwareAPI.on('new-part-request', (e) => {
                this.fire('iron-signal', { name: 'new-part-request', data: e.detail });
            });

            Kano.MakeApps.Mode.init(config);
            Kano.MakeApps.Blockly.init(config);
            Kano.AppModules.init(Object.assign({
                hardwareAPI: this.hardwareAPI,
                restartCodeHandler: () => {
                    this.$.editor.resetAppState();
                }
            }, config));
        },
        loadRemix(slug) {
            this.dispatch({ type: 'LOAD_REMIX' });
            this.remixMode = true;
            const { config } = this.getState();
            const sdk = new Kano.MakeApps.SDK(config);
            //loading component for remixing, we need to get data from the slug
            return sdk.getShareBySlug(slug)
                .then(res => {
                    //getting the workspace info from the share
                    if (res.item.workspace_info_url) {
                        return fetch(res.item.workspace_info_url)
                    }
                    throw new Error('Missing workspace information in share');
                })
                .then(r => r.json())
                .then((share) => {
                    this.dispatch({ type: 'REMIX_LOADED' });
                    return share;               
                })
                .catch(err => {
                    console.error('loading failed', err);
                    this.set('error.title', 'Loading failed');
                    this.set('error.description', 'Couldn\'t load share');
                    this.$['error-dialog'].open();
                });
        },
        attached() {
            const slug = this.context.params.slug;
            let p;
            let app;
            if (slug) {
                p = this.loadRemix(slug).then(share => {
                    app = share;
                    return this.loadMode(share.mode);
                });
            } else {
                const modeId = this._getMode(this.context);
                p = this.loadMode(modeId);
                app = JSON.parse(localStorage.getItem(`savedApp-${modeId}`));
            }
            const { config } = this.getState();
            this.editor = new Kano.Code.Editor(config);
            p.then((mode) => {
                this.editor.setMode(mode);
                this.setupEditor();
                this.dispatch({ type: 'LOAD_EDITOR_APP', data: app });
            });
        },
        loadMode(id) {
            const mode = Kano.MakeApps.Mode.modes[id];
            return Kano.Code.Mode.load(mode)
                .then(() => mode);
        },
        setupEditor () {
            const { config } = this.getState();
            Kano.MakeApps.Parts.init(config);
            Kano.MakeApps.Blockly.register(window.Blockly);
            this.editor.setToolbox(Kano.MakeApps.Blockly.categories);
            this.editor.on('share', (shareInfo) => this.share({ detail: shareInfo }));
            this.editor.on('exit', () => this._exit());
            this.editor.on('change', () => this.save());
            this.editor.on('running-state-changed', () => {
                if (!this.modeReady) {
                    return;
                }
                const running = this.editor.getRunningState();
                this.debounce('runningChanged', () => {
                    if (running) {
                        if (!this.mode) {
                            return;
                        }
                        Kano.AppModules.stop();
                        
                        // Get the parts elements from the workspace
                        const parts = this.editor.getWorkspace().getPartsDict();
                        // Tell AppModules where to find the parts
                        Kano.AppModules.loadParts(parts);
                        const code = this.editor.getCode();
                        // Generate the code
                        const appCode = Kano.AppModules.createAppCode('AppModules', code);
                        // Start all the modules. Will also trigger the `start` event from `global`
                        Kano.AppModules.start();
                        // Prepare a sandbox exposing AppModules
                        const vm = new Kano.VM({ AppModules: Kano.AppModules });
                        // Run the code
                        vm.runInContext(appCode);

                    } else {
                        Kano.AppModules.stop();
                    }
                });
            });
            this.editor.setRunningState(true);
            this.editor.inject(this.root, this.root.firstChild);
        },
        _appChanged () {
            if (!this.app) {
                return;
            }
            Kano.MakeApps.Parts.clear();
            this.editor.setParts(Kano.MakeApps.Parts.list);
            this.editor.load(this.app, Kano.MakeApps.Parts.list);
        },
        _pauseApp(modalOpen) {
            if (!this.editor) {
                return;
            }
            if (modalOpen) {
                this._wasRunning = this.editor.getRunningState();
                this.editor.setRunningState(false);
            } else {
                this.editor.setRunningState(this._wasRunning);
                this._wasRunning = undefined;
            }
        },
        _animateDragEnter () {
            let overlay = this.$['dropoverlay'],
                character = this.$['overlay-character'],
                text = this.$['overlay-text'];

            overlay.style.display = 'flex';
            overlay.animate([{
                opacity: 0
            }, {
                opacity: 1
            }], {
                duration: 300,
                fill: 'forwards',
                easing: 'ease-in-out'
            });

            character.style.transformOrigin = 'center bottom';

            character.animate([{
                transform: 'translateY(100%) rotate(4deg)'
            },{
                transform: 'translateY(0%) rotate(0deg)'
            }], {
                duration: 400,
                fill: 'forwards',
                easing: 'cubic-bezier(0.68, -0.55, 0.265, 1.55)'
            });

            text.animate([{
                transform: 'translateY(100%)',
                opacity: 0
            },{
                transform: 'translateY(0%)',
                opacity: 1
            }], {
                duration: 400,
                delay: 600,
                easing: 'ease-out',
                fill: 'forwards'
            });
        },
        _animateDragLeave () {
            let overlay = this.$['dropoverlay'],
                character = this.$['overlay-character'],
                text = this.$['overlay-text'],
                fadeOutConfig;

            fadeOutConfig = [[{
                opacity: 1
            },{
                opacity: 0
            }], {
                duration: 400,
                easing: 'ease-out',
                fill: 'forwards'
            }];

            text.animate.apply(text, fadeOutConfig);
            overlay.animate.apply(overlay, fadeOutConfig).onfinish = () => {
                overlay.style.display = 'none';
            };

            return character.animate([{
                transform: 'translateY(0%)'
            },{
                transform: 'translateY(100%)'
            }], {
                duration: 400,
                easing: 'cubic-bezier(0.68, -0.55, 0.265, 1.55)'
            }).finished;

        },
        _animateDrop () {
            let overlay = this.$['dropoverlay'],
                character = this.$['overlay-character'],
                text = this.$['overlay-text'],
                fadeOutConfig;

            fadeOutConfig = [[{
                opacity: 1
            },{
                opacity: 0
            }], {
                duration: 400,
                fill: 'forwards',
                easing: 'ease-out'
            }];

            text.animate.apply(text, fadeOutConfig);
            overlay.animate.apply(overlay, fadeOutConfig).onfinish = () => {
                overlay.style.display = 'none';
            };

            character.style.transformOrigin = 'center center';

            return character.animate([{
                transform: 'scale(1, 1)'
            },{
                transform: 'scale(0, 0)'
            }], {
                duration: 400,
                easing: 'cubic-bezier(0.6, -0.28, 0.735, 0.045)'
            }).finished;

        },
        _onFileDropped (contents) {
            let app;
            try {
                app = JSON.parse(contents);
            } catch (e) {
                app = null;
            }
            this.dispatch({ type: 'LOAD_EDITOR_APP', data: app });
        },
        _getMode (context) {
            var modeFromQs = Kano.Util.Router.parseQsParam(this.context.querystring, 'mode');
            return modeFromQs ? modeFromQs : 'normal';
        },
        _setupHardwareParts () {
            if (this.hardwareAPI) {
                this.hardwareAPI.setParts(this.addedParts);
            }
        },
        _partsChanged () {
            this.debounce('parts-changed', () => {
                if (this.hardwareAPI) {
                    this.hardwareAPI.requestDeviceUpdate();
                }
            }, 300);
        },
        save () {
            // Save after 3secs without changes
            if (!this.remixMode) {
                this.debounce('save', () => {
                    const savedApp = this.editor.save();
                    const { id } = this.editor.getMode();
                    localStorage.setItem(`savedApp-${id}`, JSON.stringify(savedApp));
                }, 3000);
            }
        },
        _activateSavePrompt () {
            this.showSavePrompt = true;
        },
        _deactivateSavePrompt () {
            this.showSavePrompt = false;
        },
        _confirmExit () {
            this.fire('exit-confirmed');
            this.fire('tracking-event', {
                name: 'ide_exit_confirmed'
            });
        },
        _launchShare () {
            this.editor.share();
        },
        _exit () {
            if (this.showSavePrompt) {
                this.$['save-prompt'].open();
                this.fire('tracking-event', {
                    name: 'save_prompt_opened'
                });
            } else {
                this.fire('exit-confirmed');
            }
        },
        _openSignup () {
            this.fire('signup');
        }
    });
</script>
