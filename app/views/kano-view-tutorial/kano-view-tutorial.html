<link rel="import" href="../../scripts/kano/make-apps/mode/mode.html">
<link rel="import" href="../../scripts/kano/make-apps/hardware-api.html">
<link rel="import" href="../../scripts/kano/make-apps/parts/parts.html">
<link rel="import" href="../../scripts/kano/util/router.html">
<link rel="import" href="../../scripts/kano/make-apps/blockly/blockly.html">
<link rel="import" href="../../scripts/kano/make-apps/challenge.html">
<link rel="import" href="../../scripts/kano/app-modules/index.html">
<link rel="import" href="../../elements/kano-app-editor/kano-app-editor.html">
<link rel="import" href="../../elements/kano-story-scene/kano-story-scene.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../elements/behaviors/kano-editor-view-behavior.html">
<link rel="import" href="../../elements/behaviors/kano-modal-animator-behavior.html">

<link rel="import" href="../../scripts/kano/make-apps/sdk.html">

<dom-module id="kano-view-tutorial">
    <style>
        :host {
            position: relative;
            @apply --layout-vertical;
            @apply --font-body;
        }
        :host kano-story-scene {
            @apply --layout-flex;
        }
        :host paper-dialog {
            border-radius: 5px;
        }
        :host kano-scene-editor {
            height: 100%;
        }
        :host button {
            @apply --kano-button;
            background-color: var(--color-green);
        }
        :host button[disabled] {
            color: #bbb;
            background-color: var(--color-grey);
        }
        :host *[hidden] {
            display: none !important;
        }
        :host .start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            background: rgba(0, 0, 0, 0.5);

            @apply --layout-vertical;
        }
        :host .start-overlay.hidden {
            display: none;
        }
        :host .start-overlay .wrapper {
            margin: auto;
            border-radius: 5px;
            background: #ffffff;
            padding: 20px;
            @apply --layout-center-justified;
            @apply --layout-center;
        }
        :host #drop-target {
            background-color: #ccc;
            border-radius: 5px;
            height: 100px;
            text-align: center;

            @apply --layout-center-justified;
            @apply --layout-center;
            @apply --layout-vertical;
        }
        :host #drop-target.active {
            background-color: #888;
        }
        :host .start-overlay .buttons {
            margin-top: 20px;
        }
    </style>
    <template>
        <template is="dom-if" if="[[loaded]]" on-dom-change="_editorDomChanged">
            <kano-scene-editor id="editor"
                               scene="[[scene]]"
                               story-name="[[fileName]]"
                               on-scene-done="_showEndModal"
                               added-parts="{{addedParts}}"></kano-scene-editor>
        </template>
        <div class$="start-overlay {{_computeOverlayClass(testing)}}">
            <div class="wrapper">
                <div id="drop-target"
                     on-dragover="_dragOver"
                     on-drop="_drop"
                     on-dragenter="_dragEnter"
                     on-dragleave="_dragLeave"
                     class$="{{_computeDropTargetClass(dragging)}}">
                    {{fileName}}
                </div>
                <div class="buttons">
                    <button class="test-button" on-tap="_startChallenge" disabled$="{{!file}}">Test Challenge</button>
                    <button class="download-button" on-tap="_downloadSteps" disabled$="{{!file}}">Download steps.json</button>
                </div>
            </div>
        </div>
        <paper-dialog class="challenge-modal" id="end-modal" modal>
          <h2>Well that's it!</h2>
          <div class="buttons">
              <button class="start-button" dialog-confirm>Got it</button>
          </div>
        </paper-dialog>
    </template>
</dom-module>

<script>
    /* globals Polymer, Kano, page */
    Polymer({
        is: 'kano-view-tutorial',
        behaviors: [
            Kano.Behaviors.ModalAnimatorBehavior,
            Kano.Behaviors.EditorViewBehavior
        ],
        properties: {
            app: {
                type: Object
            },
            file: {
                type: String,
                value: null,
                observer: '_fileChanged'
            },
            fileName: {
                type: String,
                value: 'Drop your .kcode file here'
            },
            dragging: {
                type: Boolean,
                value: false
            },
            testing: {
                type: Boolean,
                value: false
            },
            addedParts: {
                type: Array,
                observer: '_addedPartsChanged'
            }
        },
        ready () {
            this.hardwareAPI = new Kano.MakeApps.HardwareAPI(Kano.MakeApps.config);

            Kano.AppModules.init(Object.assign({ hardwareAPI }, Kano.MakeApps.config));

            Kano.MakeApps.Parts.init(Kano.MakeApps.config);
            Kano.MakeApps.Blockly.init(Kano.MakeApps.config);
            Kano.MakeApps.Mode.init(Kano.MakeApps.config);

            this.configureModal(this.$['end-modal'], 'scale-down');
            this.configureModal(this.$['end-modal'], 'fade-out');
        },
        attached () {
            this.loaded = false;

            window.dumpChallenge = () => {
                return this.dumpChallenge();
            };
        },
        _addedPartsChanged () {
            this.hardwareAPI.setParts(this.addedParts);
        },
        dumpChallenge () {
            return JSON.stringify(this.challenge, null, '    ');
        },
        dumpSteps () {
            return JSON.stringify(this.challenge.data, null, '    ');
        },
        _downloadSteps () {
            let a = window.document.createElement('a');
            a.href = window.URL.createObjectURL(new Blob([this.dumpSteps()], {type: 'application/json'}));
            a.download = 'steps.json';

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        },
        _dragOver (e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
        },
        _drop (e) {
            let file;

            e.preventDefault();
            e.stopPropagation();

            file = e.dataTransfer.files[0];
            if (file) {
                this._readFile(file).then(content => {
                    this.fileName = file.name;
                    this.file = content;
                });
            }

            this._dragLeave();
        },
        _readFile (f) {
            return new Promise((resolve, reject) => {
                var reader = new FileReader();

                reader.onload = () => {
                    resolve(reader.result);
                };

                reader.onerror = reject;

                reader.readAsText(f);
            });
        },
        _dragEnter () {
            this.dragging = true;
        },
        _dragLeave () {
            this.dragging = false;
        },
        _computeDropTargetClass (dragging) {
            return dragging ? 'active' : '';
        },
        _computeOverlayClass (testing) {
            return testing ? 'hidden' : '';
        },
        _fileChanged (contents) {
            if (contents) {
                let app = JSON.parse(contents);

                this.mode = Kano.MakeApps.Mode.modes[app.mode];

                this.challenge = Kano.MakeApps.Challenge.createFromApp(app);
                this.scene = Object.assign({}, this.challenge.data);
                this.loaded = true;
            }
        },
        _startChallenge () {
            this.set('scene.started', true);
            this.testing = true;
        },
        _showEndModal () {
            this.$['end-modal'].open();
        },
        _editorDomChanged () {
            let editor = this.$$('#editor');
            if (editor) {
                editor.animate([{
                    opacity: 0
                },{
                    opacity: 1
                }], {
                    duration: 500,
                    easing: 'ease-out'
                });
            }
        }
    });
</script>
