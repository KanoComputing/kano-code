<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../scripts/kano/make-apps/hardware-api.html">
<link rel="import" href="../kano-app-player-toolbar/kano-app-player-toolbar.html">
<dom-module id="kano-app-player">
    <style>
        :host {
          display: flex;
          align-items: center;
          @apply(--layout-vertical-reverse);
        }
        :host .user-app {
            @apply(--layout-flex);
            @apply(--layout-self-stretch);
            height: 100%;
        }

        :host(.fullscreen) {
            position: fixed;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            z-index: 100;
            background-color: rgba(0, 0, 0, 0.8);
        }

        :host(.fullscreen) .user-app {
            width: 90%;
            height: 90%;
            margin: auto;
        }

        #container {
            @apply(--layout-vertical);
            @apply(--layout-flex);
            @apply(--layout-center);
            @apply(--layout-center-justified);
            position: relative;
            height: calc(100% - 40px);
        }
        h1.error {
            color: var(--color-red, red);
        }
        kano-app-player-toolbar {
            width: 100%;
        }
    </style>
    <template>
        <div id="container">
            <template is="dom-if" if="{{failed}}">
                <h1 class="error">Something went wrong :(</h1>
                <div>The app just won't run, will it?</div>
            </template>
        </div>
        <template is="dom-if" if="{{showToolbar}}">
            <kano-app-player-toolbar running="[[running]]"
                                     on-run-button-clicked="_toggleRunning"
                                     on-reset-button-clicked="_reset"
                                     on-fullscreen-button-clicked="_toggleFullscreen"></kano-app-player-toolbar>
        </template>
    </template>
    <script type="text/javascript">
        Polymer({
            is: 'kano-app-player',
            properties: {
                src: {
                    type: String,
                    observer: '_srcChanged'
                },
                slug: {
                    type: String
                },
                failed: {
                    type: Boolean,
                    value:false
                },
                showToolbar: {
                    type: Boolean,
                    value: false
                },
                running: {
                    type: Boolean,
                    value: false
                }
            },
            _srcChanged () {
                // Check that we are loading and html file. Bsing that on the extension is not the best solution
                // as any server coulde return html content. This prevents loading of late setups bindings. For
                // exanple, Vue.js will set the property to {{item.attachment_url}} a few times before applying the binding

                if (!this.src || !/(.*\.html)|(data:text\/html;base64,.*)/.test(this.src)) {
                    return;
                }
                this.debounce('importApp', () => {
                    this.importHref(this.src, this._onAppFileLoad.bind(this), this._onAppFileError.bind(this));
                });
            },
            _onAppFileLoad () {
                let root = Polymer.dom(this.root),
                    c;
                // Create the component. Older shares were generated with the tagName `kano-user-component`
                try {
                    c = this.create(`kano-${this.slug}`);
                    if (c.constructor === HTMLElement) {
                        throw new Error('Element not registered');
                    }
                } catch (e) {
                    c = this.create('kano-user-component');
                }
                c.className = 'user-app kano-app-player';
                // Support apps exported with error
                c.$$ = function (id) {
                    if (['#light', '#camera', '#normal', '#dropzone'].indexOf(id) !== -1 && this.$.screen) {
                        return this.$.screen;
                    }
                    return Polymer.dom(this.root).querySelector(id);
                };
                root.appendChild(c);
                if (this.$.container) {
                    root.removeChild(this.$.container);
                    this.$.container = null;
                }
                if (this.component) {
                    root.removeChild(this.component);
                }
                this.component = c;
                this.fire('app-ready');
                this.async(() => {
                    this.component.$$('kano-ui-viewport').resizeView();
                });

                this.running = true;
                this.fullscreen = false;
            },
            _onAppFileError (e) {
                this.failed = true;
            },
            start () {
                if (this.component.start) {
                    this.component.start();
                } else {
                    // For compatibility with old shares
                    this.component.attached();
                }
                this.running = true;
            },
            stop () {
                this.running = false;
                this.component.stop();
            },
            getWorkspace () {
                return this.component.workspace;
            },
            _toggleRunning () {
                if (this.running) {
                    this.stop();
                } else {
                    this.start();
                }
            },
            _reset () {
                this.stop();

                setTimeout(this.start.bind(this), 0);
            },
            _toggleFullscreen () {
                this.toggleClass('fullscreen');
                this.component.$$('kano-ui-viewport').resizeView();
                this.fullscreen = !this.fullscreen;
            }
        });
    </script>
</dom-module>
