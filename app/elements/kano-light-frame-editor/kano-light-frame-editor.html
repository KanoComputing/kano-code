<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../scripts/kano/make-apps/parts-api/light-animation.html">
<link rel="import" href="../kano-part-editor-topbar/kano-part-editor-topbar.html">
<link rel="import" href="../kano-light-frame-editor-panel/kano-light-frame-editor-panel.html">
<link rel="import" href="../kano-pixel-canvas/kano-pixel-canvas.html">
<dom-module id="kano-light-frame-editor">
    <style>
        .settings {
            @apply --layout-vertical;
            @apply --layout-flex-auto;
        }
        .settings-controls {
            @apply --layout-flex-auto;
            @apply --layout-vertical;
        }
        .settings-controls>* {
            margin-bottom: 18px;
        }
        kano-pixel-canvas {
            @apply --layout-flex-auto;
            cursor: none;
            --kano-pixel-editor-background: var(--color-dark);
        }
    </style>
    <template>
        <kano-part-editor-topbar icon="light-frame" label="[[element.label]]" theme="[[theme]]"></kano-part-editor-topbar>
        <kano-light-frame-editor-panel bitmap="{{selected.userProperties.bitmap}}"
                                       width="{{selected.userProperties.width}}"
                                       height="{{selected.userProperties.height}}"
                                       pen-color="{{penColor}}"
                                       pen-type="{{penType}}">
        <div slot="canvas" class="canvas">
            <kano-pixel-canvas id="canvas"
                               bitmap="{{selected.userProperties.bitmap}}"
                               width="[[selected.userProperties.width]]"
                               height="[[selected.userProperties.height]]"
                               pixel-size="22"
                               spacing="1"
                               pen-color="[[penColor]]"
                               pen-type="[[penType]]"></kano-pixel-canvas>
        </div>
        <div slot="settings" class="settings">
            <div class="settings-controls">
                <kano-input-text value="{{selected.name}}"
                                 theme="[[theme]]"></kano-input-text>
                <kano-input-range id="width-slider"
                                  class="slider"
                                  value="{{selected.userProperties.width}}"
                                  label="Width"
                                  min="1"
                                  max="16"
                                  theme="[[theme]]"></kano-input-range>
                <kano-input-range id="height-slider"
                                  class="slider"
                                  value="{{selected.userProperties.height}}"
                                  label="Height"
                                  min="1"
                                  max="8"
                                  theme="[[theme]]"></kano-input-range>
            </div>
        </div>
        </kano-light-frame-editor-panel>
    </template>
    <script type="text/javascript">
        Polymer({
            is: 'kano-light-frame-editor',
            behaviors: [
                Kano.MakeApps.PartsAPI['light-frame']
            ],
            properties: {
                selected: {
                    type: Object,
                    notify: true
                },
                theme: {
                    type: String,
                    value: "#00d9c7"
                },
                penColor: String,
                penType: String
            },
            observers: [
                '_renderOnRealDevice(selected.userProperties.bitmap)'
            ],
            attached () {
                this.BOARD_WIDTH = 16;
                this.BOARD_HEIGHT = 8;
            },
            detached () {
                this.appModule.stop();
            },
            _renderOnRealDevice () {
                if (!this.deviceRenders) {
                    const hw = Kano.AppModules.modules.lightboard.api;
                    this.appModule = Kano.AppModules.createStandalone();
                    this.appModule.config(Object.assign({}, Kano.MakeApps.config, { hardwareAPI: hw }));
                    this.appModule.start();
                    this.deviceRenders = true;
                }

                try {
                    this.async(()=> this.appModule.getModule('lightboard').updateOrCreateShape('drawing', this.getShape(), () => {}));
                }
                catch (e) {
                   return;
                }
            },
            getShape () {
                this.model = this.selected;
                return {
                    id: 'being-edited',
                    x: this.getX(),
                    y: this.getY(),
                    width: this.getWidth(),
                    height: this.getHeight(),
                    visible: true,
                    bitmap: this.selected.userProperties.bitmap,
                    type: 'frame'
                };
            }
        });
    </script>
</dom-module>
