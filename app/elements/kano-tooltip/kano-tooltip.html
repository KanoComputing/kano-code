<link rel="import" href="../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../bower_components/web-components/kano-style/button.html">
<link rel="import" href="../behaviors/kano-animatable-behavior.html">
<script src="../../scripts/util/dom.js"></script>
<dom-module id="kano-tooltip">
    <style>
    :host {
        display: inline-block;
        position: fixed;
        z-index: 1;
        visibility: hidden;
        text-align: center;
        --kano-tooltip-border-width: 0px;
        --kano-tooltip-border-color: transparent;
    }
    :host([position="top"]) {
        transform-origin: 50% 100%;
    }
    :host([position="bottom"]) {
        transform-origin: 50% 0%;
    }
    :host([position="left"]) {
        transform-origin: 100% 50%;
    }
    :host([position="right"]) {
        transform-origin: 0% 50%;
    }
    :host .tooltip {
        position: relative;
        @apply(--shadow-elevation-6dp);
        @apply(--kano-tooltip);
        background-color: var(--kano-tooltip-background-color, white);
        border-radius: 4px;
        border: solid;
        border-color: var(--kano-tooltip-border-color);
        border-width: var(--kano-tooltip-border-width);
    }
    :host.no-animations {
        animation: none;
        transition: none;
    }
    .tooltip:after, .tooltip:before {
        border: solid transparent;
        width: 0px;
        height: 0px;
        position: absolute;
        pointer-events: none;
        content: ' ';
        border-color: transparent;
    }
    :host([position="bottom"]) .tooltip:after,
    :host([position="bottom"]) .tooltip:before {
        bottom: 100%;
        left: 50%;
    }
    :host([position="top"]) .tooltip:after,
    :host([position="top"]) .tooltip:before {
        top: 100%;
        left: 50%;
    }
    :host([position="right"]) .tooltip:after,
    :host([position="right"]) .tooltip:before {
        right: 100%;
        top: 50%;
    }
    :host([position="left"]) .tooltip:after,
    :host([position="left"]) .tooltip:before {
        left: 100%;
        top: 50%;
    }
    :host .tooltip:after {
        border-width: 15px;
    }
    :host([position="bottom"]) .tooltip:after {
        border-bottom-color: var(--kano-tooltip-background-color, white);
        margin-left: -15px;
    }
    :host([position="top"]) .tooltip:after {
        border-top-color: var(--kano-tooltip-background-color, white);
        margin-left: -15px;
    }
    :host([position="right"]) .tooltip:after {
        border-right-color: var(--kano-tooltip-background-color, white);
        margin-top: -15px;
    }
    :host([position="left"]) .tooltip:after {
        border-left-color: var(--kano-tooltip-background-color, white);
        margin-top: -15px;
    }
    :host .tooltip:before {
        border-width: calc(15px + var(--kano-tooltip-border-width));
    }
    :host([position="bottom"]) .tooltip:before {
        border-bottom-color: var(--kano-tooltip-border-color);
        margin-left: calc(-15px - var(--kano-tooltip-border-width));
    }
    :host([position="top"]) .tooltip:before {
        border-top-color: var(--kano-tooltip-border-color);
        margin-left: calc(-15px - var(--kano-tooltip-border-width));
    }
    :host([position="right"]) .tooltip:before {
        border-right-color: var(--kano-tooltip-border-color);
        margin-top: calc(-15px - var(--kano-tooltip-border-width));
    }
    :host([position="left"]) .tooltip:before {
        border-left-color: var(--kano-tooltip-border-color);
        margin-top: calc(-15px - var(--kano-tooltip-border-width));
    }
    :host .tooltip .caret-shadow {
        @apply(--kano-tooltip);
        @apply(--kano-tooltip-caret);
        position: absolute;
        width: 24px;
        height: 24px;
        background-color: transparent;
        transform: rotate(45deg);
        z-index: -1;
        padding: 0px;
    }
    :host([position="bottom"]) .tooltip .caret-shadow {
        bottom: 100%;
        left: 50%;
        margin-left: -12px;
        margin-bottom: -14px;
    }
    :host([position="left"]) .tooltip .caret-shadow {
        top: 50%;
        left: 100%;
        margin-top: -12px;
        margin-left: -14px;
    }
    :host([position="right"]) .tooltip .caret-shadow {
        top: 50%;
        right: 100%;
        margin-top: -12px;
        margin-right: -14px;
    }
    :host([position="top"]) .tooltip .caret-shadow {
        top: 100%;
        left: 50%;
        margin-left: -12px;
        margin-top: -14px;
    }
    :host .wrapper {
        position: relative;
    }

    :host button {
        @apply(--kano-button);
    }
    </style>
    <template>
        <div class$="tooltip [[position]]" id="tooltip">
            <div class="caret-shadow" hidden$="{{caretHidden(position)}}"></div>
            <slot></slot>
        </div>
    </template>
</dom-module>

<script type="text/javascript">
    /* globals Polymer, Kano */
    Polymer({
        is: 'kano-tooltip',
        behaviors: [Kano.Behaviors.AnimatableBehavior],
        properties: {
            position: {
                type: String,
                value: 'top',
                reflectToAttribute: true
            },
            target: {
                type: Object
            },
            trackTarget: {
                type: Boolean,
                value: false
            },
            zIndex: {
                type: Number,
                value: null
            },
            autoClose: {
                type: Boolean,
                value: false
            }
        },
        observers: [
            'updatePosition(target.*, position, zIndex)',
            'setupTargetTracking(target)'
        ],
        attached () {
            let observer = new MutationObserver(() => {
                this.updatePosition();
            });
            observer.observe(this, { childList: true, subtree: true, characterData: true });
            this._onClickEvent = this._onClickEvent.bind(this);
            document.addEventListener('click', this._onClickEvent);
            document.addEventListener('touchend', this._onClickEvent);
        },
        detached () {
            window.removeEventListener('resize', this.updatePosition.bind(this));
            document.removeEventListener('click', this._onClickEvent);
            document.removeEventListener('touchend', this._onClickEvent);

            if (this.targetTracker) {
                clearInterval(this.targetTracker);
            }
        },
        _onClickEvent (e) {
            let target = e.path ? e.path[0] : e.target;
            if (this.autoClose && this.opened) {
                // Go up the dom to check if the event originated from inside the tooltip or not
                while (target !== this && target !== document.body) {
                    target = target.parentNode || target.host;
                }
                if (target !== this) {
                    this.close();
                }
            }

        },
        updatePosition () {
            this.positionWillChange = true;
            this.debounce('updatePosition', () => {
                let target = this.target,
                    tooltip,
                    rect,
                    style,
                    tooltipStyle,
                    widthCenter,
                    heightCenter,
                    tRect;

                if (!target) {
                    return;
                }

                /* See whether the target was a rect or an element */
                if ('left' in target && 'top' in target &&
                    'width' in target && 'height' in target) {
                    tRect = target;
                } else {
                    tRect = target.getBoundingClientRect();
                }

                style = this.style;
                tooltip = this.$.tooltip;
                tooltipStyle = tooltip.style;
                rect = this.getBoundingClientRect();

                widthCenter = tRect.left + (tRect.width / 2) - (rect.width / 2);
                heightCenter = tRect.top + (tRect.height / 2) - (rect.height / 2);

                if (['top', 'bottom'].indexOf(this.position) !== -1) {
                    style.left = `${widthCenter}px`;
                } else if (['right', 'left'].indexOf(this.position) !== -1) {
                    style.top = `${heightCenter}px`;
                } else { /* float */
                    style.top = `${tRect.top + tRect.height * 0.95 - rect.height}px`;
                    style.left = `${widthCenter}px`;
                }

                if (this.position === 'top') {
                    style.top = `${tRect.top - rect.height - 20}px`;
                } else if (this.position === 'bottom') {
                    style.top = `${tRect.bottom + 20}px`;
                } else if (this.position === 'right') {
                    style.left = `${tRect.right + 20}px`;
                } else if (this.position === 'left') {
                    style.left = `${tRect.left - rect.width - 20}px`;
                }

                if (this.zIndex !== null) {
                    style['z-index'] = this.zIndex;
                }

                this.positionWillChange = false;
                this.open();
            }, 10);
        },
        open () {
            // Let an eventual click event triggering the open go the the click handler
            setTimeout(() => {
                let style = this.style;
                // Still recomputing the position, let it finish, it will open automatically at the end
                if (this.positionWillChange) {
                    return;
                }
                style.visibility = 'visible';

                if (this.noAnimations || this.alreadyAnimated) {
                    return;
                }
                this.animate([{
                    opacity: 0,
                    transform: 'scale(0.5)'
                }, {
                    opacity: 1,
                    transform: 'scale(1)'
                }], {
                    easing: 'cubic-bezier(0.2, 0, 0.13, 1.5)',
                    duration: 150,
                    fill: 'forwards'
                });
                this.opened = true;
                this.alreadyAnimated = true;
            });
        },
        close () {
            let style = this.style;

            this.opened = false;

            if (this.noAnimations) {
                return this.onCloseAnimationEnd();
            }
            this.animate([{
                opacity: 1,
                transform: 'scale(1)'
            }, {
                opacity: 0,
                transform: 'scale(0.5)'
            }], {
                easing: 'cubic-bezier(0.2, 0, 0.13, 1.5)',
                duration: 150
            }).onfinish = this.onCloseAnimationEnd.bind(this);
        },
        onCloseAnimationEnd () {
            let style = this.style;
            this.alreadyAnimated = false;
            style.visibility = 'hidden';
        },
        setupTargetTracking () {
            let target = this.target;

            if (!this.trackTarget) {
                return;
            }

            if (this.targetTracker) {
                clearInterval(this.targetTracker);
            }

            if (this.trackTarget && target && 'getBoundingClientRect' in target) {
                this.targetTracker = setInterval(this.updatePosition.bind(this), 1000);
            }
        },
        caretHidden (position) {
            return position === 'float';
        }
    });
</script>
