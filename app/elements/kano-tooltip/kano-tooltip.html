<link rel="import" href="../../bower_components/paper-styles/shadow.html">
<script src="../../scripts/util/dom.js"></script>
<dom-module id="kano-tooltip">
    <style>
    :host {
        display: inline-block;
        position: fixed;
        z-index: 1;
        visibility: hidden;
        font-size: 20px;
        line-height: 38px;
        text-align: center;
        padding: 18px 26px 20px;
    }
    :host[position="top"] {
        transform-origin: 50% 100%;
    }
    :host[position="bottom"] {
        transform-origin: 50% 0%;
    }
    :host[position="left"] {
        transform-origin: 100% 50%;
    }
    :host[position="right"] {
        transform-origin: 0% 50%;
    }
    :host .tooltip {
        @apply(--shadow-elevation-6dp);
        @apply(--kano-tooltip);
        background-color: var(--kano-tooltip-background-color, white);
        border-radius: 4px;
    }
    :host.no-animations {
        animation: none;
        transition: none;
    }
    :host .tooltip .caret:after {
        content: '';
        @apply(--shadow-elevation-6dp);
        @apply(--kano-tooltip);
        @apply(--kano-tooltip-caret);
        position: absolute;
        width: 15px;
        height: 15px;
        background-color: transparent;
        transform: rotate(45deg);
        z-index: -1;
    }
    :host([position="top"]) .tooltip .caret:after {
        top: -19px;
        left: -7px;
    }
    :host([position="left"]) .tooltip .caret:after {
        top: -7px;
        left: -19px;
    }
    :host([position="right"]) .tooltip .caret:after {
        top: -7px;
        left: 5px;
    }
    :host([position="bottom"]) .tooltip .caret:after {
        left: -7px;
        top: 3px;
    }
    :host .tooltip .caret {
        position: absolute;
        border: 10px solid transparent;
    }
    :host .tooltip.top .caret,
    :host .tooltip.bottom .caret {
        margin-left: -10px;
        left: 50%;
    }
    :host .tooltip.right .caret,
    :host .tooltip.left .caret {
        margin-top: -10px;
        top: 50%;
    }
    :host .tooltip.top .caret {
        border-top-color: var(--kano-tooltip-background-color, white);
        top: 100%;
    }
    :host .tooltip.bottom .caret {
        border-bottom-color: var(--kano-tooltip-background-color, white);
        bottom: 100%;
    }
    :host .tooltip.right .caret {
        border-right-color: var(--kano-tooltip-background-color, white);
        left: -20px;
    }
    :host .tooltip.left .caret {
        border-left-color: var(--kano-tooltip-background-color, white);
        left: 100%;
    }
    :host .wrapper {
        position: relative;
    }

    :host button {
        @apply(--kano-button);
    }
    </style>
    <template>
        <div class$="tooltip [[position]]" id="tooltip">
            <content></content>
            <div class="caret"></div>
        </div>
    </template>
</dom-module>

<script type="text/javascript">
    /* globals Polymer, KanoBehaviors */
    class KanoTooltip {

        get behaviors () {
            return [KanoBehaviors.AnimatableBehavior];
        }

        beforeRegister () {
            this.is = 'kano-tooltip';
            this.properties = {
                position: {
                    type: String,
                    value: 'top',
                    reflectToAttribute: true
                },
                target: {
                    type: Object
                }
            };
            this.observers = [
                'updatePosition(target.*, position)'
            ];
        }
        attached () {
            let observer = new MutationObserver(() => {
                this.updatePosition();
            });
            observer.observe(this, { childList: true, subtree: true, characterData: true });
            window.addEventListener('resize', this.updatePosition.bind(this));
        }
        detached () {
            window.removeEventListener('resize', this.updatePosition.bind(this));
        }
        updatePosition () {
            this.debounce('updatePosition', () => {
                let target = this.target,
                tooltip,
                rect,
                style,
                tooltipStyle,
                widthCenter,
                heightCenter;

                if (!target) {
                    return;
                }
                style = this.style;
                tooltip = this.$.tooltip;
                tooltipStyle = tooltip.style;
                rect = tooltip.getBoundingClientRect();

                widthCenter = target.left + (target.width / 2) - (rect.width / 2);
                heightCenter = target.top + (target.height / 2) - (rect.height / 2);

                if (['top', 'bottom'].indexOf(this.position) !== -1) {
                    style.left = `${widthCenter}px`;
                } else {
                    style.top = `${heightCenter}px`;
                }

                if (this.position === 'top') {
                    style.top = `${target.top - rect.height - 20}px`;
                } else if (this.position === 'bottom') {
                    style.top = `${target.bottom + 20}px`;
                } else if (this.position === 'right') {
                    style.left = `${target.right + 20}px`;
                } else if (this.position === 'left') {
                    style.left = `${target.left - rect.width - 20}px`;
                }

                style.visibility = 'visible';

                if (this.noAnimations || this.alreadyAnimated) {
                    return;
                }
                style.transition = 'none';
                style.transform = 'scale(0.5)';
                style.opacity = '0';

                this.getBoundingClientRect();
                style.transition = 'all cubic-bezier(0.2, 0, 0.13, 1.5) 150ms';
                style.transform = 'scale(1)';
                style.opacity = '1';
                this.alreadyAnimated = true;
            }, 10);
        }
        close () {
            let style = this.style;

            if (this.noAnimations) {
                return this.onCloseAnimationEnd();
            }
            this.addEventListener('transitionend', this.onCloseAnimationEnd);

            style.transition = 'none';
            style.transform = 'scale(1)';
            style.opacity = '1';

            this.getBoundingClientRect();
            style.transition = 'all cubic-bezier(0.2, 0, 0.13, 1.5) 150ms';
            style.transform = 'scale(0.5)';
            style.opacity = '0';
        }
        onCloseAnimationEnd () {
            let style = this.style;
            if (!this.noAnimations) {
                this.removeEventListener('transitionend', this.onCloseAnimationEnd);
            }
            this.alreadyAnimated = false;
            style.visibility = 'hidden';
            style.transform = 'scale(1)';
        }
    }
    Polymer(KanoTooltip);
</script>
