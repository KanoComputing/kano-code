<link rel="import" href="../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../behaviors/kano-animatable-behavior.html">
<script src="../../scripts/util/dom.js"></script>
<dom-module id="kano-tooltip">
    <style>
    :host {
        display: inline-block;
        position: fixed;
        z-index: 1;
        visibility: hidden;
        text-align: center;
        --kano-tooltip-border-width: 0px;
        --kano-tooltip-border-color: transparent;
    }
    :host([position="top"]) {
        transform-origin: 50% 100%;
    }
    :host([position="bottom"]) {
        transform-origin: 50% 0%;
    }
    :host([position="left"]) {
        transform-origin: 100% 50%;
    }
    :host([position="right"]) {
        transform-origin: 0% 50%;
    }
    :host .tooltip {
        position: relative;
        @apply(--shadow-elevation-6dp);
        @apply(--kano-tooltip);
        background-color: var(--kano-tooltip-background-color, white);
        border-radius: 4px;
        border: solid;
        border-color: var(--kano-tooltip-border-color);
        border-width: var(--kano-tooltip-border-width);
    }
    :host.no-animations {
        animation: none;
        transition: none;
    }
    .tooltip:after, .tooltip:before {
        border: solid transparent;
        width: 0px;
        height: 0px;
        position: absolute;
        pointer-events: none;
        content: ' ';
        border-color: transparent;
    }
    :host([position="bottom"]) .tooltip:after,
    :host([position="bottom"]) .tooltip:before {
        bottom: 100%;
        left: 50%;
    }
    :host([position="top"]) .tooltip:after,
    :host([position="top"]) .tooltip:before {
        top: 100%;
        left: 50%;
    }
    :host([position="right"]) .tooltip:after,
    :host([position="right"]) .tooltip:before {
        right: 100%;
        top: 50%;
    }
    :host([position="left"]) .tooltip:after,
    :host([position="left"]) .tooltip:before {
        left: 100%;
        top: 50%;
    }
    :host .tooltip:after {
        border-width: 15px;
    }
    :host([position="bottom"]) .tooltip:after {
        border-bottom-color: var(--kano-tooltip-background-color, white);
        margin-left: -15px;
    }
    :host([position="top"]) .tooltip:after {
        border-top-color: var(--kano-tooltip-background-color, white);
        margin-left: -15px;
    }
    :host([position="right"]) .tooltip:after {
        border-right-color: var(--kano-tooltip-background-color, white);
        margin-top: -15px;
    }
    :host([position="left"]) .tooltip:after {
        border-left-color: var(--kano-tooltip-background-color, white);
        margin-top: -15px;
    }
    :host .tooltip:before {
        border-width: calc(15px + var(--kano-tooltip-border-width));
    }
    :host([position="bottom"]) .tooltip:before {
        border-bottom-color: var(--kano-tooltip-border-color);
        margin-left: calc(-15px - var(--kano-tooltip-border-width));
    }
    :host([position="top"]) .tooltip:before {
        border-top-color: var(--kano-tooltip-border-color);
        margin-left: calc(-15px - var(--kano-tooltip-border-width));
    }
    :host([position="right"]) .tooltip:before {
        border-right-color: var(--kano-tooltip-border-color);
        margin-top: calc(-15px - var(--kano-tooltip-border-width));
    }
    :host([position="left"]) .tooltip:before {
        border-left-color: var(--kano-tooltip-border-color);
        margin-top: calc(-15px - var(--kano-tooltip-border-width));
    }
    :host .tooltip .caret-shadow {
        @apply(--kano-tooltip);
        @apply(--kano-tooltip-caret);
        position: absolute;
        width: 24px;
        height: 24px;
        background-color: transparent;
        transform: rotate(45deg);
        z-index: -1;
        padding: 0px;
    }
    :host([position="bottom"]) .tooltip .caret-shadow {
        bottom: 100%;
        left: 50%;
        margin-left: -12px;
        margin-bottom: -14px;
    }
    :host([position="left"]) .tooltip .caret-shadow {
        top: 50%;
        left: 100%;
        margin-top: -12px;
        margin-left: -14px;
    }
    :host([position="right"]) .tooltip .caret-shadow {
        top: 50%;
        right: 100%;
        margin-top: -12px;
        margin-right: -14px;
    }
    :host([position="top"]) .tooltip .caret-shadow {
        top: 100%;
        left: 50%;
        margin-left: -12px;
        margin-top: -14px;
    }
    :host .wrapper {
        position: relative;
    }

    :host button {
        @apply(--kano-button);
    }
    </style>
    <template>
        <div class$="tooltip [[position]]" id="tooltip">
            <div class="caret-shadow"></div>
            <content></content>
        </div>
    </template>
</dom-module>

<script type="text/javascript">
    /* globals Polymer, Kano */
    Polymer({
        is: 'kano-tooltip',
        behaviors: [Kano.Behaviors.AnimatableBehavior],
        properties: {
            position: {
                type: String,
                value: 'top',
                reflectToAttribute: true
            },
            target: {
                type: Object
            },
            trackTarget: {
                type: Boolean,
                value: false
            },
            zIndex: {
                type: Number,
                value: null
            }
        },
        observers: [
            'updatePosition(target.*, position, zIndex)'
        ],
        attached () {
            let observer = new MutationObserver(() => {
                this.updatePosition();
            });
            observer.observe(this, { childList: true, subtree: true, characterData: true });
        },
        detached () {
            window.removeEventListener('resize', this.updatePosition.bind(this));

            if (this.targetTracker) {
                clearInterval(this.targetTracker);
            }
        },
        updatePosition () {
            this.debounce('updatePosition', () => {
                let target = this.target,
                    tooltip,
                    rect,
                    style,
                    tooltipStyle,
                    widthCenter,
                    heightCenter,
                    tRect;

                if (!target) {
                    return;
                }

                /* See whether the target was a rect or an element */
                if ('left' in target && 'top' in target &&
                    'width' in target && 'height' in target) {
                    tRect = target;
                } else {
                    tRect = target.getBoundingClientRect()
                }

                style = this.style;
                tooltip = this.$.tooltip;
                tooltipStyle = tooltip.style;
                rect = tooltip.getBoundingClientRect();

                widthCenter = tRect.left + (tRect.width / 2) - (rect.width / 2);
                heightCenter = tRect.top + (tRect.height / 2) - (rect.height / 2);

                if (['top', 'bottom'].indexOf(this.position) !== -1) {
                    style.left = `${widthCenter}px`;
                } else {
                    style.top = `${heightCenter}px`;
                }

                if (this.position === 'top') {
                    style.top = `${tRect.top - rect.height - 20}px`;
                } else if (this.position === 'bottom') {
                    style.top = `${tRect.bottom + 20}px`;
                } else if (this.position === 'right') {
                    style.left = `${tRect.right + 20}px`;
                } else if (this.position === 'left') {
                    style.left = `${tRect.left - rect.width - 20}px`;
                }

                if (this.zIndex !== null) {
                    style['z-index'] = this.zIndex;
                }

                this.open();
            }, 10);
        },
        open () {
            let style = this.style;
            style.visibility = 'visible';

            if (this.noAnimations || this.alreadyAnimated) {
                return;
            }
            style.transition = 'none';
            style.transform = 'scale(0.5)';
            style.opacity = '0';

            this.getBoundingClientRect();
            style.transition = 'all cubic-bezier(0.2, 0, 0.13, 1.5) 150ms';
            style.transform = 'scale(1)';
            style.opacity = '1';
            this.alreadyAnimated = true;
        },
        close () {
            let style = this.style;

            if (this.noAnimations) {
                return this.onCloseAnimationEnd();
            }
            this.addEventListener('transitionend', this.onCloseAnimationEnd);

            style.transition = 'none';
            style.transform = 'scale(1)';
            style.opacity = '1';

            this.getBoundingClientRect();
            style.transition = 'all cubic-bezier(0.2, 0, 0.13, 1.5) 150ms';
            style.transform = 'scale(0.5)';
            style.opacity = '0';
        },
        onCloseAnimationEnd () {
            let style = this.style;
            if (!this.noAnimations) {
                this.removeEventListener('transitionend', this.onCloseAnimationEnd);
            }
            this.alreadyAnimated = false;
            style.visibility = 'hidden';
            style.transform = 'scale(1)';
        },
        setupTargetTracking () {
            let target = this.target;

            if (this.targetTracker) {
                clearInterval(this.targetTracker);
            }

            if (this.trackTarget && target && 'getBoundingClientRect' in target) {
                this.targetTracker = setInterval(this.updatePosition.bind(this), 1000);
            }
        }
    });
</script>
