<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../behaviors/kano-scene-component-behavior.html">
<link rel="import" href="../behaviors/kano-editor-view-behavior.html">
<link rel="import" href="../kano-power-up-modal/kano-power-up-modal.html">
<link rel="import" href="../kano-app-challenge/kano-app-challenge.html">
<link rel="import" href="../kano-app-editor/kano-app-editor.html">
<link rel="import" href="../kano-challenge-progress/kano-challenge-progress.html">
<dom-module id="kano-scene-editor">
  <style>
    :host {
      display: block;
      @apply(--layout-vertical);
    }
    :host kano-app-challenge {
        @apply(--layout-flex);
    }
    :host kano-app-editor {
        @apply(--layout-flex);
    }
    :host kano-challenge-progress {
        position: absolute;
        top: 20px;
        right: 20px;
    }
  </style>
  <template>
      <kano-app-challenge id="challenge"
                            steps="[[scene.steps]]"
                            on-save="saveApp"
                            on-save-to-storage="saveToStorage"
                            on-load="loadApp"
                            step="{{currentStep}}"
                            started="[[scene.started]]">
          <kano-app-editor id="editor"
                            parts="[[computeParts(scene.*, remix)]]"
                            default-categories="[[computeCategories(scene.*, remix)]]"
                            class="editor"
                            running="{{running}}"
                            title="[[storyName]]"
                            code="{{code}}"
                            mode="[[mode]]"
                            on-blockly-ready="_blocklyReady">
              <kano-challenge-progress id="challenge-progress" progress="[[progress]]" title="[[storyName]]" next-challenge="[[nextStory.id]]" on-share-app="shareApp" remix-mode="[[remix]]"></kano-challenge-progress>
          </kano-app-editor>
      </kano-app-challenge>
      <kano-power-up-modal id="challenge-completed"
                            options="[[extensions]]"
                            app-preview="[[appPreview]]"
                            story-name="[[storyName]]"
                            next-story="[[nextStory]]"
                            on-close="goToRemixChallenge"
                            on-power-up="powerUp"
                            on-share-app="shareApp"></kano-power-up-modal>
      </paper-dialog>
  </template>
</dom-module>
<script type="text/javascript">

    /* globals Polymer, Kano */

    Polymer({
        is: 'kano-scene-editor',
        behaviors: [Kano.Behaviors.EditorViewBehavior, Kano.Behaviors.SceneComponentBehavior],
        properties: {
            storyName: {
                type: String
            },
            nextStory: {
                type: String
            },
            currentStep: {
                type: Number,
                value: 0
            },
            progress: {
                type: Number,
                computed: "computeProgress(currentStep, scene)"
            },
            extensions: {
                type: Array
            }
        },
        observers: [
            'endedChanged(scene.ended)',
            '_sceneChanged(scene)',
            '_sceneStarted(scene.started)'
        ],
        _sceneStarted (started) {
            if (started) {
                this.$['challenge-progress'].animateIn();
            }
        },
        _blocklyReady (scene) {
            this._loadVariables();
        },
        _sceneChanged () {
            this._loadVariables();
        },
        _loadVariables () {
            let workspace = this.$.editor.getBlocklyWorkspace();
            if (this.scene && this.scene.variables && workspace) {
                this.scene.variables.forEach((v) => {
                    Blockly.Variables.addVariable(v, workspace);
                });
            }
        },
        endedChanged () {
            if (this.scene.ended) {
                this.$.editor.generateCover().then((image) => {
                    this.appPreview = image.src;
                    this.$['challenge-completed'].open();
                });
            }
        },
        computeProgress (currentStep, scene) {
            return (currentStep + 1) / scene.steps.length;
        },
        ready () {
            this.remix = false;
            this.code = {};
        },
        attached () {
            this.mode = Kano.MakeApps.Mode.modes[(this.scene.mode || 'normal')];
        },
        shareApp () {
            this.$.editor.share();
        },
        computeParts () {
            if (this.remix) {
                return Kano.MakeApps.Parts.list.filter((part) => {
                    return this.mode.parts.indexOf(part.type) !== -1;
                });
            } else {
                return Kano.MakeApps.Parts.list.filter(part => this.scene.parts.indexOf(part.type) !== -1);
            }
        },
        computeCategories (e) {
            let cats = {};
            if (this.remix) {
                cats = Kano.MakeApps.Blockly.categories;
            } else {
                this.scene.modules.forEach(id => {
                    cats[id] = Kano.MakeApps.Blockly.categories[id];
                });
                cats.events = Kano.MakeApps.Blockly.categories.events;
            }


            return cats;
        },
        saveApp (e) {
            let id = e.detail.id,
                blockIds = e.detail.blockIds,
                stepIds = e.detail.stepIds,
                app = this.$.editor.save(true);
            this.addToStore(id, {
                app,
                blockIds,
                stepIds
            });
        },
        saveToStorage () {
            let app = this.$.editor.save();
            localStorage.setItem('savedApp', JSON.stringify(app));
        },
        loadApp (e) {
            let id = e.detail,
                savedState,
                challenge;
            savedState = this.fromStore(id);
            challenge = this.$.challenge;
            this.$.editor.load(savedState.app, this.computeParts());
            challenge.set('stepIds', savedState.stepIds);
            challenge.set('blockIds', savedState.blockIds);
        },
        goToRemixChallenge () {
            this.remix = true;
        },
        powerUp (e) {
            let extensionId = e.detail.id;
            this.fire('extend-story', extensionId);
            e.stopPropagation();
        }
    });
</script>
