<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<dom-module id="kano-blockly-omnibox">
    <template>
        <style>
            :host {
                display: block;
                border-radius: 4px;
                overflow: hidden;
                @apply(--shadow-elevation-16dp);
                z-index: 0;
                background: #152028;
            }
            input {
                width: 100%;
                color: white;
                font-family: monospace;
                border: 0px;
                padding: 6px 9px;
                font-size: 16px;
                box-sizing: border-box;
                background-color: transparent;
            }
            input:focus {
                outline: none;
                /* Need design for focused input */
            }
            .extra {
                background-color: #0f181e;
                min-height: 30px;
                border-top: 1px solid #1D2930;
            }
            .input-wrapper {
                position: relative;
                background-color: #0f181e;
            }
            .input-wrapper .hint {
                position: absolute;
                top: 0px;
                left: 0px;
                width: 100%;
                height: 100%;
                color: rgba(255, 255, 255, 0.45);
                pointer-events: none;
            }
            .results {
                overflow: auto;
                max-height: 300px;
            }
            .result {
                @apply --layout-horizontal;
                @apply --layout-center;
                border-top: 1px solid #1D2930;
                color: white;
                padding: 6px 10px;
                font-family: monospace;
                cursor: pointer;
            }
            .result:hover {
                background: #37464F;
            }
            .result .label {
                @apply --layout-flex;
            }
            .result .color {
                width: 10px;
                height: 10px;
                border-radius: 2px;
                margin-right: 10px;
            }
        </style>
        <div class="input-wrapper">
            <input id="input" type="text" value="{{query::input}}" on-keydown="_onInputKeydown">
        </div>
        <div class="results">
            <template is="dom-repeat" items="[[results]]" as="result">
                <div class="result" on-tap="_onResultTapped">
                    <div class="color" style$="[[_computeBlockStyle(result)]]"></div>
                    <div class="label">[[_computeBlockLabel(result)]]</div>
                </div>
            </template>
        </div>
        <div class="extra"></div>
    </template>
    <script>
        Polymer({
            is: 'kano-blockly-omnibox',
            properties: {
                query: {
                    type: String,
                    observer: '_queryChanged'
                },
                targetWorkspace: {
                    type: Object
                },
                noDrag: {
                    type: Boolean,
                    value: false
                },
                filter: {
                    type: Function,
                    observer: '_filterChanged'
                }
            },
            attached () {
                this.target = document.body;
            },
            _blockCreated () {
                this.fire('close');
            },
            _filterChanged () {
                this.lookup();
            },
            _queryChanged (query) {
                this.set('hint', '');
                this.debounce('updateResult', () => {
                    this.lookup();
                }, 300);
            },
            lookup () {
                let results = this.targetWorkspace.search(this.query || '');
                if (typeof this.filter === 'function') {
                    results = results.filter(this.filter);
                }
                this.set('results', results);
            },
            _computeBlockLabel (block) {
                return block.toAPIString();
            },
            _computeBlockStyle (result) {
                return `background: ${result.getColour()};`;
            },
            focus () {
                this.$.input.focus();
            },
            clear () {
                this.query = '';
            },
            _onResultTapped (e) {
                let block = e.model.get('result');
                this.fire('confirm', { selected: block });
            },
            _onInputKeydown (e) {
                if (e.keyCode === 13) {
                    this.fire('confirm', { selected: this.results[0] });
                }
            }
        });
    </script>
</dom-module>
