<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../kano-blockly/kano-blockly.html">
<link rel="import" href="../../bower_components/web-components/kano-style/typography.html">

<link rel="import" href="../behaviors/kano-app-editor-behavior.html">
<link rel="import" href="./blocks/set-blocks.html">
<link rel="import" href="../../scripts/kano/make-apps/blockly/minecraft-blockly.html">

<dom-module id="kano-minecraft">
    <template>
        <style>
            :host {
                display: block;
                @apply --layout-vertical;
            }
            kano-blockly {
                @apply --layout-flex;
            }
        </style>
        <kano-blockly id="blockly" toolbox="[[toolbox]]" code="{{code}}" on-change="_onBlockyEvent"></kano-blockly>
    </template>
    <script>
        Polymer({
            is: 'kano-minecraft',
            behaviors: [Kano.Behaviors.AppEditorBehavior],
            properties: {
                code: {
                    type: String,
                    notify: true
                }
            },
            attached () {
                this._onBlocklyReady = this._onBlocklyReady.bind(this);
                this.$.blockly.addEventListener('blockly-ready', this._onBlocklyReady);
            },
            detached () {
                this.$.blockly.removeEventListener('blockly-ready', this._onBlocklyReady);
            },
            _onBlocklyReady () {
                Kano.MakeApps.Blockly.register(Blockly);
                this.toolbox = [{
                    name: 'Minecraft',
                    id: 'minecraft',
                    colour: '#70B046',
                    blocks: [{
                        id: 'minecraft_set_blocks'
                    },{
                        id: 'minecraft_coordinates',
                        shadow: {
                            'X': '<shadow type="math_number"><field name="NUM">0</field></shadow>',
                            'Y': '<shadow type="math_number"><field name="NUM">0</field></shadow>',
                            'Z': '<shadow type="math_number"><field name="NUM">0</field></shadow>'
                        }
                    }]
                }].concat(Object.keys(Kano.MakeApps.Blockly.categories).map(key => Kano.MakeApps.Blockly.categories[key]));
            },
            _onBlockyEvent (e) {
                // Check if a create event follows a close-flyout event. If so, do not notify
                // of the close-flyout event
                if (e.detail.type === 'close-flyout') {
                    // Defer the notification
                    this.closeFlyoutTimeoutId = setTimeout(() => {
                        this.notifyChange('blockly', { event: e.detail });
                    });
                } else {
                    // A create event will cancel its previous close-flyout event
                    if (e.detail.type === 'create') {
                        clearTimeout(this.closeFlyoutTimeoutId);
                    }
                    this.notifyChange('blockly', { event: e.detail });
                }
            },
            getBlocklyWorkspace () {
                return this.$.blockly.getWorkspace();
            }
        });
    </script>
</dom-module>
