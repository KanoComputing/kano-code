<link rel="import" href="../kano-blockly/kano-blockly.html">
<link rel="import" href="../kano-style/kano-style.html">

<dom-module id="kano-ui-editor">
    <style>
    :host {
        display: block;
        @apply(--layout-vertical);
    }
    :host iron-pages {
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    :host .empty {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
    }
    :host .code-editor {
        position: relative;
        @apply(--layout-vertical);
        @apply(--layout-flex);
    }
    :host header {
        position: absolute;
        font-family: bariol;
        font-weight: normal;
        font-size: 1.2em;
        padding: 25px;
        text-align: center;
        top: 0px;
        right: 0px;
        left: 50%;
    }
    :host kano-blockly {
        @apply(--layout-flex);
    }
    </style>
    <template>
        <iron-pages
            id="pages"
            attr-for-selected="name"
            selected="{{selectedPage}}">
            <div name="empty" class="empty">
                <h1>Select an element</h1>
            </div>
            <div name="edit-code" class="code-editor">
                <kano-blockly id="blockly"
                        toolbox="[[toolbox]]"
                        blocks="[[blocks]]"
                        on-change="blocklyChanged"
                        code="{{code}}"></kano-blockly>
                <header>
                    <kano-event-select
                        triggers="{{computeTriggers(uiElements.*)}}"
                        selected-trigger="{{selectedTrigger}}"
                        selected-event="{{event}}"
                        ></kano-event-select>
                </header>
            </div>
        </iron-pages>
    </template>
</dom-module>
<script type="text/javascript">
    class KanoUiEditor {
        beforeRegister () {
            this.is = 'kano-ui-editor';
            this.properties = {
                uiElements: {
                    type: Array,
                    value: () => []
                },
                toolbox: {
                    type: Array,
                    computed: 'computeToolbox(uiElements.*)'
                },
                selectedUi: {
                    type: Object,
                    observer: 'selectedUiChanged'
                },
                event: {
                    type: String
                },
                defaultCategories: {
                    type: Array,
                    value: () => []
                },
                selectedPage: {
                    type: String,
                    computed: 'computeSelectedPage(selectedUi)',
                    value: 'empty'
                },
                selectedTrigger: {
                    type: Object
                },
                code: {
                    type: String,
                    notify: true
                },
                blocks: {
                    type: Object
                }
            };
            this.observers = [
                'computeBlocks(selectedTrigger, event)'
            ];
            this.listeners = {
                'pages.iron-select': 'pageEntered',
                'pages.iron-deselect': 'pageLeaved',
            };
        }
        computeBlocks () {
            if (!this.selectedTrigger) {
                return;
            }
            let code = this.selectedTrigger.codes[this.event];
            if (!code) {
                this.$.blockly.clearWorkspace();
                return;
            }
            // Compute blocks is an observer that will react to changes on
            // two properties that can be changed at the same time.
            // To avoid duplicate call of this function, we debounce it
            this.debounce('computeBlocks', () => {
                this.set('blocks', code.blocks);
            }, 10);
        }
        blocklyChanged () {
            this.saveCode(this.selectedTrigger, this.event);
        }
        selectedTriggerChanged (newValue, oldValue) {
            if (oldValue) {
                this.saveCode(oldValue, this.event);
            }
        }
        saveCode (trigger, event) {
            this.debounce('saveCode', () => {
                let code = {},
                label;
                code.blocks = this.$.blockly.getBlocks();
                label = this.getEventFromId(trigger.events, event).label;
                code.rule = {
                    trigger: `When ${trigger.name} ${label}`,
                    action: this.$.blockly.getCode('Natural')
                };
                code.code = this.$.blockly.getCode('JavaScript');
                this.fire('code-change', {
                    id: trigger.id,
                    event,
                    code
                });
            }, 300);
        }
        computeTriggers () {
            return this.uiElements.filter((element) => this.hasEvents(element));
        }
        pageEntered (e) {
            // Trigger a resize on blockly when we get back to the
            // code editor page
            if (e.detail.item.getAttribute('name') === 'edit-code') {
                let blocky = this.$.blockly;
                blockly.showToolbox();
                // Ugly but necessary. Blockly needs a resize to be triggered
                // here because, its container was display none
                blockly.resize();
            }
        }
        pageLeaved (e) {
            if (e.detail.item.getAttribute('name') === 'edit-code') {
                blockly.hideToolbox();
            }
        }
        hasEvents (selectedUi) {
            return selectedUi &&
                    selectedUi.events &&
                    selectedUi.events.length;
        }
        computeSelectedPage () {
            if (this.selectedUi) {
                return 'edit-code';
            }
            return 'empty';
        }
        selectedUiChanged () {
            let trigger;
            if (this.hasEvents(this.selectedUi)) {
                trigger = this.selectedUi;
            } else {
                trigger = this.computeTriggers()[0];
            }
            if (!trigger) {
                return;
            }
            this.set('selectedTrigger', trigger);
        }
        getEventFromId (events, id) {
            for (let i in events) {
                if (events[i].id === id) {
                    return events[i];
                }
            }
        }
        computeToolbox () {
            this.uiElements.forEach((ui) => {
                ui.blocks.forEach((block) => {
                    Blockly.Blocks[block.id] = {
                        init: function () {
                            block.colour = ui.hue;
                            this.jsonInit(block);
                        }
                    };
                    Blockly.JavaScript[block.id] = block.javascript(ui);
                    Blockly.Natural[block.id] = block.natural(ui);
                });
            });
            return this.uiElements.map((ui) => {
                return {
                        name: ui.name,
                        blocks: ui.blocks,
                        colour: ui.hue
                    };
            }).concat(this.defaultCategories || []).filter((category) => category.blocks.length);
        }
    }
    Polymer(KanoUiEditor);
</script>
