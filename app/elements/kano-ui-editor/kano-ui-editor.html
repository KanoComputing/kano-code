<link rel="import" href="../kano-blockly/kano-blockly.html">
<link rel="import" href="../kano-style/kano-style.html">

<dom-module id="kano-ui-editor">
    <style>
    :host {
        display: block;
        @apply(--layout-vertical);
    }
    :host iron-pages {
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    :host .empty {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
    }
    :host .code-editor {
        position: relative;
        @apply(--layout-vertical);
        @apply(--layout-flex);
    }
    :host header {
        position: absolute;
        font-family: bariol;
        font-weight: normal;
        font-size: 1.2em;
        padding: 25px;
        text-align: center;
        top: 0px;
        right: 0px;
        left: 50%;
    }
    :host kano-blockly {
        @apply(--layout-flex);
    }
    </style>
    <template>
        <iron-pages
            id="pages"
            attr-for-selected="name"
            selected="{{selectedPage}}">
            <div name="empty" class="empty">
                <h1>Select an element</h1>
            </div>
            <div name="edit-code" class="code-editor">
                <kano-blockly id="blockly" toolbox="{{toolbox}}" code="{{code}}"></kano-blockly>
                <header>
                    <kano-event-select
                        triggers="{{computeTriggers(uiElements.*)}}"
                        selected-trigger="{{selectedTrigger}}"
                        selected-event="{{event}}"
                        ></kano-event-select>
                </header>
            </div>
        </iron-pages>
    </template>
</dom-module>
<script type="text/javascript">
    class KanoUiEditor {
        beforeRegister () {
            this.is = 'kano-ui-editor';
            this.properties = {
                uiElements: {
                    type: Array,
                    value: () => []
                },
                toolbox: {
                    type: Array,
                    computed: 'computeToolbox(uiElements.*)'
                },
                selectedUi: {
                    type: Object,
                    observer: 'selectedUiChanged'
                },
                code: {
                    type: String,
                    notify: true
                },
                event: {
                    type: String
                },
                rule: {
                    type: Object,
                    notify: true,
                    computed: 'computeRule(event, selectedTrigger.events.*, code)'
                },
                defaultCategories: {
                    type: Array,
                    value: () => []
                },
                selectedPage: {
                    type: String,
                    computed: 'computeSelectedPage(selectedUi)',
                    value: 'empty'
                }
            };
            this.listeners = {
                'pages.iron-select': 'pageEntered',
                'pages.iron-deselect': 'pageLeaved',
            };
        }
        computeTriggers () {
            return this.uiElements.filter((element) => this.hasEvents(element));
        }
        pageEntered (e) {
            // Trigger a resize on blockly when we get back to the
            // code editor page
            if (e.detail.item.getAttribute('name') === 'edit-code') {
                let blocky = this.$.blockly;
                blockly.showToolbox();
                // Ugly but necessary. Blockly needs a resize to be triggered
                // here because, its container was display none
                blockly.resize();
            }
        }
        pageLeaved (e) {
            if (e.detail.item.getAttribute('name') === 'edit-code') {
                blockly.hideToolbox();
            }
        }
        hasEvents (selectedUi) {
            return selectedUi
                    && selectedUi.events
                    && selectedUi.events.length;
        }
        computeSelectedPage () {
            if (this.selectedUi) {
                return 'edit-code';
            }
            return 'empty';
        }
        selectedUiChanged () {
            let trigger;
            if (this.hasEvents(this.selectedUi)) {
                trigger = this.selectedUi;
            } else {
                trigger = this.computeTriggers()[0];
            }
            if (!trigger) {
                return;
            }
            this.set('selectedTrigger', trigger);
        }
        computeRule (eventName) {
            let label,
                events;
            if (!this.selectedTrigger.events) {
                return;
            }
            events = this.selectedTrigger.events;
            for (let i in events) {
                if (events[i].id === this.event) {
                    label = events[i].label;
                    break;
                }
            }
            return {
                trigger: `When ${this.selectedTrigger.name} ${label}`,
                action: this.$.blockly.getCode('Natural')
            };
        }
        computeToolbox () {
            this.uiElements.forEach((ui) => {
                ui.blocks.forEach((block) => {
                    Blockly.Blocks[block.id] = {
                        init: function () {
                            block.colour = ui.hue;
                            this.jsonInit(block);
                        }
                    };
                    Blockly.JavaScript[block.id] = block.javascript(ui);
                    Blockly.Natural[block.id] = block.natural(ui);
                });
            });
            return this.uiElements.map((ui) => {
                return {
                        name: ui.name,
                        blocks: ui.blocks,
                        colour: ui.hue
                    };
            }).concat(this.defaultCategories || []).filter((category) => category.blocks.length);
        }
        getBlocklyXml () {
            return this.$.blockly.getXml();
        }
    }
    Polymer(KanoUiEditor);
</script>
