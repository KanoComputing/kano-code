<link rel="import" href="../kano-blockly/kano-blockly.html">
<link rel="import" href="../kano-style/kano-style.html">

<dom-module id="kano-ui-editor">
    <style>
    :host {
        display: block;
        @apply(--layout-vertical);
    }
    :host iron-pages {
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    :host .empty {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
    }
    :host .code-editor {
        @apply(--layout-vertical);
        @apply(--layout-flex);
    }
    :host header {
        font-family: bariol;
        font-weight: normal;
        font-size: 1.2em;
        padding: 25px;
        background-color: var(--color-grey-lighter);
        text-align: center;
    }
    :host .event-control {
        background-color: var(--primary-color);
        color: var(--color-white);
        padding: 4px;
        border-radius: 6px;
    }
    :host kano-blockly {
        @apply(--layout-flex);
    }
    </style>
    <template>
        <iron-pages
            id="pages"
            attr-for-selected="name"
            selected="{{selectedPage}}">
            <div name="empty" class="empty">
                <h1>Select an element</h1>
            </div>
            <div name="edit-code" class="code-editor">
                <template is="dom-if" if="{{hasEvents(selectedUi)}}">
                    <header>
                        <label>When </label>
                        <label class="event-control">
                            <span>{{selectedUi.name}}</span>
                            <select id="select" value="{{event::change}}">
                                <template is="dom-repeat" items="[[selectedUi.events]]" as="event">
                                    <option value$="[[event.id]]">[[event.label]]</option>
                                </template>
                            </select>
                        </label>
                    </header>
                </template>
                <kano-blockly id="blockly" toolbox="{{toolbox}}" code="{{code}}"></kano-blockly>
            </div>
        </iron-pages>
    </template>
</dom-module>
<script type="text/javascript">
    class KanoUiEditor {
        beforeRegister () {
            this.is = 'kano-ui-editor';
            this.properties = {
                uiElements: {
                    type: Array,
                    value: () => []
                },
                toolbox: {
                    type: Array,
                    computed: 'computeToolbox(uiElements.*)'
                },
                selectedUi: {
                    type: Object,
                    value: () => {
                        return {};
                    },
                    observer: 'selectedUiChanged'
                },
                code: {
                    type: String,
                    notify: true
                },
                event: {
                    type: String
                },
                rule: {
                    type: Object,
                    notify: true,
                    computed: 'computeRule(event, selectedUi.events.*, code)'
                },
                defaultCategories: {
                    type: Array,
                    value: () => []
                },
                selectedPage: {
                    type: String,
                    computed: 'computeSelectedPage(selectedUi)',
                    value: 'empty'
                }
            };
            this.listeners = {
                'pages.iron-select': 'pageEntered',
                'pages.iron-deselect': 'pageLeaved',
            }
        }
        pageEntered (e) {
            // Trigger a resize on blockly when we get back to the
            // code editor page
            if (e.detail.item.getAttribute('name') === 'edit-code') {
                let blocky = this.$.blockly;
                blockly.showToolbox();
                // Ugly but necessary. Blockly needs a resize to be triggered
                // here because, its container was display none
                blockly.resize();
            }
        }
        pageLeaved (e) {
            if (e.detail.item.getAttribute('name') === 'edit-code') {
                blockly.hideToolbox();
            }
        }
        hasEvents (selectedUi) {
            return this.selectedUi
                    && this.selectedUi.events
                    && this.selectedUi.events.length;
        }
        computeSelectedPage () {
            if (this.hasEvents(this.selectedUi)) {
                return 'edit-code';
            }
            return 'empty';
        }
        selectedUiChanged () {
            if (!this.event
                    && this.selectedUi.events
                    && this.selectedUi.events[0]) {
                this.event = this.selectedUi.events[0].id;
            }
        }
        computeRule (eventName) {
            let select = this.$$('#select'),
                index,
                label;
            if (!select) {
                return;
            }
            index = select.selectedIndex;
            if (index === -1) {
                index = 0;
            }
            if (!this.selectedUi.events) {
                return;
            }
            label = this.selectedUi.events[index].label;
            return {
                trigger: `When ${this.selectedUi.name} ${label}`,
                action: this.$.blockly.getCode('Natural')
            };
        }
        computeToolbox () {
            this.uiElements.forEach((ui) => {
                ui.blocks.forEach((block) => {
                    Blockly.Blocks[block.id] = {
                        init: function () {
                            block.colour = ui.hue;
                            this.jsonInit(block);
                        }
                    };
                    Blockly.JavaScript[block.id] = block.javascript(ui);
                    Blockly.Natural[block.id] = block.natural(ui);
                });
            });
            return this.uiElements.map((ui) => {
                return {
                        name: ui.name,
                        blocks: ui.blocks,
                        colour: ui.hue
                    };
            }).concat(this.defaultCategories || []).filter((category) => category.blocks.length);
        }
        getBlocklyXml () {
            return this.$.blockly.getXml();
        }
    }
    Polymer(KanoUiEditor);
</script>
