<link rel="import" href="../kano-blockly/kano-blockly.html">
<link rel="import" href="../kano-style/kano-style.html">

<dom-module id="kano-ui-editor">
    <style>
    :host {
        position: relative;
        display: block;
        @apply(--layout-vertical);
        background-color: var(--color-grey-mid, grey);
    }
    :host iron-pages {
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    :host .code-editor {
        position: relative;
        @apply(--layout-vertical);
        @apply(--layout-flex);
    }
    :host header {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        background: linear-gradient(#FF842A,#FB7D36);
        color: var(--color-white, white);
        height: 60px;
        box-shadow: 0px 3px 0px 0px rgba(0,0,0,0.11);
    }
    :host header div {
        @apply(--layout-horizontal);
    }
    :host header .title {
        @apply(--layout-flex);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        text-align: center;
        font-size: 1.9em;
    }
    :host header .title span {
        margin-left: 5px;
    }
    :host header .title iron-image {
        width: 40px;
        height: 40px;
    }
    :host header .header-right,
    :host header .header-left {
        width: 60px;
        height: 60px;
    }
    :host kano-blockly {
        @apply(--layout-flex);
    }
    :host .trigger {
        position: absolute;
        top: 20px;
        right: 20px;
        width: calc(50% - 40px);
        padding: 10px;
        font-size: 1.3em;
        color: var(--color-white, white);
        background-color: var(--color-red, red);
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
    }
    :host .default {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--kano-dotted-background);
    }
    :host .default span {
        padding: 20px;
        font-style: italic;
        font-size: 1.2em;
    }
    :host .default .code-list {
        @apply(--layout-center-justified);
        @apply(--layout-center);
        @apply(--layout-vertical);
        @apply(--layout-flex);
    }
    :host .edit-config,
    :host .save button {
        background: var(--green-gradient, green);
    }
    :host .add-code {
        background: linear-gradient(#7DC242,#7EBF4D);
        box-shadow: 0px 3px 0px 0px rgba(0,0,0,0.11);
    }
    :host .add-code {
        @apply(--kano-button-big);
    }
    :host .saved-code {
        @apply(--layout-vertical);
        @apply(--layout-stretch);
        font-size: 1.4em;
        margin-top: 20px;
    }
    :host .saved-code:hover {
        cursor: pointer;
    }
    :host .code-trigger {
        padding: 10px;
        background-color: var(--color-grey-light, grey);
    }
    :host .code-action {
        padding: 10px;
        background-color: var(--color-grey-dark, grey);
    }
    :host .edit-config {
        @apply(--kano-button);
        width: 100%;
        height: 100%;
        box-shadow: 0px 0px;
    }
    :host .trigger-select {
        text-align: center;
        @apply(--kano-dotted-background);
        @apply(--layout-flex);
    }
    :host .back {
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        background-color: transparent;
        border: 0px;
        width: 100%;
        height: 100%;
    }
    :host .back iron-image {
        width: 10px;
        height: 15px;
    }
    :host .back:hover {
        cursor: pointer;
    }
    :host .background {
        padding: 25px;
    }
    :host .background input {
        @apply(--kano-light-input);
        font-size: 1.4em;
    }
    </style>
    <template>
        <header>
            <div class="header-left">
                <button class="back"
                        type="button"
                        on-tap="previous">
                    <iron-image src="/assets/icons/back-arrow-icon.png" sizing="contain"></iron-image>
                </button>
            </div>
            <div class="title">
                <iron-image src="[[computeIcon(selectedPage, selected)]]"
                            sizing="contain"></iron-image>
                <span>[[computeTitle(selectedPage, selectedPart.*, background.name)]]</span>
            </div>
            <div class="header-right">
                <button type="button"
                        class="edit-config"
                        on-tap="editConfig"
                        hidden$="[[isEditHidden(selectedPage, selected)]]">E</button>
            </div>
        </header>
        <iron-pages
            id="pages"
            attr-for-selected="name"
            selected="{{selectedPage}}">
            <div name="background" class="background">
                <input type="text" value="{{background.name::keyup}}">
                <kano-ui-customizer customizable="{{backgroundOptions}}"
                                    user-values="{{background.userStyle}}"></kano-ui-customizer>
            </div>
            <div class="default" name="default">
                <span>{{selectedPart.description}}</span>
                <div class="code-list">
                    <button type="button"
                    class="add-code"
                    on-tap="addCode">Add Code</button>
                    <template is="dom-repeat"
                            items="{{computeEventRules(selectedPage)}}"
                            as="event">
                        <div class="saved-code" on-tap="editCode">
                            <span class="code-trigger">{{event.rule.trigger}}</span>
                            <span class="code-action">{{event.rule.action}}</span>
                        </div>
                    </template>
                </div>
            </div>
            <div name="trigger" class="trigger-select">
                <kano-event-select
                    parts="{{computeParts(parts.*)}}"
                    on-selected="triggerSelected"></kano-event-select>
            </div>
            <kano-ui-configuration element="{{selectedPart}}"
                        name="config"></kano-ui-configuration>
            <div name="code" class="code-editor">
                <kano-blockly id="blockly"
                        toolbox="[[toolbox]]"
                        blocks="[[blocks]]"
                        code="{{code}}"
                        on-change="saveCode"></kano-blockly>
                <div class="trigger">
                    <span>{{trigger.text}}</span>
                </div>
            </div>
        </iron-pages>
    </template>
</dom-module>
<script type="text/javascript">
    class KanoUiEditor {
        beforeRegister () {
            this.is = 'kano-ui-editor';
            this.properties = {
                modules: {
                    type: Array,
                    computed: 'computeModules(usedCategories.*)',
                    notify: true
                },
                trigger: {
                    type: Object
                },
                parts: {
                    type: Array,
                    value: () => {
                        return [];
                    },
                    notify: true
                },
                toolbox: {
                    type: Array
                },
                selected: {
                    type: Number,
                    notify: true,
                    observer: 'selectedChanged'
                },
                selectedPart: {
                    type: Object,
                    value: null
                },
                defaultCategories: {
                    type: Array,
                    value: () => []
                },
                selectedPage: {
                    type: String,
                    value: 'background'
                },
                code: {
                    type: String,
                    notify: true
                },
                blocks: {
                    type: Object
                },
                background: {
                    type: Object,
                    value: () => {
                        return {
                            name: 'My app',
                            userStyle: {}
                        };
                    },
                    notify: true
                }
            };
            this.observers = [
                'selectedPartChanged(selectedPart.*)',
                'computeToolbox(parts.*)',
                'triggerChanged(trigger.*)',
                'updateSelectedPart(parts.*)'
            ];
            this.listeners = {
                'pages.iron-select': 'pageEntered',
                'pages.iron-deselect': 'pageLeaved'
            };
        }
        updateSelectedPart () {
            this.set('selectedPart', this.parts[this.selected]);
        }
        triggerChanged () {
            let trigger = this.trigger,
                codes = this.parts[this.selected].codes,
                event;
            if (!codes[trigger.emitter]) {
                codes[trigger.emitter] = {};
            }
            if (!codes[trigger.emitter][trigger.event]) {
                codes[trigger.emitter][trigger.event] = {};
            }
            event = codes[trigger.emitter][trigger.event];
            if (!event.blocks) {
                this.$.blockly.clearWorkspace();
                this.showPage('code');
                return;
            }
            this.set('blocks', event.blocks);
            this.showPage('code');
        }
        /**
         * Propagate changes from congiguration editor to the array
         */
        selectedPartChanged (e) {
            if (!this.selected) {
                return;
            }
            let path = e.path.replace('selectedPart', `parts.${this.selected}`);
            this.set(path, e.value);
        }
        computeModules () {
            return Object.keys(this.usedCategories).filter((name) => {
                return !!this.usedCategories[name];
            });
        }
        attached () {
            this.set('backgroundOptions', [{
                key: 'background',
                type: 'background',
                label: 'Background'
            }]);
            this.set('usedCategories', {});
        }
        selectedChanged (newValue, oldValue) {
            this.updateSelectedPart();
            if (oldValue === null && newValue !== null) {
                this.showPage('default');
            } else if (newValue === null) {
                this.showPage('background');
            }
        }
        isEditHidden () {
            return this.selectedPage !== 'default' || !this.selectedPart;
        }
        editCode (e) {
            let event = e.model.get('event');
            if (!this.selected) {
                return;
            }
            this.set('trigger', {
                emitter: event.emitterId,
                event: event.eventId,
                text: event.rule.trigger
            });
        }
        computeParts () {
            return this.parts.concat({
                id: 'global',
                name: 'Make',
                events: [{
                    id: 'start',
                    label: 'is clicked'
                }],
                codes: {}
            });
        }
        getUiParts () {
            return this.parts.filter(ui => ui.partType === 'ui');
        }
        computeEventRules () {
            let codes,
                emitter,
                event,
                rules;
            if (!this.selected) {
                return;
            }
            codes = this.selectedPart.codes;
            return Object.keys(codes).reduce((acc, emitterId) => {
                emitter = codes[emitterId];
                rules = Object.keys(emitter).map((eventId) => {
                    event = emitter[eventId];
                    return event;
                });
                return acc.concat(rules);
            }, []);
        }
        triggerSelected (e) {
            this.set('trigger', e.detail);
            this.showPage('code');
        }
        saveCode (e) {
            let detail = e.detail,
                blockType,
                split,
                categoryId;
            // If a new block is created, increment the block counter
            if (detail instanceof Blockly.Events.Create) {
                blockType = detail.xml.getAttribute('type');
                split = blockType.split('#');
                if (split.length < 2) {
                    return;
                }
                categoryId = split[0];
                if (!this.usedCategories[categoryId]) {
                    this.set(`usedCategories.${categoryId}`, 0);
                }
                this.set(`usedCategories.${categoryId}`, this.usedCategories[categoryId] + 1);
            } else if (detail instanceof Blockly.Events.Delete) {
                blockType = detail.oldXml.getAttribute('type');
                split = blockType.split('#');
                if (split.length < 2) {
                    return;
                }
                categoryId = split[0];
                this.set(`usedCategories.${categoryId}`, this.usedCategories[categoryId] - 1);
            }
            this.debounce('saveCode', () => {
                let code = {},
                    emitterPath,
                    codePath,
                    trigger = this.trigger;
                code.blocks = this.$.blockly.getBlocks();
                code.rule = {
                    trigger: trigger.text,
                    action: this.$.blockly.getCode('Natural')
                };
                code.javascript = this.$.blockly.getCode('JavaScript');
                code.emitterId = trigger.emitter;
                code.eventId = trigger.event;
                emitterPath = `selectedPart.codes.${trigger.emitter}`;
                if (!this.parts[this.selected].codes[trigger.emitter]) {
                    this.set(emitterPath, {});
                }
                codePath = `${emitterPath}.${trigger.event}`;
                this.set(codePath, code);
            }, 300);
        }
        computeTriggers () {
            return this.parts.filter((element) => this.hasEvents(element));
        }
        pageEntered (e) {
            // Trigger a resize on blockly when we get back to the
            // code editor page
            if (e.detail.item.getAttribute('name') === 'code') {
                this.showBlocklyToolbox();
            }
        }
        pageLeaved (e) {
            if (e.detail.item.getAttribute('name') === 'code') {
                this.hideBlocklyToolbox();
            }
        }
        hideBlocklyToolbox () {
            this.$.blockly.hideToolbox();
        }
        showBlocklyToolbox () {
            this.$.blockly.showToolbox();
        }
        hasEvents (selectedPart) {
            return selectedPart &&
                    selectedPart.events &&
                    selectedPart.events.length;
        }
        getEventFromId (events, id) {
            for (let i in events) {
                if (events[i].id === id) {
                    return events[i];
                }
            }
        }
        getElement (id) {
            for (let i = 0, len = this.parts.length; i < len; i++) {
                if (this.parts[i].id === id) {
                    return this.parts[i];
                }
            }
        }
        computeToolbox () {
            this.debounce('computeToolbox', () => {
                let categories,
                    toolbox,
                    parts = this.getUiParts(),
                    blocks;
                if (!parts) {
                    return;
                }
                categories = parts.map((ui) => {
                    blocks = ui.blocks.map((definition) => {
                        let block = definition.block(ui);
                        block.colour = ui.colour;
                        block.id = `${ui.id}#${block.id}`;
                        Blockly.Blocks[block.id] = {
                            init: function () {
                                this.jsonInit(block);
                            }
                        };
                        Blockly.JavaScript[block.id] = definition.javascript(ui);
                        Blockly.Natural[block.id] = definition.natural(ui);
                        return {
                            id: block.id
                        };
                    });
                    return {
                        name: ui.name,
                        colour: ui.colour,
                        blocks
                    };
                });

                toolbox = categories
                    .concat(this.defaultCategories || [])
                    .filter((category) => category.blocks.length);
                this.set('toolbox', toolbox);
            }, 10);
        }
        addCode () {
            this.showPage('trigger');
        }
        editConfig () {
            this.showPage('config');
        }
        showPage (page) {
            this.set('selectedPage', page);
        }
        previous () {
            let targetPage;
            switch (this.selectedPage) {
                case 'trigger':
                case 'config': {
                    targetPage = 'default';
                    break;
                }
                case 'code': {
                    targetPage = 'trigger';
                    break;
                }
                case 'default': {
                    this.set('selected', null);
                    break;
                }
                default: {
                    this.fire('previous');
                    break;
                }
            }
            if (targetPage) {
                this.showPage(targetPage);
            }
        }
        computeIcon () {
            if (!this.selectedPart) {
                return;
            }
            if (this.selectedPage === 'default' || this.selectedPage === 'code') {
                return this.selectedPart.image;
            }
        }
        computeTitle () {
            switch (this.selectedPage) {
                case 'default':
                case 'code': {
                    if (!this.selectedPart) {
                        return;
                    }
                    return this.selectedPart.name;
                }
                case 'config': {
                    return 'Edit Part';
                }
                case 'trigger': {
                    return 'Choose trigger';
                }
                case 'background': {
                    return this.background.name;
                }
            }
        }
    }
    Polymer(KanoUiEditor);
</script>
