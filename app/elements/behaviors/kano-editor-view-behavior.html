<script type="text/javascript">

    window.Kano = window.Kano || {};

    window.Kano.Behaviors = window.Kano.Behaviors || {};

    window.Kano.Behaviors.EditorViewBehavior = {
        properties: {
            running: {
                type: Boolean,
                observer: '_runningChanged'
            }
        },
        listeners: {
            'blockly-ready': '_registerBlockly'
        },
        _registerBlockly () {
            Kano.MakeApps.Blockly.register(window.Blockly);
        },
        _runningChanged (running) {
            this.debounce('runningChanged', () => {
                if (running) {
                    let parts,
                        appCode,
                        vm;
                    if (!this.mode) {
                        return;
                    }
                    Kano.AppModules.stop();
                    // Get the parts elements from the workspace
                    parts = this.$.editor.getWorkspace().getPartsDict();
                    // Tell AppModules where to find the parts
                    Kano.AppModules.loadParts(parts);
                    // Generate the code
                    appCode = Kano.AppModules.createAppCode('AppModules', this.code.snapshot.javascript);
                    // Prepare a sandbox exposing AppModules
                    vm = new Kano.VM({ AppModules: Kano.AppModules });
                    // Run the code
                    vm.runInContext(appCode);
                    // Start all the modules. Will also trigger the `start` event from `global` 
                    Kano.AppModules.start();
                } else {
                    Kano.AppModules.stop();
                }
            });
        }
    };

</script>
