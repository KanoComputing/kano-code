<script src="../../scripts/kano/vm.js"></script>
<link rel="import" href="../../scripts/kano/make-apps/store.html">
<script type="text/javascript">

    window.Kano = window.Kano || {};

    window.Kano.Behaviors = window.Kano.Behaviors || {};
    
    // @polymerBehavior
    Kano.Behaviors.EditorViewBehaviorImpl = {
        listeners: {
            'mode-ready': '_onModeReady'
        },
        _onModeReady () {
            const config = this.getState();
            Kano.MakeApps.Parts.init(config);
            Kano.MakeApps.Blockly.register(window.Blockly);
            this.editor.on('running-state-changed', () => {
                if (!this.modeReady) {
                    return;
                }
                const running = this.editor.getRunningState();
                this.debounce('runningChanged', () => {
                    if (running) {
                        if (!this.mode) {
                            return;
                        }
                        Kano.AppModules.stop();
                        
                        // Get the parts elements from the workspace
                        const parts = this.editor.getWorkspace().getPartsDict();
                        // Tell AppModules where to find the parts
                        Kano.AppModules.loadParts(parts);
                        const code = this.editor.getCode();
                        // Generate the code
                        const appCode = Kano.AppModules.createAppCode('AppModules', code);
                        // Start all the modules. Will also trigger the `start` event from `global`
                        Kano.AppModules.start();
                        // Prepare a sandbox exposing AppModules
                        const vm = new Kano.VM({ AppModules: Kano.AppModules });
                        // Run the code
                        vm.runInContext(appCode);

                    } else {
                        Kano.AppModules.stop();
                    }
                });
            });
            this.editor.setRunningState(true);
        },
    };

    // @polymerBehavior
    Kano.Behaviors.EditorViewBehavior = [Kano.Behaviors.EditorViewBehaviorImpl, Kano.MakeApps.Store.ReceiverBehavior];

</script>
