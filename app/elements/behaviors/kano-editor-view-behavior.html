<script src="../../scripts/kano/vm.js"></script>
<script type="text/javascript">

    window.Kano = window.Kano || {};

    window.Kano.Behaviors = window.Kano.Behaviors || {};

    // @polymerBehavior
    Kano.Behaviors.EditorViewBehavior = {
        properties: {
            running: {
                type: Boolean,
                observer: '_runningChanged'
            },
            modeReady: {
                type: Boolean,
                value: false
            }
        },
        listeners: {
            'mode-ready': '_onModeReady'
        },
        _onModeReady () {
            Kano.MakeApps.Parts.init(Kano.MakeApps.config);
            Kano.MakeApps.Blockly.register(window.Blockly);
            this.notifyPath('mode.defaultBlocks', this.mode.defaultBlocks);
            this._runningChanged(this.running);
            this.modeReady = true;
        },
        _runningChanged (running) {
            if (!this.modeReady) {
                return;
            }
            this.debounce('runningChanged', () => {
                if (running) {
                    let parts,
                        appCode,
                        vm;
                    if (!this.mode) {
                        return;
                    }
                    Kano.AppModules.stop();

                    // Get the parts elements from the workspace
                    parts = this.$.editor.getWorkspace().getPartsDict();
                    // Tell AppModules where to find the parts
                    Kano.AppModules.loadParts(parts);
                    // Generate the code
                    appCode = Kano.AppModules.createAppCode('AppModules', this.code.snapshot.javascript);
                    // Start all the modules. Will also trigger the `start` event from `global`
                    Kano.AppModules.start();
                    // Prepare a sandbox exposing AppModules
                    vm = new Kano.VM({ AppModules: Kano.AppModules });
                    // Run the code
                    vm.runInContext(appCode);

                } else {
                    Kano.AppModules.stop();
                }
            });
        }
    };

</script>
