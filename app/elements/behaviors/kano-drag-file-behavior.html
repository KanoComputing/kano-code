<script type="text/javascript">

    (function (Kano){

        Kano.Behaviors = Kano.Behaviors || {};
        
        // @polymerBehavior
        Kano.Behaviors.DragFileBehavior = {
            attached () {
                this._onDragover = this._onDragover.bind(this);
                this._onDrop = this._onDrop.bind(this);
                this._onDragenter = this._onDragenter.bind(this);
                this._onDragleave = this._onDragleave.bind(this);
                this._bindEvents();
                this.enterCount = 0;
            },
            detached () {
                this._unbindEvents();
            },
            _bindEvents () {
                this.addEventListener('dragover', this._onDragover, false);
                this.addEventListener('drop', this._onDrop, false);
                this.addEventListener('dragenter', this._onDragenter, false);
                this.addEventListener('dragleave', this._onDragleave, false);
            },
            _unbindEvents () {
                this.removeEventListener('dragover', this._onDragover);
                this.removeEventListener('drop', this._onDrop);
                this.removeEventListener('dragenter', this._onDragenter);
                this.removeEventListener('dragleave', this._onDragleave);
            },
            _onDragover (e) {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'copy';
            },
            _onDrop (e) {
                let file;
                e.preventDefault();
                e.stopPropagation();
                this.toggleClass('dragging', false);
                this._animateDrop().then(() => {
                    this.hideOverlay();
                });
                file = e.dataTransfer.files[0];
                if (file) {
                    this._readFile(file)
                        .then(content => {
                            this.fileDropped(content);
                        });
                }
            },
            _readFile (f) {
                return new Promise((resolve, reject) => {
                    var reader = new FileReader();

                    reader.onload = () => {
                        resolve(reader.result);
                    };

                    reader.onerror = reject;

                    reader.readAsText(f);
                });
            },
            _onDragenter (e) {
                let target = e.path ? e.path[0] : e.target;
                if (target !== this) {
                    this.toggleClass('dragging', true);
                } else {
                    this.showOverlay();
                    this._animateDragEnter();
                }
            },
            _onDragleave (e) {
                let target = e.path ? e.path[0] : e.target;
                if (target === this) {
                    this.toggleClass('dragging', false);
                    this._animateDragLeave().then(() => {
                        this.hideOverlay();
                    });
                }
            },
            showOverlay () {},
            hideOverlay () {},
            _animateDragEnter () {
                return Promise.resolve();
            },
            _animateDragLeave () {
                return Promise.resolve();
            },
            _animateDrop () {
                return Promise.resolve();
            }
        };
        
    })(window.Kano = window.Kano || {});
</script>
