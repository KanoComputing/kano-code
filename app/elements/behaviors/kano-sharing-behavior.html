<link rel="import" href="./kano-view-behavior.html">
<script src="./file_utils.js"></script>
<link rel="import" href="../../scripts/kano/make-apps/sdk.html">
<script type="text/javascript">

/* globals Kano, FileUtils */

window.Kano = window.Kano || {};

window.Kano.Behaviors = window.Kano.Behaviors || {};

var SharingBehavior = {

    properties: {
        remixedShare: {
            type: Object
        },
        shareInfo: {
            type: Object,
            value: function () {
                return {};
            },
            notify: true
        },
        isChallenge: {
            type: Boolean,
            value: false
        }
    },
    listeners: {
        'cover-generated': '_onCoverGenerated',
        'change-gif': '_goToGifCreator'
    },
    observers: [
        '_userChanged(user)'
    ],
    _goToPage (page) {
        this.set('shareInfo.page', page);
        this.modal.refit();
    },
    _goToGifCreator () {
        this._goToPage('gif-creation');
    },
    _onCoverGenerated () {
        if (this.shareInfo.autoshare) {
            this._shareApp({
                share: true
            });
            this._goToPage('saving');
        } else {
            this._goToPage('sharing-form');
        }
    },
    _shareApp (options) {
        // Generates the standalone component
        let savedApp,
        attachment,
        appName = 'make-apps',
        cover = this.shareInfo.coverBlob,
        spritesheet = this.shareInfo.spriteSheetBlob,
        workspaceInfo = new Blob([this.shareInfo.workspaceInfo], { type: 'application/json' }),
        files,
        trackingData = {},
        taggableParts = [
            'gyro-accelerometer',
            'motion-sensor',
            'speaker',
            'microphone'
        ],
        hardware = this.shareInfo.parts.filter(part => {
            return part.partType === 'hardware' &&
                   taggableParts.indexOf(part.type) >= 0;
        }).map(part => {
            return { product: part.type };
        });

        if (this.shareInfo.mode.id === 'lightboard') {
            hardware.push({product: 'lightboard'});
        }

        if (this.remixedShare) {
            trackingData.remixed_from_project_id = this.remixedShare.id;
        }

        if (this.shareInfo.mode.sharing.cover === 'still') {
            cover.filename = 'cover.png';
        } else {
            cover.filename = 'cover.gif';
        }

        workspaceInfo.filename = 'workspace_info.json';

        this.set('shareInfo.loading', true);

        trackingData.project_type = appName;

        files = {
            cover: cover,
            workspace_info: workspaceInfo
        };

        if (this.shareInfo.mode.sharing.spritesheet && spritesheet) {
            spritesheet.filename = 'spritesheet.png';
            files.lightboard_spritesheet = spritesheet;
        }

        //Share by calling the API
        return Kano.MakeApps.sdk.api.share.post({
            app: appName,
            title: this.shareInfo.title,
            description: this.shareInfo.description,
            files: files,
            is_private: this.shareInfo.is_private || false,
            hardware: hardware
        }).then((res) => {
            if (res.status == 200) {
                let share = res.body.item;
                // Generate the html file with the slug as component name
                savedApp = Kano.AppModules.generateStandaloneComponent(
                    share.slug,
                    this.shareInfo.parts,
                    this.shareInfo.background,
                    this.shareInfo.mode,
                    this.shareInfo.code
                );
                // Create the attachment
                attachment = new Blob([savedApp], { type: 'text/html' });
                attachment.filename = 'code.html';
                // Attach the file to the share
                return Kano.MakeApps.sdk.api.share.attach({ id: share.id, files: { attachment } }).then((res) => {
                    if (res.status == 200) {
                        trackingData.project_id = share.id;
                        return res.body.item;
                    } else {
                        throw new Error('Could not share the app');
                    }
                });
            } else {
                throw new Error('Could not share the app');
            }
        }).then((share) => {
            this.fire('share-successful');
            this.set('shareInfo.id', share.id);
            this.set('shareInfo.slug', share.slug);

            if (options && options.share) {
                this.fire('tracking-event', {
                    name: 'shared_project',
                    data: trackingData
                });
            }
            if (!this.shareInfo.is_private) {
                this._goToPage('success');
            }
            return share;
        }).then((share) => {
            // Check if it's a creation you made from scratch or a challenge
            if (!this.isChallenge) {
                // Hit the gamification engine
                let payload = {
                    name: 'share-creation',
                    detail: {
                        id: share.id
                    }
                }
                this._triggerGamificationEngine(payload);
            }
            return share;
        }).catch((e) => {
            console.error(e);
            this.fire('share-attempted');
            this._goToPage('failure');
        });
    },
    _triggerGamificationEngine (payload) {
        return new Promise(function (resolve, reject) {
            let headers = new Headers(),
                token = Kano.MakeApps.sdk.auth.getToken();
            if (token) {
                headers.append('Content-Type', 'application/json');
                headers.append('Authorization', token);
                fetch(`${Kano.MakeApps.config.API_URL}/progress`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(payload)
                }).then(r => r.json())
                .then(resolve);
            } else {
                reject(new Error('No auth token found.'));
            }
        });
    },
    /**
    * Opens the sharing modal and shares the app
    */
    share (e) {
        let app = e.detail.app,
            slug = Date.now().toString(),
            mode = Kano.MakeApps.Mode.modes[app.mode],
            shareInfo, component;
        component = Kano.AppModules.generateStandaloneComponent(
            slug,
            app.parts,
            app.background,
            mode,
            app.code);
        shareInfo = {
            app: {
                src: 'data:text/html;base64,' + window.btoa(component),
                slug
            },
            workspaceInfo: e.detail.workspaceInfo,
            page: 'gif-creation',
            title: e.detail.title || '',
            description: '',
            id: null,
            background: e.detail.background,
            parts: e.detail.parts,
            code: e.detail.code,
            mode,
            autoshare: e.detail.autoshare
        };

        this.set('shareInfo', shareInfo);
        this.modal.animationConfig = {
            entry: [{
                name: 'transform-animation',
                transformFrom: 'scale(1.5)',
                node: this.modal,
                timing: {
                    duration: 200
                }
            },{
                name: 'fade-in-animation',
                node: this.modal,
                timing: {
                    duration: 200
                }
            }],
            exit: {
                name: 'fade-out-animation',
                node: this.modal,
                timing: {
                    duration: 200
                }
            }
        };
        let onAppReady = () => {
            this.modal.refit();
            this.modal.removeEventListener('app-ready', onAppReady);
        };
        this.modal.addEventListener('app-ready', onAppReady);
        this.modal.open();
    },

    _userChanged (user) {
        // user just logged out, nothing to do
        if (!user) {
            return;
        }
        // The user logged in and the sharing was waiting authentication, trigger the share
        if (this.waitingAuth && !this.shareInfo.is_private) {
            this.confirmShare();
        }
    },

    confirmShare (e) {
        // The user is not authenticated
        if (!this.user) {
            // Flag the sharing as waiting authentication and trigger a login event
            this.waitingAuth = true;
            return this.fire('login');
        }
        this._shareApp(e.detail);

        if (!this.shareInfo.is_private) {
            this._goToPage('saving');
        }

    },

    dismissShare () {
        this.modal.close();
    }
};
// @polymerBehavior
Kano.Behaviors.SharingBehavior = [window.Kano.Behaviors.ViewBehavior, SharingBehavior];
</script>
