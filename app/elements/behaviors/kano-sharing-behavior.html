<link rel="import" href="./kano-view-behavior.html">
<script src="./file_utils.js"></script>
<script type="text/javascript">

/* globals Kano, FileUtils */

window.Kano = window.Kano || {};

window.Kano.Behaviors = window.Kano.Behaviors || {};

var SharingBehavior = {

    properties: {
        shareInfo: {
            type: Object,
            value: function () {
                return {};
            },
            notify: true
        }
    },
    listeners: {
        'cover-generated': '_goToForm',
        'change-gif': '_goToGifCreator'
    },
    observers: [
        '_userChanged(user)'
    ],
    _goToPage (page) {
        this.set('shareInfo.page', page);
        this.modal.refit();
    },
    _goToGifCreator () {
        this._goToPage('gif-creation');
    },
    _goToForm () {
        this._goToPage('sharing-form');
    },
    _shareApp () {
        // Generates the standalone component
        let savedApp,
        attachment,
        cover = this.shareInfo.coverBlob,
        workspaceInfo = new Blob([this.shareInfo.workspaceInfo], { type: 'application/json' });

        cover.filename = 'cover.png';
        workspaceInfo.filename = 'workspace_info.json';

        //Share by calling the API
        return Kano.MakeApps.sdk.api.share.post({
            app: 'make-apps',
            title: this.shareInfo.title,
            description: this.shareInfo.description,
            files: {
                cover: cover,
                workspace_info: workspaceInfo
            },
            is_private: this.shareInfo.is_private || false
        }).then((res) => {
            if (res.status == 200) {
                let share = res.body.item;
                // Generate the html file with the slug as component name
                savedApp = Kano.AppModules.generateStandaloneComponent(
                    share.slug,
                    this.shareInfo.parts,
                    this.shareInfo.background,
                    this.shareInfo.mode,
                    this.shareInfo.code
                );
                // Create the attachment
                attachment = new Blob([savedApp], { type: 'text/html' });
                attachment.filename = 'code.html';
                // Attach the file to the share
                return Kano.MakeApps.sdk.api.share.attach({ id: share.id, files: { attachment } }).then((res) => {
                    if (res.status == 200) {
                        return res.body.item;
                    } else {
                        throw new Error('Could not share the app');
                    }
                });
            } else {
                throw new Error('Could not share the app');
            }
        }).then((share) => {
            this.set('shareInfo.id', share.id);
            this._goToPage('success');
            return share;
        }).catch((e) => {
            console.error(e);
            this._goToPage('failure');
        });
    },

    /**
    * Opens the sharing modal and share the app
    */
    share (e) {
        let app = e.detail.app,
            slug = Date.now().toString(),
            mode = Kano.MakeApps.Mode.modes[app.mode],
            shareInfo, component;
        component = Kano.AppModules.generateStandaloneComponent(
            slug,
            app.parts,
            app.background,
            mode,
            app.code);
        shareInfo = {
            app: {
                src: 'data:text/html;base64,' + window.btoa(component),
                slug
            },
            workspaceInfo: e.detail.workspaceInfo,
            page: 'gif-creation',
            title: '',
            description: '',
            id: null,
            background: e.detail.background,
            parts: e.detail.parts,
            code: e.detail.code,
            mode
        };

        this.set('shareInfo', shareInfo);
        this.modal.animationConfig = {
            entry: [{
                name: 'transform-animation',
                transformFrom: 'scale(1.5)',
                node: this.modal,
                timing: {
                    duration: 200
                }
            },{
                name: 'fade-in-animation',
                node: this.modal,
                timing: {
                    duration: 200
                }
            }],
            exit: {
                name: 'fade-out-animation',
                node: this.modal,
                timing: {
                    duration: 200
                }
            }
        };
        let onAppReady = () => {
            this.modal.open();
            this.modal.removeEventListener('app-ready', onAppReady);
        };
        this.modal.addEventListener('app-ready', onAppReady);
    },

    _userChanged (user) {
        // user just logged out, nothing to do
        if (!user) {
            return;
        }
        // The user logged in and the sharing was waiting authentication, trigger the share
        if (this.waitingAuth) {
            this.confirmShare();
        }
    },

    confirmShare (e) {
        // The user is not authenticated
        if (!this.user) {
            // Flag the sharing as waiting authentication and trigger a login event
            this.waitingAuth = true;
            return this.fire('login');
        }
        this._shareApp();

        this._goToPage('publishing');
    },

    dismissShare () {
        this.modal.close();
    }
};

window.Kano.Behaviors.SharingBehavior = [window.Kano.Behaviors.ViewBehavior, SharingBehavior];
</script>
