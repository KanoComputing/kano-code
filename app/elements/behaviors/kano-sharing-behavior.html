<link rel="import" href="./kano-view-behavior.html">
<script src="./file_utils.js"></script>
<link rel="import" href="../../scripts/kano/make-apps/sdk.html">
<script type="text/javascript">

/* globals Kano, FileUtils */

window.Kano = window.Kano || {};

window.Kano.Behaviors = window.Kano.Behaviors || {};

var SharingBehavior = {

    properties: {
        shareInfo: {
            type: Object,
            value: function () {
                return {};
            },
            notify: true
        }
    },
    listeners: {
        'cover-generated': '_onCoverGenerated',
        'change-gif': '_goToGifCreator'
    },
    observers: [
        '_userChanged(user)'
    ],
    _goToPage (page) {
        this.set('shareInfo.page', page);
        this.modal.refit();
    },
    _goToGifCreator () {
        this._goToPage('gif-creation');
    },
    _onCoverGenerated () {
        if (this.shareInfo.autoshare) {
            this._shareApp();
            this._goToPage('publishing');
        } else {
            this._goToPage('sharing-form');
        }
    },
    _shareApp () {
        // Generates the standalone component
        let savedApp,
        attachment,
        appName = 'make-apps',
        cover = this.shareInfo.coverBlob,
        spritesheet = this.shareInfo.spriteSheetBlob,
        workspaceInfo = new Blob([this.shareInfo.workspaceInfo], { type: 'application/json' }),
        files;

        if (this.shareInfo.mode.sharing.cover === 'still') {
            cover.filename = 'cover.png';
        } else {
            cover.filename = 'cover.gif';
        }

        workspaceInfo.filename = 'workspace_info.json';

        this.set('shareInfo.loading', true);

        /* For filtering reasons, lightboard shares use different app name
           from regular Make Apps shares. */
        if (this.shareInfo.mode.id === 'lightboard') {
            appName = 'lightboard';
        }

        files = {
            cover: cover,
            workspace_info: workspaceInfo
        };

        if (this.shareInfo.mode.sharing.spritesheet && spritesheet) {
            spritesheet.filename = 'spritesheet.png';
            files.lightboard_spritesheet = spritesheet;
        }

        //Share by calling the API
        return Kano.MakeApps.sdk.api.share.post({
            app: appName,
            title: this.shareInfo.title,
            description: this.shareInfo.description,
            files: files,
            is_private: this.shareInfo.is_private || false
        }).then((res) => {
            if (res.status == 200) {
                let share = res.body.item;
                // Generate the html file with the slug as component name
                savedApp = Kano.AppModules.generateStandaloneComponent(
                    share.slug,
                    this.shareInfo.parts,
                    this.shareInfo.background,
                    this.shareInfo.mode,
                    this.shareInfo.code
                );
                // Create the attachment
                attachment = new Blob([savedApp], { type: 'text/html' });
                attachment.filename = 'code.html';
                // Attach the file to the share
                return Kano.MakeApps.sdk.api.share.attach({ id: share.id, files: { attachment } }).then((res) => {
                    if (res.status == 200) {
                        return res.body.item;
                    } else {
                        throw new Error('Could not share the app');
                    }
                });
            } else {
                throw new Error('Could not share the app');
            }
        }).then((share) => {
            this.set('shareInfo.id', share.id);
            this.set('shareInfo.slug', share.slug);
            if (!this.shareInfo.is_private) {
                this._goToPage('success');
            }
            return share;
        }).catch((e) => {
            console.error(e);
            this._goToPage('failure');
        });
    },

    /**
    * Opens the sharing modal and shares the app
    */
    share (e) {
        let app = e.detail.app,
            slug = Date.now().toString(),
            mode = Kano.MakeApps.Mode.modes[app.mode],
            shareInfo, component;
        component = Kano.AppModules.generateStandaloneComponent(
            slug,
            app.parts,
            app.background,
            mode,
            app.code);
        shareInfo = {
            app: {
                src: 'data:text/html;base64,' + window.btoa(component),
                slug
            },
            workspaceInfo: e.detail.workspaceInfo,
            page: 'gif-creation',
            title: e.detail.title || '',
            description: '',
            id: null,
            background: e.detail.background,
            parts: e.detail.parts,
            code: e.detail.code,
            mode,
            autoshare: e.detail.autoshare
        };

        this.set('shareInfo', shareInfo);
        this.modal.animationConfig = {
            entry: [{
                name: 'transform-animation',
                transformFrom: 'scale(1.5)',
                node: this.modal,
                timing: {
                    duration: 200
                }
            },{
                name: 'fade-in-animation',
                node: this.modal,
                timing: {
                    duration: 200
                }
            }],
            exit: {
                name: 'fade-out-animation',
                node: this.modal,
                timing: {
                    duration: 200
                }
            }
        };
        let onAppReady = () => {
            this.modal.refit();
            this.modal.removeEventListener('app-ready', onAppReady);
        };
        this.modal.addEventListener('app-ready', onAppReady);
        this.modal.open();
    },

    _userChanged (user) {
        // user just logged out, nothing to do
        if (!user) {
            return;
        }
        // The user logged in and the sharing was waiting authentication, trigger the share
        if (this.waitingAuth && !this.shareInfo.is_private) {
            this.confirmShare();
        }
    },

    confirmShare () {
        // The user is not authenticated
        if (!this.user) {
            // Flag the sharing as waiting authentication and trigger a login event
            this.waitingAuth = true;
            return this.fire('login');
        }
        this._shareApp();

        if (!this.shareInfo.is_private) {
            this._goToPage('publishing');
        }

    },

    dismissShare () {
        this.modal.close();
    }
};
// @polymerBehavior
Kano.Behaviors.SharingBehavior = [window.Kano.Behaviors.ViewBehavior, SharingBehavior];
</script>
