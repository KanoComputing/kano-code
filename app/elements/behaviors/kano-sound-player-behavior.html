<script type="text/javascript">

    window.AudioContext = window.AudioContext || window.webkitAudioContext;

    let cache = {},
        ctx;

    if (window.AudioContext) {
        ctx = new AudioContext();
    }

    window.Kano = window.Kano || {};

    window.Kano.Behaviors = window.Kano.Behaviors || {};

    // @polymerBehavior
    window.Kano.Behaviors.SoundPlayerBehavior = {
        playSound (url, analyserOn) {
            if (!ctx) {
                return;
            }
            this.loadSound(url)
                .then(buffer => {
                    let source = ctx.createBufferSource();
                    source.buffer = buffer;
                    if (analyserOn) {
                        this.analyseSound(source);
                    }
                    source.connect(ctx.destination);
                    source.start(ctx.currentTime);
                });
        },
        loadSound (url) {
            if (cache[url]) {
                return Promise.resolve(cache[url]);
            } else {
                return fetch(url)
                    .then(res => res.arrayBuffer())
                    .then(data => {
                        return new Promise((resolve, reject) => {
                            ctx.decodeAudioData(data, (buffer) => {
                                cache[url] = buffer;
                                return resolve(buffer);
                            });
                        });
                    });
            }
        },
        analyseSound (source) {
            let analyser = ctx.createAnalyser();
            analyser.smoothingTimeConstant = 0.3;
            analyser.fftSize = 1024;
            source.connect(analyser);
            //a script processor to listen for audio process in the audio context
            let processorNode = ctx.createScriptProcessor(2048, 1, 1);
            processorNode.connect(ctx.destination);
            processorNode.onaudioprocess = function () {
                this.debounce('getTheVolume', () => {
                  let values = new Uint8Array(analyser.frequencyBinCount);
                  analyser.getByteFrequencyData(values);
                  this.fire('frequency-data', {data: values});
                }, 30);
            }.bind(this);
            source.onended = () => {
                this.fire('audio-ended');
                processorNode.onaudioprocess = null;
            }
        }
    };

</script>
