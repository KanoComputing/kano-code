<script type="text/javascript">

    window.AudioContext = window.AudioContext || window.webkitAudioContext;

    let cache = {},
        ctx;

    if (window.AudioContext) {
        ctx = new AudioContext();
    }

    window.Kano = window.Kano || {};

    window.Kano.Behaviors = window.Kano.Behaviors || {};

    // @polymerBehavior
    window.Kano.Behaviors.SoundPlayerBehavior = {
        playSound (url, isAnalyserRequired) {
            if (!ctx) {
                return;
            }
            this._loadSound(url)
                .then(buffer => {
                    let source = ctx.createBufferSource();
                    source.buffer = buffer;
                    if (isAnalyserRequired) {
                        let analyserTools = this.setupAnalyser();
                        source.connect(analyserTools.analyser);
                        analyserTools.jsNode.connect(ctx.destination);
                        source.onended = () => {
                            this.fire('sound-ended');
                            analyserTools.jsNode.onaudioprocess = null;
                        };
                    }
                    source.connect(ctx.destination);
                    source.start(ctx.currentTime);
                });
        },
        _loadSound (url) {
            if (cache[url]) {
                return Promise.resolve(cache[url]);
            } else {
                return fetch(url)
                    .then(res => res.arrayBuffer())
                    .then(data => {
                        return new Promise((resolve, reject) => {
                            ctx.decodeAudioData(data, (buffer) => {
                                cache[url] = buffer;
                                return resolve(buffer);
                            });
                        });
                    });
            }
        },
        setupAnalyser () {
            let analyser = ctx.createAnalyser();
            analyser.smoothingTimeConstant = 0.3;
            analyser.fftSize = 1024;
            let jsNode = ctx.createScriptProcessor(2048, 1, 1);
            jsNode.onaudioprocess = function () {
                this.debounce('getTheVolume', () => {
                  var array = new Uint8Array(analyser.frequencyBinCount);
                  analyser.getByteFrequencyData(array);
                  this.volume = (Math.floor(this.mathAverage(array))) * 0.4;
                  this.fire('volume-changed', {volume: this.volume});
                }, 30);
            }.bind(this);
            return {analyser: analyser,
                    jsNode: jsNode}
        },
        mathAverage (data) {
            let numbers;
            if (data[0] instanceof Array) {
                numbers = data[0];
            }
            else if (typeof data[0] == "number") {
                numbers = data;
            }
            let sum = 0;
            let average = 0;
            for (let i = 0; i < numbers.length; i++) {
                sum += numbers[i];
            }
            average = sum / numbers.length;
            return average;
        }
    };

</script>
