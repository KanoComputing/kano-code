<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/web-components/kano-style/button.html">
<link rel="import" href="../../bower_components/web-components/kano-style/typography.html">
<link rel="import" href="../kano-animated-svg/kano-animated-svg.html">
<link rel="import" href="../kano-tooltip/kano-tooltip.html">
<link rel="import" href="../behaviors/kano-app-element-registry-behavior.html">
<link rel="import" href="../behaviors/kano-i18n-behavior.html">

<dom-module id="kano-workspace-toolbar">
    <style>
        :host {
            display: block;
            @apply --layout-horizontal;
            @apply --layout-center;
            @apply --layout-center-justified;
        }
        :host([show-settings]) {
            @apply --layout-end-justified;
        }
        :host>div {
            @apply --layout-horizontal;
        }
        [hidden] {
            display: none !important;
        }
        .fullscreen,
        .pause {
            border-right: 2px solid #eee;
        }
        .mouse-position {
            color: white;
            width: 100px;
        }
        .spacer {
            @apply --layout-flex;
        }
        #settings-button {
            margin: 0px;
        }
        kano-animated-svg {
            min-width: 17px;
            min-height: 17px;

            --kano-animated-path: {
                fill: white;
                stroke: white;
                stroke-width: 2px;
                stroke-linecap: round;
                stroke-linejoin: round;
                transition: all ease-in-out 200ms;
            }
        }
        .icon:hover {
            transition: opacity .3s ease;
            opacity: 0.8;
            cursor: pointer;
        }
        .icon {
            display: flex;
            padding: 0px;
            align-items: center;
            justify-content: center;
            transition: background-color .3s ease;
        }
        kano-tooltip {
            box-sizing: border-box;
            --kano-tooltip: {
                overflow: hidden;
            };
        }
        button {
            @apply --layout-horizontal;
            @apply --layout-center;
            @apply --layout-center-justified;
            @apply --kano-button;
            background-color: #515151;
            padding: 8px 16px;
            cursor: pointer;
            margin-left: 9px;
            transition: background-color .3s ease;
            font-size: 12px;
            border-radius: 2px;
            text-shadow: none;
            font-family: var(--font-body);
        }
        button span.x {
            display: none;
        }
        button.open span.x {
            display: inline-block;
            transform: translate(0px, -2px);
        }
        .icon {
            width: 33px;
            height: 33px;
        }
        #play-pause-button {
            background: #7CC74C;
        }
        iron-icon {
            --iron-icon-width: 21px;
            --iron-icon-height: 21px;
        }
        ul {
            margin: 0px;
            padding: 16px 0px;
            color: black;
            min-width: 200px;
        }
        li {
            @apply --layout-vertical;
            @apply --layout-stretch;
        }
        .inline {
            @apply --layout-horizontal;
            @apply --layout-center;
            @apply --layout-start-justified;
            padding: 8px 12px;
            cursor: pointer;
            opacity: 0.6;
            background: transparent;
            color: black;
            text-transform: initial;
            margin-left: 0px;
            font-size: 16px;
            font-family: var(--font-body);
            transition: none;
            text-decoration: none;
        }
        ul li .inline:hover {
            opacity: 0.8;
            background: rgba(0, 0, 0, 0.2);
        }
        ul li .inline iron-icon {
            --iron-icon-width: 18px;
            --iron-icon-height: 18px;
            --iron-icon-fill-color: black;
            margin-right: 12px;
        }
    </style>
    <template>
        <button id="settings-button" type="button" class="icon settings" hidden$="[[!showSettings]]" on-tap="_settingsTapped">
            <iron-icon icon="settings"></iron-icon>
        </button>
        <div class="spacer" hidden$="[[!showSettings]]"></div>
        <div class="mouse-position" hidden$="[[mousePositionHidden(showMousePosition)]]">
            x: {{mouseX}}, y: {{mouseY}}
        </div>
        <div class="part-controls" hidden$="[[noPartControls]]">
            <button id="add-part-button" class$="{{_applyButtonClass(partsMenuOpen)}}" on-tap="_togglePartsMenu">
                <span>{{_computePartsMenuButtonLabel(partsMenuOpen)}}</span>
                <span class="x">&nbsp;&times;</span>
            </button>
            <button id="edit-layout-button" class$="{{_applyButtonClass(editableLayout)}}" on-tap="_editLayoutClicked">
                <span>[[_computeEditingButtonLabel(editableLayout)]]</span>
                <span class="x">&nbsp;&times;</span>
            </button>
        </div>
        <div class="player-bar" hidden$="[[noPlayerBar]]">
            <button class="icon" type="button" on-tap="fullscreenClicked">
                <img src="/assets/icons/fullscreen-icon.svg" alt="Fullscreen mode" />
            </button>
            <button class="icon" type="button" on-tap="resetClicked">
                <img src="/assets/icons/reset-icon.svg" alt="Reset app" />
            </button>
            <button class="icon" id="play-pause-button" type="button" on-tap="_runButtonClicked">
                <kano-animated-svg width="19" height="21" paths="[[makeButtonIconPaths]]" selected="{{_getRunningStatus(running)}}"></kano-animated-svg>
            </button>
        </div>
        <kano-tooltip id="tooltip" target="[[tooltipTarget]]" position="bottom">
            <ul>
                <li>
                    <button type="button" class="inline" on-tap="_reset">
                        <iron-icon src="/assets/icons/reset.png"></iron-icon>
                        <div>[[localize('RESET_WORKSPACE', 'Reset Workspace')]]</div>
                    </button>
                </li>
                <li>
                    <button type="button" class="inline" on-tap="_export">
                        <iron-icon src="/assets/icons/export.png"></iron-icon>
                        <div>[[localize('EXPORT', 'Export')]]</div>
                    </button>
                </li>
                <li>
                    <button type="button" class="inline" on-tap="_import">
                        <iron-icon src="/assets/icons/import.png"></iron-icon>
                        <div>[[localize('IMPORT', 'Import')]]</div>
                    </button>
                </li>
                <li>
                    <a href="https://insights.hotjar.com/s?siteId=119134&surveyId=9857" target="_blank" class="inline">
                        <iron-icon src="/assets/icons/feedback.png"></iron-icon>
                        <div>[[localize('GIVE_FEEDBACK', 'Give Feedback')]]</div>
                    </a>
                </li>
            </ul>
        </kano-tooltip>
    </template>
</dom-module>

<script type="text/javascript">
    /* globals Polymer, Kano */
    Polymer({
        is: 'kano-workspace-toolbar',
        behaviors: [Kano.Behaviors.AppElementRegistryBehavior, Kano.Behaviors.I18nBehavior],
        properties: {
            mouseX: {
                type: Number
            },
            mouseY: {
                type: Number
            },
            showMousePosition: {
                type: Boolean,
                value: false
            },
            running: {
                type: Boolean,
                value: false
            },
            editableLayout: {
                type: Boolean,
                value: false
            },
            partsMenuOpen: {
                type: Boolean,
                value: false
            },
            noPlayerBar: {
                type: Boolean,
                value: false
            },
            noPartControls: {
                type: Boolean,
                value: false
            },
            showSettings: {
                type: Boolean,
                value: false
            },
            tooltipOpened: {
                type: Boolean,
                value: false,
                observer: '_tooltipOpenStateChanged'
            }
        },
        ready () {
            this.makeButtonIconPaths = {
                stopped: 'M 4,18 10.5,14 10.5,6 4,2 z M 10.5,14 17,10 17,10 10.5,6 z',
                running: 'M 2,18 6,18 6,2 2,2 z M 11,18 15,18 15,2 11,2 z'
            };
            document.addEventListener('mousedown', (e) => {
                if (this.tooltipOpened) {
                    if (e.path && e.path.indexOf(this.$.tooltip) === -1) {
                        this._closeTooltip();
                    } else {
                        let cursor = e.target;
                        while (cursor.parentNode) {
                            if (cursor === this.$.tooltip) {
                                return;
                            }
                            cursor = cursor.parentNode;
                        }
                        this._closeTooltip();
                    }
                }
            });
        },
        attached () {
            this._registerElement('fullscreen-button', this.$['fullscreen-button']);
            this._registerElement('add-part-button', this.$['add-part-button']);
        },
        mousePositionHidden (show) {
            return !show;
        },
        fullscreenClicked (e) {
            this.fire('fullscreen-button-clicked');
        },
        _runButtonClicked (e) {
            this.fire('run-button-clicked');
        },
        resetClicked (e) {
            this.fire('reset-button-clicked');
        },
        _getRunningStatus (running) {
            return running ? 'running' : 'stopped';
        },
        _computeEditingButtonLabel (editableLayout) {
            return editableLayout ? this.localize('DONE', 'done') : this.localize('EDIT_LAYOUT', 'Edit Layout');
        },
        _editLayoutClicked () {
            this.fire('edit-layout-button-clicked');
        },
        _togglePartsMenu () {
            this.fire('toggle-parts-menu');
        },
        _computePartsMenuButtonLabel (open) {
            return open ? this.localize('CLOSE', 'close') : this.localize('ADD_PARTS', 'add parts');
        },
        _applyButtonClass (open) {
            return open ? 'open' : '';
        },
        _settingsTapped () {
            this._toggleTooltip();
        },
        _tooltipOpenStateChanged (openState) {
            openState ? this.$.tooltip.open() : this.$.tooltip.close();
        },
        _toggleTooltip () {
            this.tooltipTarget = this.$['settings-button'];
            this.tooltipOpened = !this.tooltipOpened;
        },
        _closeTooltip () {
            this.tooltipOpened = false;
        },
        _reset () {
            this.fire('iron-signal', { name: 'reset-workspace' });
        },
        _export () {
            this.fire('iron-signal', { name: 'export-app' });
        },
        _import () {
            this.fire('iron-signal', { name: 'import-app' });
        }
    });
</script>
