<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<dom-module id="kano-data-visualizer">
    <style>
    :host {
        display: block;
        overflow: hidden;
        @apply(--layout-vertical);
    }
    :host .speedy {
        @apply(--layout-flex);
        font-family: monospace;
        color: var(--kano-data-visualizer-color, white);
        word-wrap: break-word;
    }
    :host paper-progress {
        --paper-progress-active-color: var(--primary-color);
    }
    *[hidden] {
        display: none !important;
    }
    </style>
    <template>
        <paper-progress indeterminate hidden$="[[isProgressHidden(loading, hideProgress)]]"></paper-progress>
        <div class="speedy">[[scrollingText]]</div>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer */
    Polymer({
        is: 'kano-data-visualizer',
        properties: {
            for: {
                type: String
            },
            bufferLength: {
                type: Number,
                value: 15
            },
            loading: {
                type: Boolean,
                notify: true,
                value: false
            },
            hideProgress: {
                type: Boolean,
                value: false
            }
        },
        attached () {
            this.scrollingText = '';
            document.addEventListener('request', this.onRequest.bind(this));
            document.addEventListener('response', this.onResponse.bind(this));
        },
        isProgressHidden (loading, hideProgress) {
            return !loading || hideProgress;
        },
        onRequest (e) {
            let detail = e.detail;
            if (detail.id !== this.for) {
                return;
            }
            this.loading = true;
        },
        onResponse (e) {
            let detail = e.detail,
                res;
            if (detail.id !== this.for) {
                return;
            }
            this.loading = false;
            res = detail.res;
            res.text().then((content) => {
                this.typewrite(content, 0, Math.max(1, Math.round(content.length / 200)));
            });
        },
        typewrite (text, speed, chunkSize) {
            let scrolling = this.scrollingText;
            // The source is ended
            if (!text.length) {
                // The buffer is empty, we stop
                if(!scrolling.length) {
                    return;
                }
                // Remove a piece of the buffer
                scrolling = scrolling.substring(chunkSize);
                this.scrollingText = scrolling;
                // Call the next iteration
                setTimeout(() => {
                    this.typewrite('', speed, chunkSize);
                }, speed);
                return;
            }
            // Add the beginning of the text to the buffer, removing it from the text
            scrolling += text.slice(0, chunkSize);
            // The buffer is overflowing, only keep the last chars
            if (scrolling.length > this.bufferLength) {
                scrolling = scrolling.substring(scrolling.length - this.bufferLength, this.bufferLength);
            }
            // Apply the text
            this.scrollingText = scrolling;
            // Call the next iteration
            setTimeout(() => {
                this.typewrite(text.substring(chunkSize), speed, chunkSize);
            }, speed);
        }
    });
</script>
