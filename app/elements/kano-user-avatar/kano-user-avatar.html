<link rel="import" href="../kano-drop-down/kano-drop-down.html">
<link rel="import" href="../kano-circle-progress/kano-circle-progress.html">

<dom-module is="kano-user-avatar">
    <style>
        :host .user-avatar {
            margin: -10px 0;
            width: 45px;
            height: 45px;
            position: absolute;
            top: 14px;
            left: 4px;
            -webkit-filter: none;
            filter: none;
            border: 2px solid white;
            border-radius: 50%;
        }

        :host ::content kano-circle-progress svg {
            display: block;
            width: 53px;
            height: 53px;
        }

        :host ::content kano-circle-progress svg circle {
            stroke: var(--color-orange) !important;
        }

        :host ::content kano-circle-progress {
            width: 60px;
        }

        :host .progress-header {
            display: inline-block;
            border-radius: 100%;
            height: 60px;
            width: 60px;
        }

        :host ::content kano-drop-down b.notch.kano-drop-down {
            left: 25px;
        }

        :host ::content kano-drop-down .drop-down {
            top: 0;
        }

    </style>
    <template>
        <div style="position: relative">
            <div class='progress-header'>
                <kano-circle-progress value="[[progress]]"></kano-circle-progress>
                <img src='{{user.avatar.urls.circle}}' class="user-avatar"/>
            </div>
        </div>
        <kano-drop-down items="{{items}}"></kano-drop-down>
    </template>
    <script>
        class KanoUserAvatar {
            beforeRegister () {
                this.is = 'kano-user-avatar'
                this.properties = {
                    user: {
                        type: Object,
                        observer: 'showProgress'
                    },
                    app: Object,
                    progress: {
                        type: Number,
                        value: 0
                    }
                }
                this.levelsMap = {
                    "1": 0,
                    "2": 150,
                    "3": 300,
                    "4": 500,
                    "5": 800,
                    "6": 1300,
                    "7": 1600,
                    "8": 2200,
                    "9": 3000
                };
            }

        getProgress (xp) {
            let last = 0,
                lvl;

            for (lvl in this.levelsMap) {
                if (this.levelsMap.hasOwnProperty(lvl)) {
                    if (xp < this.levelsMap[lvl]) {
                        return [xp - last, this.levelsMap[lvl] - xp, this.levelsMap[lvl] - last];
                    }
                    last = this.levelsMap[lvl];
                }
            }

            return 0;
        }

        getPercent (xp) {
            let progress = this.getProgress(xp),
                covered = progress[0],
                leap = progress[2];

            return (covered * 100) / leap;
        }

        calculate (xp) {
            let current = '1',
                lvl;

            if (typeof xp !== 'number') {
                return null;
            }

            for (lvl in this.levelsMap) {
                if (this.levelsMap.hasOwnProperty(lvl)) {
                    if (xp < this.levelsMap[lvl]) {
                        return current;
                    }
                    current = lvl;
                }
            }

            return current;
        }

        showProgress () {
            if (!this.user) {
                this.progress = 0;
                return;
            }

            this.app.sdk.api.users.get.byUsername({ username: this.user.username })
                .then((res, d) => {
                    profile = res.body.user.profile;
                    progressPercent = this.getPercent(profile.xp) / 100;
                    this.level = parseInt(this.calculate(profile.xp), 10) || 0;

                    this.progress = progressPercent;

                    let items = [
                        {
                            name: this.user.username,
                            extra: `Level ${this.level}`,
                            url: `${this.app.config.WORLD_URL}/users/${this.user.username}`
                        },
                        {
                            name: 'Settings',
                            url: `${this.app.config.WORLD_URL}/accounts/settings`
                        },
                        {
                            name: 'Log out',
                            logout: true
                        }
                    ]

                    if (this.user.admin_level > 0) {
                        items.push({
                            name: 'Admin',
                            url: `${this.app.config.WORLD_URL}/admin`
                        })
                    }

                    this.set('items', items)

                });

        }
    }

    Polymer(KanoUserAvatar);
    </script>
</dom-module>
