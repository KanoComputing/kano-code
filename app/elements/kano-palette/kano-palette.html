<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/web-components/kano-icons/kano-icons.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../kano-tooltip/kano-tooltip.html">
<dom-module id="kano-palette">
    <style>
    :host {
        @apply --layout-horizontal;
        text-align: left;
    }
    :host .pen-control {
        margin-right: 24px;

    }
    .palette, .controls {
        @apply --layout-flex;
        text-align: left;
    }
    .palette-content {
        @apply --layout-horizontal;
        @apply --layout-wrap;
        @apply --layout-justified;
        width: 43px;
    }
    .palette-color, .pen-control button {
        width: 20px;
        height: 20px;
        margin-bottom: 3px;
        cursor: pointer;
        border: 1px solid transparent;
        box-sizing: border-box;
        position: relative;
    }
    .palette-color.selected {
        border-color: grey;
    }
    .palette-color.selected::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: 70% 70%;
        background-repeat: no-repeat;
        background-position: center;
        opacity: 0.7;
    }
    .palette-color.selected.fill::before {
        background-image: url(/assets/icons/bucket.svg);
    }
    .palette-color.selected.draw::before {
        background-image: url(/assets/icons/pencil.svg);
    }
    .add-color {
        background: transparent;
        color: grey;
        font-size: 22px;
        font-family: monospace;
        @apply --layout-vertical;
        @apply --layout-center;
        @apply --layout-center-justified;
    }
    .add-color:focus {
        outline: none;
        color: var(--color-orange);
    }
    .pen-control button {
        @apply --kano-button;
        @apply --layout-horizontal;
        @apply --layout-center-justified;
        width: 32px;
        height: 32px;
        padding: 0;
        background-color: var(--color-chateau);
    }
    .pen-control button iron-icon {
        --iron-icon-height: 20px;
        --iron-icon-width: 20px;
        fill: #999;
    }
    .pen-control iron-selector {
        @apply --layout-vertical;
    }
    .pen-control button:focus {
        outline: none;
    }
    .pen-control button.iron-selected {
        border-color: #fff;
    }
    :host label {
        display: inline-block;
        font-family: var(--font-body);
        font-size: 16px;
        font-weight: bold;
        color: rgba(255,255,255,0.5);
        margin-bottom: 24px;
        text-align: left;
    }
    kano-tooltip {
        --kano-tooltip-border-color: var(--color-dark);
        --kano-tooltip-background-color: var(--color-dark);
        --kano-tooltip-caret: {
            @apply(--shadow-elevation-2dp);
        };
    }
    </style>
    <template>
        <div class="pen-control">
            <label>Tools</label>
            <iron-selector selected="[[penType]]" attr-for-selected="name">
                <button on-tap="_penControlTapped" name="draw">
                    <iron-icon icon="kano-icons:paint-brush"></iron-icon>
                </button>
                <button on-tap="_penControlTapped" name="fill">
                    <iron-icon icon="kano-icons:paint-bucket"></iron-icon>
                </button>
            </iron-selector>
        </div>
        <div class="palette">
            <label>Colors</label>
            <div class="palette-content">
                <template is="dom-repeat" items="[[DEFAULT_PALETTE]]" as="color">
                    <div class$="palette-color [[_computePaletteItemSelectedClass(color, penColor)]] [[penType]]" style$="[[_computePaletteColor(color)]]" on-tap="_paletteItemTapped"></div>
                </template>
                <template is="dom-repeat" items="[[palette]]" as="color">
                    <div class$="palette-color [[_computePaletteItemSelectedClass(color, penColor)]] [[penType]]" style$="[[_computePaletteColor(color)]]" on-tap="_paletteItemTapped"></div>
                </template>
                <button class="palette-color add-color" on-tap="_openWheel" id="add-color">+</button>
            </div>
        </div>
        <kano-tooltip class="tooltip" position="right" id="tooltip" target="[[tooltipTarget]]" auto-close>
            <kano-color-wheel value="{{penColor}}" on-value-changed="_penColorChanged"></kano-color-wheel>
        </kano-tooltip>
    </template>
    <script type="text/javascript">
        Polymer({
            is: 'kano-palette',
            properties: {
                bitmaps: {
                    type: Array,
                    value: () => {
                        return [['#000000']];
                    },
                    observer: 'test'
                },
                penType: {
                    type: String,
                    computed: '_computePenType(_penType, _isShiftPressed)',
                    notify: true,
                },
                penColor: {
                    type: String,
                    notify: true
                }
            },
            test () {
                console.log('POO')
            },
            attached () {
                this._onKeyEvent = this._onKeyEvent.bind(this);
                document.addEventListener('keydown', this._onKeyEvent);
                document.addEventListener('keyup', this._onKeyEvent);
                this._penType = 'draw';
                this._isShiftPressed = false;
                this.previewButtonIconPaths = {
                    stopped: 'M 10,4 l 16, 12, 0, 0, -16, 12, z',
                    running: 'M 4,4 l 24, 0 0, 24, -24, 0, z'
                };
                this.previewState = 'stopped';
                this.DEFAULT_PALETTE = ['#ffffff', '#ce1124', '#fb823f', '#f7e548', '#44fb42', '#4397f9', '#f66af9',
                                '#8f35f7', '#000000', '#f85653', '#3ffde0'];
                this.previewIndex = 0;
            },
            detached () {
                document.removeEventListener('keydown', this._onKeyEvent);
                document.removeEventListener('keyup', this._onKeyEvent);
            },
            _computePenType (penType, shiftPressed) {
                console.log('pen type while computing is', penType)
                return shiftPressed ? 'fill' : penType;
            },
            _onKeyEvent (e) {
                this.set('_isShiftPressed', e.shiftKey);
            },
            _penControlTapped (e) {
                let target = e.currentTarget;
                this.set('_penType', target.getAttribute('name'));
            },
            _penColorChanged () {
                // this._computePalette();
                this._closeWheel();
            },
            _openWheel () {
                this.tooltipTarget = this.$['add-color'].getBoundingClientRect();
                this.$.tooltip.open();
            },
            _paletteItemTapped (e) {
                let color = e.model.get('color');
                this.set('penColor', color);
            },
            _closeWheel () {
                this.$.tooltip.close();
            },
            _computePaletteColor (color) {
                return `background: ${color}`;
            },
            _computePalette () {
                console.log('computing palette')
                this.debounce('palette', () => {
                    let palette = this.bitmaps.reduce((acc, bitmap) => {
                        return acc.concat(bitmap);
                    }, []);

                    palette.push(this.penColor);
                    
                    // Remove duplicates and color already in the default palette. Limit to 15 custom colors
                    palette = palette.filter((elem, pos, self) => {
                        return self.indexOf(elem) === pos && this.DEFAULT_PALETTE.indexOf(elem) === -1 &&
                                elem !== null && typeof elem !== 'undefined';
                    }).splice(-4, 4);

                    this.set('palette', palette);
                    if (!this.penColor) {
                        this.set('penColor', this.palette[0]);
                    }
                }, 16);
            },
            _computePaletteItemSelectedClass (color, penColor, penType) {
                return color === penColor ? 'selected' : '';
            }
        });
    </script>
</dom-module>
