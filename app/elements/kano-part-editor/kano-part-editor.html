<link rel="import" href="../kano-ui-editor/kano-ui-editor.html">
<link rel="import" href="../kano-data-editor/kano-data-editor.html">
<link rel="import" href="../kano-light-frame-editor/kano-light-frame-editor.html">
<link rel="import" href="../kano-light-animation-editor/kano-light-animation-editor.html">
<link rel="import" href="../kano-light-shape-configuration/kano-light-shape-configuration.html">
<dom-module id="kano-part-editor">
    <style>
    :host {
        display: block;
        position: relative;
        min-width: 85%;
        text-align: center;
        min-width: 80%;
        border-radius: 6px;
        @apply(--layout-vertical);
    }
    :host(.is-scrolled) #config-panel-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: lightgrey;
    }
    :host(.can-scroll:not(.scrolled-to-bottom)) #config-panel-container::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: lightgrey;
    }
    #config-panel-container {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        width: 100%;
        position: relative;
        margin-bottom: 24px;
    }
    kano-light-animation-editor {
        overflow-x: hidden;
    }
    #config-panel-container>* {
        overflow-y: auto;
        height: 100%;
        @apply(--layout-flex);
    }
    :host .title-bar {
        width: 90%;
        text-align: left;
        padding-bottom: 5px;
        @apply(--layout-horizontal);
        @apply(--layout-justified);
    }
    :host #element-name-editor {
        @apply(--kano-light-input);
        margin-left: 15px;
        border-bottom: 1px dotted var(--color-black, black);
    }
    :host #element-name-editor:focus {
        outline: none;
        border-bottom-color: var(--color-orange, orange);
    }
    :host .icon {
        cursor: pointer;
    }
    :host .delete-button {
        color: #de0f30;
    }
    :host #edit-icon {
        width: 20px;
        height: 20px;
    }
    </style>
    <template>
        <div class="title-bar">
            <div class="element-name-editor">
                <input id="element-name-editor" type="text" value="{{selected.name::keyup}}"
                on-keydown="enterQuitsInput">
            <label class="icon" for="element-name-editor">
                <iron-icon id="edit-icon" src="/assets/icons/layout-edit-icon.png"></iron-icon>
            </label>
            </div>

            <label class="icon delete-button" on-tap="_deletePart">delete
                <iron-icon  src="/assets/icons/layout-bin-icon.png"></iron-icon>
            </label>
        </div>
        <div id="config-panel-container"></div>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer */
    Polymer({
        is: 'kano-part-editor',
        behaviors: [Polymer.Templatizer],
        properties: {
            selected: {
                type: Object,
                notify: true
            },
            mode: {
                type: Object
            }
        },
        _instanceProps: {
            selected: true
        },
        observers: [
            '_configPanelChanged(selected.configPanel)',
            '_selectedChanged(selected.*)'
        ],
        _configPanelChanged (panel) {
            let tagName = panel || 'div',
                container = Polymer.dom(this.$['config-panel-container']),
                template = document.createElement('template');

            template.innerHTML = `<${tagName} id="${tagName.replace('kano-', '')}" mode="[[mode]]" selected="{{selected}}" element="{{selected}}"></${tagName}>`

            this.templatize(template);
            this.instance = this.stamp({
                mode: this.mode,
                selected: this.selected
            });

            this.scrollTarget = this.instance.root.firstChild;

            // Listen to scroll events on the part-editor to append the top/bottom divider
            this.scrollTarget.addEventListener('scroll', this._onScroll.bind(this));

            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            container.appendChild(this.instance.root);

            // Compute the scroll state next to remove the dividers from the eventual previous editor
            requestAnimationFrame(this._onScroll.bind(this));
        },
        _onScroll () {
            let target = this.scrollTarget;

            this.toggleClass('can-scroll', target.offsetHeight < target.scrollHeight);
            this.toggleClass('is-scrolled', target.scrollTop > 0);
            this.toggleClass('scrolled-to-bottom', target.scrollTop + target.offsetHeight >= target.scrollHeight);
        },
        _forwardInstancePath (inst, path, value) {
            this.set(path, value);
            this._parentProps = {};
        },
        _forwardInstanceProp (inst, prop, value) {
            this.set(prop, value);
        },
        _selectedChanged(e) {
            if (this.instance) {
                this.instance.set(e.path, e.value);
            }
        },
        _deletePart () {
            this.fire('delete-part', this.selected);
        },
        enterQuitsInput () {
            if (event.keyCode == 13) {
                this.blur();
                return false;
            }
        }
    });
</script>
