<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../kano-ui-editor/kano-ui-editor.html">
<link rel="import" href="../kano-data-editor/kano-data-editor.html">
<link rel="import" href="../behaviors/kano-i18n-behavior.html">
<dom-module id="kano-part-editor">
    <style>
    :host {
        position: relative;
        text-align: center;
        border-radius: 6px;
        min-width: 420px;
        flex: 1 0 auto;
        background-color: var(--color-dark);
        @apply --layout-vertical;
    }
    :host(.is-scrolled) #config-panel-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: lightgrey;
    }
    :host(.can-scroll:not(.scrolled-to-bottom)) #config-panel-container::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: lightgrey;
    }
    #config-panel-container {
        flex: 1 0 auto;
        display: flex;
        position: relative;
        box-sizing: border-box;
    }
    kano-light-animation-editor {
        overflow-x: hidden;
    }
    #config-panel-container>* {
        overflow-y: auto;
        flex: 1 0 auto;
    }
    :host .button-container {
        @apply --layout-flex;
        @apply --layout-horizontal;
        @apply --layout-end-justified;
    }
    :host .type-display {
        width: 80px;
        margin-right: 8px;
    }
    :host .title-bar {
        @apply --layout-horizontal;
        @apply --layout-start-justified;
        @apply --layout-center;
        text-align: left;
        font-family: var(--font-body);
        font-weight: bold;
        font-size: 18px;
        color: rgba(255,255,255,0.5);
        border-bottom: 1px solid #202428;
        padding: 0 48px 24px;
    }
    :host button {
        @apply --kano-button;
        @apply --layout-self-center;
        text-shadow: none;
        font-weight: bold;
    }
    :host .done-button {
        background-color: var(--color-grassland);
    }
    :host .done-button:hover {
        background-color: var(--color-apple);
    }
    :host .delete-button {
        background-color: var(--color-chateau);
        padding: 14px 16px 12px;
        margin-right: 24px;
    }
    :host .delete-button:hover {
        background-color: var(--color-abbey);   
    }
/*    #element-name-editor {
        width: 400px;
        margin: 0 32px;
        --paper-input-container-focus-color: var(--color-orange, orange);
        --paper-input-container-color: rgba(255,255,255,0.5);
        --paper-input-container-input-color: rgba(255,255,255,0.5);
        --paper-input-container: {
            font-size: 18px;
            padding: 0;
        };
    }*/
    :host .icon {
        cursor: pointer;
    }
    :host #edit-icon {
        width: 20px;
        height: 20px;
    }
    </style>
    <template>
        <div class="title-bar">
            <div class="type-display">[[selected.label]]</div>
            <!-- <paper-input id="element-name-editor" value="{{selected.name}}" on-keydown="enterQuitsInput"></paper-input> -->
            <div class="button-container">
                <button class="delete-button" type="button" on-tap="_deletePart" dialog-dismiss>Delete</button>
                <button class="done-button" type="button" dialog-dismiss>Done</button>
            </div>
        </div>
        <div id="config-panel-container"></div>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer */
    Polymer({
        is: 'kano-part-editor',
        behaviors: [
            Polymer.Templatizer,
            Kano.Behaviors.I18nBehavior
        ],
        properties: {
            selected: {
                type: Object,
                notify: true
            },
            mode: {
                type: Object
            }
        },
        _instanceProps: {
            selected: true
        },
        observers: [
            '_configPanelChanged(selected.configPanel)',
            '_selectedChanged(selected.*)'
        ],
        _configPanelChanged (panel) {
            let tagName = panel || 'div',
                container = Polymer.dom(this.$['config-panel-container']),
                template = document.createElement('template');

            // Add `kano-part-editor` class to simulate CSS processing of ShadyDOM
            template.innerHTML = `<${tagName} class="kano-part-editor" id="${tagName.replace('kano-', '')}" mode="[[mode]]" selected="{{selected}}" element="{{selected}}"></${tagName}>`

            this.templatize(template);
            this.instance = this.stamp({
                mode: this.mode,
                selected: this.selected
            });

            this.scrollTarget = this.instance.root.firstChild;

            // Listen to scroll events on the part-editor to append the top/bottom divider
            this.scrollTarget.addEventListener('scroll', this._onScroll.bind(this));

            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            container.appendChild(this.instance.root);

            // Compute the scroll state next to remove the dividers from the eventual previous editor
            requestAnimationFrame(this._onScroll.bind(this));
        },
        _onScroll () {
            let target = this.scrollTarget;

            this.toggleClass('can-scroll', target.offsetHeight < target.scrollHeight);
            this.toggleClass('is-scrolled', target.scrollTop > 0);
            this.toggleClass('scrolled-to-bottom', target.scrollTop + target.offsetHeight >= target.scrollHeight);
        },
        _forwardInstancePath (inst, path, value) {
            this.set(path, value);
            this._parentProps = {};
        },
        _forwardInstanceProp (inst, prop, value) {
            this.set(prop, value);
        },
        _selectedChanged(e) {
            if (this.instance) {
                this.instance.set(e.path, e.value);
            }
            // Let know the bindings that the `id` changed together with the name
            if (e.path === 'selected.name') {
                this.notifyPath('selected.id', this.selected.id);
            }
        },
        _deletePart () {
            this.fire('delete-part', this.selected);
        },
        enterQuitsInput () {
            if (event.keyCode == 13) {
                this.blur();
                return false;
            }
        }
    });
</script>
