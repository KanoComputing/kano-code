<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../kano-icons/kc-ui.html">
<link rel="import" href="../kano-ui-editor/kano-ui-editor.html">
<link rel="import" href="../kano-data-editor/kano-data-editor.html">
<link rel="import" href="../kano-light-shape-configuration/kano-light-shape-configuration.html">
<link rel="import" href="../kano-light-animation-part-editor/kano-light-animation-part-editor.html">
<link rel="import" href="../kano-light-frame-part-editor/kano-light-frame-part-editor.html">
<link rel="import" href="../kano-motion-sensor-part-editor/kano-motion-sensor-part-editor.html">
<link rel="import" href="../behaviors/kano-i18n-behavior.html">
<link rel="import" href="../behaviors/kano-media-query-behavior.html">
<link rel="import" href="../kano-code-shared-styles/kano-code-shared-styles.html">
<!--
@group Kano Elements
@hero hero.svg
@demo demo/kano-part-editor.html
-->
<dom-module id="kano-part-editor">
    <style include="kano-code-shared-styles">
        :host {
            @apply --layout-vertical;
            border: 1px solid #202428;
            border-radius: 6px;
            background: #292f35;
        }
        :host #config-panel-container {
            @apply --layout-vertical;
            flex: 1 0 auto;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
        }
        #config-panel-container > * {
            @apply --layout-vertical;
            flex: 1 1 auto;
        }
    </style>
    <template>
        <div id="config-panel-container"></div>
    </template>
</dom-module>
<script type="text/javascript">
    var colorThemes = {
        'ui': '#00d9c7',
        'data': '#9b61bd',
        'hardware': '#ef5285'
    }
    Polymer({
        is: 'kano-part-editor',
        behaviors: [
            Polymer.Templatizer,
            Kano.Behaviors.MediaQueryBehavior,
            Kano.Behaviors.I18nBehavior
        ],
        properties: {
            selected: {
                type: Object,
                notify: true,
                observer: '_selectedSet'
            },
            mode: {
                type: Object
            },
            theme: {
                type: String,
                computed: '_computeTheme(selected)'
            },
            name: {
                type: String,
                value: ''
            }
        },
        _instanceProps: {
            selected: true,
            name: true
        },
        observers: [
            '_configPanelChanged(selected.configPanel)',
            '_selectedChanged(selected.*)',
            '_updateName(selected)'
        ],
        _selectedChanged (e) {
            if (this.instance) {
                this.instance.set(e.path, e.value);
            }
        },
        _configPanelChanged (panel, oldValue) {
            let tagName = panel || 'div',
                container = Polymer.dom(this.$['config-panel-container']),
                template = document.createElement('template');

            this._updateName(this.selected);

            // Add `kano-part-editor` class to simulate CSS processing of ShadyDOM
            template.innerHTML = `<${tagName} class="kano-part-editor" id="${tagName.replace('kano-', '')}" mode="[[mode]]" selected="{{selected}}" element="{{selected}}" theme="[[theme]]" name="{{name}}"></${tagName}>`

            this.templatize(template);
            this.instance = this.stamp({
                mode: this.mode,
                theme: this.theme,
                name: this.name
            });

            this.scrollTarget = this.instance.root.firstChild;

            // Listen to scroll events on the part-editor to append the top/bottom divider
            this.scrollTarget.addEventListener('scroll', this._onScroll.bind(this));

            this._cleanContainer();

            container.appendChild(this.instance.root);

            // Compute the scroll state next to remove the dividers from the eventual previous editor
            requestAnimationFrame(this._onScroll.bind(this));
        },
        _computeTheme (selected) {
            if (!selected) {
                return;
            }
            const theme = colorThemes[selected.partType];
            return theme;
        },
        _updateName (selected) {
            if (!selected) {
                return;
            }
            this.set('name', selected.name);
        },
        _onScroll () {
            let target = this.scrollTarget;

            this.toggleClass('can-scroll', target.offsetHeight < target.scrollHeight);
            this.toggleClass('is-scrolled', target.scrollTop > 0);
            this.toggleClass('scrolled-to-bottom', target.scrollTop + target.offsetHeight >= target.scrollHeight);
        },
        _forwardInstancePath (inst, path, value) {
            this.set(path, value);
            this._parentProps = {};
        },
        _forwardInstanceProp (inst, prop, value) {
            this.set(prop, value);
        },
        enterQuitsInput () {
            if (event.keyCode == 13) {
                this.blur();
                return false;
            }
        },
        _cleanContainer () {
            let container = Polymer.dom(this.$['config-panel-container']);
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
        },
        _selectedSet (newValue, oldValue) {
            if (oldValue) {
                this.fire('config-panel-changed');
            }
        },
        stop () {
            this._cleanContainer();
        }
    });
</script>
