<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../kano-ui-editor/kano-ui-editor.html">
<link rel="import" href="../kano-data-editor/kano-data-editor.html">
<link rel="import" href="../behaviors/kano-i18n-behavior.html">
<link rel="import" href="../behaviors/kano-media-query-behavior.html">
<link rel="import" href="../kano-media-query/kano-media-query.html">
<link rel="import" href="../kano-code-shared-styles/kano-code-shared-styles.html">
<dom-module id="kano-part-editor">
    <style include="kano-code-shared-styles">
        :host {
            flex: 1 0 auto;
            position: relative;
            text-align: center;
            border-radius: 6px;
            background-color: var(--color-dark);
            @apply --layout-vertical;
        }
        :host #config-panel-container {
            @apply --layout-vertical;
            flex: 1 0 auto;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
        }
        :host #config-panel-container {
            width: 720px;
            padding: var(--kano-modal-content-padding-large);
        }
        :host([large-screen]) #config-panel-container {
            width: 540px;
            padding: var(--kano-modal-content-padding-large);
        }
        :host([medium-screen]) #config-panel-container {
            width: 380px;
            padding: var(--kano-modal-content-padding-small);
        }
        :host([small-screen]) #config-panel-container {
            width: 380px;
            padding: 16px;
        }
        :host(.large) #config-panel-container {
            width: 900px;
            padding: 0;
        }
        :host([medium-screen].large) #config-panel-container {
            width: 620px;
            padding: 0;
        }
        :host([small-screen].large) #config-panel-container {
            width: 100%;
            padding: 0;
        }
        #config-panel-container > * {
            @apply --layout-vertical;
            flex: 1 1 auto;
        }
        :host .button-container {
            @apply --layout-flex;
            @apply --layout-horizontal;
            @apply --layout-end-justified;
        }
        :host .type-display {
            width: 80px;
            margin-right: 32px;
            color: #fff;
        }
        :host([small-screen][with-name-editor]) .type-display {
            display: none;
        }
        :host .title-bar {
            flex: 1 0 auto;
            @apply --layout-horizontal;
            @apply --layout-start-justified;
            @apply --layout-center;
            text-align: left;
            font-family: var(--font-body);
            font-weight: bold;
            font-size: 16px;
            color: rgba(255,255,255,0.5);
            border-bottom: 1px solid #202428;
            padding: var(--kano-modal-header-padding-large);
        }
        :host([medium-screen]) .title-bar,
        :host([small-screen]) .title-bar {
            padding: var(--kano-modal-header-padding-small);
        }
        :host([small-screen]) .title-bar {
            padding: 16px;
        }
        :host([small-screen]) kano-input {
            width: 140px;
        }
        :host button {
            @apply --kano-button;
            @apply --layout-self-center;
            font-size: 14px;
            line-height: 14px;
            text-shadow: none;
            font-weight: bold;
            border-radius: 3px;
            padding: 12px 22px 10px;
        }
        :host button.done-button {
            background-color: var(--color-grassland);
        }
        :host button.done-button:hover {
            background-color: var(--color-sushi);
        }
        :host button.delete-button {
            background-color: var(--color-chateau);
            padding: 10px 16px 8px;
            margin-right: 24px;
            font-size: 12px;
        }
        :host([small-screen]) .delete-button {
            margin-right: 16px;
        }
        :host .delete-button:hover {
            background-color: var(--color-abbey);
        }
        :host .icon {
            cursor: pointer;
        }
        :host #edit-icon {
            width: 20px;
            height: 20px;
        }
        [hidden] {
          display: none !important;
        }
    </style>
    <template>
        <kano-media-query small-screen="{{smallScreen}}" medium-screen="{{mediumScreen}}" large-screen="{{largeScreen}}">
        </kano-media-query>
        <div class="title-bar">
            <div class="type-display">[[selected.label]]</div>
            <kano-input hidden$="[[!withNameEditor]]" type="text" label="Name" value="{{selected.name}}" no-label></kano-input>
            <div class="button-container">
                <button class="delete-button" type="button" on-tap="_deletePart" dialog-dismiss>Delete</button>
                <button class="done-button" type="button" dialog-dismiss>Done</button>
            </div>
        </div>
        <div id="config-panel-container"></div>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer */
    Polymer({
        is: 'kano-part-editor',
        behaviors: [
            Polymer.Templatizer,
            Kano.Behaviors.MediaQueryBehavior,
            Kano.Behaviors.I18nBehavior
        ],
        properties: {
            selected: {
                type: Object,
                notify: true
            },
            mode: {
                type: Object
            },
            withNameEditor: {
                type: Boolean,
                computed: '_needNameEditor(selected)',
                reflectToAttribute: true
            }
        },
        _instanceProps: {
            selected: true
        },
        observers: [
            '_configPanelChanged(selected.configPanel)',
            '_selectedChanged(selected.*)'
        ],
        _selectedChanged (e) {
            if (this.instance) {
                this.instance.set(e.path, e.value);
            }
            // Let know the bindings that the `id` changed together with the name
            if (e.path === 'selected.name') {
                this.notifyPath('selected.id', this.selected.id);
            }
        },
        _configPanelChanged (panel) {
            let tagName = panel || 'div',
                container = Polymer.dom(this.$['config-panel-container']),
                template = document.createElement('template');

            // Add `kano-part-editor` class to simulate CSS processing of ShadyDOM
            template.innerHTML = `<${tagName} class="kano-part-editor" id="${tagName.replace('kano-', '')}" mode="[[mode]]" selected="{{selected}}" element="{{selected}}"></${tagName}>`

            this.templatize(template);
            this.instance = this.stamp({
                mode: this.mode,
                selected: this.selected
            });

            this.scrollTarget = this.instance.root.firstChild;

            // Listen to scroll events on the part-editor to append the top/bottom divider
            this.scrollTarget.addEventListener('scroll', this._onScroll.bind(this));

            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            container.appendChild(this.instance.root);

            // Compute the scroll state next to remove the dividers from the eventual previous editor
            requestAnimationFrame(this._onScroll.bind(this));
        },
        _onScroll () {
            let target = this.scrollTarget;

            this.toggleClass('can-scroll', target.offsetHeight < target.scrollHeight);
            this.toggleClass('is-scrolled', target.scrollTop > 0);
            this.toggleClass('scrolled-to-bottom', target.scrollTop + target.offsetHeight >= target.scrollHeight);
        },
        _forwardInstancePath (inst, path, value) {
            this.set(path, value);
            this._parentProps = {};
        },
        _forwardInstanceProp (inst, prop, value) {
            this.set(prop, value);
        },
        _needNameEditor (selected) {
            return selected && selected.configPanel === 'kano-light-animation-editor';
        },
        _deletePart () {
            this.fire('delete-part', this.selected);
        },
        enterQuitsInput () {
            if (event.keyCode == 13) {
                this.blur();
                return false;
            }
        }
    });
</script>
