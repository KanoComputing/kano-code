<script src="../../bower_components/interact/interact.js"></script>
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../behaviors/kano-app-editor-behavior.html">
<link rel="import" href="../behaviors/kano-i18n-behavior.html">
<link rel="import" href="../behaviors/kano-app-element-registry-behavior.html">
<link rel="import" href="../kano-sidebar/kano-sidebar.html">
<link rel="import" href="../kano-animation/animations/from-big-animation.html">
<link rel="import" href="../kano-workspace/kano-workspace.html">
<link rel="import" href="../kano-part-editor/kano-part-editor.html">
<link rel="import" href="../kano-background-editor/kano-background-editor.html">
<link rel="import" href="../kano-root-view/kano-root-view.html">
<link rel="import" href="../kano-animated-svg/kano-animated-svg.html">
<link rel="import" href="../kano-bitmap-renderer/kano-bitmap-renderer.html">

<!--

`kano-app-editor`

Example:
    <kano-app-editor></kano-app-editor>

 The following custom properties and mixins are also available for styling:

 Custom property | Description | Default
 ----------------|-------------|----------

@group Kano Elements
@hero hero.svg
@demo ./demo/index.html
-->
<dom-module id="kano-app-editor">
    <style>
    :host {
        position: relative;
        display: block;
        @apply --layout-vertical;
    }
    :host section {
        @apply(--layout-horizontal-reverse);
        @apply(--layout-flex);
    }
    :host section #blocks-panel {
        position: relative;
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--kano-inset-box-shadow)
        min-width: 38%;
        max-width: 62%;
        width: 55%;
    }
    :host section #workspace-panel {
        position: relative;
        @apply(--layout-vertical);
        min-width: 38%;
        max-width: 62%;
        background-color: var(--kano-app-editor-workspace-background, #f2f2f2);
    }
    :host #workspace-panel kano-workspace {
        @apply(--layout-flex);
        padding: 10px 20px;
    }
    :host [main] {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        position: relative;
    }
    kano-root-view {
        @apply(--layout-flex);
    }
    :host #resize {
        position: absolute;
        width: 8px;
        top: 0px;
        bottom: 0px;
        right: -4px;
        cursor: ew-resize;
        background-color: transparent;
        z-index: 1;
    }
    :host .drawer {
        position: relative;
        @apply(--layout-vertical);
    }
    :host .drawer-content {
        @apply(--layout-flex);
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
    };
    :host .drawer-content > * {
        margin-top: 8%;
    }
    :host .drawer-content > kano-sidebar {
        @apply(--layout-flex);
        margin-top: 0px;
    }
    :host .close-drawer {
        position: absolute;
        top: 12px;
        right: 20px;
        background-color: var(--color-green, green);
        @apply(--kano-button);
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-center-justified);
    }
    :host .close-drawer .times {
        font-size: 25px;
        font-weight: 500;
        transform: translate(0px, -3px);
    }
    :host .hidden {
        visibility: hidden;
        opacity: 0;
    }
    paper-dialog {
        @apply --layout-horizontal;
        border-radius: 6px;
        padding: 24px 40px 24px 24px;
    }
    paper-dialog#dialog>iron-pages {
        @apply --layout-horizontal;
        @apply --layout-flex;
        margin: 0px;
        padding: 0px;
    }
    paper-dialog>iron-pages>div {
        @apply --layout-horizontal;
        @apply --layout-start;
        @apply --layout-flex;
        font-family: var(--font-body);
        color: #464646;
    }
    paper-dialog #modal-content {
        @apply --layout-flex;
    }
    paper-dialog #badge {
        padding: 12px;
        margin: 6px 28px 6px 4px;
        box-sizing: border-box;
        border-radius: 50%;
        background: #EA0923;
    }
    paper-dialog #badge iron-icon {
        transform: rotate(-9deg);
        --iron-icon-width: 24px;
        --iron-icon-height: 24px;
    }
    paper-dialog#dialog h2,
    paper-dialog#dialog h2 {
        font-family: var(--font-body);
        margin: 0px;
        font-weight: bold;
        color: black;
    }
    paper-dialog div#buttons {
        padding: 18px 0px 0px;
        @apply --layout-start-justified;
    }
    paper-dialog .buttons button {
        @apply --kano-button;
        border-radius: 3px;
        padding: 12px 22px;
        text-shadow: none;
        font-size: 14px;
        min-height: 32px;
        font-weight: bold;
        min-width: 80px;
        color: #8D8D8D;
        background: #E1E1E1;
    }
    paper-dialog .buttons button:not(:first-of-type) {
        margin-left: 7px;
    }
    paper-dialog .buttons .confirm {
        background: #EA0923;
        color: white;
    }

    #partsPanel {
        --paper-drawer-panel-drawer-container: {
            box-shadow: none !important;
        };
    }
    .editor {
        position: relative;
    }
    #edit-part-dialog {
        @apply --layout-vertical;
        overflow: auto;
    }
    #edit-part-dialog kano-part-editor {
        flex: 1 0 auto;
        min-width: 420px;
    }
    #edit-part-dialog .icon-button {
        position: absolute;
        right: 0;
        top: 0;
    }
    .code-overlay {
        @apply --layout-fit;
        background: #414a51;
        opacity: 0;
        transition: opacity 200ms linear;
        pointer-events: none;
    }
    .code-overlay.open {
        opacity: 0.85;
    }
    .icon-button {
        background: transparent;
        border: 0px;
        cursor: pointer;
    }
    </style>
    <template>
        <section id="section" on-mousemove="mouseMoved" on-mouseup="completedResizing">
            <div class="ui-edition" id="workspace-panel">
                <kano-workspace id="workspace"
                                class="visible-when-running"
                                parts="{{addedParts}}"
                                selected="{{selected}}"
                                running="{{running}}"
                                editable-layout="{{editableLayout}}"
                                code="[[code]]"
                                mode="[[mode]]"
                                background="[[background.userStyle.background]]"
                                parts-menu-open="[[partsMenuOpen]]"
                                challenge-state="{{challengeState}}"
                                on-ui-ready="workspaceUiReady"
                                on-open-settings="onPartSettings"
                                on-close-settings="closeSettings"
                                on-change="_proxyChange"
                                on-run-button-clicked="_runButtonClicked"
                                on-reset-app-state="_resetAppState"
                                on-toggle-parts-menu="toggleParts"
                                on-settings-button-clicked="toggleMenu"
                                on-save-button-clicked="share"></kano-workspace>
            </div>
            <div name="code" class="editor" id="blocks-panel">
                <div id="resize" on-mousedown="resizeWorkspace" class="visible-when-running"></div>
                <paper-drawer-panel
                    id="partsPanel"
                    force-narrow
                    disable-edge-swipe
                    disable-swipe
                    right-drawer
                    selected="{{partsPanelState}}"
                    drawer-width="{{drawerWidth}}">
                    <div main class="main">
                        <slot name="above-code"></slot>
                        <kano-root-view
                            id="root-view"
                            parts="{{addedParts}}"
                            code="{{code}}"
                            mode="[[mode]]"
                            on-change="_proxyChange"
                            default-categories="{{defaultCategories}}"
                            loading$="[[!modeReady]]"></kano-root-view>
                        <slot name="under-code"></slot>
                        <div id="code-overlay" class="code-overlay"></div>
                    </div>
                    <div class="drawer animatable" drawer id="drawer">
                        <iron-pages selected="{{drawerPage}}" attr-for-selected="id" class="drawer-content">
                            <kano-sidebar
                                id="sidebar"
                                ui-elements="{{parts}}"
                                name="parts"
                                on-done="toggleParts"
                                parts="[[addedParts]]"
                                on-ui-ready="onPartReady"></kano-sidebar>
                            <kano-part-editor
                                selected="{{selected}}"
                                mode="[[mode]]"
                                class="tooltip-content"
                                on-delete-part="deletePartClicked"
                                id="part-editor"></kano-part-editor>
                            <kano-background-editor
                                class="tooltip-content"
                                id="background-editor"
                                mode="[[mode.id]]"
                                background="{{background}}"
                                name="background"></kano-background-editor>
                        </iron-pages>
                    </div>
                </paper-drawer-panel>
            </div>
        </section>
        <paper-dialog id="dialog" entry-animation="from-big-animation" with-backdrop on-iron-overlay-closed="_modalClosed">
            <iron-pages attr-for-selected="name" selected="[[dialogPage]]">
                <div name="confirm-delete">
                    <div id="badge">
                        <iron-icon src="/assets/icons/exclamation.svg"></iron-icon>
                    </div>
                    <div id="modal-content">
                        <h2>[[localize('ARE_YOU_SURE', 'Are you sure')]]</h2>
                        <div>[[localize('ABOUT_TO_DELETE', 'You are about to delete')]] '[[toBeRemoved.name]]'</div>
                        <div>[[localize('WANT_TO_DO_THIS', 'Are you sure you want to do this?')]]</div>
                        <div class="buttons" id="buttons">
                            <button dialog-confirm class="confirm">[[localize('Confirm', 'Confirm')]]</button>
                            <button dialog-dismiss class="cancel">[[localize('CANCEL', 'Cancel')]]</button>
                        </div>
                    </div>
                </div>
                <div name="external-use-warning">
                    <div id="badge">
                        <iron-icon src="/assets/icons/exclamation.svg"></iron-icon>
                    </div>
                    <div id="modal-content">
                        <h2>[[localize('OH_OH', 'Oh oh')]]&hellip;</h2>
                        <div>[[localize('CANT_DELETE', 'You can\'t delete')]] '[[toBeRemoved.name]]' [[localize('USED_IN_CODE', 'because it is used in the code')]]</div>
                        <div class="buttons" id="buttons">
                            <button dialog-dismiss class="cancel">[[localize('CANCEL', 'Cancel')]]</button>
                        </div>
                    </div>
                </div>
                <div name="reset-warning">
                    <div id="badge">
                        <iron-icon src="/assets/icons/exclamation.svg"></iron-icon>
                    </div>
                    <div id="modal-content">
                        <h2>[[localize('RESET', 'Reset')]]</h2>
                        <div>[[localize('ABOUT_TO_RESET', 'You\'ll lose any unsaved changes')]]</div>
                        <div class="buttons" id="buttons">
                            <button dialog-confirm class="confirm">[[localize('Confirm', 'Confirm')]]</button>
                            <button dialog-dismiss class="cancel">[[localize('CANCEL', 'Cancel')]]</button>
                        </div>
                    </div>
                </div>
            </iron-pages>
        </paper-dialog>
        <paper-dialog id="edit-part-dialog" fit-into="[[codeEditor]]" entry-animation="from-big-animation" on-iron-overlay-closed="_partEditorDialogClosed">
            <button class="icon-button" type="button" dialog-dismiss>
                <iron-icon icon="close"></iron-icon>
            </button>
            <kano-part-editor
                selected="{{selected}}"
                mode="[[mode]]"
                class="tooltip-content"
                on-delete-part="deletePartClicked"
                hide-delete-button
                id="part-editor"></kano-part-editor>
        </paper-dialog>
        <iron-signals on-iron-signal-export-app="_exportApp">
        <iron-signals on-iron-signal-import-app="_importApp">
        <iron-signals on-iron-signal-reset-workspace="reset">
        <iron-a11y-keys target="[[target]]" keys="alt+p" on-keys-pressed="toggleParts"></iron-a11y-keys>
        <iron-a11y-keys target="[[target]]" keys="alt+s" on-keys-pressed="share"></iron-a11y-keys>
    </template>
</dom-module>

<script src="./kano-app-editor.js"></script>
