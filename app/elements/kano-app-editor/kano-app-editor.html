<script src="../../bower_components/interact/interact.js"></script>
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../behaviors/kano-app-editor-behavior.html">
<link rel="import" href="../kano-sidebar/kano-sidebar.html">
<link rel="import" href="../kano-workspace/kano-workspace.html">
<link rel="import" href="../kano-part-editor/kano-part-editor.html">
<link rel="import" href="../kano-background-editor/kano-background-editor.html">
<link rel="import" href="../kano-root-view/kano-root-view.html">
<link rel="import" href="../kano-animated-svg/kano-animated-svg.html">
<link rel="import" href="../kano-bitmap-renderer/kano-bitmap-renderer.html">

<dom-module id="kano-app-editor">
    <style>
    :host {
        position: relative;
        display: block;
        @apply(--layout-vertical);
    }
    :host section {
        @apply(--layout-horizontal);
        @apply(--layout-flex);
    }
    :host section #right-panel {
        position: relative;
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--kano-inset-box-shadow)
        min-width: 38%;
        max-width: 62%;
        width: 62%;
    }
    :host section #left-panel {
        position: relative;
        @apply(--layout-vertical);
        @apply(--kano-box-shadow);
        min-width: 38%;
        max-width: 62%;
        background-color: var(--color-dark, black);
    }
    :host #left-panel kano-workspace {
        @apply(--layout-flex);
        padding: 10px;
    }
    :host [main] {
        @apply(--layout-vertical);
        @apply(--layout-flex);
    }
    :host kano-root-view {
        @apply(--layout-flex);
    }
    :host #resize {
        position: relative;
        width: 8px;
        cursor: ew-resize;
        background-color: rgba(0, 0, 0, 0.11);
    }
    #resize .handle {
        position: absolute;
        background-color: #404040;
        width: 16px;
        height: 38px;
        border: 2px solid #616161;
        border-radius: 5px;
        top: calc(50% - 19px);
        left: -8px;
        box-sizing: border-box;
    }
    :host #resize .handle::before,
    :host #resize .handle::after {
        content: '';
        position: absolute;
        top: calc(50% - 5px);
        width: 2px;
        border-radius: 1px;
        height: 10px;
        background-color: white;
    }
    :host #resize .handle::before {
        left: 3px;
    }
    :host #resize .handle::after {
        right: 3px;
    }
    :host .root-view-wrapper {
        position: relative;
        @apply(--layout-vertical);
        @apply(--layout-flex);
    }
    :host .share-button {
        @apply(--kano-button);
        background-color: var(--color-orange, orange);
        position: absolute;
        top: 20px;
        right: 20px;
    }
    :host .menu {
        position: absolute;
        top: 10px;
        left: 10px;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        @apply(--kano-icon-button);
        cursor: pointer;
    }
    :host .menu iron-image {
        width: 25px;
        height: 25px;
    }
    :host .parts-toggle {
        position: absolute;
        @apply(--layout-horizontal);
        right: 5px;
        bottom: 20px;
    }
    :host .parts-toggle label {
        margin: auto 0;
        display: block;
        color: #a4a4a4;
    }
    :host .parts-toggle button span {
        font-size: 60px;
        transform: translate(0px, -8px) rotate(0deg);
        text-shadow: 1px 1px 0 #57b40c;
        transition: 0.3s;

        display: block;
        margin: auto 10px;
    }
    :host .parts-toggle.open button span {
        transform: translate(6px, -6px) rotate(45deg);
    }
    :host .parts-toggle.open button {
        background: var(--color-green);
    }
    :host .make-button,
    :host .parts-toggle button {
        @apply(--kano-round-button);
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        box-shadow: none;
        margin: auto 10px;
        width: 70px;
        height: 70px;
    }
    :host .parts-toggle button {
        background: var(--color-green);
        border: 4px solid #57b40c;
    }
    :host .make-button.stopped {
        border: 4px solid #fb592b;
        background: #fc823f;
    }
    :host .make-button.running {
        border: 4px solid #e63533;
        background: var(--color-red, red);
    }
    :host .make-button {
        position: absolute;
        top: 10px;
        right: 5px;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
    }
    .make-button kano-animated-svg {
        @apply(--layout-flex);
        width: 17px;
        height: 21px;
        /* Firefox centering */
        margin: 0 auto;
        -webkit-filter: drop-shadow(0px 2px 0px rgba(0, 0, 0, 0.25));
        filter: drop-shadow(0px 2px 0px rgba(0, 0, 0, 0.25));
        --kano-animated-path: {
            fill: white;
            stroke: white;
            stroke-width: 2px;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all ease-in-out 200ms;
        }
    }
    :host .drawer {
        position: relative;
        @apply(--layout-vertical);
    }
    :host .drawer-content {
        @apply(--layout-flex);
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
    };
    :host .drawer-content > * {
        margin-top: 8%;
    }
    :host .drawer-content > kano-sidebar {
        @apply(--layout-flex);
        margin-top: 0px;
    }
    :host .close-drawer {
        position: absolute;
        top: 12px;
        right: 20px;
        background-color: var(--color-green, green);
        @apply(--kano-button);
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-center-justified);
    }
    :host .close-drawer .times {
        font-size: 25px;
        font-weight: 500;
        transform: translate(0px, -3px);
    }
    :host h1#app-title {
        position: absolute;
        top: 14px;
        left: 55px;
        color: var(--color-white, white);
        margin: 0;
        font-size: 18px;
    }
    :host .elevate {
        z-index: 101;
    }
    :host .hidden {
        visibility: hidden;
        opacity: 0;
    }
    paper-dialog .buttons button {
        @apply(--kano-button);
        margin-left: 5px;
    }
    paper-dialog .buttons .confirm {
        background-color: var(--color-red, red);
    }
    .pause-overlay {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
    }
    .pause-overlay iron-image {
        width: 40%;
        height: 40%;
        z-index: 1;
        cursor: pointer;
    }
    .editable-layout {
        opacity: 0.5;
        pointer-events: none;
    }
    *[hidden] {
        display: none !important;
    }
    </style>
    <template>
        <section id="section" on-mousemove="mouseMoved" on-mouseup="completedResizing">
            <div class="ui-edition" id="left-panel">
                <div class="pause-overlay" hidden$="[[_isPauseOverlayHidden(running, editableLayout)]]">
                    <iron-image src="/assets/icons/play-btn-overlay.svg" sizing="contain" on-tap="_runButtonClicked"></iron-image>
                </div>
                <kano-workspace id="workspace"
                                class="visible-when-running"
                                on-ui-ready="workspaceUiReady"
                                parts="{{addedParts}}"
                                selected="{{selected}}"
                                on-open-settings="onPartSettings"
                                on-close-settings="closeSettings"
                                on-change="_proxyChange"
                                running="{{running}}"
                                editable-layout="{{editableLayout}}"
                                code="[[code]]"
                                mode="[[mode]]"
                                background="[[background.userStyle.background]]"></kano-workspace>
                <div class$="parts-toggle {{applyOpenClass(partsPanelState, drawerPage)}}">
                    <label>{{partsMenuLabel(partsPanelState, drawerPage)}}</label>
                    <button type="button" class="parts-button" on-tap="toggleParts" id="add-part-button">
                        <span>+</span>
                    </button>
                </div>
                <button class="menu"
                        type="button"
                        on-tap="toggleMenu"
                        id="toggle-menu-button">
                    <iron-image src="/assets/icons/menu.png" sizing="contain"></iron-image>
                </button>
                <h1 id="app-title">{{title}}</h1>
                <button type="button"
                    class$="make-button visible-when-running [[getMakeButtonClass(running, editableLayout)]]"
                    on-tap="_runButtonClicked"
                    id="make-button">
                    <kano-animated-svg width="19" height="21" paths="[[makeButtonIconPaths]]" selected="{{_getRunningStatus(running)}}">
                    </kano-animated-svg>
                </button>
            </div>
            <div id="resize" on-mousedown="resizeWorkspace" class="visible-when-running">
                <div class="handle"></div>
            </div>
            <div name="code" class="editor" id="right-panel">
                <paper-drawer-panel
                    id="partsPanel"
                    force-narrow
                    disable-edge-swipe
                    disable-swipe
                    selected="{{partsPanelState}}"
                    drawer-width="{{drawerWidth}}">
                    <div main>
                        <kano-root-view
                            id="root-view"
                            parts="{{addedParts}}"
                            code="{{code}}"
                            mode="[[mode]]"
                            on-change="_proxyChange"
                            default-categories="{{defaultCategories}}"></kano-root-view>
                        <button type="button" class="share-button" on-tap="share" id="share-button" hidden$="[[!showShareButton]]">Share App</button>
                        <content></content>
                    </div>
                    <div class="drawer animatable" drawer id="drawer">
                        <iron-pages selected="{{drawerPage}}" attr-for-selected="id" class="drawer-content">
                            <kano-sidebar
                                id="sidebar"
                                ui-elements="{{parts}}"
                                name="parts"
                                on-done="toggleParts"
                                parts="[[addedParts]]"
                                on-ui-ready="onPartReady"></kano-sidebar>
                            <kano-part-editor
                                selected="{{selected}}"
                                mode="[[mode]]"
                                class="tooltip-content"
                                on-delete-part="deletePartClicked"
                                id="part-editor"></kano-part-editor>
                            <kano-background-editor
                                class="tooltip-content"
                                id="background-editor"
                                background="{{background}}"
                                name="background"></kano-background-editor>
                        </iron-pages>
                    </div>
                </paper-drawer-panel>
            </div>
        </section>
        <paper-dialog id="confirm-delete" with-backdrop on-iron-overlay-closed="modalClosed">
            <h2>Delete Part</h2>
            <div class="modal-content">
                <div>You are about to delete '[[selected.name]]'</div>
                <div>Are you sure you want to do this?</div>
            </div>
            <div class="buttons">
                <button dialog-dismiss class="cancel">Cancel</button>
                <button dialog-confirm class="confirm">Confirm</button>
            </div>
        </paper-dialog>
        <paper-dialog id="external-use-warning" with-backdrop>
            <h2>Delete Part</h2>
            <div class="modal-content">
                <div>You can't delete '[[selected.name]]' because it is used in the code</div>
            </div>
            <div class="buttons">
                <button dialog-dismiss class="cancel">Cancel</button>
            </div>
        </paper-dialog>
        <iron-signals on-iron-signal-export-app="_exportApp">
        <iron-signals on-iron-signal-import-app="_importApp">
        <iron-signals on-iron-signal-reset-workspace="reset">
        <iron-a11y-keys target="[[target]]" keys="alt+p" on-keys-pressed="toggleParts"></iron-a11y-keys>
        <iron-a11y-keys target="[[target]]" keys="cmd+shift+s ctrl+shift+s" on-keys-pressed="share"></iron-a11y-keys>
    </template>
</dom-module>

<script src="./kano-app-editor.js"></script>
