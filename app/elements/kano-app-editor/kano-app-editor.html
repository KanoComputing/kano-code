<script src="../../bower_components/interact/interact.js"></script>
<script src="../../bower_components/js-beautify/js/lib/beautify.js"></script>
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-overlay-behavior/iron-overlay-backdrop.html">
<link rel="import" href="../behaviors/kano-app-editor-behavior.html">
<link rel="import" href="../behaviors/kano-media-query-behavior.html">
<link rel="import" href="../behaviors/kano-i18n-behavior.html">
<link rel="import" href="../behaviors/kano-app-element-registry-behavior.html">
<link rel="import" href="../kano-animation/animations/from-big-animation.html">
<link rel="import" href="../kano-media-query/kano-media-query.html">
<link rel="import" href="../kano-workspace/kano-workspace.html">
<link rel="import" href="../kano-part-editor/kano-part-editor.html">
<link rel="import" href="../kano-background-editor/kano-background-editor.html">
<link rel="import" href="../kano-root-view/kano-root-view.html">
<link rel="import" href="../kano-animated-svg/kano-animated-svg.html">
<link rel="import" href="../kano-bitmap-renderer/kano-bitmap-renderer.html">
<link rel="import" href="../kano-code-display/kano-code-display.html">
<link rel="import" href="../kano-add-parts/kano-add-parts.html">
<link rel="import" href="../kano-animation/animations/from-big-animation.html">
<link rel="import" href="../kano-style/dialog.html">
<!--
`kano-app-editor`
Example:
    <kano-app-editor></kano-app-editor>
 The following custom properties and mixins are also available for styling:
 Custom property | Description | Default
 ----------------|-------------|----------
@group Kano Elements
@hero hero.svg
@demo ./demo/index.html
-->
<dom-module id="kano-app-editor">
    <style include="kano-style-dialog">
        :host {
            @apply --layout-vertical;
            position: relative;
            max-width: 100vw;
        }
        :host([lockdown]) {
            pointer-events: none;
        }
        /*Don't apply lockdown on topbar*/
        :host([lockdown]) ::slotted(*) {
            pointer-events: auto;
        }
        :host section {
            @apply --layout-horizontal-reverse;
            @apply --layout-flex;
        }
        :host section #blocks-panel {
            @apply --layout-flex-auto;
            @apply --layout-vertical;
            @apply --kano-inset-box-shadow;
            position: relative;
            min-width: 50%;
            max-width: 70%;
        }
        :host section #workspace-panel {
            @apply --layout-vertical;
            position: relative;
            min-width: 33%;
            max-width: 50%;
            width: 33%;
            background-color: var(--kano-app-editor-workspace-background, #f2f2f2);
        }
        .tab-selector {
            --paper-tabs: {
                height: 32px;
                background-color: var(--kano-app-editor-workspace-background, #f2f2f2);
            };
            --paper-tabs-selection-bar: {
                border-bottom: none;
            };
        }
        .tab-selector .tab {
            --paper-tab: {
                width: 50%;
                color: #fff;
                font-family: var(--font-body);
                font-weight: bold;
                text-transform: uppercase;
                padding: 0;
                border-top: 1px solid var(--kano-app-editor-workspace-background, #f2f2f2);
                border-left: 1px solid var(--kano-app-editor-workspace-background, #f2f2f2);
                padding: 0;
            };
            --paper-tab-content: {
                padding: 0 8px;
            };
            --paper-tab-content-unselected: {
                color: rgba(255, 255, 255, 0.5);
                background-color: var(--color-abbey);
            };
            --paper-tab-ink: var(--color-dark);
        }
        :host iron-pages.workspace-pages {
            @apply --layout-vertical;
            @apply --layout-flex;
            overflow-y: auto;
        }
        :host #workspace-panel kano-workspace {
            @apply --layout-flex;
        }
        :host kano-code-display {
            @apply --flex-layout;
            margin: 16px;
        }
        :host [main] {
            @apply --layout-vertical;
            @apply --layout-flex;
            position: relative;
        }
        kano-root-view {
            @apply --layout-flex;
        }
        :host #resize {
            position: absolute;
            width: 8px;
            top: 0px;
            bottom: 0px;
            right: -4px;
            cursor: ew-resize;
            background-color: transparent;
            z-index: 1;
        }
        :host .hidden {
            visibility: hidden;
            opacity: 0;
        }
        .editor {
            position: relative;
        }
        #edit-part-dialog {
            @apply --layout-vertical;
            @apply --layout-flex-auto;
            background-color: transparent;
            flex-shrink: 0;
            overflow: hidden;
            font-weight: bold;
            color: #fff;
        }
        .modal {
            width: 427px;
        }
        .large-modal {
            width: 880px;
        }
        :host([small-screen]) #edit-part-dialog,
        :host([small-screen]) #edit-background-dialog {
            width: 100%;
            left: -32px !important;
        }
        :host #edit-part-dialog-content,
        :host #background-editor {
            margin: 0;
        }
        .code-overlay {
            @apply --layout-fit;
            background: #414a51;
            opacity: 0;
            transition: opacity 200ms linear;
            pointer-events: none;
        }
        .code-overlay.open {
            opacity: 0.85;
        }
        .icon-button {
            background: transparent;
            border: 0px;
            cursor: pointer;
        }
        paper-dialog#parts-modal {
            padding: 0px;
            border-radius: 6px;
        }
        kano-add-parts#add-parts {
            margin: 0px;
            font-family: var(--font-body);
        }
        paper-dialog#dialog {
            background-color: #fff;
        }
        paper-dialog#dialog>iron-pages {
            @apply --layout-horizontal;
            @apply --layout-flex;
        }
        paper-dialog#dialog>iron-pages>div {
            @apply --layout-horizontal;
            @apply --layout-start;
            @apply --layout-flex;
            font-family: var(--font-body);
            color: #292f35;
        }
        paper-dialog#dialog>iron-pages>h2 {
            color: #000;
        }
        paper-dialog .buttons .confirm {
            background: #EA0923;
            color: white;
        }
    </style>
    <template>
        <kano-media-query small-screen="{{smallScreen}}" medium-screen="{{mediumScreen}}" large-screen="{{largeScreen}}">
        </kano-media-query>

        <iron-overlay-backdrop id="backdrop" on-click="_onLockdownClicked"></iron-overlay-backdrop>
        <section id="section" on-mousemove="mouseMoved" on-mouseup="completedResizing">
            <div class="ui-edition" id="workspace-panel">
                <template is="dom-if" if="[[modeReady]]">
                    <paper-tabs class="tab-selector" attr-for-selected="id" selected="{{workspaceTab}}" autoselect>
                        <paper-tab id="workspace" class="tab">Canvas</paper-tab>
                        <paper-tab id="code-display" class="tab">JavaScript</paper-tab>
                    </paper-tabs>
                </template>
                <iron-pages class="workspace-pages" attr-for-selected="id" selected="[[workspaceTab]]">
                    <kano-workspace id="workspace"
                                    class="visible-when-running"
                                    parts="{{addedParts}}"
                                    selected="{{selected}}"
                                    running="{{running}}"
                                    editable-layout="{{editableLayout}}"
                                    code="[[code]]"
                                    mode="[[mode]]"
                                    background="[[background.userStyle.background]]"
                                    parts-menu-open="[[partsMenuOpen]]"
                                    challenge-state="{{challengeState}}"
                                    on-open-settings="onPartSettings"
                                    on-ui-ready="workspaceUiReady"
                                    on-change="_proxyChange"
                                    on-run-button-clicked="_runButtonClicked"
                                    on-reset-app-state="_resetAppState"
                                    on-toggle-parts-menu="toggleParts"></kano-workspace>
                    <kano-code-display id="code-display" code="[[_setCodeDisplay(code.snapshot.javascript, workspaceTab)]]" lang="javascript"></kano-code-display>
                </iron-pages>
            </div>
            <div name="code" class="editor" id="blocks-panel">
                <div id="resize" on-mousedown="resizeWorkspace" class="visible-when-running"></div>
                <div main class="main">
                    <slot name="above-code"></slot>
                    <kano-root-view
                        id="root-view"
                        parts="{{addedParts}}"
                        code="{{code}}"
                        mode="[[mode]]"
                        on-change="_proxyChange"
                        default-categories="{{defaultCategories}}"
                        loading$="[[!modeReady]]"></kano-root-view>
                    <slot name="under-code"></slot>
                    <div id="code-overlay" class="code-overlay"></div>
                </div>
            </div>
        </section>
        <paper-dialog id="dialog" entry-animation="from-big-animation" with-backdrop on-iron-overlay-closed="_modalClosed">
            <iron-pages attr-for-selected="name" selected="[[dialogPage]]">
                <div name="confirm-delete">
                    <div id="badge">
                        <iron-icon src="/assets/icons/exclamation.svg"></iron-icon>
                    </div>
                    <div id="dialog-content">
                        <h2>[[localize('ARE_YOU_SURE', 'Are you sure')]]</h2>
                        <div>[[localize('ABOUT_TO_DELETE', 'You are about to delete')]] '[[toBeRemoved.name]]'</div>
                        <div>[[localize('WANT_TO_DO_THIS', 'Are you sure you want to do this?')]]</div>
                        <div class="buttons" id="buttons">
                            <button dialog-confirm class="confirm">[[localize('Confirm', 'Confirm')]]</button>
                            <button dialog-dismiss class="cancel">[[localize('CANCEL', 'Cancel')]]</button>
                        </div>
                    </div>
                </div>
                <div name="external-use-warning">
                    <div id="badge">
                        <iron-icon src="/assets/icons/exclamation.svg"></iron-icon>
                    </div>
                    <div id="dialog-content">
                        <h2>[[localize('OH_OH', 'Oh oh')]]&hellip;</h2>
                        <div>[[localize('CANT_DELETE', 'You can\'t delete')]] '[[toBeRemoved.name]]' [[localize('USED_IN_CODE', 'because it is used in the code')]]</div>
                        <div class="buttons" id="buttons">
                            <button dialog-dismiss class="cancel">[[localize('CANCEL', 'Cancel')]]</button>
                        </div>
                    </div>
                </div>
                <div name="reset-warning">
                    <div id="badge">
                        <iron-icon src="/assets/icons/exclamation.svg"></iron-icon>
                    </div>
                    <div id="dialog-content">
                        <h2>[[localize('RESET', 'Reset')]]</h2>
                        <div>[[localize('ABOUT_TO_RESET', 'You\'ll lose any unsaved changes')]]</div>
                        <div class="buttons" id="buttons">
                            <button dialog-confirm class="confirm">[[localize('Confirm', 'Confirm')]]</button>
                            <button dialog-dismiss class="cancel">[[localize('CANCEL', 'Cancel')]]</button>
                        </div>
                    </div>
                </div>
                <div name="feature-not-available-offline">
                    <div id="badge">
                        <iron-icon src="/assets/icons/exclamation.svg"></iron-icon>
                    </div>
                    <div id="dialog-content">
                        <h2>[[localize('SHARING_NOT_AVAILABLE', "This feature isn't available offline")]]</h2>
                        <div>[[localize('CONNECT_TO_INTERNET', "Make sure you're connected to the internet.")]]</div>
                        <div class="buttons" id="buttons">
                            <button dialog-confirm class="confirm">[[localize('GOT_IT', 'Got it')]]</button>
                        </div>
                    </div>
                </div>
            </iron-pages>
        </paper-dialog>
        <paper-dialog id="edit-part-dialog"
                      entry-animation="from-big-animation"
                      on-iron-overlay-closed="_partEditorDialogClosed"
                      no-cancel-on-outside-click>
            <kano-part-editor
                id="edit-part-dialog-content"
                selected="{{selected}}"
                mode="[[mode]]"
                class="modal no-padding"
                on-config-panel-changed="_repositionPanel"
                on-delete-part="deletePartClicked"></kano-part-editor>
        </paper-dialog>
        <paper-dialog id="edit-background-dialog" fit-into="[[codeEditor]]" entry-animation="from-big-animation" on-iron-overlay-closed="_backgroundEditorDialogClosed">
            <kano-background-editor
                id="background-editor"
                class="no-padding"
                mode="[[mode.id]]"
                background="{{background}}"
                name="background"></kano-background-editor>
        </paper-dialog>
        <paper-dialog id="parts-modal" entry-animation="from-big-animation" on-iron-overlay-closed="_partsModalClosed" with-backdrop>
            <kano-add-parts id="add-parts" class="no-padding" available-parts="[[parts]]" on-cancel="_closePartsModal" on-confirm="_addParts"></kano-add-parts>
        </paper-dialog>
        <iron-signals on-iron-signal-export-app="_exportApp">
        <iron-signals on-iron-signal-import-app="_importApp">
        <iron-signals on-iron-signal-reset-workspace="reset">
        <iron-signals on-iron-signal-new-part-request="_newPartRequest">
        <iron-a11y-keys target="[[target]]" keys="alt+p" on-keys-pressed="toggleParts"></iron-a11y-keys>
        <iron-a11y-keys target="[[target]]" keys="alt+s" on-keys-pressed="share"></iron-a11y-keys>
    </template>
</dom-module>

<script src="./kano-app-editor.js"></script>
