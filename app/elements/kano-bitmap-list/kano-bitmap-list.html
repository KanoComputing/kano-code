<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/polymer-sortablejs/polymer-sortablejs.html">
<link rel="import" href="../../bower_components/x-carousel/x-carousel.html">
<link rel="import" href="../../bower_components/web-components/kano-alert/kano-alert.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../../bower_components/web-components/kano-icons/kano-icons.html">
<link rel="import" href="../behaviors/kano-app-editor-behavior.html">
<link rel="import" href="../kano-bitmap-renderer/kano-bitmap-renderer.html">
<!--
### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--kano-bitmaplist-action-container` | Mixin applied to the action controller | `{}`

@group Kano Elements
@hero hero.svg
@demo demo/index.html
-->
<dom-module id="kano-bitmap-list">
    <template>
        <style>
            :host {
                display: block;
                position: relative;
            }
            .action-container {
                @apply --layout-horizontal;
                @apply --kano-bitmaplist-action-container;
            }
            #delete-slot {
                @apply --layout-flex-auto;
            }
            #frames {
                @apply --layout-horizontal;
                @apply --layout-center;
                height: 110px;
                position: relative;
                box-sizing: border-box;
                padding: 0;
            }
            .carousel-content {
                @apply --layout-horizontal;
                @apply --layout-center;
            }
            .sortable-item {
                @apply --layout-horizontal;
                @apply --layout-center;
                @apply --layout-center-justified;
                position: relative;
                width: 116px;
                height: 68px;
                border: 2px solid #8f9195;
                border-radius: 6px;
                box-sizing: border-box;
                margin-right: 22px;
            }
            .sortable-item.sortable-ghost {
                opacity: 0.45;
            }
            kano-bitmap-renderer {
                cursor: pointer;
            }
            .sortable-item.selected {
                border: 2px solid #fff;
            }
            .index-number {
                width: 18px;
                height: 18px;
                position: absolute;
                bottom: 4px;
                right: 4px;
                background: #bbb;
                color: #252b31;
                font-size: 14px;
                font-weight: bold;
                line-height: 18px;
                text-align: center;
                border-radius: 3px;
            }
            .sortable-item:not(.selected) .index-number {
                display: none;
            }
            iron-icon {
                --iron-icon-height: 16px;
                --iron-icon-width: 16px;
                margin: 0 18px;
                cursor: pointer;
                fill: #999;
            }
            iron-icon.end-arrow {
                transform: rotate(180deg);
            }
            x-carousel {
                position: relative;
                height: 112px;
                @apply --layout-horizontal;
                @apply --layout-center;
            }
            .disabled {
                opacity: 0.6;
                pointer-events: none;
            }
            [hidden] {
                display: none !important;
            }
        </style>
            <div class="action-container">
                <slot name="label"></slot>
                <div on-tap="addFrame" class$="[[_computeButtonClass(running)]]">
                    <slot name="add-button"></slot>
                </div>
                <div on-tap="duplicateFrame" class$="[[_computeButtonClass(running)]]">
                    <slot name="duplicate-button"></slot>
                </div>
                <div id="delete-slot" on-tap="deleteFrame" class$="[[_computeButtonClass(running)]]">
                    <slot name="delete-button"></slot>
                </div>
                <div on-tap="deleteAllFrames" class$="[[_computeButtonClass(running)]]">
                    <slot name="delete-all-button"></slot>
                </div>
            </div>
        <x-carousel id="carousel" keep-buttons-visible>
            <iron-icon icon="kano-icons:arrow" slot="left-button" carousel-control-left></iron-icon>
            <div slot="content" class="carousel-content">
                <div id="padding-left" hidden$="[[!running]]">
                </div>
                <sortable-js id="frames"
                             group="frames"
                             animation="150"
                             on-start="_sortStart"
                             on-end="_sortEnd">
                    <template is="dom-repeat" items="[[bitmaps]]" as="bm" id="repeat">
                        <div class$="sortable-item [[_computeFrameSelectedClass(index, selectedIndex, running)]]">
                            <kano-bitmap-renderer width="[[width]]"
                                                  height="[[height]]"
                                                  spacing="1"
                                                  pixel-size="4"
                                                  bitmap="[[bm]]"
                                                  on-tap="_selectFrame"></kano-bitmap-renderer>
                            <div hidden$="[[!displayedIndex]]" class="index-number">[[displayedIndex]]</div>
                        </div>
                    </template>
                </sortable-js>
                <div id="padding-right" hidden$="[[!running]]">
                </div>
            </div>
            <iron-icon class="end-arrow" icon="kano-icons:arrow" slot="right-button" carousel-control-right></iron-icon>
        </x-carousel>
        <kano-alert id="delete-all-alert"
                    heading="Do you want to start again?"
                    text="You are about to delete all your frames!">
            <div slot="actions">
                <button class="kano-alert-primary" on-tap="confirmDeleteAll" dialog-confirm>Confirm</button>
                <button class="kano-alert-secondary" dialog-dismiss>Cancel</button>
            </div>
        </kano-alert>
    </template>
    <script>
        Polymer({
            is: 'kano-bitmap-list',
            behaviors: [
                Kano.Behaviors.AppEditorBehavior
            ],
            properties: {
                bitmaps: {
                    type: Array,
                    notify: true
                },
                selected: {
                    type: Array,
                    notify: true
                },
                selectedIndex: {
                    type: Number,
                    value: 0,
                    notify: true
                },
                width: {
                    type: Number,
                    value: 1
                },
                height: {
                    type: Number,
                    value: 1
                },
                displayedIndex: {
                    type: Number,
                    computed: '_computeDisplayedIndex(selectedIndex)'
                },
                running: {
                    type: Boolean,
                    value: false,
                    observer: '_onRunningChanged'
                },
                moveDelay: Number
            },
            observers: [
                '_selectedChanged(selected.*)',
                '_bitmapsChanged(bitmaps)'
            ],
            _computeDisplayedIndex (selectedIndex) {
                return selectedIndex + 1;
            },
            _computeButtonClass (running) {
                return running ? 'disabled' : '';
            },
            _selectedChanged (e) {
                if (this.sorting) {
                    return;
                }

                this.async(this._moveToSelected);

                //Values of the 'selected' pixel array changed, update the bitmaps array
                if (e.path === 'selected.splices') {
                    const splices = e.value;
                    splices.indexSplices.forEach(splice => {
                        this.splice(`bitmaps.${this.selectedIndex}`,
                                splice.index, 1, this.selected[splice.index]);
                    });
                }
            },
            _bitmapsChanged () {
                if (this.bitmaps.length === 0) {
                    this.addFrame();
                }
                if (!this.selected) {
                    this.selected = this.bitmaps[0] && this.bitmaps[0].slice(0);
                }
            },
            _sortStart (e) {
                if (e.detail) {
                    this.sorting = true;
                    this._select(e.detail.item.children[0]);
                }
            },
            _sortEnd (e) {
                this.sorting = false;
                if (typeof e.newIndex === 'number') {
                    this.selectedIndex = e.newIndex;
                    this.selected = this.bitmaps[this.selectedIndex].slice(0);
                }
            },
            _selectFrame (e) {
                let event = Polymer.dom(e);
                this._select(event.localTarget);
            },
            _select (target) {
                let model = this.$.repeat.modelForElement(target),
                    bitmap = model.get('bm');
                this.selected = bitmap.slice(0);
                this.selectedIndex = this.bitmaps.indexOf(bitmap);
            },
            _computeFrameSelectedClass (index, selectedIndex, running) {
                return selectedIndex === index ? 'selected' : '';
            },
            duplicateFrame () {
                const copy = this.bitmaps[this.selectedIndex].slice(0);
                this.selectedIndex++;
                this.splice('bitmaps', this.selectedIndex, 0, copy);
                this.set('selected', copy.slice(0));
            },
            addFrame () {
                this.debounce('add-frame', () => {
                    let frame = this.getEmptyFrame();

                    if (this.bitmaps.length) {
                        this.selectedIndex++;
                    } else {
                        this.selectedIndex = 0;
                    }

                    this.splice('bitmaps', this.selectedIndex, 0, frame);
                    this.set('selected', frame.slice(0));

                    this.notifyChange('light-animation-add-frame');
                }, 100);
            },
            deleteFrame () {
                this.splice('bitmaps', this.selectedIndex, 1);

                if (this.bitmaps.length === 0) {
                    this.addFrame();
                } else {
                    this.selectedIndex = this.selectedIndex === 0 ?
                            this.selectedIndex : this.selectedIndex - 1;
                    this.set('selected', this.bitmaps[this.selectedIndex].slice(0));
                }
            },
            deleteAllFrames () {
                if (this.bitmaps && this._bitmapsNotEmpty()) {
                    this.$['delete-all-alert'].open();
                }
            },
            _bitmapsNotEmpty () {
                //returns true if there is more than an empty frame in the list
                let allColors = this.bitmaps.reduce((acc, bitmap, index, bitmaps) => {
                    if (bitmaps.indexOf(bitmap) === index) {
                        return acc.concat(bitmap);
                    }
                }, []);
                return allColors.some((value) => {
                    return value !== '#000000'
                });
            },
            confirmDeleteAll () {
                this.set('bitmaps', []);
            },
            _moveToSelected () {
                const target = Polymer.dom(this.root).querySelector('.selected');
                if (target) {
                    this.$.carousel.moveTo(this.$['padding-left'].offsetWidth +
                            target.offsetLeft + target.offsetWidth / 2, this.moveDelay);
                }
            },
            _onRunningChanged (running, wasRunning) {
                //set a padding around the frames, so the playback doesn't jump
                if (running) {
                    this.$['padding-left'].style.width =
                            this.$['padding-right'].style.width = `${this.offsetWidth / 2}px`;
                }

                if (!running && wasRunning) {
                    this._moveToSelected();
                }
            },
            getEmptyFrame () {
                const emptyFrame = [];
                for (let i = 0; i < this.width * this.height; i++) {
                    emptyFrame.push('#000000');
                }
                return emptyFrame;
            }
        });
    </script>
</dom-module>
