<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/polymer-sortablejs/polymer-sortablejs.html">
<link rel="import" href="../../bower_components/x-carousel/x-carousel.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../../bower_components/web-components/kano-icons/kano-icons.html">
<link rel="import" href="../kano-bitmap-renderer/kano-bitmap-renderer.html">
<!--

@group Kano Elements
@hero hero.svg
@demo ./demo/index.html

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--kano-bitmaplist-action-container` | Mixin applied to the action controller | `{}`
-->
<dom-module id="kano-bitmap-list">
    <template>
        <style>
            :host {
                display: block;
                position: relative;
            }
            .action-container {
                @apply --layout-horizontal;
                @apply --kano-bitmaplist-action-container;
            }
            #frames {
                @apply --layout-horizontal;
                @apply --layout-center;
                height: 110px;
                position: relative;
                padding: 0;
            }
            sortable-js {
                @apply --layout-horizontal;
                @apply --layout-end;
                padding: 11px 4px;
                max-width: 100%;
                box-sizing: border-box;
            }
            .sortable-item {
                @apply --layout-horizontal;
                @apply --layout-center;
                @apply --layout-center-justified;
                width: 116px;
                height: 68px;
                cursor: pointer;
                border: 2px solid #8f9195;
                border-radius: 6px;
                box-sizing: border-box;
            }
            .sortable-item.sortable-ghost {
                opacity: 0.45;
            }
            kano-bitmap-renderer.selected {
                border-color: var(--color-chateau);
            }
            .bin {
                position: absolute;
                top: 28px;
                left: 0;
                width: 312px;
                height: 150px;
                @apply --layout-vertical;
                @apply --layout-center;
                @apply --layout-center-justified;
                display: none;
                background-image: url(/assets/icons/layout-bin-icon.png);
                background-size: 28px;
                background-position: center center;
                background-repeat: no-repeat;
                overflow: visible;
            }
            .bin-list {
                width: 100%;
                height: 100%;
            }
            iron-icon {
                --iron-icon-height: 16px;
                --iron-icon-width: 16px;
                margin: 0 18px;
                cursor: pointer;
                fill: #999;
            }
            iron-icon.end-arrow {
                transform: rotate(180deg);
            }
            x-carousel {
                position: relative;
                height: 112px;
                @apply --layout-horizontal;
                @apply --layout-center;
            }
        </style>
            <div class="action-container">
                <slot name="label"></slot>
                <slot name="add-button" on-tap="addFrame"></slot>
                <slot name="duplicate-button" on-tap="duplicateFrame"></slot>
                <slot name="delete-button" on-tap="deleteFrame"></slot>
            </div>
        <x-carousel id="carousel" keep-controls-visible>
            <iron-icon icon="kano-icons:arrow" slot="left-button" carousel-control-left></iron-icon>
            <div slot="content">
                <sortable-js group="frames" class="bin" id="bin"></sortable-js>
                <sortable-js id="frames" group="frames" animation="150" on-start="_sortStarted" on-end="_sortEnd" on-remove="_sortRemove">
                        <template is="dom-repeat" items="[[bitmaps]]" as="bm" id="repeat" >
                            <div class="sortable-item">
                                <kano-bitmap-renderer width="[[width]]"
                                                    height="[[height]]"
                                                    spacing="1"
                                                    pixel-size="4"
                                                    bitmap="[[bm]]"
                                                    on-mousedown="_registerBinPosition"
                                                    on-tap="_selectFrame"
                                                    class$="[[_computeFrameSelectedClass(index, selectedIndex)]]"></kano-bitmap-renderer>
                            </div>
                        </template>
                </sortable-js>
            </div>
            <iron-icon class="end-arrow" icon="kano-icons:arrow" slot="right-button" carousel-control-right></iron-icon>
        </x-carousel>
    </template>
    <script>
        Polymer({
            is: 'kano-bitmap-list',
            properties: {
                bitmaps: {
                    type: Array,
                    notify: true
                },
                selected: {
                    type: Array,
                    notify: true
                },
                selectedIndex: {
                    type: Number,
                    value: 0,
                    notify: true
                },
                width: {
                    type: Number,
                    value: 1
                },
                height: {
                    type: Number,
                    value: 1
                }
            },
            observers: [
                '_selectedChanged(selected.*)',
                '_bitmapsChanged(bitmaps)'
            ],
            _selectedChanged (e) {
                if (this.sorting) {
                    return;
                }
                let index = this.selectedIndex,
                    splices;

                this.async(() => {
                    let target = Polymer.dom(this.root).querySelector('.selected');
                    this.$.carousel.moveTo(target.offsetLeft + target.offsetWidth / 2);
                }, 100);

                //Values of the 'selected' pixel array changed, update the bitmaps array
                if (e.path === 'selected.splices') {
                    splices = e.value;
                    splices.indexSplices.forEach(splice => {
                        this.splice(`bitmaps.${index}`, splice.index, 1, this.selected[splice.index]);
                    });
                }
            },
            _bitmapsChanged () {
                if (!this.selected) {
                    this.selected = this.bitmaps[0].slice(0);
                }
            },
            _sortStarted (e) {
                if (e.detail) {
                    this.sorting = true;
                    this.$.bin.style.left = this.binPosition + 'px';
                    
                    this.$.frames.animate([{
                        transform: 'translateY(0%)'
                    }, {
                        transform: 'translateY(20%)'
                    }], {
                        duration: 150,
                        fill: 'forwards'
                    });

                    this.$.bin.style.display = 'flex';
                    this.$.bin.animate([{
                        opacity: 0,
                        transform: 'translateY(0%)'
                    }, {
                        opacity: 1,
                        transform: 'translateY(-50%)'
                    }], {
                        duration: 150,
                        fill: 'forwards'
                    });
                    this._select(e.detail.item.children[0]);
                }
            },
            _sortEnd (e) {
                if (e.detail) {
                    this.sorting = false;
                    this.$.frames.style.width = 'auto';
                    this.selectedIndex = e.detail.newIndex;
                    this.selected = this.bitmaps[this.selectedIndex].slice(0);

                    this.$.frames.animate([{
                        transform: 'translateY(20%)'
                    }, {
                        transform: 'translateY(0%)'
                    }], {
                        duration: 150,
                        fill: 'forwards'
                    });

                    this.$.bin.animate([{
                        opacity: 1,
                        transform: 'translateY(-50%)'
                    }, {
                        opacity: 0,
                        transform: 'translateY(0%)'
                    }], {
                        duration: 150,
                        fill: 'forwards'
                    }).onfinish = () => {
                        this.$.bin.style.display = 'none';
                    }
                }
            },
            _sortRemove (e) {
                if (this.bitmaps.length !== 0) {
                    this.selectedIndex = e.detail && e.detail.newIndex || 0;
                    this.set('selected', this.bitmaps[this.selectedIndex].slice(0));
                } else {
                    this.async(() => this.createEmptyFrame());
                }
            },
            _selectFrame (e) {
                let event = Polymer.dom(e);
                this._select(event.localTarget);
            },
            _registerBinPosition (e) {
                let event = Polymer.dom(e),
                    sortableItem = event.localTarget.parentElement;
                this.binPosition = sortableItem.offsetLeft - sortableItem.offsetWidth + 6;
            },
            _select (target) {
                let model = this.$.repeat.modelForElement(target),
                    bitmap = model.get('bm');
                this.selected = bitmap.slice(0);
                this.selectedIndex = this.bitmaps.indexOf(bitmap);
            },
            _computeFrameSelectedClass (index, selectedIndex) {
                return index === selectedIndex ? 'selected' : '';
            },
            addFrame () {
                let copy;

                if (!this.bitmaps.length) {
                    this.createEmptyFrame();
                } else {
                    copy = this.bitmaps[this.selectedIndex].slice(0);
                    this.splice('bitmaps', this.selectedIndex, 0, copy);
                    this.selectedIndex = this.selectedIndex + 1;
                    this.set('selected', copy.slice(0));
                }

                if (this.selectedIndex === this.bitmaps.length - 1) {
                    this.async(() => this.$.carousel.scrollToEnd(), 100);
                }
            },
            createEmptyFrame () {
                let frame = [];

                for (let i = 0; i < this.width * this.height; i++) {
                    frame.push('#000000');
                }
                this.push('bitmaps', frame);
                this.selectedIndex = 0;
                this.set('selected', frame);
            }
        });
    </script>
</dom-module>
