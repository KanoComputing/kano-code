<dom-module id="kano-meta-tags">
    <style></style>
    <template></template>
    <script>
        Polymer({
            is: 'kano-meta-tags',
            properties: {
                url: {
                    type: String,
                    value: ''
                },
                title: {
                    type: String,
                    value: ''
                },
                description: {
                    type: String,
                    value: ''
                },
                siteName: {
                    type: String,
                    value: ''
                },
                image: {
                    type: String,
                    value: ''
                }
            },
            observers: [
                'update(url, title, description, siteName, image)'
            ],
            update () {
                this.debounce('update', () => {
                    let openTagDict = {
                            "og:url": this.url || "",
                            "og:title": this.title || "",
                            "og:description": this.description || "",
                            "og:site_name": this.siteName || "",
                            "og:image": this.image || "",
                            "twitter:card": "summary_large_image",
                            "twitter:site": "@teamkano"
                        },
                        propertyValues = Object.keys(openTagDict);

                    for (let i = 0; i < propertyValues.length; i++) {
                        let key = propertyValues[i];

                        // Only add or update when a value is there
                        if (openTagDict[key]) {
                            this.addOrUpdateMetaTag(key, openTagDict[key]);
                        }
                    }

                    this.updatePageTitle(this.title);

                    /* Tell prerender to save the page now */
                    document.prerenderReady = true;
                });
            },
            addOrUpdateMetaTag (propertyAttr, value) {
                let nodeList = [],
                    tag,
                    updated = false;

                nodeList = Array.from(document.getElementsByTagName('meta'));

                for (tag of nodeList) {
                    if (tag.getAttribute('property') === propertyAttr && tag.getAttribute('content') !== value) {
                        tag.setAttribute('content', value);
                        updated = true;
                        break;
                    }
                }

                if (!updated) {
                    this.createMetaTag(propertyAttr, value);
                }
            },
            createMetaTag (propertyValue, contentValue) {
                let head = document.head,
                    meta = document.createElement('meta');

                meta.setAttribute('property', propertyValue);
                meta.setAttribute('content', contentValue);
                head.appendChild(meta);
            },
            updatePageTitle (title) {
                let titles = document.head.getElementsByTagName('title');

                for (let i = 0; i < titles.length; i++) {
                    let t = titles[i];

                    t.innerHTML = title;
                }

                if (titles.length <= 0) {
                    let t = document.createElement('title');
                    t.innerHTML = title;
                    document.head.appendChild(t);
                }
            }
        });
    </script>
</dom-module>
