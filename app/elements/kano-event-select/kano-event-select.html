<link rel="import" href="../behaviors.html">
<dom-module id="kano-event-select">
    <style>
    :host {
        position: relative;
        display: block;
        @apply(--layout-horizontal);
        padding: 5px 5px 5px 35px;
        @apply(--kano-shadow);
    }
    :host .content {
        @apply(--layout-vertical);
        @apply(--layout-start);
    }
    :host .trigger {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        padding: 15px 5px 15px;
        font-size: 1.4em;
    }
    :host .trigger iron-image {
        margin-right: 15px;
    }
    :host .trigger:hover {
        cursor: pointer;
    }
    :host .trigger:not(:last-of-type) {
        border-bottom: 1px solid var(--color-grey-light, grey);
    }
    :host .triggers {
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
        @apply(--layout-flex);
    }
    :host .title {
        padding-top: 15px;
        font-size: 1.4em;
        font-weight: 600;
    }
    </style>
    <template>
        <div class="title">Select a Trigger:</div>
        <div class="triggers">
            <template is="dom-repeat" items="{{computeTriggers(parts.*)}}" as="trigger">
                <div class="trigger"
                    on-tap="selectTrigger">
                    <span>[[trigger.text]]</span>
                    <span>&gt;</span>
                </div>
            </template>
        </div>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer, KanoBehaviors */

    class KanoEventSelect {

        get behaviors () {
            return [KanoBehaviors.AppEditorBehavior];
        }

        beforeRegister () {
            this.is = 'kano-event-select';
            this.properties = {
                parts: {
                    type: Array
                },
                opened: {
                    type: Boolean,
                    value: false
                }
            };
        }
        toggleOpened () {
            this.opened = !this.opened;
        }
        computeTriggers () {
            let triggers;
            if (!this.parts) {
                return;
            }
            triggers =  this.parts.reduce((acc, part) => {
                let events;
                if (!part.events) {
                    return acc;
                }
                events = part.events.map((event) => {
                    return {
                        emitter: part.id,
                        event: event.id,
                        text: `When ${part.name} ${event.label}`,
                        icon: part.image
                    };
                });
                return acc.concat(events);
            }, []);
            if (this.parts.some((part) => part.partType === 'data')) {
                triggers.push({
                    text: 'When data updated',
                    emitter: 'global',
                    event: 'data-update',
                    icon: '/assets/part/data-part-icon.png'
                });
            }
            return triggers.sort((a, b) => {
                if (a.emitter === 'global' && b.emitter !== 'global') {
                    return -1;
                } else if (b.emitter === 'global' && a.emitter !== 'global') {
                    return 1;
                }
                return 0;
            });
        }
        selectTrigger (e) {
            let trigger = e.model.get('trigger');
            this.fire('selected', trigger);
            this.notifyChange('trigger', {
                trigger
            });
        }
    }
    Polymer(KanoEventSelect);
</script>
