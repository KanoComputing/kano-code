<link rel="import" href="../behaviors.html">
<dom-module id="kano-event-select">
    <style>

    @keyframes scale-in {
        from {
            opacity: 0;
            transform: scale(0.5);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    :host {
        position: relative;
        display: block;
        margin-right: 5px;
        animation: scale-in cubic-bezier(0.2, 0, 0.13, 1.5) 150ms;
        transform-origin: calc(100% - 30px) 0%;
    }
    :host.no-animation {
        animation: none;
    }
    :host .triangle {
        width: 0;
        height: 0;
        border-left: 20px solid transparent;
        border-right: 20px solid transparent;
        border-bottom: 20px solid #505760;

        position: absolute;
        right: 20px
    }
    :host .content {
        /*@apply(--layout-vertical);
        @apply(--layout-start);*/
        border-radius: 5px;

        margin-top: 20px;
        @apply(--shadow-elevation-6dp);
    }
    :host .content .head {
        background: #505760;
        margin: 0px;
        padding: 20px;
        color: white;
        border-top-right-radius: 5px;
        border-top-left-radius: 5px;
    }
    :host .content .head .title {
        padding-top: 5px;
        font-size: 1.4em;
    }
    :host .trigger {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        padding: 15px 15px 15px;
        font-size: 1.0em;
    }
    :host .trigger iron-image {
        margin-right: 15px;
    }
    :host .trigger:hover {
        background-color: #e5e5e5;
        cursor: pointer;
    }
    :host .trigger:not(:last-of-type) {
        border-bottom: 1px solid var(--color-grey-light, grey);
    }
    :host .trigger:last-of-type {
        border-bottom-left-radius: 5px;
        border-bottom-right-radius: 5px;
    }
    :host .triggers {
        background: var(--color-white, white);
        border-bottom-left-radius: 5px;
        border-bottom-right-radius: 5px;
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
        @apply(--layout-flex);
    }
    </style>
    <template>
        <div class="triangle"></div>
        <div class="content">
            <div class="head">
                <div class="title">Write New Code</div>
                <div class="subtitle">Select a Trigger</div>
            </div>
            <div class="triggers">
                <template is="dom-repeat" items="{{computeTriggers(parts.*)}}" as="trigger">
                    <div class="trigger"
                        on-tap="selectTrigger">
                        <span>[[trigger.text]]</span>
                        <span>&gt;</span>
                    </div>
                </template>
            </div>
        </div>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer, KanoBehaviors */

    class KanoEventSelect {

        get behaviors () {
            return [KanoBehaviors.AppEditorBehavior, KanoBehaviors.AnimatableBehavior];
        }

        beforeRegister () {
            this.is = 'kano-event-select';
            this.properties = {
                parts: {
                    type: Array
                },
                opened: {
                    type: Boolean,
                    value: false
                }
            };
        }
        toggleOpened () {
            this.opened = !this.opened;
        }
        computeTriggers () {
            let triggers;
            if (!this.parts) {
                return;
            }
            triggers =  this.parts.reduce((acc, part) => {
                let events;
                if (!part.events) {
                    return acc;
                }
                events = part.events.map((event) => {
                    return {
                        emitter: part.id,
                        event: event.id,
                        text: `When ${part.name} ${event.label}`,
                        icon: part.image
                    };
                });
                return acc.concat(events);
            }, []);
            if (this.parts.some((part) => part.partType === 'data')) {
                triggers.push({
                    text: 'When data updated',
                    emitter: 'global',
                    event: 'data-update',
                    icon: '/assets/part/data-part-icon.png'
                });
            }
            return triggers.sort((a, b) => {
                if (a.emitter === 'global' && b.emitter !== 'global') {
                    return -1;
                } else if (b.emitter === 'global' && a.emitter !== 'global') {
                    return 1;
                }
                return 0;
            });
        }
        selectTrigger (e) {
            let trigger = e.model.get('trigger');
            this.fire('selected', trigger);
            this.notifyChange('trigger', {
                trigger
            });
        }
    }
    Polymer(KanoEventSelect);
</script>
