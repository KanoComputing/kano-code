<script src="../../scripts/util/client.js"></script>
<link rel="import" href="../../scripts/kano/make-apps/sdk.html">
<link rel="import" href="../../scripts/kano/make-apps/experiments.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../kano-style/themes/dark.html">
<link rel="import" href="../../bower_components/web-components/kano-auth/kano-auth.html">

<link rel="import" href="../kano-routing/kano-routing.html">
<link rel="import" href="../kano-ui-item/kano-ui-item.html">
<link rel="import" href="../behaviors/kano-modal-animator-behavior.html">
<link rel="import" href="../behaviors/kano-view-behavior.html">
<link rel="import" href="../behaviors/kano-code-ga-tracking-behavior.html">
<link rel="import" href="../behaviors/kano-code-tracking-behavior.html">
<link rel="import" href="../behaviors/kano-gamification-behavior.html">
<link rel="import" href="../kano-try-chrome/kano-try-chrome.html">
<link rel="import" href="../../scripts/kano/make-apps/progress.html">
<link rel="import" href="../../scripts/kano/make-apps/store.html">
<link rel="import" href="../../scripts/kano/make-apps/actions/user.html">
<!--
`kano-app` provides the whole Make apps app.
Example:
    <kano-app></kano-app>
@group Kano Elements
@element kano-app
-->
<dom-module id="kano-app">
    <template>
        <style>
            :host {
                font-family: var(--font-body);
                display: block;
                @apply(--layout-vertical);
                @apply(--layout-flex);
            }
            :host button {
                font-family: Bariol;
            }
            :host kano-routing {
                @apply(--layout-vertical);
                @apply(--layout-flex);
                overflow: auto;
            }
            :host button,
            :host .main header .link {
                @apply(--kano-button-small);
                text-decoration: none;
                background-color: var(--primary-color);
            }
            :host .main header {
                background-color: var(--color-header, black);
                color: white;
                @apply(--kano-header);
                @apply(--layout-horizontal);
                @apply(--layout-justified);
                @apply(--layout-center);
                height: 62px;
            }
            :host .main header div {
                @apply(--layout-flex);
            }
            :host .main header .logged {
                @apply(--layout-vertical);
            }
            :host .user-info {
                margin-left: 5px;
            }
            :host kano-routing {
                @apply(--layout-flex);
                position: relative;
            }
            :host .logged-out {
                background: white;
            }
            #toast {
                --paper-toast-background-color: var(--kano-app-editor-workspace-background);
            }
            #toast button {
                background-color: var(--color-green);
                margin-left: 16px;
            }
        </style>
        <kano-routing id="router"
                ctx="{{ctx}}"
                name="app"
                user="[[user]]"
                on-login="_login"
                page="{{route}}"></kano-routing>
        <kano-auth id="auth"
                   on-login="_onLogin"
                   world-url="{{worldUrl}}"
                   api-url="{{apiUrl}}"
                   assets-path="/assets"
                   on-success="_authSuccess"
                   on-cancel="_authCancelled"
                   successful="[[authenticated]]"></kano-auth>
        <paper-toast id="toast" text="[[message.text]]" duration="[[message.duration]]">
            <button type="button" name="button" hidden$="[[!message.closeWithButton]]" on-tap="_closeToast">[[message.buttonText]]</button>
        </paper-toast>
        <kano-try-chrome></kano-try-chrome>
    </template>
</dom-module>
<script>
    /* globals Polymer, Kano, ClientUtil, page */

    Polymer({
        is: 'kano-app',
        behaviors: [
            Kano.Behaviors.KanoCode.GABehavior,
            Kano.Behaviors.KanoCode.TrackingBehavior,
            Kano.MakeApps.Store.ReceiverBehavior,
            Kano.Behaviors.GamificationBehavior
        ],
        properties: {
            user: {
                type: Object,
                observer: '_userChanged'
            },
            offline: {
                type: Boolean,
                value: false
            },
            route: {
                type: String,
                observer: '_routeChanged'
            },
            authenticated: {
                type: Boolean,
                value: false
            }
        },
        listeners: {
            logout: '_logout',
            shutdown: '_shutdown',
            signup: '_signup',
            'kano-error': '_showErrorOnToast',
            'view-loaded': '_viewLoaded',
            'ga-tracking-event': '_trackGAEvent',
            'ga-page-tracking-event': '_trackGAPage',
            'update-user-progress': '_updateUserProgress'
        },
        _routeChanged (route) {
            // User not authenticated not actions to be done
            if (!this.user) {
                return;
            }
        },
        ready () {
            this.editor = null;
            const { config } = this.getState();
            this.sdk = new Kano.MakeApps.SDK(config);
            this.progress = new Kano.MakeApps.Progress(config);
            this.offline = config.TARGET === 'osonline' && ClientUtil.isPi();
            this.worldUrl = config.WORLD_URL;
            this.apiUrl = config.API_URL;
            let initialiseSDK = () => {
                this.sdk.initSession().then((user) => {
                    /**
                     * Set the token to allow this to be used by the tracking
                     * behavior
                     */
                    this.token = this.sdk.getToken();
                    if (user) {
                        Kano.MakeApps.Actions.User.authenticate(user);
                        this.set('user', user);
                        this._populateUser();
                    } else {
                        this.trackVisitType('Logged out');
                    }
                    /**
                     * Initialize the tracking only after initializing the sdk
                     * to ensure that the token is used when starting the
                     * session, if applicable
                     */
                    this._initializeTracking({
                        detail: {
                            token: this.token,
                            path: window.location.pathname
                        }
                    });
                })
                .catch(() => {
                    this.trackVisitType('Logged out');
                });
            };
            if (this.offline) {
                fetch(config.TOKEN_ENDPOINT, {method: 'POST'})
                .then((response) => {
                    if (response.ok) {
                        // The API has responded, need to set the token
                        return response.json();
                    }
                })
                .then((retObj) => {
                    if (retObj.hasOwnProperty('token')) {
                        this.sdk.setToken(retObj.token);
                    }

                    initialiseSDK();
                })
                .catch((error) => {
                    // Server responded with 401 or some other error occurred
                    // still need to initialise the SDK
                    initialiseSDK();
                });
            } else {
                initialiseSDK();
            }
            Kano.MakeApps.experiments.addExperiments('ui', ['gamification_modal']);
        },
        _showErrorOnToast (e) {
            this.message = e.detail;
            if (this.message.text) {
                this.$.toast.open();
                // The content changed, need to refit
                this.$.toast.refit();
            }
        },
        _closeToast () {
            this.$.toast.close();
        },
        _shutdown (e) {
            if (!this.offline) {
                console.log("Can't shutdown outside of offline mode.");
                return;
            }

            const state = this.getState();

            fetch(state.config.SHUTDOWN_ENDPOINT)
            .then((response) => {
                if (!response.ok) {
                    console.log("Failed to shutdown.");
                }
            })
            .catch((error) => {
                console.log(error);
            });
        },
        _logout (e) {
            e.preventDefault();
            this.sdk.logout();
            Kano.MakeApps.Actions.User.logout();
            this.user = null;
            this.$.auth.reset();
            this.progress.reset();
            clearInterval(this._pollingIntervalId);
            /**
             * Attach the token to the event to allow this to be associated with
             * the user, and then clear the token
             */
            this.fire('tracking-event', {
                name: 'logged_out',
                token: this.token
            });
            this.token = null;
        },
        _login (e) {
            if (e && e.detail) {
                this.authCallbacks = e.detail;
            }

            this.authCallbacks = this.authCallbacks || {};
            this.$.auth.open('login');
        },
        _signup (e) {
            if (e && e.detail) {
                this.authCallbacks = e.detail;
            }

            this.authCallbacks = this.authCallbacks || {};
            this.$.auth.open('signup');
        },
        _authSuccess () {
            if (this.authCallbacks && this.authCallbacks.onSuccess) {
                this.authCallbacks.onSuccess.call();
                this.set('authCallbacks', null);
            }
        },
        _authCancelled () {
            if (this.authCallbacks && this.authCallbacks.onCancel) {
                this.authCallbacks.onCancel.call();
                this.set('authCallbacks', null);
            }
        },
        _fetchUserProgress () {
            this.sdk.getProgress()
                .then((res) => {
                    Kano.MakeApps.Actions.User.updateLevels(res.progress.levels);
                    this.set('user.profile.levels', res.progress.levels);
                });
        },
        _onLogin (e) {
            let data = e.detail;
            this.sdk.setToken(data.token);
            this.token = data.token;
            Kano.MakeApps.Actions.User.authenticate(data.user);
            this.user = data.user;
            this._populateUser();
            this.authenticated = true;
            this.fire('tracking-event', {
                name: 'logged_in'
            });

            this.syncCachedProgress();
        },
        _populateUser () {
            this._updateProfile();
        },
        _updateProfile () {
            this.sdk.getUserByUsername(this.user.username)
                .then((res) => {
                    Kano.MakeApps.Actions.User.updateProfile(res.user.profile);
                    this.set('user.profile', res.user.profile);
                    this._fetchUserProgress();
                });
        },
        _updateUserProgress (e) {
            let progress = e.detail
                           && e.detail.levels
                           && e.detail.levels.progress;
            if (!progress) {
                return;
            }
            this.set('user.profile.levels', progress);
        },
        _userChanged (user) {
            this.debounce('userChanged', () => {
                if (user) {
                    this.trackVisitType('Logged in');
                } else {
                    this.trackVisitType('Logged out');
                }
            });
        },
        _viewLoaded () {
            window.prerenderReady = true;
        },
        _trackGAEvent (e, payload) {
            this.dispatchTrackingEvent(payload);
        },
        _trackGAPage (e, payload) {
            this.dispatchVirtualPageView(payload.title, payload.path);
        }
    });
</script>
