<script src="../../scripts/app.js"></script>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../kano-routing/kano-routing.html">
<link rel="import" href="../kano-style/kano-style.html">

<dom-module id="kano-app">
    <style>
    :host {
        display: block;
        width: 100%;
        height: 100%;
        @apply(--layout-vertical);
        font-family: var(--font-body);
    }
    :host button,
    :host header a {
        @apply(--kano-button);
        text-decoration: none;
        background-color: var(--primary-color);
    }
    :host header {
        background-color: var(--color-header, black);
        color: white;
        @apply(--kano-header);
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        @apply(--layout-center);
        height: 62px;
    }
    :host header div {
        @apply(--layout-flex);
    }
    :host .user-info {
        margin-left: 5px;
    }
    :host header iron-image {
        height: 42px;
        width: 155px;
        margin-left: 15px;
    }
    :host header button {
        margin-right: 15px;
    }
    :host header .links {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        padding-right: 5px;
    }
    :host kano-routing {
        @apply(--layout-flex);
    }
    </style>
    <template>
        <style include="kano-style"></style>
        <header>
            <div class="user-info">
                <h1 hidden$="{{!user}}">{{user}}</h1>
                <button type="button"
                    class="login-button"
                    on-tap="toggleLogin">{{computeButtonLogin(user)}}</button>
            </div>
            <iron-image src="../../assets/make-apps-logo.png"
                        preload
                        sizing="contain"></iron-image>
            <div class="links">
                <template is="dom-repeat" items="{{ctx.links}}" as="link">
                    <a href$="[[link.url]]">[[link.label]]</a>
                </template>
            </div>
        </header>
        <kano-routing ctx="{{ctx}}"></kano-routing>
    </template>
</dom-module>
<script>
    class KanoApp {
        beforeRegister () {
            this.is = 'kano-app';
            this.properties = {
                user: {
                    type: String,
                    value: ''
                }
            };
            this.observers = [
                'ctxChanged(ctx.*)'
            ];
        }
        /**
         * When the router changes the ctx, we update it in the app
         */
        ctxChanged () {
            app.ctx = this.ctx;
        }
        computeButtonLogin (user) {
            return user ? 'Logout' : 'Login';
        }
        toggleLogin () {
            let modal;

            if (this.user) {
                app.modelManager.unset('user');
                this.user = app.modelManager.get('user');
                return;
            }

            const handleSwitch = (ev) => {
                if (ev.target.localName === 'kano-login-form') {
                    modal.setContent(document.createElement('kano-signup-form'));
                    document.querySelector('#already-signedup-button')
                        .addEventListener('click', handleSwitch);
                }
                if (ev.target.id === 'already-signedup-button') {
                    modal.setContent(document.createElement('kano-login-form'));
                    document.querySelector('kano-login-form')
                        .addEventListener('signup-click', handleSwitch);
                }
            };

            const handleLogin = (data) => {
                app.modelManager.set('user', data.details);
                this.user = data.details.user.username;
                modal.close();
            };

            modal = document.createElement('kano-modal');
            modal.setContent(document.createElement('kano-login-form'));
            modal.show(() => {
                let loginForm = document.querySelector('kano-login-form');
                loginForm.addEventListener('signup-click', handleSwitch);
                loginForm.addEventListener('success', handleLogin);
            });

            modal.addEventListener('modal-close', () => {
                document.body.removeChild(modal);
            });
            document.body.appendChild(modal);
        }
    }
    Polymer(KanoApp);
</script>
