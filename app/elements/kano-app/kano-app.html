<script src="../../scripts/util/client.js"></script>
<link rel="import" href="../../scripts/kano/make-apps/sdk.html">
<link rel="import" href="../../scripts/config/config.html">

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../../bower_components/web-components/kano-style/themes/light.html">
<link rel="import" href="../../bower_components/web-components/kano-auth/kano-auth.html">

<link rel="import" href="../kano-routing/kano-routing.html">
<link rel="import" href="../kano-ui-item/kano-ui-item.html">
<link rel="import" href="../kano-side-menu/kano-side-menu.html">
<link rel="import" href="../behaviors/kano-modal-animator-behavior.html">
<link rel="import" href="../behaviors/kano-view-behavior.html">
<link rel="import" href="../behaviors/kano-tracking-behavior.html">
<link rel="import" href="../kano-slider/kano-slider.html">
<link rel="import" href="../kano-try-chrome/kano-try-chrome.html">
<link rel="import" href="../../scripts/kano/make-apps/progress.html">
<!--
`kano-app` provides the whole Make apps app.
Example:
    <kano-app></kano-app>
@group Kano Elements
@element kano-app
-->
<dom-module id="kano-app">
    <style>
    :host {
        font-family: var(--font-body);
        display: block;
        @apply(--layout-vertical);
        @apply(--layout-flex);
    }
    :host button {
        font-family: Bariol;
    }
    #drawer {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        --paper-drawer-panel-main-container: {
            @apply(--layout-flex);
        };
        --paper-drawer-panel-drawer-container: {
            box-shadow: none !important;
        };
        overflow-y: scroll;
    }
    :host kano-routing {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        overflow: auto;
    }
    :host button,
    :host .main header .link {
        @apply(--kano-button-small);
        text-decoration: none;
        background-color: var(--primary-color);
    }
    :host .main header {
        background-color: var(--color-header, black);
        color: white;
        @apply(--kano-header);
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        @apply(--layout-center);
        height: 62px;
    }
    :host .main header div {
        @apply(--layout-flex);
    }
    :host .main header .logged {
        @apply(--layout-vertical);
    }
    :host .user-info {
        margin-left: 5px;
    }
    :host .main header iron-image {
        height: 42px;
        width: 155px;
        margin-left: 15px;
    }
    :host .main header button {
        margin-right: 15px;
    }
    :host .main header .links {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        padding-right: 5px;
    }
    :host paper-drawer-panel {
        @apply(--layout-flex);
        position: relative;
    }
    :host .logged-out {
        background: white;
    }
    :host .main {
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    #toast button {
        background-color: var(--color-green);
        margin-left: 16px;
    }
    </style>
    <template>
        <paper-drawer-panel id="drawer" force-narrow disable-edge-swipe disable-swipe right-drawer>
            <kano-side-menu drawer user="[[user]]"
                            on-toggle-menu="toggleMenu"
                            offline="[[offline]]"
                            on-login="_login"
                            world-url="[[worldUrl]]"></kano-side-menu>
            <kano-routing main id="router"
                          ctx="{{ctx}}"
                          name="app"
                          on-toggle-menu="toggleMenu"
                          user="[[user]]"
                          on-login="_login"
                          page="{{route}}"></kano-routing>
        </paper-drawer-panel>
        <kano-auth id="auth"
                   on-login="_onLogin"
                   world-url="{{worldUrl}}"
                   api-url="{{apiUrl}}"
                   assets-path="/assets"
                   on-success="_authSuccess"
                   on-cancel="_authCancelled"
                   successful="[[authenticated]]"></kano-auth>
        <paper-toast id="toast" text="[[message.text]]" duration="[[message.duration]]">
            <button type="button" name="button" hidden$="[[!message.closeWithButton]]" on-tap="_closeToast">[[message.buttonText]]</button>
        </paper-toast>
        <kano-try-chrome></kano-try-chrome>
    </template>
</dom-module>
<script>
    /* globals Polymer, Kano, ClientUtil, page */

    Polymer({
        is: 'kano-app',
        behaviors: [
            Kano.Behaviors.TrackingBehavior
        ],
        properties: {
            user: {
                type: Object,
                observer: '_userChanged'
            },
            offline: {
                type: Boolean,
                value: false
            },
            route: {
                type: String,
                observer: '_routeChanged'
            },
            authenticated: {
                type: Boolean,
                value: false
            }
        },
        listeners: {
            logout: '_logout',
            shutdown: '_shutdown',
            signup: '_signup',
            'kano-error': '_showErrorOnToast',
            'view-loaded': '_viewLoaded',
            'track-event': '_trackEvent',
            'track-page': '_trackPage'
        },
        _routeChanged (route) {
            // User not authenticated not actions to be done
            if (!this.user) {
                return;
            }
            // Stop the notifications polling on every route change
            this._stopNotificationsPolling();
            // Restart the polling if we need it on this route
            if (this._needsNotifications()) {
                this._startNotificationsPolling();
            }
        },
        _needsNotifications () {
            // If the route is apps or home ( routes with the navbar )
            return this.route === 'apps' || this.route === 'home';
        },
        ready () {
            this.editor = null;
            this.offline = Kano.MakeApps.config.TARGET === 'osonline' && ClientUtil.isPi();
            this.worldUrl = Kano.MakeApps.config.WORLD_URL;
            this.apiUrl = Kano.MakeApps.config.API_URL;
            let initialiseSDK = () => {
                Kano.MakeApps.sdk.auth.initSession((err, user) => {
                    if (user) {
                        this.set('user', user);
                        this._populateUser();
                        if (this._needsNotifications()) {
                            this._startNotificationsPolling();
                        }
                    } else {
                        this.trackVisitType('Logged out');
                    }
                });
            };
            if (this.offline) {
                fetch(Kano.MakeApps.config.TOKEN_ENDPOINT, {method: 'POST'})
                .then((response) => {
                    if (response.ok) {
                        // The API has responded, need to set the token
                        return response.json();
                    }
                })
                .then((retObj) => {
                    if (retObj.hasOwnProperty('token')) {
                        Kano.MakeApps.sdk.auth.setToken(retObj.token);
                    }

                    initialiseSDK();
                })
                .catch((error) => {
                    // Server responded with 401 or some other error occurred
                    // still need to initialise the SDK
                    initialiseSDK();
                });
            } else {
                initialiseSDK();
            }
            Kano.MakeApps.config.addExperiments('ui', ['gamification_modal']);
        },
        _showErrorOnToast (e) {
            this.message = e.detail;
            if (this.message.text) {
                this.$.toast.open();
                // The content changed, need to refit
                this.$.toast.refit();
            }
        },
        _closeToast () {
            this.$.toast.close();
        },
        _shutdown (e) {
            if (!this.offline) {
                console.log("Can't shutdown outside of offline mode.");
                return;
            }

            fetch(Kano.MakeApps.config.SHUTDOWN_ENDPOINT)
            .then((response) => {
                if (!response.ok) {
                    console.log("Failed to shutdown.");
                }
            })
            .catch((error) => {
                console.log(error);
            });
        },
        _logout (e) {
            e.preventDefault();
            Kano.MakeApps.sdk.auth.logout(false);
            this.user = null;
            this.$.drawer.closeDrawer();
            this.$.auth.reset();
            Kano.MakeApps.Progress.reset();
            clearInterval(this._pollingIntervalId);
        },
        _login (e) {
            if (e && e.detail) {
                this.authCallbacks = e.detail;
            }

            this.authCallbacks = this.authCallbacks || {};
            this.$.auth.open('login');
        },
        _signup (e) {
            if (e && e.detail) {
                this.authCallbacks = e.detail;
            }

            this.authCallbacks = this.authCallbacks || {};
            this.$.auth.open('signup');
        },
        _authSuccess () {
            if (this.authCallbacks && this.authCallbacks.onSuccess) {
                this.authCallbacks.onSuccess.call();
                this.set('authCallbacks', null);
            }
        },
        _authCancelled () {
            if (this.authCallbacks && this.authCallbacks.onCancel) {
                this.authCallbacks.onCancel.call();
                this.set('authCallbacks', null);
            }
        },
        _onLogin (e) {
            let data = e.detail;
            Kano.MakeApps.sdk.auth.setToken(data.token);
            data.user.notifications = [];
            this.user = data.user;
            this._populateUser();
            if (this._needsNotifications()) {
                this._startNotificationsPolling();
            }
            this.authenticated = true;
        },
        _populateUser () {
            this._updateProfile();
            this._updateNotifications();
        },
        toggleMenu (e) {
            let state = e.detail;
            this.editor = document.getElementById('editor');
            if (typeof state !== 'undefined') {
                if (state) {
                    this.$.drawer.openDrawer();
                } else {
                    this.$.drawer.closeDrawer();
                }
            } else {
                this.$.drawer.togglePanel();
            }
        },
        _startNotificationsPolling () {
            this._pollingIntervalId = setInterval(this._updateNotifications.bind(this), 30000);
        },
        _stopNotificationsPolling () {
            clearInterval(this._pollingIntervalId);
        },
        _updateNotifications () {
            Kano.MakeApps.sdk.api.notifications.get()
                .then((res) => {
                    this.set('user.notifications', res.body.entries.map((notification) => {
                        notification.time = notification.date_created;
                        return notification;
                    }));
                });
        },
        _updateProfile () {
            Kano.MakeApps.sdk.api.users.get.byUsername({ username: this.user.username })
                .then((res) => {
                    this.set('user.profile', res.body.user.profile);
                });
        },
        _userChanged (user) {
            this.debounce('userChanged', () => {
                if (user) {
                    this.trackVisitType('Logged in');
                } else {
                    this.trackVisitType('Logged out');
                }
            });
        },
        _viewLoaded () {
            window.prerenderReady = true;
        },
        _trackEvent (e, payload) {
            this.dispatchTrackingEvent(payload);
        },
        _trackPage (e, payload) {
            this.dispatchVirtualPageView(payload.title, payload.path);
        }
    });
</script>
