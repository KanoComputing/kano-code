<script src="../../scripts/app.js"></script>
<script src="../../scripts/util/client.js"></script>

<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../kano-routing/kano-routing.html">
<link rel="import" href="../kano-style/kano-style.html">
<link rel="import" href="../kano-auth/kano-auth.html">
<!--
`kano-app` provides the whole Make apps app.
Example:
    <kano-app></kano-app>
@group Kano Elements
@element kano-app
-->
<dom-module id="kano-app">
    <style>
    :host, :host .main {
        display: block;
        width: 100%;
        height: 100%;
        @apply(--layout-vertical);
        font-family: var(--font-body);
        overflow: auto;
    }
    :host button,
    :host .main header .link {
        @apply(--kano-button-small);
        text-decoration: none;
        background-color: var(--primary-color);
    }
    :host .main header {
        background-color: var(--color-header, black);
        color: white;
        @apply(--kano-header);
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        @apply(--layout-center);
        height: 62px;
    }
    :host .main header div {
        @apply(--layout-flex);
    }
    :host .main header .logged {
        @apply(--layout-vertical);
    }
    :host .user-info {
        margin-left: 5px;
    }
    :host .main header iron-image {
        height: 42px;
        width: 155px;
        margin-left: 15px;
    }
    :host .main header button {
        margin-right: 15px;
    }
    :host .main header .links {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        padding-right: 5px;
    }
    :host paper-drawer-panel {
        @apply(--layout-flex);
    }
    :host .main iron-pages {
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    :host .main iron-pages > * {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
    }
    :host .logged-out {
        background: #ff842a;
        color: white;
        font-size: 1.3em;
    }
    :host .access-denied {
        justify-content: center;
        align-items: center;
        background: #ff842a;
        color: white;
        font-size: 1.3em;
    }
    :host kano-routing {
        @apply(--layout-flex);
    }
    :host .auth-modal {
        border-radius: 5px;
    }
    </style>
    <template>
        <style include="kano-style"></style>
        <paper-drawer-panel id="drawer" force-narrow disable-edge-swipe disable-swipe>
            <kano-side-menu drawer user="[[user]]" on-login="login" on-logout="logout" on-toggle-menu="toggleMenu" on-reset-workspace="resetWorkspace"></kano-side-menu>
            <div class="main" main>
                <iron-pages selected="[[accessState]]" attr-for-selected="name">
                    <div name="logged-out" class="logged-out">
                        <span>Please Login</span>
                    </div>
                    <div name="not-allowed" class="access-denied">
                        <span>Make Apps while it is still in private beta, thank you for your interest!</span>
                        <span> Redirecting to Kano World</span>
                    </div>
                    <kano-routing name="allowed" id="router" ctx="{{ctx}}" name="app" on-toggle-menu="toggleMenu" user="[[user]]"></kano-routing>
                </iron-pages>
            </div>
        </paper-drawer-panel>
        <paper-dialog id="auth-modal" class="auth-modal" modal>
            <kano-auth on-login="onLogin"></kano-auth>
        </paper-dialog>
    </template>
</dom-module>
<script>
    /* globals Polymer, app, ClientUtil */

    class KanoApp {
        beforeRegister () {
            this.is = 'kano-app';
            this.properties = {
                user: {
                    type: Object
                },
                redirectTimer: {
                    type: Object
                }
            };
            this.observers = [
                'ctxChanged(ctx.*)',
                'launchLogin(user)'
            ];
        }
        /**
         * When the router changes the ctx, we update it in the app
         */
        ctxChanged () {
            app.ctx = this.ctx;
        }
        isUserLoggedIn () {
            return !!this.user;
        }
        userCanHandleMakeApps () {
            if (window.app.config.ENV === 'development') {
                return true;
            }
            if (this.isUserLoggedIn() && this.user.buckets && this.user.buckets.indexOf('make-apps-beta') !== -1) {
                return true;
            }
            return false;
        }
        computeAccessState () {
            clearTimeout(this.redirectTimer);
            if (!this.isUserLoggedIn()) {
                return 'logged-out';
            }

            if (!this.userCanHandleMakeApps()) {
                this.redirectToKanoWorld();
                return 'not-allowed';
            }

            return 'allowed';
        }
        launchLogin () {
            let state = this.computeAccessState();
            this.set('accessState', state);
            if (!this.isUserLoggedIn()) {
                this.login();
            }
        }
        redirectToKanoWorld () {
            this.redirectTimer = setTimeout(()=>{location.href='http://world.kano.me';}, 5000);
        }
        attached () {
            this.set('accessState', 'logged-out');
            let initialiseSDK = () => {
                app.sdk.auth.initSession((err, user) => {
                    if (user) {
                        this.set('user', user);
                    } else {
                        this.launchLogin();
                    }
                });
            };

            if (window.app.config.TARGET === 'osonline' && ClientUtil.isPi()) {

                fetch(window.app.config.TOKEN_ENDPOINT)
                .then((response) => {
                    if (response.ok) {
                        // The API has responded, need to set the token
                        return response.json();
                    }
                })
                .then((retObj) => {
                    if (retObj.hasOwnProperty('token')) {
                        app.sdk.auth.setToken(retObj['token']);
                    }

                    initialiseSDK();
                })
                .catch((error) => {
                    // Server responded with 401 or some other error occurred
                    // still need to initialise the SDK
                    initialiseSDK();
                });
            } else {
                initialiseSDK();
            }
        }
        logout (e) {
            e.preventDefault();
            app.sdk.auth.setToken(null);
            this.user = null;
        }
        login () {
            let modal = this.$['auth-modal'];
            modal.open();
        }
        onLogin (e) {
            let data = e.detail;
            this.user = data.user;
            app.sdk.auth.setToken(data.token);
            this.$['auth-modal'].close();
        }
        toggleMenu () {
            this.$.drawer.togglePanel();
        }
        resetWorkspace () {
            localStorage.clear();
            this.$.router.reload();
        }
    }
    Polymer(KanoApp);
</script>
