<script src="../../scripts/util/client.js"></script>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">


<link rel="import" href="../app.html">
<link rel="import" href="../kano-routing/kano-routing.html">
<link rel="import" href="../kano-style/kano-style.html">
<link rel="import" href="../kano-auth/kano-auth.html">
<link rel="import" href="../kano-side-menu/kano-side-menu.html">
<!--
`kano-app` provides the whole Make apps app.
Example:
    <kano-app></kano-app>
@group Kano Elements
@element kano-app
-->
<dom-module id="kano-app">
    <style>
    :host {
        font-family: var(--font-body);
        display: block;
        @apply(--layout-vertical);
        @apply(--layout-flex);
    }
    :host paper-drawer-panel {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        --paper-drawer-panel-main-container: {
            @apply(--layout-flex);
        };
    }
    :host kano-routing {
        @apply(--layout-vertical);
        @apply(--layout-flex);
        overflow: auto;
    }
    :host button,
    :host .main header .link {
        @apply(--kano-button-small);
        text-decoration: none;
        background-color: var(--primary-color);
    }
    :host .main header {
        background-color: var(--color-header, black);
        color: white;
        @apply(--kano-header);
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        @apply(--layout-center);
        height: 62px;
    }
    :host .main header div {
        @apply(--layout-flex);
    }
    :host .main header .logged {
        @apply(--layout-vertical);
    }
    :host .user-info {
        margin-left: 5px;
    }
    :host .main header iron-image {
        height: 42px;
        width: 155px;
        margin-left: 15px;
    }
    :host .main header button {
        margin-right: 15px;
    }
    :host .main header .links {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        padding-right: 5px;
    }
    :host paper-drawer-panel {
        @apply(--layout-flex);
        position: relative;
    }
    :host .logged-out {
        background: white;
    }
    :host .main {
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    :host .auth-modal {
        border-radius: 5px;
    }
    :host .news-bar {
        background-color: #7DC242;
        min-height: 40px;
        color: white;
        font-size: 1em;
        text-decoration: none;
        padding: 7px;
        text-align: center;
    }
    :host .news-bar:hover {
        background-color: #8AC854;
    }
    </style>
    <template>
        <a class="news-bar" href="https://insights.hotjar.com/s?siteId=119134&surveyId=9857" target="_blank">
            Hey, coder! We need your help to improve Make Apps. Click here to share feedback and report bugs!
        </a>
        <paper-drawer-panel id="drawer" force-narrow disable-edge-swipe disable-swipe>
            <kano-side-menu drawer user="[[user]]" on-toggle-menu="toggleMenu" editor="{{editor}}" on-login="_login"></kano-side-menu>
            <kano-routing id="router" ctx="{{ctx}}" name="app" on-toggle-menu="toggleMenu" user="[[user]]" on-login="_login" main></kano-routing>
        </paper-drawer-panel>
        <paper-dialog id="auth-modal" class="auth-modal" modal>
            <kano-auth on-login="_onLogin" auth-view="{{authView}}" id="auth"></kano-auth>
        </paper-dialog>
    </template>
</dom-module>
<script>
    /* globals Polymer, Kano, ClientUtil, page */

    Polymer({
        is: 'kano-app',
        properties: {
            user: {
                type: Object
            }
        },
        listeners: {
            logout: '_logout',
            signup: '_signup'
        },
        pollingInterval: {
            type: Number,
            value: 30000
        },
        ready () {
            this.editor = null;
            let initialiseSDK = () => {
                Kano.MakeApps.sdk.auth.initSession((err, user) => {
                    if (user) {
                        this.set('user', user);
                        this._populateUser();
                        this._startNotificationsPolling();
                    }
                });
            };
            if (Kano.MakeApps.config.TARGET === 'osonline' && ClientUtil.isPi()) {

                fetch(Kano.MakeApps.config.TOKEN_ENDPOINT)
                .then((response) => {
                    if (response.ok) {
                        // The API has responded, need to set the token
                        return response.json();
                    }
                })
                .then((retObj) => {
                    if (retObj.hasOwnProperty('token')) {
                        Kano.MakeApps.sdk.auth.setToken(retObj.token);
                    }

                    initialiseSDK();
                })
                .catch((error) => {
                    // Server responded with 401 or some other error occurred
                    // still need to initialise the SDK
                    initialiseSDK();
                });
            } else {
                initialiseSDK();
            }
        },
        _logout (e) {
            e.preventDefault();
            Kano.MakeApps.sdk.auth.setToken(null);
            this.user = null;
            page.redirect("/");
            this.$.drawer.closeDrawer();
            this.$.auth.reset();
            Kano.MakeApps.progress.reset();
            clearInterval(this._pollingIntervalId);
        },
        _login () {
            let modal = this.$['auth-modal'];
            modal.open();
        },
        _signup () {
            this._login();
            this.authView = 'signup';
        },
        _onLogin (e) {
            let data = e.detail;
            Kano.MakeApps.sdk.auth.setToken(data.token);
            data.user.notifications = [];
            this.user = data.user;
            this.$['auth-modal'].close();
            this._populateUser();
            this._startNotificationsPolling();
        },
        _populateUser () {
            this._updateProfile();
            this._updateNotifications();
        },
        toggleMenu () {
            this.editor = document.getElementById('editor');
            this.$.drawer.togglePanel();
        },
        _startNotificationsPolling () {
            this._pollingIntervalId = setInterval(this._updateNotifications.bind(this), 30000);
        },
        _updateNotifications () {
            Kano.MakeApps.sdk.api.notifications.get()
                .then((res) => {
                    this.set('user.notifications', res.body.entries.map((notification) => {
                        notification.time = notification.date_created;
                        return notification;
                    }));
                });
        },
        _updateProfile () {
            Kano.MakeApps.sdk.api.users.get.byUsername({ username: this.user.username })
                .then((res) => {
                    this.set('user.profile', res.body.user.profile);
                });
        }
    });
</script>
