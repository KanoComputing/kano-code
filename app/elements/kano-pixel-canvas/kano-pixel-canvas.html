<link rel="import" href="../kano-color-picker/kano-color-picker.html">
<dom-module id="kano-pixel-canvas">
    <style>
    :host {
        display: block;
    }
    .pixel {
        width: 22px;
        height: 22px;
        margin: 3px;
        background-color: black;
    }
    .canvas {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        padding: 10px;
        background-color: #444;
        border-radius: 4px;
        box-shadow: 0 0 10px 4px rgba(0, 0, 0, 0.05);
        border: solid 1px #ececec;
        box-sizing: border-box;
    }
    .pen {
        width: 26px;
        height: 26px;
        margin-right: 5px;
    }
    .picker {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        margin-top: 16px;
    }
    </style>
    <template>
        <div class="content">
            <div class="canvas" style$="[[_computeCanvasStyle(width)]]">
                <template is="dom-repeat" items="[[bitmap]]" as="pixel" id="repeat">
                    <div class="pixel" style$="[[_computePixelStyle(pixel)]]" on-mouseover="_pixelOver" on-mouseout="_pixelOut"></div>
                </template>
            </div>
            <div class="picker">
                <iron-image src="/assets/icons/pencil.svg" sizing="contain" class="pen"></iron-image>
                <kano-color-picker value="{{penColor}}" palette="[[palette]]"></kano-color-picker>
            </div>
        </div>
    </template>
    <script type="text/javascript">
        Polymer({
            is: 'kano-pixel-canvas',
            properties: {
                bitmap: {
                    type: Array,
                    value: () => {
                        return [['#000000']];
                    },
                    notify: true
                },
                width: {
                    type: Number,
                    value: 1
                },
                height: {
                    type: Number,
                    value: 1
                },
                palette: {
                    type: Array
                }
            },
            observers: [
                '_computePalette(bitmap.*)'
            ],
            ready () {
                this._mouseDown = this._mouseDown.bind(this);
                this._mouseUp = this._mouseUp.bind(this);
            },
            attached () {
                document.addEventListener('mousedown', this._mouseDown);
                document.addEventListener('touchstart', this._mouseDown);
                document.addEventListener('mouseup', this._mouseUp);
                document.addEventListener('touchend', this._mouseUp);
            },
            detached () {
                document.removeEventListener('mousedown', this._mouseDown);
                document.removeEventListener('touchstart', this._mouseDown);
                document.removeEventListener('mouseup', this._mouseUp);
                document.removeEventListener('touchend', this._mouseUp);
            },
            _computePalette () {
                this.debounce('palette', () => {
                    if (!this.bitmap) {
                        return;
                    }
                    this.set('palette', this.bitmap.filter((elem, pos) => {
                        return this.bitmap.indexOf(elem) === pos;
                    }).splice(-16, 16));
                }, 16);
            },
            _computeCanvasStyle (width) {
                let w = (width * 28) + 22;
                return `max-width: ${w}px; width: ${w}px;`;
            },
            _computePixelStyle (pixel) {
                return `background-color: ${pixel || '#000000'};`;
            },
            _pixelOver (e) {
                let target = e.path ? e.path[0] : e.target;
                if (this.isMouseDown) {
                    let model = this.$$('#repeat').modelForElement(target),
                        index;
                    if (model) {
                        index = model.get('index');
                        this.splice('bitmap', index, 1, this.penColor);
                    }
                } else {
                    target.style.backgroundColor = this.penColor;
                }
            },
            _pixelOut (e) {
                let target = e.path ? e.path[0] : e.target;
                target.style.backgroundColor = e.model.get('pixel') || '#000000';
            },
            _mouseDown (e) {
                let target = e.path ? e.path[0] : e.target;
                this.isMouseDown = true;
                if (target.classList.contains('pixel')) {
                    this._pixelOver(e);
                }
            },
            _mouseUp () {
                this.isMouseDown = false;
            }
        });
    </script>
</dom-module>
