<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../kano-blockly-flyout/kano-blockly-flyout.html">
<link rel="import" href="../kano-style/typography.html">
<dom-module id="kano-blockly-toolbox">
    <template>
        <style>
            :host {
                display: block;
                --kano-blockly-toolbox-background: #56445d;
                padding: 18px 22px 0px 12px;
                color: white;
                font-family: var(--font-body);
                background: var(--kano-blockly-toolbox-background);
                overflow-y: auto;
                border-right: 1px solid #645a6e;
                @apply --kano-blockly-toolbox;
            }
            .category {
                @apply --layout-horizontal;
                @apply --layout-center;
                width: 100%;
                color: white;
                background: transparent;
                padding: 0;
                border: 0;
                margin-right: 12px;
                font-family: var(--font-body);
                font-size: 14px;
                cursor: pointer;
                border-top: 1px solid transparent;
                transition: border-color linear 100ms;
            }
            .separator {
                height: 16px;
            }
            .category>* {
                pointer-events: none;
            }
            .category.selected {
                border-top-color: #383838;
            }
            .category:focus {
                outline: none;
            }
            @keyframes fade-in {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }
            .flyout-host {
                transition: border-color linear 150ms;
                border-bottom: 1px solid transparent;
                animation: fade-in ease-out 150ms;
                overflow: hidden;
            }
            .category.selected+.separator+.flyout-host {
                border-bottom-color: #383838;
            }
            .category.selected .color {
                box-shadow: 0 0 0 1px var(--kano-blockly-toolbox-background),
                            0 0 0 2px var(--selected-color, black);
            }
            .color {
                width: 12px;
                height: 12px;
                margin: 12px;
                margin-left: 2px;
                border-radius: 50%;
                box-shadow: 0 0 0 1px var(--kano-blockly-toolbox-background),
                            0 0 0 2px var(--kano-blockly-toolbox-background);
                transition: box-shadow linear 150ms;
            }
            *[hidden] {
                display: none !important;
            }
            :host([opened]) {
                @apply --shadow-elevation-4dp;
            }
        </style>
        <template is="dom-repeat" items="[[toolbox]]" as="category">
            <button type="button" class$="category [[_computeSelectedClass(category.selected)]]" on-tap="_selectCategory" id$="category-[[category.id]]" hidden$="[[_isSeparator(category.type)]]">
                <div class="color" style$="[[_computeColorStyle(category.colour)]]"></div>
                <div>[[category.name]]</div>
            </button>
            <div class="separator" hidden$="[[!_isSeparator(category.type)]]"></div>
            <template is="dom-if" if="[[category.selected]]">
                <div class="flyout-host">
                    <kano-blockly-flyout id$="flyout-[[category.id]]"
                                            padding-left="0"
                                            toolbox="[[currentToolbox]]"
                                            target-workspace="[[targetWorkspace]]"
                                            on-block-created="_onBlockCreated"></kano-blockly-flyout>
                </div>
            </template>
        </template>
    </template>
    <script>
        Polymer({
            is: 'kano-blockly-toolbox',
            properties: {
                targetWorkspace: {
                    type: Object,
                    observer: '_targetWorkspaceChanged'
                },
                toolbox: {
                    type: Array
                },
                opened: {
                    type: Boolean,
                    value: false,
                    notify: true,
                    reflectToAttribute: true
                },
                autoClose: {
                    type: Boolean,
                    value: false
                }
            },
            _isSeparator(type) {
                return type === 'separator';
            },
            _computeColorStyle (color) {
                return `background: ${color};`;
            },
            _computeSelectedClass (selected) {
                return selected ? 'selected' : '';
            },
            _onBlockCreated () {
                if (this.autoClose) {
                    this.close();
                }
            },
            close () {
                this.set(`toolbox.${this.currentSelected}.selected`, false);
                let e = {
                    type: Blockly.Events.CLOSE_FLYOUT
                };
                this.currentSelected = undefined;
                this.customStyle['--selected-color'] = null;
                this.updateStyles();
                if (this.targetWorkspace) {
                    this.targetWorkspace.fireChangeListener(e);
                }
            },
            _targetWorkspaceChanged (ws) {
                if (!ws) {
                    return;
                }
                ws.getParentSvg().addEventListener('click', this._targetWorkspaceClicked.bind(this));
            },
            _targetWorkspaceClicked () {
                this.close();
            },
            _selectCategory (e) {
                let category = e.model.get('category'),
                    target = e.target,
                    index = e.model.get('index');

                if (category.type === 'separator') {
                    return;
                }

                if (typeof this.currentSelected !== 'undefined') {
                    this.set(`toolbox.${this.currentSelected}.selected`, false);
                }

                if (this.currentSelected !== index) {
                    let e = {
                        type: Blockly.Events.OPEN_FLYOUT,
                        categoryId: category.id
                    };
                    this.currentSelected = index;
                    this.set(`toolbox.${this.currentSelected}.selected`, true);
                    this.currentToolbox = category.blocks;
                    this.customStyle['--selected-color'] = category.colour;
                    this.updateStyles();
                    Polymer.RenderStatus.afterNextRender(this, () => {
                        this._scrollIfNeeded(category.id);
                    });
                    this.targetWorkspace.fireChangeListener(e);
                    this.set('opened', true);
                } else {
                    let e = {
                        type: Blockly.Events.CLOSE_FLYOUT
                    };
                    this.currentSelected = undefined;
                    this.customStyle['--selected-color'] = null;
                    this.updateStyles();
                    if (this.targetWorkspace) {
                        this.targetWorkspace.fireChangeListener(e);
                    }
                    target.blur();
                    this.set('opened', false);
                }
            },
            _scrollIfNeeded (categoryId) {
                let flyout = this.$$(`#flyout-${categoryId}`),
                    rect, flyoutRect;
                    rect;
                    if (!flyout) {
                        return;
                    }
                    rect = this.getBoundingClientRect();
                    flyoutRect = flyout.getBoundingClientRect();
                    if (flyoutRect.height > rect.height) {
                        this.$$(`#category-${categoryId}`).scrollIntoView({block: 'start', behavior: 'smooth'});
                    }
            },
            getCategoryElement (id) {
                return this.$$(`#category-${id}`);
            },
            getFlyoutBlock (type) {
                let flyout = this.$$(`#flyout`);
                if (flyout) {
                    return flyout.getBlockByType(type);
                }
            },
            _flyoutDOMChanged (e) {
                let categoryId = e.model.get('category.id'),
                    flyout = this.$$(`#flyout-${categoryId}`),
                    flyoutSizeChanged;
                if (!flyout) {
                    return;
                }
                flyoutSizeChanged = (e) => {
                    let size = e.detail,
                        rect = this.getBoundingClientRect(),
                        categoryButton;
                    flyout.removeEventListener('size-changed', flyoutSizeChanged);
                    if (size.height > rect.height) {
                        categoryButton = this.$$(`#category-${categoryId}`);
                        Polymer.RenderStatus.afterNextRender(this, () => {
                            categoryButton.scrollIntoView(true);
                        });
                    }
                };
                flyout.addEventListener('size-changed', flyoutSizeChanged);
            }
        });
    </script>
</dom-module>
