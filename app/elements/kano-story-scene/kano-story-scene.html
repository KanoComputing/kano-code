<dom-module id="kano-story-scene">
    <style>
    :host {
        display: block;
        position: relative;
        @apply(--layout-vertical);
    }
    :host #view {
        @apply(--layout-flex);
    }
    :host #overlay {
        position: absolute;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
        display: none;
    }
    :host #challenge-completed {
        border-radius: 5px;
    }

    :host #challenge-completed .buttons button,
    :host #challenge-completed .buttons a {
        @apply(--kano-button);
        border-radius: 5px;
        margin: 0 10px;
        min-height: 45px;
        font-weight: bold;
        text-transform: uppercase;
        text-decoration: none;
    }

    :host #challenge-completed .buttons .remix {
        background: var(--color-orange);
    }

    :host #challenge-completed .buttons .share {
        background: var(--color-kw-blue);
    }

    :host #challenge-completed .buttons .next-challenge {
        background: var(--color-green);
    }

    :host #challenge-completed h2 {
        color: var(--color-green);
    }
    </style>
    <template>
        <kano-view id="view"
                location="[[location]]"
                view-name="[[name]]"
                attributes="{{attributes}}"
                on-scene-done="sceneFinished"></kano-view>
        <div id="overlay"></div>
        <paper-dialog id="challenge-completed" with-backdrop on-iron-overlay-closed="goToRemixChallenge">
            <div class="dialog pure-g">
                <div class="pure-u-1 pure-u-md-1-2 vertical-aligned">
                    <div class="p-box">
                        <h2>High five!</h2>
                        <p> You have completed the [[storyName]] challenge </p>
                    </div>
                </div>
                <div class="pure-u-1 pure-u-md-1-2 vertical-aligned">
                    <div class="p-box">
                        <div class="buttons">
                            <button class="share" on-tap="shareApp">Share</button>
                            <button class="remix" on-tap="goToRemixChallenge">Remix</button>
                            <template is="dom-if" if="[[nextStory]]">
                                <a class="next-challenge" href$="/story/[[nextStory]]">Next Challenge</a>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </paper-dialog>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer */

    class KanoStoryScene {
        beforeRegister () {
            this.is = 'kano-story-scene';
            this.properties = {
                scene: {
                    type: Object,
                    value: () => {
                        return {};
                    }
                },
                storyName: {
                    type: String,
                    value: ''
                },
                nextStory: {
                    type: String
                },
                location: {
                    type: String
                },
                name: {
                    type: String
                },
                attributes: {
                    type: Object
                },
                store: {
                    type: Object,
                    value: () => {
                        return {};
                    }
                }
            };
            this.observers = [
                'componentChanged(scene.component)'
            ];
        }
        ready () {
            this.overlayDone = this.overlayDone.bind(this);
            this.overlay = null;
        }
        goToRemixChallenge () {
            this.$['challenge-completed'].close();
            this.set('attributes.scene.remix', true);
        }
        sceneFinished (e) {
            if (this.scene.overlay_after) {
                e.stopPropagation();
                console.log(this.scene.overlay_after);
                this.setupOverlay(this.scene.overlay_after);
            }
        }
        componentChanged () {
            let scene = this.scene,
                pieces,
                name,
                loc;
            if (!scene.component && !scene.load) {
                return;
            }
            if (scene.load) {
                this.$.view.mountComponent(this.savedScenes[scene.load]);
                return;
            }
            this.setupOverlay(scene.overlay_before);
            // Cut using '/'
            pieces = scene.component.split('/');
            // Extract the last piece
            name = pieces.pop();
            // Join back the first pieces to get the location
            loc = pieces.join('/');
            this.set('location', `assets/stories/${loc}`);
            this.set('attributes', {
                scene: scene.data,
                store: this.store,
                storyName: this.storyName,
                nextStory: this.nextStory
            });
            this.set('name', `kano-scene-${name}`);
        }
        overlayDone () {
            if (!this.beforeDone && this.scene.overlay_before) {
                this.beforeDone = true;
            } else if (this.scene.overlay_after) {
                if (this.scene.show_remix_options) {
                    this.$['challenge-completed'].open();
                } else {
                    this.fire('scene-done');
                }
            }
            this.overlay.end().then(() => {
                this.$.overlay.style.display = 'none';
            });
        }
        setupOverlay (overlayConfig) {
            let pieces,
                name,
                loc,
                el;
            if (!overlayConfig || !overlayConfig.component) {
                return;
            }
            // Cut using '/'
            pieces = overlayConfig.component.split('/');
            // Extract the last piece
            name = pieces.pop();
            // Join back the first pieces to get the location
            loc = pieces.join('/');
            el = document.createElement('kano-view');
            el.location = `assets/stories/${loc}`;
            el.viewName = `kano-scene-${name}`;
            el.attributes = {
                scene: overlayConfig.data
            };
            this.$.overlay.style.display = 'flex';
            el.addEventListener('overlay-done', this.overlayDone);
            el.style.flex = 1;
            while (this.$.overlay.firstChild) {
                this.$.overlay.removeChild(this.$.overlay.firstChild);
            }
            this.overlay = el;
            this.$.overlay.appendChild(el);
        }
    }
    Polymer(KanoStoryScene);
</script>
