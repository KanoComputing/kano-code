<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../kano-scene-editor/kano-scene-editor.html">
<link rel="import" href="../kano-scene-challenge-overlay/kano-scene-challenge-overlay.html">
<dom-module id="kano-story-scene">
    <style>
    :host {
        display: block;
        position: relative;
        @apply(--layout-vertical);
        overflow: hidden;
    }
    .scene, .overlay {
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    .scene>*:not(template), .overlay>*:not(template) {
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    .overlay {
        position: absolute;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
        @apply(--layout-vertical);
    }
    *[hidden] {
        display: none !important;
    }
    :host #overlay>* {
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    </style>
    <template>
        <iron-lazy-pages class="scene" attr-for-selected="name" selected="[[name]]" restamp>
            <template is="iron-lazy-page" name="editor">
                <kano-scene-editor user="[[user]]"
                                   store="{{store}}"
                                   story-name="[[storyName]]"
                                   scene="[[sceneData]]"
                                   extensions="{{extensions}}"
                                   on-scene-done="sceneCompleted"
                                   next-story="{{nextStory}}"
                                   ended="[[scene.ended]]"
                                   added-parts="{{addedParts}}"></kano-scene-editor>
            </template>
            <template is="iron-lazy-page" name="empty"></template>
        </iron-lazy-pages>
        <iron-lazy-pages class="overlay" attr-for-selected="name" selected="[[overlayName]]" restamp hidden$="[[overlayHidden]]">
            <template is="iron-lazy-page" name="challenge-overlay">
                <kano-scene-challenge-overlay id="overlay" scene="[[overlayScene]]" on-overlay-done="overlayDone"></kano-scene-challenge-overlay>
            </template>
            <template is="iron-lazy-page" name="empty"></template>
        </iron-lazy-pages>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer */

    Polymer({
        is: 'kano-story-scene',
        properties: {
            scene: {
                type: Object,
                value: () => {
                    return {};
                }
            },
            storyName: {
                type: String,
                value: ''
            },
            nextStory: {
                type: Object
            },
            store: {
                type: Object,
                value: () => {
                    return {};
                }
            },
            extensions: {
                type: Array
            },
            user: Object,
            addedParts: { /* This property is used by HardwareAPI in the view */
                type: Array,
                notify: true
            }
        },
        observers: [
            'componentChanged(scene.component)'
        ],
        _parseSceneComponent (sceneComponent) {
            let pieces, component = {};
            // Cut using '/'
            pieces = sceneComponent.split('/');
            // Extract the last piece
            component.name = pieces.pop();
            component.prefix = pieces.join('/');
            component.common = component.prefix === 'common';
            return component;
        },
        ready () {
            this.overlayDone = this.overlayDone.bind(this);
            this.overlayHidden = true;
        },
        sceneCompleted (e) {
            if (this.scene.overlay_after) {
                e.stopPropagation();
                this.setupOverlay(this.scene.overlay_after);
            } else if (this.scene.show_remix_options) {
                this.set('sceneData.completed', true);
            }
            this.fire('track-event', {
                event: 'worldTutorialCompleted'
            });
        },
        componentChanged () {
            let scene = this.scene,
                component;
            if (!scene.component && !scene.load) {
                return;
            }
            this.setupOverlay(scene.overlay_before);
            component = this._parseSceneComponent(scene.component);
            this.sceneData = Object.assign({}, scene.data);
            // Let the end of the overlay load the data
            if (!this.scene.overlay_before) {
                this.set('sceneData.started', true);
            }
            // Force a trip to emptiness, resets the component if the name is the same
            this.set('name', 'empty');
            this.set('name', component.name);
        },
        overlayDone (e) {
            let started = false,
                target = e.path ? e.path[0] : e.target;
            if (!this.beforeDone && this.scene.overlay_before) {
                this.beforeDone = true;
                started = true;
            } else {
                if (this.scene.overlay_after && this.scene.show_remix_options) {
                    this.set('sceneData.completed', true);
                }
                this.fire('scene-done');
            }
            target.end().then(() => {
                this.overlayHidden = true;
                if (started) {
                    this.set('sceneData.started', true);
                    this.set('overlayName', 'empty');
                }
            });
        },
        setupOverlay (overlayConfig) {
            let component;
            if (!overlayConfig || !overlayConfig.component) {
                return;
            }
            component = this._parseSceneComponent(overlayConfig.component);

            if (overlayConfig.data.appPreview) {
                let slug = Date.now().toString();

                overlayConfig.data.example_story_url = Kano.AppModules.generateStandaloneComponent(
                    slug,
                    this.store.current.app.parts,
                    this.store.current.app.background,
                    Kano.MakeApps.Mode.modes[this.store.current.app.mode],
                    this.store.current.app.code
                );
                overlayConfig.data.example_story_slug = slug;
                overlayConfig.data.example_story_url = 'data:text/html;base64,' + window.btoa(overlayConfig.data.example_story_url);
            }

            this.set('overlayScene', overlayConfig.data);
            this.set('overlayName', component.name);
            this.overlayHidden = false;
        }
    });
</script>
