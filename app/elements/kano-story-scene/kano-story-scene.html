<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../kano-view/kano-view.html">
<dom-module id="kano-story-scene">
    <style>
    :host {
        display: block;
        position: relative;
        @apply(--layout-vertical);
        overflow: hidden;
    }
    :host #view {
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    :host #overlay {
        position: absolute;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
        @apply(--layout-vertical);
        display: none;
    }
    :host #overlay>* {
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }
    </style>
    <template>
        <kano-view id="view"
                location="[[location]]"
                view-name="[[name]]"
                attributes="{{attributes}}"
                on-scene-done="sceneFinished"></kano-view>
        <div id="overlay"></div>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer */

    Polymer({
        is: 'kano-story-scene',
        properties: {
            scene: {
                type: Object,
                value: () => {
                    return {};
                }
            },
            storyName: {
                type: String,
                value: ''
            },
            nextStory: {
                type: Object
            },
            location: {
                type: String
            },
            name: {
                type: String
            },
            attributes: {
                type: Object
            },
            store: {
                type: Object,
                value: () => {
                    return {};
                }
            },
            extensions: {
                type: Array
            }
        },
        observers: [
            'componentChanged(scene.component)',
            'extensionsChanged(extensions.*)'
        ],
        extensionsChanged(e) {
            this.set(`attributes.${e.path}`, e.value);
        },
        ready () {
            this.overlayDone = this.overlayDone.bind(this);
            this.overlay = null;
        },
        sceneFinished (e) {
            if (this.scene.overlay_after) {
                e.stopPropagation();
                this.setupOverlay(this.scene.overlay_after);
            } else if (this.scene.show_remix_options) {
                this.set('attributes.scene.ended', true);
            }
        },
        componentChanged () {
            let scene = this.scene,
                attributes = {},
                pieces,
                name,
                loc;
            if (!scene.component && !scene.load) {
                return;
            }
            if (scene.load) {
                this.$.view.mountComponent(this.savedScenes[scene.load]);
                return;
            }
            this.setupOverlay(scene.overlay_before);
            // Cut using '/'
            pieces = scene.component.split('/');
            // Extract the last piece
            name = pieces.pop();
            // Join back the first pieces to get the location
            loc = pieces.join('/');
            this.set('location', `assets/stories/${loc}`);
            attributes.store = this.store;
            attributes.storyName = this.storyName;
            attributes.nextStory = this.nextStory;
            attributes.scene = Object.assign({}, scene.data);
            attributes.extensions = this.extensions;
            // Let the end of the overlay load the data
            if (!scene.overlay_before) {
                attributes.scene.started = true;
            }
            this.set('attributes', attributes);
            this.set('name', `kano-scene-${name}`);
        },
        overlayDone () {
            let started = false;
            if (!this.beforeDone && this.scene.overlay_before) {
                this.beforeDone = true;
                started = true;
            } else if (this.scene.overlay_after) {
                if (this.scene.show_remix_options) {
                    this.set('attributes.scene.ended', true);
                }

                this.fire('scene-done');
            }
            this.overlay.end().then(() => {
                this.$.overlay.style.display = 'none';
                if (started) {
                    this.set('attributes.scene.started', true);
                }
            });
        },
        setupOverlay (overlayConfig) {
            let pieces,
                name,
                loc,
                el;
            if (!overlayConfig || !overlayConfig.component) {
                return;
            }
            // Cut using '/'
            pieces = overlayConfig.component.split('/');
            // Extract the last piece
            name = pieces.pop();
            // Join back the first pieces to get the location
            loc = pieces.join('/');
            el = document.createElement('kano-view');
            el.location = `assets/stories/${loc}`;
            el.viewName = `kano-scene-${name}`;
            el.attributes = {
                scene: overlayConfig.data
            };
            this.$.overlay.style.display = 'flex';
            el.addEventListener('overlay-done', this.overlayDone);
            el.style.flex = 1;
            while (this.$.overlay.firstChild) {
                this.$.overlay.removeChild(this.$.overlay.firstChild);
            }
            this.overlay = el;
            this.$.overlay.appendChild(el);
        }
    });
</script>
