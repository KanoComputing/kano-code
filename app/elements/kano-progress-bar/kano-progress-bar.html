<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/web-components/kano-style/typography.html">
<link rel="import" href="../../bower_components/web-components/kano-modal/kano-modal.html">

<!--
`kano-progress-bar`
@group Kano Elements
@demo demo/kano-progress-bar.html

The following custom properties and mixins are also available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--kano-progress-bar-bg-color` | Custom property applied to the progress bar background color | `{}`,
`--kano-progress-bar-color` | Custom property to the progress bar fill color | `{}`
`--kano-progress-bar-label` | Mixin applied to the progress label | `{}`
-->

<dom-module id="kano-progress-bar">
    <style>
        :host {
            display: block;
            width: 100%;
        }
        :host .slider-container {
            height: 100%;
            position: relative;
        }
        :host .label-container {
            position: absolute;
            top: -40px;
            left: 0;
            width: 100%;
            transform: translateX(-90%);
            font-family: var(--font-body, sans-serif);
            @apply --kano-progress-bar-label;
        }
        :host .label {
            float: right;
        }
        :host #progress-fill {
            width: 100%;
            height: 100%;
            background: var(--kano-progress-bar-color, #9fd465);
            border-radius: 12px;
            transform: translateX(-90%);
        }
        :host .progress-shadow {
            position: relative;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            z-index: 2;
            overflow: hidden;
            border-radius: 12px;
            background: var(--kano-progress-bar-bg-color, #e5e5e5);
        }
    </style>
    <template>
        <div id="progress" class="slider-container">
            <div class="progress-shadow">
                <div id="progress-fill"></div>
            </div>
                <div hidden$="[[!withDisplay]]" id="progress-label" class="label-container">
                    <div class="label">
                        <slot name="label"></slot>
                    </div>
                </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'kano-progress-bar',
        properties: {
            rate: {
                type: Number,
                observer: '_onRateChanged',
                notify: true
            },
            unitValue: {
                type: Number,
                value: 1
            },
            currentValue: {
                type: Number,
                value: null,
                notify: true
            },
            /**
             * Speed of progress animation
             */
            speed: {
                type: Number,
                value: 600
            },
            animating: {
                type: Boolean,
                value: false,
                notify: true
            },
            withDisplay: {
                type: Boolean,
                value: false
            }
        },
        attached () {
            this._onTransitionEnd = this._onTransitionEnd.bind(this);
        },
        _onRateChanged (newRate, oldRate) {
            if (this.animating) {
                return;
            }
            //limit rate between 0 and 100
            newRate = this._limitingValue(newRate, 0, 100);
            //setup bar or animate change
            if (typeof oldRate === 'undefined') {
                this._setupBar(this._limitingValue(newRate, 0, 100));
            } else {
                this._animateProgress(newRate, this._limitingValue(oldRate, 0, 100));
            }
        },
        _setupBar (rate) {
            this.$['progress-fill'].style.transform = `translateX(-${100 - rate}%)`;
            if (this.withDisplay) {
                this.$['progress-label'].style.transform = `translateX(-${100 - rate}%)`;
            }
            this._checkLimits(rate);
        },
        _animateProgress (newRate, oldRate) {
            if (newRate === oldRate) {
                return;
            }
            this.animating = true;

            this.$['progress-fill'].addEventListener('transitionend', this._onTransitionEnd);   
            this.$['progress-fill'].style.transition = `transform ${this.speed}ms linear`;
            this.$['progress-fill'].style.transform = `translateX(-${100 - newRate}%)`;
            //If value is available, increment it while animating
            if (this.currentValue && this.unitValue) {
                let newValue = this._computeNewValue(newRate, oldRate);
                this._incrementValue(newValue, this.speed / Math.abs(newRate - oldRate));
            }
            if (this.withDisplay) {
                this.$['progress-label'].style.transition = `transform ${this.speed}ms linear`;
                this.$['progress-label'].style.transform = `translateX(-${100 - newRate}%)`;
            }
        },
        _incrementValue (target, frequency) {
            // incrementing up or down
            let cent = target > this.currentValue ? +this.unitValue : -this.unitValue;
            let incrementing = setInterval(() => {
                this.currentValue = this.currentValue + cent;
                if (this.currentValue === target) {
                    clearInterval(incrementing);
                }
            }, frequency);
        },
        _computeNewValue (newRate, oldRate) {
            //TODO extreme values should be more accurate (rounding issues)
            let zeroPercentValue = Math.round(this.currentValue - oldRate * this.unitValue),
                hundredPercentValue = Math.round(this.currentValue + (100 - oldRate) * this.unitValue),
                newValue = Math.round(newRate * this.unitValue + zeroPercentValue);
            return this._limitingValue(newValue, zeroPercentValue, hundredPercentValue);
        },
        _limitingValue (value, min, max) {
            value = Math.min(value, max);
            value = Math.max(value, min);
            return value;
        },
        _checkLimits (rate) {
            if (rate <= 0) {
                this.fire('min-reached');
            } else if (rate >= 100) {
                this.fire('max-reached');
            }
        },
        _onTransitionEnd () {
            this.animating = false;
            this.$['progress-fill'].removeEventListener('transitionend', this.toggleAnimationFlag);
        }
    });
</script>