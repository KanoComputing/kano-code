<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../../bower_components/web-components/kano-modal/kano-modal.html">

<!--
`kano-progress-bar`
@group Kano Elements
@demo demo/kano-progress-bar.html

The following custom properties and mixins are also available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--kano-progress-bar-bg-color` | Mixin applied to the progress bar background color | `{}`,
`--kano-progress-bar-color` | Mixin applied to the progress bar fill color | `{}`
-->

<dom-module id="kano-progress-bar">
    <style>
        :host {
            display: block;
            width: 100%;
        }
        :host .slider-container {
            height: 100%;
        }
        :host #progress-label {
            width: 100%;
            height: 50px;
            transform: translateX(-90%);
            font-family: 'Bariol', sans-serif;
        }
        :host #progress-fill {
            width: 100%;
            height: 100%;
            background: var(--kano-progress-bar-color, #9fd465);
            border-radius: 12px;
            transform: translateX(-90%);
        }
        :host .progress-shadow {
            position: relative;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            z-index: 2;
            overflow: hidden;
            border-radius: 12px;
            background: var(--kano-progress-bar-bg-color, #e5e5e5);
        }
    </style>
    <template>
        <div id="progress" class="slider-container">
            <div class="progress-shadow">
                <div id="progress-fill"></div>
            </div>
                <slot name="label" id="progress-label"></slot>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'kano-progress-bar',
        properties: {
            /**
             * The minimum value in the progress bar's range
             */
            min: {
                type: Number,
                value: 0,
            },
            /**
             * The maximum value in the progress bar's range
             */
            max: {
                type: Number,
                value: 100
            },
            startValue: {
                type: Number,
                value: 0,
                observer: 'initializeBar'
            },
            targetValue: {
                type: Number,
                observer: '_launchAnimation'
            },
            /**
             * Immediate value while incrementing in progress
             */
            immediateValue: {
                type: Number
            },
            /**
             * Speed of the transition
             */
            speed: {
                type: Number,
                value: 600
            }
        },
        initializeBar (value) {
            let startRatio = this.startValue / this.max;
            if (!this.immediateValue) {
                this.$['progress-fill'].style.transform = `translateX(-${100 - startRatio * 100}%)`;
                this.$['progress-label'].style.transform = `translateX(-${100 - startRatio * 100}%)`;
            }
        },
        addValue (value, speed) {
            this.speed = speed || this.speed;
            this.$['progress-fill'].style.transition = `transform ${this.speed}ms linear`;
            this.$['progress-label'].style.transition = `transform ${this.speed}ms linear`;
            this.targetValue = this.startValue + value;
        },
        _launchAnimation (targetValue) {
            let newRatio = targetValue / this.max <= 1 ? targetValue / this.max : 1,
                interval = this.speed / targetValue;
            this._incrementXp(targetValue, interval);
            this._animateProgress(newRatio);
        },
        _incrementXp (target, interval) {
            this.immediateValue = this.startValue;
            let incrementing = setInterval(() => {
                this.immediateValue++;
                if (this.immediateValue > target) {
                    this.startValue = this.immediateValue;
                    clearInterval(incrementing);
                }
            }, interval);
        },
        _animateProgress (ratio) {
            this.$['progress-fill'].style.transform = `translateX(-${100 - ratio * 100}%)`;
            this.$['progress-label'].style.transform = `translateX(-${100 - ratio * 100}%)`;
        }
    });
</script>