<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../kano-app-challenge/kano-app-challenge.html">
<link rel="import" href="../kano-minecraft/kano-minecraft.html">

<link rel="import" href="./app-modules-import.html">

<script src="../../scripts/kano/vm.js"></script>

<dom-module id="kc-minecraft-challenge">
    <template>
        <style>
            :host {
                display: block;
                @apply --layout-vertical;
            }
            kano-app-challenge, kano-minecraft {
                @apply --layout-vertical;
                @apply --layout-flex;
            }
        </style>
        <kano-app-challenge steps="[[steps]]" started="[[started]]">
            <kano-minecraft slot="editor" code="{{code}}"></kano-minecraft>
        </kano-app-challenge>
    </template>
    <script>
        Polymer({
            is: 'kc-minecraft-challenge',
            properties: {
                challenge: {
                    type: String,
                    observer: '_challengeChanged'
                },
                code: {
                    type: String,
                    observer: '_codeChanged'
                }
            },
            attached () {
                this.appModules = new Kano.AppModules.createStandalone();
                this.appModules.init({});
            },
            _challengeChanged (challenge) {
                fetch(`/assets/minecraft/challenges/${challenge}.json`)
                    .then(r => r.json())
                    .then(ch => {
                        this.steps = ch.steps;
                        this.started = true;
                    });
            },
            _codeChanged (code) {
                this.debounce('run', this._run, 300);
            },
            _run () {
                let appCode,
                    vm;
                this.appModules.stop();

                // Generate the code
                appCode = this.appModules.createAppCode('AppModules', this.code);

                // Prepare a sandbox exposing AppModules
                vm = new Kano.VM({ AppModules: this.appModules });
                // Run the code
                vm.runInContext(appCode);
                // Start all the modules. Will also trigger the `start` event from `global`
                this.appModules.start();
            }
        });
    </script>
</dom-module>