<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/polymer-filters/polymer-filters.html">
<link rel="import" href="../../bower_components/polymer-filters/filters/compare.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/web-components/kano-icons/kano-icons.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../../scripts/kano/make-apps/parts-api/light-frame.html">
<link rel="import" href="../../scripts/kano/app-modules/lightboard.html">
<link rel="import" href="../behaviors/kano-app-editor-behavior.html">
<link rel="import" href="../kano-pixel-canvas/kano-pixel-canvas.html">
<link rel="import" href="../inputs/kano-input-text/kano-input-text.html">
<link rel="import" href="../inputs/kano-input-color/kano-input-color.html">
<link rel="import" href="../inputs/kano-input-range/kano-input-range.html">
<link rel="import" href="../kano-media-query/kano-media-query.html">
<link rel="import" href="../kano-icons/parts.html">
<link rel="import" href="../kano-icons/kc-ui.html">
<link rel="import" href="../kano-code-shared-styles/kano-code-shared-styles.html">
<link rel="import" href="../kano-style/themes/dark.html">
<dom-module id="kano-light-frame-editor-panel">
    <style include="kano-code-shared-styles">
        :host {
            @apply --layout-vertical;
            @apply --layout-center-justified;
            width: 880px;
            background-color: #292f35;
            --part-theme: #00d9c7;
        }
        :host label {
            @apply --layout-self-start;
            display: inline-block;
            font-family: var(--font-body);
            font-size: 14px;
            font-weight: bold;
            text-align: left;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            margin-bottom: 19px;
        }
        iron-icon  {
            --iron-icon-height: 32px;
            --iron-icon-width: 32px;
            transition: fill 300ms;
        }
        .center-panel {
            @apply --layout-horizontal;
        }
        .side-menu {
            @apply --layout-vertical;
            border-right: 1px solid var(--kano-app-part-editor-border);
        }
        .side-menu button {
            @apply --kano-button;
            display: block;
            width: 56px;
            height: 56px;
            background-color: transparent;
            border-radius: 0;
            padding: 0;
        }
        .side-menu button iron-icon {
            fill: rgba(255,255,255,0.5);
        }
        .side-menu button:hover {
            background: #54595d;
        }
        .side-menu button.selected {
            background: #5b646b;
        }
        .side-menu button:hover iron-icon,
        .side-menu button.selected iron-icon {
            fill: #fff;
        }
        #palette {
            @apply --layout-horizontal;
            @apply --layout-justified;
            width: 148px;
            text-align: left;
        }
        .canvas-container {
            @apply --layout-flex-none;
            @apply --layout-vertical;
            @apply --layout-center-justified;
            @apply --layout-center;
            width: 554px;
            height: 340px;
        }
        .canvas-container iron-pages {
            @apply --layout-horizontal;
            @apply --layout-center-justified;
            margin-top: -1px;
            margin-left: -1px;
        }
        .control-container {
            @apply --layout-flex-auto;
            @apply --layout-horizontal;
            border-left: 1px solid var(--kano-app-part-editor-border);
        }
        .control-container label {
            margin: 34px 0 20px
        }
        .control-content {
            @apply --layout-flex-auto;
            @apply --layout-horizontal;
            padding: 0 28px;
        }
        .control-content>* {
            @apply --layout-flex-auto;
            @apply --layout-vertical;
        }
        .control-content .custom-colour-header {
            @apply --layout-horizontal;
            @apply --layout-center;
            @apply --layout-justified;
            margin: 0 14px 20px 0;
        }
        .control-content .custom-colour-header button {
            @apply --kano-button;
            @apply --layout-horizontal;
            @apply --layout-center;
            font-size: 14px;
            line-height: 18px;
            font-weight: bold;
            background-color: transparent;
            color: rgba(255,255,255,0.5);
            padding: 0;
            transition: background-color 300ms;
        }
        .control-content .custom-colour-header label {
            margin: 0 18px 0 0; 
        }
        .control-content .custom-colour-header button:not(:last-child) {
            margin-right: 14px;
        }
        .control-content .custom-colour-header iron-icon {
            --iron-icon-height: 16px;
            --iron-icon-width: 16px;
            margin-right: 4px;
        }
        .control-content .custom-colour-header button:hover {
            color: #fff;
        }
        .control-content .custom-colour-header button:hover iron-icon {
            fill: var(--part-theme);
        }
        .control-content kano-tooltip {
            --kano-tooltip-border-color: var(--color-dark);
            --kano-tooltip-background-color: var(--color-dark);
            --kano-tooltip-caret: {
                @apply(--shadow-elevation-2dp);
            };
        }
        .control-container kano-input-range:first-child {
            margin-right: 16px;
        }
        #default-palette,
        #custom-palette {
            --kano-input-color-size: 32px;
            --kano-input-color-margin: 0.5px;
            --kano-color-input-field: {
                margin: 0;
                padding: 2px;
            };
        }
        #default-palette {
            margin-bottom: 38px;
        }
        #custom-palette {
            height: 103px;
            width: 97%;
            overflow: auto;
            margin-bottom: 0;
        }
        .settings {
            @apply --layout-vertical;
            @apply --layout-flex-auto;
        }
        button.add-frame iron-icon {
            --iron-icon-height: 18px;
            --iron-icon-width: 18px;
            fill: #999;
        }
        :host button.add-frame:hover iron-icon {
            fill: var(--color-kano-orange);
        }
        button.add-frame:disabled {
            opacity: 0.3;
        }
    </style>
    <template>
        <div class="center-panel">
            <div class="side-menu">
                <iron-selector selected="[[penType]]" attr-for-selected="name">
                    <button id="draw-button" class="side-menu-button" on-tap="_penControlTapped" name="draw">
                        <iron-icon icon="kc-ui:paint-draw"></iron-icon>
                    </button>
                    <button id="fill-button" class="side-menu-button" on-tap="_penControlTapped" name="fill">
                        <iron-icon icon="kc-ui:paint-fill"></iron-icon>
                    </button>
                    <button id="erase-button" class="side-menu-button" on-tap="_penControlTapped" name="erase">
                        <iron-icon icon="kc-ui:paint-erase"></iron-icon>
                    </button>
                </iron-selector>
                <button id="settings-button" class="side-menu-button" on-tap="_settingsTapped">
                    <iron-icon icon="kc-ui:settings"></iron-icon>
                </button>
            </div>
            <div class="canvas-container">
                <slot name="canvas"></slot>
            </div>
            <div class="control-container">
                    <iron-pages class="control-content" selected="[[controlPanel]]" attr-for-selected="name">
                        <div name="palette">
                            <label>Colors</label>
                            <kano-input-color id="default-palette" 
                                              on-value-changed="_onColorChange"
                                              idle="[[customPaletteActive]]"
                                              row-size="6"></kano-input-color>
                            <div class="custom-colour-header">
                                <label>Custom</label>
                                <kano-tooltip id="tooltip" 
                                              class="tooltip"
                                              position="right"
                                              target="[[tooltipTarget]]"
                                              opened="{{wheelOpened}}"
                                              auto-close>
                                    <kano-color-wheel id="wheel" 
                                                      on-value-changed="_addCustomColor"
                                                      render-later></kano-color-wheel>
                                </kano-tooltip>
                                <button id="custom-colour-add" type="button" on-tap="_openWheel">
                                    <iron-icon class="add-icon" icon="kc-ui:add"></iron-icon>
                                    <span >Add</span>
                                </button>
                            </div>
                            <kano-input-color id="custom-palette"
                                              on-value-changed="_onColorChange"
                                              idle="[[!customPaletteActive]]"
                                              row-size="6"></kano-input-color>
                        </div>
                        <div name="settings" class="settings">
                            <label>Settings</label>
                            <slot name="settings"></slot>
                        </div>
                    </iron-pages>
            </div>
        </div>
    </template>
    <script type="text/javascript">
        Polymer({
            is: 'kano-light-frame-editor-panel',
            behaviors: [
                PolymerFilters.FilterBehavior,
                Kano.Behaviors.AppElementRegistryBehavior,
                Kano.Behaviors.AppEditorBehavior,
                Kano.MakeApps.PartsAPI['light-frame']
            ],
            properties: {
                selected: {
                    type: Object,
                    notify: true
                },
                name: {
                    type: String
                },
                penType: {
                    type: String,
                    computed: '_computePenType(_penType, _isShiftPressed)',
                    notify: true
                },
                penColor: {
                    type: String,
                    observer: '_penColorChanged',
                    notify: true
                },
                wheelOpened: {
                    type: Boolean,
                    observer: '_wheelStatusChanged'
                },
                controlPanel: {
                    type: String,
                    value: 'palette'
                },
                customPaletteActive: {
                    type: Boolean,
                    value: false
                },
                _isShiftPressed:{
                    type: Boolean,
                    value: false
                }
            },
            observers: [
                '_onControlPanelChanged(controlPanel, penType)'
            ],
            attached () {
                this.set('_penType', 'draw');
            },
            _addCustomColor (e) {
                this.$['custom-palette'].addColor(e.detail.value);
                this.$.tooltip.close();
            },
            _computePalette (colors) {
                this.debounce('palette', () => {
                    let palette = colors.slice(0);
                    palette.push(this.penColor);

                    // Remove duplicates and color already in the default palette
                    palette = palette.filter((elem, pos, self) => {
                        return self.indexOf(elem) === pos && this.$['default-palette'].colors.indexOf(elem) === -1 &&
                                elem !== null && typeof elem !== 'undefined';
                    });
                    this.$['custom-palette'].set('colors', palette);
                }, 16);
            },
            _computePenType (penType, shiftPressed) {
                return shiftPressed ? 'fill' : penType;
            },
            _penControlTapped (e) {
                if (this._isShiftPressed) {
                    return;
                }
                const target = e.currentTarget ? e.currentTarget : Polymer.dom(e).rootTarget;
                this.controlPanel = 'palette';
                this.set('_penType', target.getAttribute('name'));
            },
            _settingsTapped () {
                this.controlPanel = 'settings';
            },
            _onControlPanelChanged (panel, penType) {
                if (panel === 'palette' && this._isShiftPressed) {
                    return;
                } else if (panel === 'palette') {
                    this._highlightSideMenuButton(`${penType}-button`);
                } else {
                    this._highlightSideMenuButton(`${panel}-button`);
                }
            },
            _highlightSideMenuButton (id) {
                Polymer.dom(this.root).querySelectorAll('.side-menu-button').forEach((el) => {
                    this.toggleClass('selected', el.id === id, el);
                }, this)
            },
            _openWheel (e) {
                const target = e.currentTarget ? e.currentTarget : Polymer.dom(e).rootTarget;
                this._renderWheel();
                this.async(() => {
                    this.$.tooltip.set('target', target.getBoundingClientRect());
                    this.$.tooltip.open();
                });
            },
            _renderWheel () {
                if (this._wheelRendered) {
                    return;
                }
                this._wheelRendered = true;
                this.$.wheel.render();
            },
            _onColorChange (e) {
                if (e.detail.value) {
                    this.customPaletteActive = Polymer.dom(e).rootTarget.id === 'custom-palette';
                    this.penColor = e.detail.value;
                }
            },
            _penColorChanged (newValue, oldValue) {
                if (newValue && oldValue) {
                    this.notifyChange('light-animation-color-changed', { value: newValue });
                }
            },
            _wheelStatusChanged (opened) {
                const event = opened ? 'light-animation-wheel-open' : 'light-animation-wheel-close';
                this.notifyChange(event);
            },
            getElementsRegistry () {
                return {
                    'brush-button': this.$['draw-button'],
                    'bucket-button': this.$['fill-button'],
                    'colors': this.$['default-palette'].getColorField(),
                    'add-color-button': this.$['add-color'],
                    'color-wheel': this.$['wheel']
                }
            },
        });
    </script>
</dom-module>
