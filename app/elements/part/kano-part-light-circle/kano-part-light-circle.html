<link rel="import" href="../kano-light-shape-behavior.html">
<link rel="import" href="../../kano-style/part.html">
<link rel="import" href="../../../scripts/kano/make-apps/parts-api/light-circle.html">
<dom-module id="kano-part-light-circle">
    <style is="custom-style" include="part-style"></style>
    <style>
    :host {
        display: block;
    }
    .container {
        position: relative;
        border: 1px solid blue;
    }
    .pixel {
        width: 21px;
        height: 21px;
        margin: 3px;
    }
    .canvas {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        padding: 2px;
    }
    .container[running] {
        display: none;
    }
    </style>
    <template>
        <div class="container" style$="[[_computeContainerStyle(model.userProperties.*)]]" running$="[[isRunning]]">
            <div id="pixel-array" class="canvas"></div>
        </div>
    </template>
    <script type="text/javascript">
        /* globals Polymer, Kano */

        Polymer({
            is: 'kano-part-light-circle',
            behaviors: [Kano.MakeApps.PartsAPI['light-circle'], Kano.Behaviors.LightShapeBehavior],
            _computeContainerStyle () {
                let radius = this.model.userProperties.radius,
                    size = ((radius * 2) + 1) * this.PIXEL_SIZE + 4,
                    container = this.$['pixel-array'],
                    bitmap = new Array(Math.pow(radius, 2)),
                    i = 0,
                    distance,
                    div;
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
                for (let y = -radius; y <= radius; y++) {
                    for (let x = -radius; x <= radius; x++) {
                        distance = Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2));
                        if (radius >= distance) {
                            bitmap[i] = this.model.userProperties.color;
                        } else {
                            bitmap[i] = null;
                        }
                        i++;
                    }
                }
                bitmap.forEach((color) => {
                    div = document.createElement('div');
                    div.className = 'pixel';
                    div.style.backgroundColor = color;
                    container.appendChild(div);
                });
                return `width: ${size}px; height: ${size}px;`;
            },
            applyTransform () {
                if (!this.model) {
                    return;
                }
                let radius = parseInt(this.model.userProperties.radius),
                    x = this.OFFSET_X + this.PIXEL_SIZE * (this.getX() - radius),
                    y = this.OFFSET_Y + this.PIXEL_SIZE * (this.getY() - radius);

                this.transform(`translate(${x}px, ${y}px)`);
            }
        });
    </script>
</dom-module>
