<link rel="import" href="../../ui/behaviors.html">
<link rel="import" href="../../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<dom-module id="kano-part-microphone">
    <style>
    :host {
        display: block;
    }
    .container {
        position: relative;
        width: 50px;
        height: 50px;
    }
    .canvas-container, .ripple {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
    }
    :host[disabled] .ripple {
        background-color: #9e9e9e;
    }
    .ripple {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgb(229, 57, 53);
        transition: background-color linear 150ms;
    }
    iron-image {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        @apply(--shadow-elevation-2dp);
    }
    </style>
    <template>
        <div class="container">
            <div class="ripple" style$="[[_computeRippleStyle(volume)]]"></div>
            <div class="ripple" style$="[[_computeRippleStyle(low)]]"></div>
            <iron-image src="[[model.image]]" sizing="cover"></iron-image>
        </div>
    </template>
    <script type="text/javascript">
        /* globals Polymer, Kano */

        // Cross browser tweaks
        // Putting getUserMedia in navigator is a wrong practice, since the spec moved it inside MediaDevices
        // but calling it outside of navigator will fail on chrome
        window.MediaDevices = window.MediaDevices || {};
        if (window.MediaDevices && window.MediaDevices.getUserMedia) {
            navigator.getUserMedia = window.MediaDevices.getUserMedia;
        }
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        window.AudioContext = window.AudioContext || window.webkitAudioContext;


        Polymer({
            is: 'kano-part-microphone',
            behaviors: [Kano.Behaviors.UIBehavior],
            properties: {
                volume: {
                    type: Number,
                    value: 0,
                    readOnly: true,
                    notify: true
                },
                low: {
                    type: Number,
                    value: 0,
                    readOnly: true,
                    notify: true
                },
                disabled: {
                    type: Boolean,
                    value: false,
                    notify: true,
                    reflectToAttribute: true
                }
            },
            attached () {
                this._onStreamReady = this._onStreamReady.bind(this);
                this._onStreamError = this._onStreamError.bind(this);
                try {
                    navigator.getUserMedia({ audio: true }, this._onStreamReady, this._onStreamError);
                } catch (e) {
                    this.fire('kano-error', {
                        text: `Your browser doesn't support audio input. The microphone part has been disabled`,
                        duration: 0,
                        closeWithButton: true,
                        buttonText: 'OK'
                    });
                    this.disabled = true;
                }
            },
            detached () {
                cancelAnimationFrame(this.requestId);
                if (this.stream) {
                    this.stream.getAudioTracks().forEach(function(track) {
                        track.stop();
                    });
                }
            },
            _onStreamReady (stream) {
                this.disabled = false;
                this.stream = stream;
                this.audioContext = new window.AudioContext();
                this.analyser = this.audioContext.createAnalyser();
                this.source = this.audioContext.createMediaStreamSource(stream);
                this.analyser.smoothingTimeConstant = 0.5;
                this.analyser.fftSize = 64;
                this.soundData = new Uint8Array(this.analyser.frequencyBinCount);

                this.source.connect(this.analyser);
                this._updateVisualisation();
            },
            _onStreamError (e) {
                if (e.name === 'PermissionDeniedError') {
                    this.fire('kano-error', {
                        text: `Make apps need the right permissions to use the microphone. You can allow that in your browser's settings`,
                        duration: 0,
                        closeWithButton: true,
                        buttonText: 'OK'
                    });
                }
                this.disabled = true;
            },
            _updateVisualisation () {
                let stats;
                // Populates the sound data array
                this.analyser.getByteFrequencyData(this.soundData);
                stats = this._getSoundStats(this.soundData);
                this._setVolume(Math.min(120, stats.volume) / 1.2);
                this._setLow(Math.min(120, stats.low) / 1.2);
                this.requestId = requestAnimationFrame(this._updateVisualisation.bind(this));
            },
            _computeRippleStyle (volume) {
                return `box-shadow: 0px 0px 0px ${(volume * 0.5)}px rgba(229, 57, 53, 0.4);`;
            },
            _getSoundStats (array) {
                let values = 0,
                    lows = 0,
                    length = array.length,
                    average;

                // get all the frequency amplitudes
                for (let i = 0; i < length; i++) {
                    values += array[i];
                    if (i === 21) {
                        lows = values;
                    }
                }

                average = values / length;
                return { volume: average, low: lows / 21 };
            }
        });
    </script>
</dom-module>
