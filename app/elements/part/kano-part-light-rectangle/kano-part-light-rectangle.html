<link rel="import" href="../../behaviors/kano-emitter-behavior.html">
<link rel="import" href="../kano-light-shape-behavior.html">
<link rel="import" href="../../kano-style/part.html">
<dom-module id="kano-part-light-rectangle">
    <style is="custom-style" include="part-style"></style>
    <style>
    :host {
        display: block;
    }
    .container {
        position: relative;
        border: 1px solid blue;
    }
    .pixel {
        width: 21px;
        height: 21px;
        margin: 3px;
    }
    .canvas {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        padding: 2px;
    }
    .container[running] {
        display: none;
    }
    </style>
    <template>
        <div class="container" style$="[[_computeContainerStyle(model.userProperties.*)]]" running$="[[isRunning]]">
            <div id="pixel-array" class="canvas"></div>
        </div>
    </template>
    <script type="text/javascript">
        /* globals Polymer, Kano */

        Polymer({
            is: 'kano-part-light-rectangle',
            behaviors: [Kano.Behaviors.LightShapeBehavior, Kano.Behaviors.EmitterBehavior],
            _computeContainerStyle () {
                let width = this.model.userProperties.width * this.PIXEL_SIZE + 4,
                    height = this.model.userProperties.height * this.PIXEL_SIZE + 4,
                    length = this.model.userProperties.width * this.model.userProperties.height,
                    container = this.$['pixel-array'],
                    div;
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
                for (let i = 0; i < length; i++) {
                    div = document.createElement('div');
                    div.className = 'pixel';
                    div.style.backgroundColor = this.model.userProperties.color;
                    container.appendChild(div);
                }
                return `width: ${width}px; height: ${height}px;`;
            },
            stop () {
                Kano.Behaviors.UIBehavior.stop.apply(this, arguments);
                Kano.Behaviors.EmitterBehavior.stop.apply(this, arguments);
            },
            setWidth (w) {
                this.set('model.userProperties.width', w);
                this._updateLightboard();
            },
            getWidth () {
                return this.get('model.userProperties.width');
            },
            setHeight (h) {
                this.set('model.userProperties.height', h);
                this._updateLightboard();
            },
            getHeight () {
                return this.get('model.userProperties.height');
            },
            setColor (c) {
                this.set('model.userProperties.color', c);
                this._updateLightboard();
            },
            getColor () {
                return this.get('model.userProperties.color');
            },
            _updateLightboard () {
                this.debounce('_updateLightboard', () => {
                    if (this.isRunning) {
                        let shape = {
                            id: this.model.id,
                            x: this.getX(),
                            y: this.getY(),
                            width: parseInt(this.model.userProperties.width),
                            height: parseInt(this.model.userProperties.height),
                            color: this.model.userProperties.color,
                            type: 'rectangle'
                        };
                        this.fire('update-shape', shape);
                    }
                });
            }
        });
    </script>
</dom-module>
