<script src="../../../../monaco-editor-element/dist/monaco-editor/vs/loader.js"></script>
<script src="../../../../monaco-editor-element/monaco-editor.js"></script>
<link rel="import" href="../../scripts/kano/make-apps/store.html">
<link rel="import" href="../kano-style/themes/dark.html">
<link rel="import" href="../../scripts/legacy/store.html">

<dom-module id="kc-code-editor">
    <template>
        <style>
            :host {
                display: block;
                position: relative;
                background-color: var(--color-grey-darker, grey);
            }
        </style>
        <monaco-editor id="editor"
                        namespace="bower_components/monaco-editor-element/dist/monaco-editor/vs"
                        theme="vs-dark"
                        on-ready="_editorReady"
                        on-changed="_editorSourceChanged"></monaco-editor>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer, Kano, monaco */

    class KCCodeEditor extends Kano.Code.Store.StateReceiver(Polymer.Element) {
        static get is() { return 'kc-code-editor'; }
        static get properties() {
            return {
                noUser: {
                    type: Boolean,
                    value: true,
                },
                noBack: {
                    type: Boolean,
                    value: true,
                },
                toolbox: {
                    type: Array,
                    linkState: 'toolbox',
                },
                code: {
                    type: Object,
                    linkState: 'code',
                },
                source: {
                    type: Object,
                    linkState: 'source',
                    observer: '_sourceChanged',
                },
                user: {
                    type: Object,
                    linkState: 'user',
                },
                logoutEnabled: {
                    type: Boolean,
                    linkState: 'editor.logoutEnabled',
                },
            };
        }
        _sourceChanged() {
            this.$.editor.value = this.source;
        }
        _editorReady() {
            monaco.languages.typescript.javascriptDefaults.setDiagnosticsOptions({
                noSemanticValidation: true,
                noSyntaxValidation: false,
            });

            monaco.languages.typescript.javascriptDefaults.setCompilerOptions({
                target: monaco.languages.typescript.ScriptTarget.ES2015,
                allowNonTsExtensions: true,
            });
            this._sourceChanged();
            this.computeToolbox();
        }
        _editorSourceChanged() {
            const code = this.$.editor.value;
            this.dispatch({ type: 'UPDATE_CODE', code });
        }
        computeToolbox() {
            if (!this.toolbox || !window.monaco) {
                return;
            }
            this.toolbox.forEach((category) => {
                monaco.languages.typescript.javascriptDefaults
                    .addExtraLib(category.definitionFile, category.id);
            });
        }
        canRemovePart(part) {
            return false;
        }
        getSource() {
            return this.$.editor.value;
        }
    }

    customElements.define(KCCodeEditor.is, KCCodeEditor);

</script>
