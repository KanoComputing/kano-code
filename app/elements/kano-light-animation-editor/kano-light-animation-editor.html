<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/polymer-filters/polymer-filters.html">
<link rel="import" href="../../bower_components/polymer-filters/filters/compare.html">
<link rel="import" href="../../bower_components/web-components/kano-icons/kano-icons.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../../scripts/kano/make-apps/parts-api/light-animation.html">
<link rel="import" href="../../scripts/kano/app-modules/lightboard.html">
<link rel="import" href="../kano-palette/kano-palette.html">
<link rel="import" href="../kano-pixel-canvas/kano-pixel-canvas.html">
<link rel="import" href="../kano-bitmap-renderer/kano-bitmap-renderer.html">
<link rel="import" href="../kano-bitmap-list/kano-bitmap-list.html">
<link rel="import" href="../kano-icons/parts.html">
<link rel="import" href="../kano-media-query/kano-media-query.html">
<link rel="import" href="../kano-animated-svg/kano-animated-svg.html">
<link rel="import" href="../kano-style/themes/dark.html">
<link rel="import" href="../inputs/kano-input-range/kano-input-range.html">
<link rel="import" href="../inputs/kano-input/kano-input.html">
<link rel="import" href="../inputs/kano-input-color/kano-input-color.html">
<link rel="import" href="../kano-code-shared-styles/kano-code-shared-styles.html">
<link rel="import" href="../behaviors/kano-media-query-behavior.html">
<link rel="import" href="../behaviors/kano-app-element-registry-behavior.html">
<link rel="import" href="../behaviors/kano-app-editor-behavior.html">
<dom-module id="kano-light-animation-editor">
    <style include="kano-code-shared-styles">
        :host {
            width: 880px;
            @apply --layout-vertical;
            @apply --layout-center-justified;
            background-color: var(--color-dark);
        }
        :host label {
            @apply --layout-self-start;
            display: inline-block;
            font-family: var(--font-body);
            font-size: 14px;
            font-weight: bold;
            text-align: left;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            margin-bottom: 19px;
        }
        .top-panel {
            @apply --layout-horizontal;
            @apply --layout-justified;
            @apply --layout-center;
            height: 64px;
            padding: 0 8px;
            border-bottom: 1px solid var(--);
        }
        .top-panel>* {
            margin: 0 8px;
        }
        .top-panel .title {
            font-size: 16px;
            font-weight: bold;
            margin-right: 16px;
            color: #fff;
        }
        .top-panel .action button {
            @apply --kano-button;
            border-radius: 3px;
            background: #54595d;
        }
        .top-panel .action button:hover {
            background-color: #5b646b;
        }
        .top-panel .action button#done {
            font-size: 14px;
            font-weight: bold;
            text-shadow: none;
            padding: 8px 24px;
        }
        .top-panel .action button:not(#done) {
            width: 32px;
            height: 32px;
            padding: 0;
            margin-right: 16px;
        }
        .top-panel .action button:not(#done)>* {
            margin: 0 auto;
        }
        .top-panel iron-icon {
            --iron-icon-fill-color: #fff;
        }
        .top-panel .action button iron-icon {
            fill: #8f9195;
            transition: fill 100ms;
        }
        .top-panel .action button:hover iron-icon {
            fill: #fff;
        }
        .top-panel .action {
            @apply --layout-flex-auto;
            @apply --layout-horizontal;
            @apply --layout-end-justified;
        }
        .top-panel button kano-animated-svg {
            @apply --layout-flex;
            width: 18px;
            height: 18px;
            -webkit-filter: drop-shadow(0px 2px 0px rgba(0, 0, 0, 0.25));
            filter: drop-shadow(0px 2px 0px rgba(0, 0, 0, 0.25));
            fill: #8F9195;
            stroke: #8F9195;
            stroke-width: 3px;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all ease-in-out 200ms;
        }
        .top-panel button:hover kano-animated-svg {
            fill: #fff;
            stroke: #fff;
        }
        .center-panel {
            @apply --layout-horizontal;
        }
        .side-menu {
            @apply --layout-vertical;
            border-right: 1px solid var(--kano-app-part-editor-border);
        }
        .side-menu button {
            @apply --kano-button;
            display: block;
            width: 56px;
            height: 56px;
            background-color: transparent;
            border-radius: 0;
            padding: 0;
        }
        .side-menu button iron-icon {
            fill: #8f9195;
            transition: fill 100ms;
        }
        .side-menu button:hover {
            background: #54595d;
        }
        .side-menu button.selected {
            background: #5b646b;
        }
        .side-menu button:hover iron-icon,
        .side-menu button.selected iron-icon {
            fill: #fff;
        }
        #palette {
            @apply --layout-horizontal;
            @apply --layout-justified;
            width: 148px;
            text-align: left;
        }
        .canvas-container {
            @apply --layout-flex-none;
            @apply --layout-vertical;
            @apply --layout-center-justified;
            width: 554px;
            height: 320px;
        }
        .canvas-container iron-pages {
            @apply --layout-horizontal;
            @apply --layout-center-justified;
            margin-top: -1px;
            margin-left: -1px;
        }
        kano-pixel-canvas {
            cursor: none;
            --kano-pixel-editor-background: var(--color-dark);
        }
        .control-container {
            @apply --layout-flex-auto;
            @apply --layout-horizontal;
            border-left: 1px solid var(--kano-app-part-editor-border);
        }
        .control-container label:first-of-type {
            margin: 20px 0;
        }
        .control-content {
            @apply --layout-flex-auto;
            @apply --layout-horizontal;
            padding: 0 28px;
        }
        .control-content>* {
            @apply --layout-flex-auto;
            @apply --layout-vertical;
        }
        .control-content .custom-colour-header {
            @apply --layout-horizontal;
            @apply --layout-center;
        }
        .control-content .custom-colour-header button {
            @apply --kano-button;
            font-size: 14px;
            font-weight: bold;
            background-color: transparent;
            color: #8f9195;
            padding: 0;
        }
        .control-content .custom-colour-header label,
        .control-content .custom-colour-header button {
            margin-right: 16px;
        }
        .control-content kano-tooltip {
            --kano-tooltip-border-color: var(--color-dark);
            --kano-tooltip-background-color: var(--color-dark);
            --kano-tooltip-caret: {
                @apply(--shadow-elevation-2dp);
            };
        }
        .control-content .settings-controls {
            @apply --layout-vertical;
            @apply --layout-flex-auto;
            @apply --layout-justified;
            padding-bottom: 36px;
        }
        .control-container .size-settings {
            @apply --layout-horizontal;
        }
        .control-container kano-input-range:first-child {
            margin-right: 16px;
        }
        #default-palette,
        #custom-palette {
            --kano-input-color-margin: 0.5px;
        }
        #default-palette {
            margin: 4px 0 16px;
        }
        .bottom-panel {
            background-color: #252b31;
        }
        .bottom-panel-header {
            border-top: 1px solid var(--kano-app-part-editor-border);
            border-bottom: 1px solid var(--kano-app-part-editor-border);
        }
        kano-bitmap-list button {
            @apply --kano-button;
            color: #8f9195;
        }
        kano-bitmap-list button,
        kano-bitmap-list label {
            @apply --layout-horizontal;
            @apply --layout-center;
            font-size: 14px;
            line-height: 18px;
            font-weight: bold;
            background-color: transparent;
            margin: 16px 40px 16px 0;
            padding: 0;
            transition: color 100ms;
        }
        kano-bitmap-list label {
            color: white;
        }
        kano-bitmap-list iron-icon {
            --iron-icon-height: 14px;
            --iron-icon-width: 14px;
            margin-right: 8px;
            transition: fill 100ms;
        }
        kano-bitmap-list iron-icon#add-icon {
            --iron-icon-height: 18px;
            --iron-icon-width: 18px;
        }

        kano-bitmap-list button:hover {
            color: #fff;
        }
        kano-bitmap-list button:hover iron-icon {
            fill: #fff;
        }
        .bottom-panel-label {
            margin: 16px 40px 16px 24px;
        }
        #frames {
            @apply --layout-flex;
            overflow: hidden;
        }
        button.add-frame iron-icon {
            --iron-icon-height: 18px;
            --iron-icon-width: 18px;
            fill: #999;
        }
        :host button.add-frame:hover iron-icon {
            fill: #fff;
        }
        button.add-frame:disabled {
            opacity: 0.3;
        }
    </style>
    <template>
        <kano-media-query small-screen="{{smallScreen}}" medium-screen="{{mediumScreen}}" large-screen="{{largeScreen}}">
        </kano-media-query>
        <div class="top-panel">
            <iron-icon id="part-icon" icon="parts:light-animation"></iron-icon>
            <div class="title">Animation</div>
            <div class="action">
                <button id="reverse" type="button">
                    <iron-icon icon="av:skip-previous"></iron-icon>
                </button>
                <button id="reset" type="button">
                    <iron-icon icon="av:replay"></iron-icon>
                </button >
                <button id="preview-button" type="button" on-tap="_togglePreviewState">
                    <kano-animated-svg width="32" height="32" paths="[[previewButtonIconPaths]]" selected="[[previewState]]"></kano-animated-svg>
                </button>
                <button id="done" type="button" dialog-dismiss>Done</button>
            </div>
        </div>
        <div class="center-panel">
            <div class="side-menu">
                <iron-selector selected="[[penType]]" attr-for-selected="name">
                    <button id="draw-button" class="side-menu-button" on-tap="_penControlTapped" name="draw">
                        <iron-icon icon="kano-icons:paint-brush"></iron-icon>
                    </button>
                    <button id="fill-button" class="side-menu-button" on-tap="_penControlTapped" name="fill">
                        <iron-icon icon="kano-icons:paint-bucket"></iron-icon>
                    </button>
                </iron-selector>
                <button id="settings-button" class="side-menu-button" on-tap="_settingsTapped">
                    <iron-icon icon="settings"></iron-icon>
                </button>
            </div>
            <div class="canvas-container">
                <iron-pages selected="[[previewState]]" attr-for-selected="name" id="canvas-area">
                    <kano-pixel-canvas id="canvas"
                                        name="stopped"
                                        bitmap="{{selectedFrame}}"
                                        width="[[selected.userProperties.width]]"
                                        height="[[selected.userProperties.height]]"
                                        pixel-size="22"
                                        spacing="1"
                                        palette="[[palette]]"
                                        pen-color="[[penColor]]"
                                        pen-type="[[penType]]"
                                        on-paint-action="_onPaintAction"></kano-pixel-canvas>
                    <kano-bitmap-renderer class="preview-renderer" 
                                          name="running"
                                          bitmap="[[frame]]"
                                          pixel-size="22"
                                          spacing="1"
                                          width="[[selected.userProperties.width]]"
                                          height="[[selected.userProperties.height]]"></kano-bitmap-renderer>
                </iron-pages>
            </div>
            <div class="control-container">
                    <iron-pages class="control-content" selected="[[controlPanel]]" attr-for-selected="name">
                        <div name="palette">
                            <label>Colors</label>
                            <kano-input-color id="default-palette" on-value-changed="_onColorChange" idle="[[customPaletteActive]]"></kano-input-color>
                            <div class="custom-colour-header">
                                <label>Custom</label>
                                <button id="custom-colour-add" type="button">
                                    <span on-tap="_openWheel">Add</span>
                                    <kano-tooltip id="tooltip" class="tooltip" position="right" target="[[tooltipTarget]]" auto-close opened="{{wheelOpened}}">
                                        <kano-color-wheel id="wheel" on-value-changed="_addCustomColor" render-later></kano-color-wheel>
                                    </kano-tooltip>
                                </button>
                                <button id="custom-colour-delete" type="button">
                                    <span>Delete</span>
                                </button>
                            </div>
                            <kano-input-color id="custom-palette" on-value-changed="_onColorChange" idle="[[!customPaletteActive]]"></kano-input-color>
                        </div>
                        <div name="settings">
                            <label>Settings</label>
                            <div class="settings-controls">
                                <kano-input type="text" label="Name" value="{{selected.name}}"></kano-input>
                                <div class="size-settings">
                                    <kano-input-range id="width-slider" class="slider" value="{{selected.userProperties.width}}" label="Width" min="1" max="16"></kano-input-range>
                                    <kano-input-range id="height-slider" class="slider" value="{{selected.userProperties.height}}" label="Height" min="1" max="8"></kano-input-range>
                                </div>
                                <kano-input-range id="speed-slider" class="slider" value="{{selected.userProperties.speed}}" label="Speed" min="1" max="30" symbol="fps"></kano-input-range>
                            </div>
                        </div>
                    </iron-pages>
            </div>
        </div>
        <div class="bottom-panel">
            <kano-bitmap-list id="frames"
                              bitmaps="{{selected.userProperties.bitmaps}}"
                              selected="{{selectedFrame}}"
                              selected-index="{{selectedIndex}}"
                              width="[[selected.userProperties.width]]"
                              height="[[selected.userProperties.height]]">
                        <!-- <button id="add-frame-button" type="button" name="button" class="add-frame" on-tap="_addFrame" disabled$="[[isEq(previewState, 'running')]]"><iron-icon icon="kano-icons:plus"></iron-icon></button> -->
                        <label class="bottom-panel-label" slot="label">Animate</label>
                        <button id="preview-button" type="button" slot="add-button">
                            <iron-icon id="add-icon" icon="add"></iron-icon>
                            <span>Add cell</span>
                        </button>
                        <button id="preview-button" type="button" slot="duplicate-button">
                            <iron-icon icon="content-copy"></iron-icon>
                            <span>Duplicate</span>
                        </button>
                        <button id="preview-button" type="button" slot="delete-button">
                            <iron-icon icon="clear"></iron-icon>
                            <span>Delete</span>
                        </button>
            </kano-bitmap-list>
        </div>
    </template>
    <script type="text/javascript">
        Polymer({
            is: 'kano-light-animation-editor',
            behaviors: [
                PolymerFilters.FilterBehavior,
                Kano.Behaviors.MediaQueryBehavior,
                Kano.Behaviors.AppElementRegistryBehavior,
                Kano.Behaviors.AppEditorBehavior,
                Kano.MakeApps.PartsAPI['light-animation']
            ],
            properties: {
                controlPanel: {
                    type: String
                },
                selected: {
                    type: Object,
                    notify: true
                },
                selectedIndex: {
                    type: Number,
                    value: 0
                },
                selectedFrame: {
                    type: Array,
                    value: () => {
                        return ['#000000'];
                    }
                },
                pixelSize: {
                    type: Number,
                    value: 20
                },
                penType: {
                    type: String,
                    computed: '_computePenType(_penType, _isShiftPressed)'
                },
                penColor: {
                    type: String,
                    observer: '_penColorChanged'
                },
                wheelOpened: {
                    type: Boolean,
                    observer: '_wheelStatusChanged'
                },
                previewState: {
                    type: String,
                    observer: '_previewStateChanged'
                },
                customPaletteActive: {
                    type: Boolean,
                    value: false
                }
            },
            observers: [
                '_onSelectedChanged(selected.*)',
                '_onSmallScreenActive(smallScreen)',
                '_onFrameChanged(frame.*)',
                '_onSelectedFrameChanged(selectedFrame.*)',
                '_onControlPanelChanged(controlPanel, penType)'
            ],
            created () {
                this._onKeydown = this._onKeydown.bind(this);
                this._onKeyup = this._onKeyup.bind(this);
            },
            attached () {
                // let paletteElements = this.$.palette.getElementsRegistry();
                this.previewButtonIconPaths = {
                    stopped: 'M 10,4 l 16, 12, 0, 0, -16, 12, z',
                    running: 'M 4,4 l 24, 0 0, 24, -24, 0, z'
                };
                this._isShiftPressed = false;
                this.previewState = 'stopped';
                this.previewIndex = 0;
                document.addEventListener('keydown', this._onKeydown);
                document.addEventListener('keyup', this._onKeyup);
                // this.$.palette._computePalette();
                this.BOARD_WIDTH = 16;
                this.BOARD_HEIGHT = 8;
                this.set('_penType', 'draw');
                this.controlPanel = 'palette';
                this.$$('#custom-palette').colors = [];
                this._registerElement('animation-editor', this);
                this._registerElement('animation-editor-width-slider', this.$['width-slider']);
                this._registerElement('animation-editor-height-slider', this.$['height-slider']);
                this._registerElement('animation-editor-speed-slider', this.$['speed-slider']);
                // this._registerElement('animation-editor-palette', this.$['palette']);
                this._registerElement('animation-editor-canvas', this.$['canvas-area']);
                this._registerElement('animation-editor-preview-button', this.$['preview-button']);
                this._registerElement('animation-editor-add-frame-button', this.$['add-frame-button']);
                this._registerElement('animation-editor-frames', this.$['frames']);
                // this._registerElement('animation-editor-draw-button', paletteElements['draw-button']);
                // this._registerElement('animation-editor-fill-button', paletteElements['fill-button']);
                // this._registerElement('animation-editor-colors', paletteElements['colors']);
                // this._registerElement('animation-editor-add-color-button', paletteElements['add-color-button']);
                // this._registerElement('animation-editor-color-wheel', paletteElements['color-wheel']);
            },
            detached () {
                document.removeEventListener('keydown', this._onKeydown);
                document.removeEventListener('keyup', this._onKeyup);
                this._stopPreview();
            },
            _addCustomColor (e) {
                this.$['custom-palette'].addColor(e.detail.value);
                this.$.tooltip.close();
            },
            _computePalette () {
                this.debounce('palette', () => {
                    let palette = this.bitmaps.reduce((acc, bitmap) => {
                        return acc.concat(bitmap);
                    }, []);

                    palette.push(this.penColor);

                    // Remove duplicates and color already in the default palette. Limit to 18 custom colors
                    palette = palette.filter((elem, pos, self) => {
                        return self.indexOf(elem) === pos && this.DEFAULT_PALETTE.indexOf(elem) === -1 &&
                                elem !== null && typeof elem !== 'undefined';
                    }).splice(-6, 6);

                    this.set('palette', palette);
                    if (!this.penColor) {
                        this.set('penColor', this.palette[0]);
                    }
                }, 16);
            },
            _computePenType (penType, shiftPressed) {
                return shiftPressed ? 'fill' : penType;
            },
            stop () {
                this._stopPreview();
            },
            _penColorChanged (newValue) {
                this.notifyChange('light-animation-color-changed', { value: newValue });
            },
            _wheelStatusChanged (opened) {
                const event = opened ? 'light-animation-wheel-open' : 'light-animation-wheel-close';
                this.notifyChange(event);
            },
            _previewStateChanged () {
                this.notifyChange('light-animation-preview-changed', { value: this.previewState });
            },
            _onPaintAction () {
                this.notifyChange('light-animation-paint', { tool: this.penType });
            },
            _onSelectedChanged (e) {
                this.selectedIndex = this.selectedIndex || 0;
                if (e.path = "selected") {
                    this.selectedFrame = this.selected.userProperties.bitmaps[this.selectedIndex].slice(0);
                }
            },
            _onFrameChanged () {
                this._renderOnRealDevice(this.frame);
            },
            _onSelectedFrameChanged () {
                this._renderOnRealDevice(this.selectedFrame);
            },
            _togglePreviewState () {
                this.set('previewState', this.previewState === 'running' ? 'stopped' : 'running');
                if (this.previewState === 'running') {
                    this._updatePreview();
                } else {
                    clearTimeout(this.timeoutId);
                }
            },
            _stopPreview () {
                this.set('previewState', 'stopped');
                clearTimeout(this.timeoutId);
            },
            _updatePreview () {
                let bitmaps = this.selected.userProperties.bitmaps;
                if (bitmaps) {
                    this.frame = bitmaps[this.previewIndex];
                    this.previewIndex++;
                    if (this.previewIndex > bitmaps.length - 1) {
                        this.previewIndex = 0;
                    }
                }
                this.timeoutId = setTimeout(this._updatePreview.bind(this), 1000 / this.selected.userProperties.speed);
            },
            _selectNextFrame () {
                this.selectedIndex = Math.min(this.selected.userProperties.bitmaps.length - 1, this.selectedIndex + 1);
                this.selectedFrame = this.selected.userProperties.bitmaps[this.selectedIndex].slice(0);
            },
            _selectPreviousFrame () {
                this.selectedIndex = Math.max(0, this.selectedIndex - 1);
                this.selectedFrame = this.selected.userProperties.bitmaps[this.selectedIndex].slice(0);
            },
            _settingsTapped () {
                this.controlPanel = 'settings';
            },
            _addFrame () {
                this.$.frames.addFrame();
                this.notifyChange('light-animation-add-frame');
            },
            _isNewFrameDisabled (previewState) {
                return (previewState === 'running');
            },
            _onControlPanelChanged (panel, penType) {
                if (panel === 'palette' && this._isShiftPressed) {
                    return;
                } else if (panel === 'palette') {
                    this._highlightSideMenuButton(`${penType}-button`);
                } else {
                    this._highlightSideMenuButton(`${panel}-button`);
                }
            },
            _highlightSideMenuButton (id) {
                Polymer.dom(this.root).querySelectorAll('.side-menu-button').forEach((el) => {
                    this.toggleClass('selected', el.id === id, el);
                }, this)
            },
            _onKeydown (e) {
                this.set('_isShiftPressed', e.shiftKey);

                switch (e.key) {
                    case 'n':
                      this._addFrame();
                      break;
                    case 'ArrowRight':
                      this._selectNextFrame();
                      break;
                    case 'ArrowLeft':
                      this._selectPreviousFrame();
                      break;
                }
            },
            _onKeyup (e) {
                this.set('_isShiftPressed', e.shiftKey);
            },
            _openWheel (e) {
                const target = e.currentTarget ? e.currentTarget : Polymer.dom(e).rootTarget;
                // this.$.tooltip.set('target', null);
                this._renderWheel();
                this.async(() => {
                    this.$.tooltip.set('target', target.getBoundingClientRect());
                    this.$.tooltip.open();
                });
            },
            _onSmallScreenActive (smallScreen) {
                this.pixelSize = smallScreen ? 18 : 20;
            },
            _penControlTapped (e) {
                if (this._isShiftPressed) {
                    return;
                }
                const target = e.currentTarget ? e.currentTarget : Polymer.dom(e).rootTarget;
                this.controlPanel = 'palette';
                this.set('_penType', target.getAttribute('name'));
            },
            _renderOnRealDevice (frame) {
                try {
                    Kano.AppModules.modules.lightboard.shapes = {
                       'being-edited': this.getShape(frame)
                    };
                    Kano.AppModules.modules.lightboard.updateAndSync(false, () => {});
                }
                catch (e) {
                   return;
                }
            },
            _renderWheel () {
                if (this._wheelRendered) {
                    return;
                }
                this._wheelRendered = true;
                this.$.wheel.render();
            },
            _onColorChange (e) {
                if (e.detail.value) {
                    this.customPaletteActive = Polymer.dom(e).rootTarget.id === 'custom-palette';
                    this.penColor = e.detail.value;
                }
            },
            getShape (frame) {
                this.model = this.selected;
                return {
                    id: 'being-edited',
                    x: this.getX(),
                    y: this.getY(),
                    width: this.getWidth(),
                    height: this.getHeight(),
                    visible: true,
                    bitmap: frame,
                    type: 'frame'
                };
            }
        });
    </script>
</dom-module>
