<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/polymer-filters/polymer-filters.html">
<link rel="import" href="../../bower_components/polymer-filters/filters/compare.html">
<link rel="import" href="../../bower_components/web-components/kano-icons/kano-icons.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../../scripts/kano/make-apps/parts-api/light-animation.html">
<link rel="import" href="../../scripts/kano/app-modules/lightboard.html">
<link rel="import" href="../kano-palette/kano-palette.html">
<link rel="import" href="../kano-pixel-canvas/kano-pixel-canvas.html">
<link rel="import" href="../kano-bitmap-renderer/kano-bitmap-renderer.html">
<link rel="import" href="../kano-bitmap-list/kano-bitmap-list.html">
<link rel="import" href="../kano-media-query/kano-media-query.html">
<link rel="import" href="../kano-animated-svg/kano-animated-svg.html">
<link rel="import" href="../inputs/kano-input-range/kano-input-range.html">
<link rel="import" href="../inputs/kano-input/kano-input.html">
<link rel="import" href="../kano-code-shared-styles/kano-code-shared-styles.html">
<link rel="import" href="../behaviors/kano-media-query-behavior.html">
<dom-module id="kano-light-animation-editor">
    <style include="kano-code-shared-styles">
        :host {
            @apply --layout-vertical;
            @apply --layout-center-justified;
        }
        :host([medium-screen]),
        :host([small-screen]) {
            @apply --layout-vertical;
        }
        :host([small-screen]) button {
            width: 28px;
            height: 28px;
        }
        :host label {
            @apply --layout-self-start;
            display: inline-block;
            font-family: var(--font-body);
            font-size: 14px;
            font-weight: bold;
            text-align: left;
            color: rgba(255,255,255,0.5);
            margin-bottom: 24px;
        }
        .settings {
            @apply --layout-horizontal;
            @apply --layout-justified;
            @apply --layout-center;
            padding: 10px 48px 8px;
            border-bottom: 1px solid #202428;
        }
        :host([medium-screen]) .settings,
        :host([small-screen]) .settings {
            @apply --layout-vertical;
            align-items: stretch;
            padding: var(--kano-modal-header-padding-small);
            padding-top: 24px;
        }
        :host([small-screen]) .settings {
            padding: 24px 16px 24px;
        }
        .settings label {
            margin-right: 24px;
            margin-bottom: 0;
            @apply --layout-self-center;
        }
        :host([medium-screen]) .settings label,
        :host([small-screen]) .settings label {
            display: none;
        }
        .settings kano-input-range {
            width: 210px;
            margin-right: 12px;
            --kano-input-range-label: {
                width: 42px;
                margin-right: 16px;
            };
            --kano-input-range-display: {
                width: 48px;
                margin-left: 12px;
            };
        }
        .settings kano-input-range:last-of-type {
            margin-right: 0;
        }
        :host([medium-screen]) .settings kano-input-range,
        :host([small-screen]) .settings kano-input-range {
            width: auto;
            margin: 8px 0;
        }
        .main {
            @apply --layout-horizontal;
            @apply --layout-center-justified;
            padding: 16px 48px 16px;
        }
        :host([medium-screen]) .main {
            @apply --layout-vertical;
            padding: 32px;
        }
        :host([small-screen]) .main {
            @apply --layout-vertical;
            padding: 32px 16px;
        }
        .editing-tools {
            @apply --layout-flex-auto;
            @apply --layout-horizontal;
        }
        #palette {
            @apply --layout-horizontal;
            @apply --layout-justified;
            width: 148px;
            text-align: left;
        }
        :host([small-screen]) #palette,
        :host([medium-screen]) #palette {
            flex: 5 5 auto;
            @apply --layout-start-justified;
        }
        .small-screen-control-container {
            display: none;
        }
        :host([small-screen]) .small-screen-control-container,
        :host([medium-screen]) .small-screen-control-container {
            @apply --layout-vertical;
            @apply --layout-flex-auto;
            width: 48px;
            margin-left: 16px;
        }
        .canvas-container {
            @apply --layout-flex-none;
            @apply --layout-vertical;
            width: 385px;
            height: 244px;
            margin: 0 72px;
        }
        :host([small-screen]) .canvas-container,
        :host([medium-screen]) .canvas-container {
            @apply --layout-self-center;
            margin: 24px 0 0 0;
        }
        :host([small-screen]) .canvas-container {
            width: 100%;
            min-width: 352px;
        }
        .canvas-container iron-pages {
            @apply --layout-horizontal;
            @apply --layout-center-justified;
            margin-top: -2px;
            margin-left: -2px;
        }
        kano-pixel-canvas {
            cursor: none;
            --kano-pixel-editor-background: var(--color-dark);
        }
        .control-container {
            @apply --layout-flex-auto;
            @apply --layout-vertical;
            width: 106px;
        }
        :host([small-screen]) .control-container,
        :host([medium-screen]) .control-container {
            display: none;
        }
        .framelist-container {
            @apply --layout-horizontal;
            @apply --layout-center;
            border-top: 1px solid #202428;
            padding: 0 48px;
        }
        :host([small-screen]) .framelist-container {
            padding: 12px 16px;
        }
        #frames {
            @apply --layout-flex;
            overflow: hidden;
        }
        :host button {
            @apply --kano-button;
            @apply --layout-horizontal;
            @apply --layout-center-justified;
            background-color: var(--color-chateau);
            border-radius: 3px;
            width: 36px;
            height: 36px;
            padding: 0;
        }
        button.add-frame iron-icon {
            --iron-icon-height: 21px;
            --iron-icon-width: 21px;
            margin-top: 1px;
            margin-left: 2px;
            fill: #999;
        }
        :host button.add-frame:hover iron-icon {
            fill: #fff;
        }
        button.add-frame:disabled {
            opacity: 0.3;
        }
        button.control kano-animated-svg,
        .small-screen-control-container button kano-animated-svg {
            @apply --layout-flex;
            width: 18px;
            height: 18px;
            -webkit-filter: drop-shadow(0px 2px 0px rgba(0, 0, 0, 0.25));
            filter: drop-shadow(0px 2px 0px rgba(0, 0, 0, 0.25));
            fill: #999;
            stroke: #999;
            stroke-width: 3px;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all ease-in-out 200ms;
        }
        button.control:hover kano-animated-svg,
        .small-screen-control-container button kano-animated-svg {
            fill: #fff;
            stroke: #fff;
        }
    </style>
    <template>
        <kano-media-query small-screen="{{smallScreen}}" medium-screen="{{mediumScreen}}" large-screen="{{largeScreen}}">
        </kano-media-query>
        <div class="settings">
            <label>Settings</label>
            <kano-input-range class="slider" value="{{selected.userProperties.width}}" label="Width" min="1" max="16"></kano-input-range>
            <kano-input-range class="slider" value="{{selected.userProperties.height}}" label="Height" min="1" max="8"></kano-input-range>
            <kano-input-range class="slider" value="{{selected.userProperties.speed}}" label="Speed" min="1" max="30" symbol="fps"></kano-input-range>
        </div>
        <div class="main">
            <div class="editing-tools">
                <kano-palette id="palette" bitmaps="[[selected.userProperties.bitmaps]]" pen-type="{{penType}}" palette="{{palette}}" pen-color="{{penColor}}"></kano-palette>
                <div class="small-screen-control-container">
                    <label>Controls</label>
                    <button type="button" name="button" on-tap="_togglePreviewState">
                        <kano-animated-svg width="32" height="32" paths="[[previewButtonIconPaths]]" selected="[[previewState]]"></kano-animated-svg>
                    </button>
                </div>
            </div>
            <div class="canvas-container">
                <label>Canvas</label>
                <iron-pages selected="[[previewState]]" attr-for-selected="name">
                    <kano-pixel-canvas id="canvas"
                                        name="stopped"
                                        bitmap="{{selectedFrame}}"
                                        spacing="2"
                                        width="[[selected.userProperties.width]]"
                                        height="[[selected.userProperties.height]]"
                                        pixel-size="[[pixelSize]]"
                                        palette="[[palette]]"
                                        pen-color="[[penColor]]"
                                        pen-type="[[penType]]"></kano-pixel-canvas>
                    <kano-bitmap-renderer class="preview-renderer" 
                                          name="running"
                                          bitmap="[[frame]]"
                                          spacing="2"
                                          width="[[selected.userProperties.width]]"
                                          height="[[selected.userProperties.height]]"
                                          pixel-size="[[pixelSize]]"></kano-bitmap-renderer>
                </iron-pages>
            </div>
            <div class="control-container">
                <label>Controls</label>
                <button class="control" type="button" name="button" on-tap="_togglePreviewState">
                    <kano-animated-svg width="32" height="32" paths="[[previewButtonIconPaths]]" selected="[[previewState]]"></kano-animated-svg>
                </button>
            </div>
        </div>
        <div class="framelist-container">
            <div class="framelist-button-container">
                <button type="button" name="button" class="add-frame" on-tap="_addFrame" disabled$="[[isEq(previewState, 'running')]]"><iron-icon icon="kano-icons:plus"></iron-icon></button>
            </div>
            <kano-bitmap-list id="frames"
                              bitmaps="{{selected.userProperties.bitmaps}}"
                              selected="{{selectedFrame}}"
                              selected-index="{{selectedIndex}}"
                              width="[[selected.userProperties.width]]"
                              height="[[selected.userProperties.height]]"></kano-bitmap-list>
        </div>
    </template>
    <script type="text/javascript">
        Polymer({
            is: 'kano-light-animation-editor',
            behaviors: [
                PolymerFilters.FilterBehavior,
                Kano.Behaviors.MediaQueryBehavior,
                Kano.MakeApps.PartsAPI['light-animation']
            ],
            properties: {
                selected: {
                    type: Object,
                    notify: true
                },
                selectedIndex: {
                    type: Number,
                    value: 0
                },
                selectedFrame: {
                    type: Array,
                    value: () => {
                        return ['#000000'];
                    }
                },
                pixelSize: {
                    type: Number,
                    value: 20
                }
            },
            observers: [
                '_onSelectedChanged(selected.*)',
                '_onSmallScreenActive(smallScreen)',
                '_onFrameChanged(frame.*)',
                '_onSelectedFrameChanged(selectedFrame.*)',
            ],
            created () {
                this._onKeydown = this._onKeydown.bind(this);
            },
            attached () {
                this.previewButtonIconPaths = {
                    stopped: 'M 10,4 l 16, 12, 0, 0, -16, 12, z',
                    running: 'M 4,4 l 24, 0 0, 24, -24, 0, z'
                };
                this.previewState = 'stopped';
                this.previewIndex = 0;
                document.addEventListener('keydown', this._onKeydown);
                this.$.palette._computePalette();
                this.BOARD_WIDTH = 16;
                this.BOARD_HEIGHT = 8;
            },
            detached () {
                document.removeEventListener('keydown', this._onKeydown);
                this._stopPreview();
            },
            stop () {
                this._stopPreview();
            },
            _onSelectedChanged (e) {
                this.selectedIndex = this.selectedIndex || 0;
                if (e.path = "selected") {
                    this.selectedFrame = this.selected.userProperties.bitmaps[this.selectedIndex].slice(0);
                }
            },
            _onFrameChanged () {
                this._renderOnRealDevice(this.frame);
            },
            _onSelectedFrameChanged () {
                this._renderOnRealDevice(this.selectedFrame);
            },
            _togglePreviewState () {
                this.set('previewState', this.previewState === 'running' ? 'stopped' : 'running');
                if (this.previewState === 'running') {
                    this._updatePreview();
                } else {
                    clearTimeout(this.timeoutId);
                }
            },
            _stopPreview () {
                this.set('previewState', 'stopped');
                clearTimeout(this.timeoutId);
            },
            _updatePreview () {
                let bitmaps = this.selected.userProperties.bitmaps;
                if (bitmaps) {
                    this.frame = bitmaps[this.previewIndex];
                    this.previewIndex++;
                    if (this.previewIndex > bitmaps.length - 1) {
                        this.previewIndex = 0;
                    }
                }
                this.timeoutId = setTimeout(this._updatePreview.bind(this), 1000 / this.selected.userProperties.speed);
            },
            _selectNextFrame () {
                this.selectedIndex = Math.min(this.selected.userProperties.bitmaps.length - 1, this.selectedIndex + 1);
                this.selectedFrame = this.selected.userProperties.bitmaps[this.selectedIndex].slice(0);
            },
            _selectPreviousFrame () {
                this.selectedIndex = Math.max(0, this.selectedIndex - 1);
                this.selectedFrame = this.selected.userProperties.bitmaps[this.selectedIndex].slice(0);
            },
            _addFrame () {
                this.$.frames.addFrame();
            },
            _isNewFrameDisabled (previewState) {
                return (previewState === 'running');
            },
            _onKeydown (e) {
                switch (e.key) {
                    case 'n':
                      this._addFrame();
                      break;
                    case 'ArrowRight':
                      this._selectNextFrame();
                      break;
                    case 'ArrowLeft':
                      this._selectPreviousFrame();
                      break;
                }
            },
            _onSmallScreenActive (smallScreen) {
                this.pixelSize = smallScreen ? 18 : 20;
            },
            _renderOnRealDevice (frame) {
                Kano.AppModules.modules.lightboard.shapes = {
                    'being-edited': this.getShape(frame)
                };
                Kano.AppModules.modules.lightboard.updateAndSync(false, () => {});
            },
            getShape (frame) {
                this.model = this.selected;
                return {
                    id: 'being-edited',
                    x: this.getX(),
                    y: this.getY(),
                    width: this.getWidth(),
                    height: this.getHeight(),
                    visible: true,
                    bitmap: frame,
                    type: 'frame'
                };
            }
        });
    </script>
</dom-module>
