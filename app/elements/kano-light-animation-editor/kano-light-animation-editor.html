<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer-filters/polymer-filters.html">
<link rel="import" href="../../bower_components/polymer-filters/filters/compare.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../../scripts/kano/make-apps/parts-api/light-animation.html">
<link rel="import" href="../../scripts/kano/app-modules/lightboard.html">
<link rel="import" href="../kano-part-editor-topbar/kano-part-editor-topbar.html">
<link rel="import" href="../kano-animated-svg/kano-animated-svg.html">
<link rel="import" href="../kano-light-frame-editor-panel/kano-light-frame-editor-panel.html">
<link rel="import" href="../kano-bitmap-list/kano-bitmap-list.html">
<link rel="import" href="../kano-pixel-canvas/kano-pixel-canvas.html">
<link rel="import" href="../behaviors/kano-app-element-registry-behavior.html">
<link rel="import" href="../behaviors/kano-app-editor-behavior.html">
<dom-module id="kano-light-animation-editor">
    <style>
        :host {
            display: block;
        }
        .action-control {
            @apply --layout-flex-auto;
            @apply --layout-horizontal;
            @apply --layout-end-justified;
        }
        .action-control button {
            @apply --kano-button;
            width: 32px;
            height: 32px;
            background: #54595d;
            border-radius: 3px;
            padding: 0;
            margin-right: 16px;
        }
        .action-control button:hover {
            background-color: #00d9c7;
        }
        .action-control button iron-icon {
            fill: #8f9195;
            transition: fill 300ms;
        }
        .action-control button:hover iron-icon {
            fill: #fff;
        }
        .action-control button kano-animated-svg {
            width: 18px;
            height: 18px;
            -webkit-filter: drop-shadow(0px 2px 0px rgba(0, 0, 0, 0.25));
            filter: drop-shadow(0px 2px 0px rgba(0, 0, 0, 0.25));
            fill: #8F9195;
            stroke: #8F9195;
            stroke-width: 3px;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all ease-in-out 300ms;
            margin: 0 auto;
        }
        .action-control button:hover kano-animated-svg {
            fill: #fff;
            stroke: #fff;
        }
        .settings {
            @apply --layout-vertical;
            @apply --layout-flex-auto;
        }
        .settings-controls {
            @apply --layout-flex-auto;
            @apply --layout-vertical;
        }
        .settings-controls>* {
            margin-bottom: 18px;
        }
        .settings-controls .size-settings {
            @apply --layout-horizontal;
        }
        .settings-controls .size-settings kano-input-range:first-child {
            margin-right: 16px;
        }
        kano-pixel-canvas {
            @apply --layout-flex-auto;
            cursor: none;
            --kano-pixel-editor-background: var(--color-dark);
        }
        .bottom-panel {
            background-color: #252b31;
        }
        .bottom-panel-header {
            border-top: 1px solid var(--kano-app-part-editor-border);
            border-bottom: 1px solid var(--kano-app-part-editor-border);
        }
        kano-bitmap-list {
            --kano-bitmaplist-action-container: {
                border-top: 1px solid var(--kano-app-part-editor-border);
                border-bottom: 1px solid var(--kano-app-part-editor-border);
            };
        }
        kano-bitmap-list button {
            @apply --kano-button;
            color: #8f9195;
        }
        kano-bitmap-list button,
        kano-bitmap-list label {
            @apply --layout-horizontal;
            @apply --layout-center;
            text-transform: uppercase;
            font-family: var(--font-body);
            font-size: 12px;
            line-height: 16px;
            font-weight: bold;
            background-color: transparent;
            margin: 7px 60px 7px 0;
            padding: 0;
            transition: color 300ms;
        }
        kano-bitmap-list label {
            color: white;
        }
        kano-bitmap-list iron-icon {
            --iron-icon-height: 14px;
            --iron-icon-width: 14px;
            margin-right: 8px;
        }
        iron-icon.add-icon {
            --iron-icon-height: 16px;
            --iron-icon-width: 16px;
        }
        kano-bitmap-list button:hover {
            color: #fff;
        }
        kano-bitmap-list button:hover iron-icon {
            fill: #00d9c7;
        }
        kano-bitmap-list button#delete-frame-button:hover iron-icon {
            fill: var(--color-flame);
        }
        #bitmap-label {
            margin: 7px 52px 7px 24px;
        }
        #frames {
            @apply --layout-flex;
            overflow: hidden;
        }
        button.add-frame iron-icon {
            --iron-icon-height: 18px;
            --iron-icon-width: 18px;
            fill: #999;
        }
        :host button.add-frame:hover iron-icon {
            fill: var(--color-kano-orange);
        }
        button.add-frame:disabled {
            opacity: 0.3;
        }
    </style>
    <template>
        <kano-part-editor-topbar icon="light-animation" label="[[element.label]]" theme="[[theme]]">
            <div class="action-control" slot="action">
                <button id="reverse" type="button" on-tap="_resetPreview">
                    <iron-icon icon="av:skip-previous"></iron-icon>
                </button>
                <button id="preview-button" type="button" on-tap="_togglePreviewState">
                    <kano-animated-svg width="32" S
                                       height="32"
                                       paths="[[previewButtonIconPaths]]"
                                       selected="[[previewState]]"></kano-animated-svg>
                </button>
            </div>
        </kano-part-editor-topbar>
        <kano-light-frame-editor-panel id="editor-panel"
                                       bitmap="{{selectedFrame}}"
                                       width="{{selected.userProperties.width}}"
                                       height="{{selected.userProperties.height}}"
                                       pen-color="{{penColor}}"
                                       pen-type="{{penType}}">
        <div slot="canvas" class="canvas">
            <iron-pages selected="[[previewState]]" attr-for-selected="name" id="canvas-area">
                <kano-pixel-canvas id="canvas"
                                    name="stopped"
                                    bitmap="{{selectedFrame}}"
                                    width="[[selected.userProperties.width]]"
                                    height="[[selected.userProperties.height]]"
                                    pixel-size="22"
                                    spacing="1"
                                    pen-color="[[penColor]]"
                                    pen-type="[[penType]]"
                                    on-paint-action="_onPaintAction"></kano-pixel-canvas>
                <kano-bitmap-renderer class="preview-renderer"
                                      name="running"
                                      bitmap="[[frame]]"
                                      pixel-size="22"
                                      spacing="1"
                                      width="[[selected.userProperties.width]]"
                                      height="[[selected.userProperties.height]]"></kano-bitmap-renderer>
            </iron-pages>
        </div>
        <div slot="settings" class="settings">
            <div class="settings-controls">
                <kano-input-text value="{{selected.name}}"
                                 theme="[[theme]]"></kano-input-text>
                <div class="size-settings">
                    <kano-input-range id="width-slider"
                                      class="slider"
                                      value="{{selected.userProperties.width}}"
                                      label="Width"
                                      min="1"
                                      max="16"
                                      theme="[[theme]]"></kano-input-range>
                    <kano-input-range id="height-slider"
                                      class="slider"
                                      value="{{selected.userProperties.height}}"
                                      label="Height"
                                      min="1"
                                      max="8"
                                      theme="[[theme]]"></kano-input-range>
                </div>
                <kano-input-range id="speed-slider"
                                  class="slider"
                                  value="{{selected.userProperties.speed}}"
                                  label="Speed"
                                  min="1"
                                  max="30"
                                  symbol="fps"
                                  theme="[[theme]]"></kano-input-range>
            </div>
        </div>
        </kano-light-frame-editor-panel>
        <div class="bottom-panel">
            <kano-bitmap-list id="frames"
                              bitmaps="{{selected.userProperties.bitmaps}}"
                              selected="{{selectedFrame}}"
                              selected-index="{{selectedIndex}}"
                              width="[[selected.userProperties.width]]"
                              height="[[selected.userProperties.height]]">
                <label id="bitmap-label" slot="label">Animate</label>
                <button id="add-frame-button" type="button" slot="add-button" disabled$="[[isEq(previewState, 'running')]]">
                    <iron-icon class="add-icon" icon="add"></iron-icon>
                    <span>Add cell</span>
                </button>
                <button type="button" slot="duplicate-button" disabled$="[[isEq(previewState, 'running')]]">
                    <iron-icon icon="content-copy"></iron-icon>
                    <span>Duplicate</span>
                </button>
                <button id="delete-frame-button" type="button" slot="delete-button" disabled$="[[isEq(previewState, 'running')]]">
                    <iron-icon icon="clear"></iron-icon>
                    <span>Delete</span>
                </button>
            </kano-bitmap-list>
        </div>
    </template>
    <script type="text/javascript">
        Polymer({
            is: 'kano-light-animation-editor',
            behaviors: [
                PolymerFilters.FilterBehavior,
                Kano.Behaviors.AppElementRegistryBehavior,
                Kano.Behaviors.AppEditorBehavior,
                Kano.MakeApps.PartsAPI['light-animation']
            ],
            properties: {
                selected: {
                    type: Object,
                    notify: true
                },
                selectedIndex: {
                    type: Number,
                    value: 0
                },
                previewState: {
                    type: String,
                    observer: '_previewStateChanged'
                },
                theme: {
                    type: String,
                    value: "#00d9c7"
                },
                selectedFrame: Array,
                penColor: String,
                penType: String
            },
            observers: [
                '_onSelectedChanged(selected.*)',
                '_onFrameChanged(frame.*)',
                '_onSelectedFrameChanged(selectedFrame.*)'
            ],
            created () {
                this._onKeydown = this._onKeydown.bind(this);
                this._onKeyup = this._onKeyup.bind(this);
            },
            attached () {
                let panelElements;

                document.addEventListener('keydown', this._onKeydown);
                document.addEventListener('keyup', this._onKeyup);

                this.previewButtonIconPaths = {
                    stopped: 'M 10,4 l 16, 12, 0, 0, -16, 12, z',
                    running: 'M 4,4 l 24, 0 0, 24, -24, 0, z'
                };
                this.previewState = 'stopped';

                this.async(() => {
                    panelElements = this.$['editor-panel'].getElementsRegistry();
                    this._registerElement('animation-editor', this);
                    this._registerElement('animation-editor-width-slider', this.$['width-slider']);
                    this._registerElement('animation-editor-height-slider', this.$['height-slider']);
                    this._registerElement('animation-editor-speed-slider', this.$['speed-slider']);
                    this._registerElement('animation-editor-canvas', this.$['canvas-area']);
                    this._registerElement('animation-editor-preview-button', this.$['preview-button']);
                    this._registerElement('animation-editor-add-frame-button', this.$['add-frame-button']);
                    this._registerElement('animation-editor-frames', this.$['frames']);
                    this._registerElement('animation-editor-palette', panelElements['palette']);
                    this._registerElement('animation-editor-draw-button', panelElements['draw-button']);
                    this._registerElement('animation-editor-fill-button', panelElements['fill-button']);
                    this._registerElement('animation-editor-colors', panelElements['colors']);
                    this._registerElement('animation-editor-add-color-button', panelElements['add-color-button']);
                    this._registerElement('animation-editor-color-wheel', panelElements['color-wheel']);
                });
            },
            _onKeydown (e) {
                this.set('_isShiftPressed', e.shiftKey);
                switch (e.key) {
                    case 'n':
                      this._addFrame();
                      break;
                    case 'ArrowRight':
                      this._nextFrame();
                      break;
                    case 'ArrowLeft':
                      this._previousFrame();
                      break;
                }
            },
            _onKeyup (e) {
                this.set('_isShiftPressed', e.shiftKey);
            },
            _addFrame () {
                this.$.frames.addFrame();
                this.notifyChange('light-animation-add-frame');
            },
            _nextFrame () {
                this.selectedIndex = Math.min(this.selected.userProperties.bitmaps.length - 1, this.selectedIndex + 1);
                this.selectedFrame = this.selected.userProperties.bitmaps[this.selectedIndex].slice(0);
            },
            _previousFrame () {
                this.selectedIndex = Math.max(0, this.selectedIndex - 1);
                this.selectedFrame = this.selected.userProperties.bitmaps[this.selectedIndex].slice(0);
            },
            _onSelectedChanged (e) {
                if (e.path === "selected" || e.path === "selected.userProperties.bitmaps") {
                    this.selectedFrame = this.selected.userProperties.bitmaps[this.selectedIndex].slice(0);
                }
            },
            _resetPreview () {
                this.previewState = 'stopped';
                this.selectedIndex = 0;
                clearTimeout(this.timeoutId);
            },
            _togglePreviewState () {
                this.set('previewState', this.previewState === 'running' ? 'stopped' : 'running');
                if (this.previewState === 'running') {
                    this._updatePreview();
                } else {
                    clearTimeout(this.timeoutId);
                }
            },
            _updatePreview () {
                let bitmaps = this.selected.userProperties.bitmaps;
                if (bitmaps) {
                    this.frame = bitmaps[this.selectedIndex];
                    this.selectedIndex++;
                    if (this.selectedIndex > bitmaps.length - 1) {
                        this.selectedIndex = 0;
                    }
                }
                this.timeoutId = setTimeout(this._updatePreview.bind(this), 1000 / this.selected.userProperties.speed);
            },
            _onFrameChanged () {
                this._renderOnRealDevice(this.frame);
            },
            _onSelectedFrameChanged () {
                this._renderOnRealDevice(this.selectedFrame);
            },
            _previewStateChanged () {
                this.notifyChange('light-animation-preview-changed', { value: this.previewState });
            },
            _onPaintAction () {
                this.notifyChange('light-animation-paint', { tool: this.penType });
            },
            _renderOnRealDevice () {
                try {
                    Kano.AppModules.modules.lightboard.shapes = {
                       'being-edited': this.getShape(this.selectedFrame)
                    };
                    Kano.AppModules.modules.lightboard.updateAndSync(false, () => {});
                }
                catch (e) {
                   return;
                }
            },
            getShape (frame) {
                this.model = this.selected;
                return {
                    id: 'being-edited',
                    x: this.getX(),
                    y: this.getY(),
                    width: this.getWidth(),
                    height: this.getHeight(),
                    visible: true,
                    bitmap: frame,
                    type: 'frame'
                };
            }
        });
    </script>
</dom-module>
