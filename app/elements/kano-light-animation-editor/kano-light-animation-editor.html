<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/polymer-filters/polymer-filters.html">
<link rel="import" href="../../bower_components/polymer-filters/filters/compare.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/web-components/kano-icons/kano-icons.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../inputs/kano-input-range/kano-input-range.html">
<link rel="import" href="../kano-pixel-canvas/kano-pixel-canvas.html">
<link rel="import" href="../kano-bitmap-renderer/kano-bitmap-renderer.html">
<link rel="import" href="../kano-bitmap-list/kano-bitmap-list.html">
<link rel="import" href="../kano-tooltip/kano-tooltip.html">
<link rel="import" href="../kano-animated-svg/kano-animated-svg.html">
<link rel="import" href="../kano-palette/kano-palette.html">
<link rel="import" href="../kano-code-shared-styles/kano-code-shared-styles.html">
<link rel="import" href="../behaviors/kano-media-query-behavior.html">
<dom-module id="kano-light-animation-editor">
    <style include="kano-code-shared-styles">
        :host {
            @apply --layout-vertical;
            @apply --layout-center-justified;
        }
        :host([medium-screen]),
        :host([small-screen]) {
            max-width: 665px;
            @apply --layout-vertical;
        }
        :host button {
            @apply --kano-button;
            @apply --layout-horizontal;
            @apply --layout-center-justified;
            background-color: var(--color-chateau);
            width: 48px;
            height: 48px;
        }
        .main {
            @apply --layout-horizontal;
            @apply --layout-start-justified;
            padding: 32px 48px;
        }
        :host([medium-screen]) .main,
        :host([small-screen]) .main {
            @apply --layout-vertical;
        }
        .canvas-editor {
            @apply --layout-horizontal;
        }
        .canvas-container {
            @apply --layout-flex-none;
            @apply --layout-vertical;
            width: 400px;
            height: 244px;
            margin: 0 36px;
        }
        .canvas-container iron-pages {
            @apply --layout-horizontal;
            @apply --layout-center-justified;
        }
        kano-pixel-canvas {
            cursor: none;
            --kano-pixel-editor-background: var(--color-dark);
        }
        .control-container {
            flex: 1 1 auto;
            min-height: 260px;
            @apply --layout-vertical;
        }
        :host([medium-screen]) .control-container label,
        :host([small-screen]) .control-container label {
            margin-top: 16px;
        }
        :host label {
            display: inline-block;
            font-family: var(--font-body);
            font-size: 16px;
            font-weight: bold;
            text-align: left;
            color: rgba(255,255,255,0.5);
            margin-bottom: 24px;
            @apply --layout-self-start;
        }
        .control-content {
            @apply --layout-flex;
            @apply --layout-vertical;
        }
        .control-content kano-input {
            min-height: 33px;
            margin-bottom: 16px;
            --kano-input-label: {
                width: 70px;
                margin-right: 30px;
            };
        }
        .control-content kano-input-range {
            --kano-input-range-label: {
                width: 70px;
                margin-right: 30px;
            };
        }
        :host .row {
            margin-bottom: 16px;
        }
        :host .row:last-child {
            margin-bottom: 0;
        }
        .slider {
            --kano-settings-label: {
                width: 80px;
            };
        }
        .framelist-container {
            height: 98px;
            border-top: 1px solid #202428;
            padding: 24px 48px 0;
            @apply --layout-horizontal;
            @apply --layout-center;
        }
        .framelist-container button {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
            font-size: 32px;
            font-family: monospace;
            padding: 0;
        }
        .framelist-button-container {
            margin-right: 16px;
        }
        #frames {
            overflow: hidden;
            @apply --layout-flex;
        }
        button.add-frame:disabled {
            opacity: 0.3;
        }
        kano-animated-svg {
            @apply --layout-flex;
            width: 18px;
            height: 18px;
            -webkit-filter: drop-shadow(0px 2px 0px rgba(0, 0, 0, 0.25));
            filter: drop-shadow(0px 2px 0px rgba(0, 0, 0, 0.25));
            --kano-animated-path: {
                fill: white;
                stroke: white;
                stroke-width: 3px;
                stroke-linecap: round;
                stroke-linejoin: round;
                transition: all ease-in-out 200ms;
            }
        }
    </style>
    <template>
        <div class="header"></div>
        <div class="main">
            <div class="canvas-editor">
                <kano-palette id="palette" bitmaps="[[selected.userProperties.bitmaps]]" pen-type="{{penType}}" palette="{{palette}}" pen-color="{{penColor}}"></kano-palette>
                <div class="canvas-container">
                    <label>Canvas</label>
                    <iron-pages selected="[[previewState]]" attr-for-selected="name">
                        <kano-pixel-canvas id="canvas"
                                            name="stopped"
                                            bitmap="{{selectedFrame}}"
                                            spacing="2"
                                            width="[[selected.userProperties.width]]"
                                            height="[[selected.userProperties.height]]"
                                            pixel-size="21"
                                            palette="[[palette]]"
                                            pen-color="[[penColor]]"
                                            pen-type="[[penType]]"></kano-pixel-canvas>
                        <kano-bitmap-renderer class="preview-renderer" name="running" bitmap="[[frame]]" spacing="2" width="[[selected.userProperties.width]]" height="[[selected.userProperties.height]]" pixel-size="21"></kano-bitmap-renderer>
                    </iron-pages>
                </div>
            </div>
            <div class="control-container">
                <label>Controls</label>
                <div class="control-content">
                    <kano-input type="text" label="Name" value="{{element.name}}"></kano-input>
                    <kano-input-range class="slider row" value="{{selected.userProperties.width}}" label="Width" min="1" max="16"></kano-input-range>
                    <kano-input-range class="slider row" value="{{selected.userProperties.height}}" label="Height" min="1" max="8"></kano-input-range>
                    <kano-input-range class="slider row" value="{{selected.userProperties.speed}}" label="Frame rate" min="1" max="30" symbol="fps"></kano-input-range>
                </div>
            </div>
        </div>
        <div class="divider"></div>
        <div class="framelist-container">
            <div class="framelist-button-container">
                <button type="button" name="button" class="preview-control" on-tap="_togglePreviewState">
                    <kano-animated-svg width="32" height="32" paths="[[previewButtonIconPaths]]" selected="[[previewState]]"></kano-animated-svg>
                </button>
            </div>
            <div class="framelist-button-container">
                <button type="button" name="button" class="add-frame" on-tap="_addFrame" disabled$="[[isEq(previewState, 'running')]]"><span><iron-icon icon="kano-icons:plus"></iron-icon></span></button>
            </div>
            <kano-bitmap-list bitmaps="{{selected.userProperties.bitmaps}}" selected="{{selectedFrame}}" selected-index="{{selectedIndex}}" width="[[selected.userProperties.width]]" height="[[selected.userProperties.height]]" class="frame-list" id="frames"></kano-bitmap-list>
        </div>
    </template>
    <script type="text/javascript">
        Polymer({
            is: 'kano-light-animation-editor',
            behaviors: [PolymerFilters.FilterBehavior, Kano.Behaviors.MediaQueryBehavior],
            properties: {
                selected: {
                    type: Object,
                    notify: true
                },
                selectedIndex: {
                    type: Number,
                    value: 0
                },
                selectedFrame: {
                    type: Array,
                    value: () => {
                        return ['#000000'];
                    }
                }
            },
            observers: [
                '_onSelectedChanged(selected.*)',
                '_selectedFrameChanged(selectedFrame.*)'
            ],
            attached () {
                this.previewButtonIconPaths = {
                    stopped: 'M 10,4 l 16, 12, 0, 0, -16, 12, z',
                    running: 'M 4,4 l 24, 0 0, 24, -24, 0, z'
                };
                this.previewState = 'stopped';
                this.previewIndex = 0;
            },
            _onSelectedChanged (e) {
                this.selectedIndex = this.selectedIndex || 0;
                if (e.path = "selected") {
                    this.selectedFrame = this.selected.userProperties.bitmaps[this.selectedIndex].slice(0);
                }
            },
            _togglePreviewState () {
                this.set('previewState', this.previewState === 'running' ? 'stopped' : 'running');
                if (this.previewState === 'running') {
                    this._updatePreview();
                } else {
                    clearTimeout(this.timeoutId);
                }
            },
            _updatePreview () {
                let bitmaps = this.selected.userProperties.bitmaps;
                if (bitmaps) {
                    this.frame = bitmaps[this.previewIndex];
                    this.previewIndex++;
                    if (this.previewIndex > bitmaps.length - 1) {
                        this.previewIndex = 0;
                    }
                }
                this.timeoutId = setTimeout(this._updatePreview.bind(this), 1000 / this.selected.userProperties.speed);
            },
            _generateEmptyBitmap (name, width, height, color='#000000') {
                let length = width * height;
                for (let i = 0; i < length; i++) {
                    this.push(name, color);
                }
            },
            _selectedFrameChanged (e) {
                if (!this.selectedFrame) {
                    return;
                }

                if (this.selectedFrame.length === 0) {
                    this._generateEmptyBitmap('selectedFrame', this.width, this.height);
                }
                // this.$.palette._computePalette();
            },
            _addFrame () {
                this.$.frames.addFrame();
            },
            _isNewFrameDisabled (previewState) {
                return (previewState === 'running');
            },
            enterQuitsInput () {
                if (event.keyCode == 13) {
                    this.blur();
                    return false;
                }
            }
        });
    </script>
</dom-module>
