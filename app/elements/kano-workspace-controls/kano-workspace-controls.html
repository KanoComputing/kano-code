<link rel="import" href="../behaviors.html">
<link rel="import" href="../../bower_components/Sortable/Sortable.html">
<dom-module id="kano-workspace-controls">
    <style>
    :host {
        display: block;
        position: relative;
        max-height: 40%;
        min-height: 70px;
        @apply(--layout-vertical);
    }
    :host .content {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        background-color: var(--color-black, black);
    }
    :host .toolbar {
        @apply(--layout-horizontal);
        padding: 5px;
        background-color: #212121;
    }
    :host .toolbar .controls {
        @apply(--layout-flex);
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
    }
    :host .toolbar .controls button {
        @apply(--kano-button-small);
        margin-left: 5px;
    }
    :host .add-ui {
        @apply(--kano-round-button);
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        background: linear-gradient(#7DC243,#358401);
        color: var(--color-white, white);
        position: absolute;
        top: -25px;
        left: 5px;
        box-shadow: 0px 3px 0px 0px rgba(0,0,0,0.11);
    }
    :host .add-ui iron-image {
        width: 25px;
        height: 25px;
        transition: all ease-out 200ms;
    }
    :host .add-ui.opened {
        background: var(--red-gradient, red);
    }
    :host .add-ui.opened iron-image {
        transform: rotate(45deg);
    }
    :host .parts {
        padding: 0px 10px;
        overflow-y: auto;
        @apply(--layout-horizontal);
        @apply(--layout-wrap);

        align-items: center;
        flex: 1;
    }
    :host .part {
        padding: 3px;
        position: relative;
    }
    :host .part.selected {
        border: 2px dotted white;
    }
    :host .part .trash {
        width: 25px;
        height: 25px;
        position: absolute;
        right: 2px;
        bottom: 4px;
    }
    :host kano-ui-item {
        --kano-ui-item-color: var(--color-white, white);
    }
    :host .share-button {
        background: var(--blue-gradient, blue);
    }
    :host .make-button {
        background: var(--orange-gradient, orange);
    }
    :host .make-button.stop {
        background: var(--red-gradient, red);
    }
    :host paper-dialog .buttons button {
        @apply(--kano-button);
        margin-left: 5px;
    }
    :host paper-dialog .buttons .confirm {
        background: var(--red-gradient, red);
    }
    </style>
    <template>
        <button id="add-part"
                type="button"
                class$="add-ui [[computeAddUiClass(opened)]]"
                on-tap="addTapped">
            <iron-image src="/assets/icons/plus-icon.png"
                        sizing="contain"></iron-image>
        </button>
        <div class="content">
            <div class="toolbar">
                <div class="controls">
                    <button type="button"
                            class="share-button"
                            on-tap="shareTapped">share</button>
                    <button id="make-button"
                            type="button"
                            class$="make-button {{computeRunningClass(running)}}"
                            on-tap="makeTapped">make</button>
                </div>

            </div>
            <sortable-js class="parts" id="parts-tray">
                <template is="dom-repeat"
                            items="{{parts}}"
                            as="part">
                    <div class$="part [[partClass(part, selected)]]">
                        <kano-ui-item model="[[part]]"
                                      on-tap="partTapped"
                                      size="70"
                                      id$="part-[[part.id]]"></kano-ui-item>
                        <iron-image src="/assets/icons/bin.svg" class="trash" sizing="contain" hidden$="[[!isSelected(part, selected)]]" on-tap="openDeleteModal"></iron-image>
                    </div>
                </template>
            </div>
        </div>
        <array-selector id="selector" items="{{parts}}" selected="{{selected}}"></array-selector>
        <paper-dialog id="confirm-delete" with-backdrop on-iron-overlay-closed="modalClosed">
          <h2>Delete Part</h2>
          <div class="modal-content">
              <div>You are about to delete '[[selected.name]]'</div>
              <div>Are you sure you want to do this?</div>
          </div>
          <div class="buttons">
            <button dialog-dismiss class="cancel">Cancel</button>
            <button dialog-confirm class="confirm">Confirm</button>
          </div>
        </paper-dialog>
    </template>
</dom-module>
<script type="text/javascript">

    class KanoWorkspaceControls {

        get behaviors () {
            return [KanoBehaviors.AppEditorBehavior];
        }

        beforeRegister () {
            this.is = 'kano-workspace-controls';
            this.properties = {
                running: {
                    type: Boolean
                },
                selected: {
                    type: Object,
                    notify: true
                },
                code: {
                    type: String
                },
                parts: {
                    type: Array,
                    notify: true
                },
                opened: {
                    type: Boolean,
                    value: false
                }
            };
            this.listeners = {
                'mouseenter': 'onMouseEnter',
                'mouseleave': 'onMouseLeave'
            };
        }
        attached () {
            window.addEventListener('keyup', this.onKeyUp.bind(this));
        }

        detached () {
            window.removeEventListener('keyup', this.onKeyUp.bind(this));
        }

        onKeyUp (e) {
            // If the delete key is pressed and an element is selected
            // and the workspace is focused, remove the element
            if (e.keyCode === 8 &&
                    this.selected &&
                    this.focused) {
                e.preventDefault();
                this.openDeleteModal();
            }
        }
        openDeleteModal () {
            this.$['confirm-delete'].open();
        }
        modalClosed (e) {
            if (e.detail.confirmed) {
                this.removeSelected();
            }
        }
        removeSelected () {
            let index = this.parts.indexOf(this.selected),
                partsCount;
            this.splice('parts', index, 1);
            partsCount = this.parts.length;
            if (partsCount) {
                this.$.selector.select(this.parts[partsCount - 1]);
            } else {
                this.$.selector.clearSelection();
            }
            this.fire('change');
        }
        onMouseEnter () {
            this.focused = true;
        }
        onMouseLeave () {
            this.focused = false;
        }
        computeRunningClass () {
            return this.running ? 'stop' : 'run';
        }
        switchTab (e) {
            let buttons = this.querySelectorAll('.tab-nav button');
            for (let i = 0, len = buttons.length; i < len; i++) {
                buttons[i].classList.remove('selected');
            }
            e.target.classList.add('selected');
        }
        addTapped () {
            this.fire('add-tap');
        }
        shareTapped () {
            this.fire('share-tap');
        }
        makeTapped () {
            this.fire('make-tap');
        }
        partTapped (e) {
            let part = e.model.get('part');
            this.selectPart(part);
        }
        selectPart (part) {
            this.$.selector.select(part);
            this.notifyChange('select-part', { part });
        }
        isSelected (part, selected) {
            return selected && part.id === selected.id;
        }
        partClass (part, selected) {
            if (this.isSelected(part, selected)) {
                return 'selected';
            }
            return '';
        }
        computeAddUiClass () {
            return this.opened ? 'opened' : 'closed';
        }
    }
    Polymer(KanoWorkspaceControls);
</script>
