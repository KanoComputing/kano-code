<link rel="import" href="../behaviors.html">
<link rel="import" href="../kano-data-visualizer/kano-data-visualizer.html">
<link rel="import" href="../kano-carousel/kano-carousel.html">
<link rel="import" href="../../bower_components/Sortable/Sortable.html">
<dom-module id="kano-workspace-controls">
    <style>
    :host {
        display: block;
        position: relative;
        @apply(--layout-vertical);
        background-color: var(--color-dark, black);
    }
    :host .content {
        @apply(--layout-horizontal);
    }
    :host .parts {
        flex: 1;
        @apply(--layout-horizontal);
        @apply(--layout-flex);
    }
    :host .part {
        position: relative;
        padding: 3px;
        border: 2px solid transparent;
    }
    :host .part .trash {
        width: 25px;
        height: 25px;
        position: absolute;
        right: 2px;
        bottom: 4px;
    }
    :host kano-data-visualizer {
        position: absolute;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
    }
    :host kano-ui-item {
        --kano-ui-item-color: var(--color-white, white);
    }
    :host paper-dialog .buttons button {
        @apply(--kano-button);
        margin-left: 5px;
    }
    :host paper-dialog .buttons .confirm {
        background: var(--red-gradient, red);
    }
    :host kano-carousel {
        @apply(--layout-flex);
        overflow: hidden;
        --kano-carousel-button {
            background: red;
        }
    }
    :host sortable-js {
        padding: 0px 20px;
    }
    :host .add-part-section {
        @apply(--layout-vertical);
        @apply(--layout-center);
        padding: 7px;
        border-left: 2px solid var(--color-grey-mid, grey);
    }
    :host .add-part-section label {
        text-transform: uppercase;
        color: var(--color-white, white);
    }
    :host .add-part-button {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background-color: var(--color-white, white);
        color: black;
        font-size: 2em;
        font-weight: 100;
        border: 0px;
    }
    :host .add-part-button:hover {
        cursor: pointer;
    }
    :host .background-item {
        @apply(--layout-vertical);
        @apply(--layout-center);
        color: white;
    }
    :host .background-icon {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background-color: var(--color-white, white);
    }
    </style>
    <template>
        <div class="content">
            <kano-carousel id="carousel">
                <sortable-js id="parts-tray" class="parts">
                    <div class="part">
                        <kano-ui-item model="[[backgroundPart]]"
                            on-tap="backgroundTapped"
                            size="50"
                            id="background"></kano-ui-item>
                    </div>
                    <template is="dom-repeat"
                    items="{{parts}}"
                    as="part">
                    <div class="part">
                        <kano-data-visualizer for="[[part.id]]" buffer-length="100"></kano-data-visualizer>
                        <kano-ui-item model="[[part]]"
                            selected="[[isSelected(part, selected)]]"
                            on-tap="partTapped"
                            size="50"
                            id$="part-[[part.id]]"></kano-ui-item>
                        <iron-image src="/assets/icons/bin.svg" class="trash" sizing="contain" hidden$="[[!isSelected(part, selected)]]" on-tap="openDeleteModal"></iron-image>
                    </div>
                </template>
            </sortable-js>
        </kano-carousel>
        <div class="add-part-section">
            <button type="button" class="add-part-button" on-tap="addPartTapped">+</button>
            <label>Add Parts</label>
        </div>
        </div>
        <array-selector id="selector" items="{{parts}}" selected="{{selected}}"></array-selector>
        <paper-dialog id="confirm-delete" with-backdrop on-iron-overlay-closed="modalClosed">
          <h2>Delete Part</h2>
          <div class="modal-content">
              <div>You are about to delete '[[selected.name]]'</div>
              <div>Are you sure you want to do this?</div>
          </div>
          <div class="buttons">
            <button dialog-dismiss class="cancel">Cancel</button>
            <button dialog-confirm class="confirm">Confirm</button>
          </div>
        </paper-dialog>
        <paper-dialog id="external-use-warning" with-backdrop>
          <h2>Delete Part</h2>
          <div class="modal-content">
              <div>You can't delete '[[selected.name]]' because it is used in another part</div>
          </div>
          <div class="buttons">
            <button dialog-dismiss class="cancel">Cancel</button>
          </div>
        </paper-dialog>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer, KanoBehaviors */

    class KanoWorkspaceControls {

        get behaviors () {
            return [KanoBehaviors.AppEditorBehavior];
        }

        beforeRegister () {
            this.is = 'kano-workspace-controls';
            this.properties = {
                running: {
                    type: Boolean
                },
                selected: {
                    type: Object,
                    notify: true
                },
                code: {
                    type: String
                },
                codes: {
                    type: Object,
                    notify: true
                },
                parts: {
                    type: Array,
                    notify: true
                },
                deletionDisabled: {
                    type: Boolean,
                    value: false
                }
            };
            this.listeners = {
                'mouseenter': 'onMouseEnter',
                'mouseleave': 'onMouseLeave'
            };
        }
        attached () {
            this.backgroundPart = {
                name: 'Background',
                colour: 'orange'
            };
            window.addEventListener('keyup', this.onKeyUp.bind(this));
        }

        detached () {
            window.removeEventListener('keyup', this.onKeyUp.bind(this));
        }

        onKeyUp (e) {
            // If the delete key is pressed and an element is selected
            // and the workspace is focused, remove the element
            if (e.keyCode === 8 &&
                    this.selected &&
                    this.focused) {
                e.preventDefault();
                if (this.deletionDisabled) {
                    return;
                }
                this.openDeleteModal();
            }
        }
        checkBlockDependency () {
            let emitter, event, xmlString, xml, parser, blocks, block, blockId, pieces, code;
            for (let i in this.codes) {
                emitter = this.codes[i];
                for (let j in emitter) {
                    event = emitter[j];
                    for (let index in event) {
                        code = event[index];
                        // Get the blockly xml and parse it
                        xmlString = code.snapshot.blocks;
                        parser = new DOMParser();
                        xml = parser.parseFromString(xmlString, 'text/xml');
                        // Get all the 'block' elements
                        blocks = xml.getElementsByTagName('block');
                        // Check for every one of them...
                        for (let k = 0, len = blocks.length; k < len; k++) {
                            block = blocks[k];
                            blockId = block.getAttribute('type');
                            pieces = blockId.split('#');
                            // ...if the type of the block is the part we're trying to delete
                            if (pieces[0] === this.selected.id) {
                                return true;
                            }
                        }
                    }
                }
            }
            return false;
        }
        openDeleteModal () {
            if (this.checkBlockDependency()) {
                return this.$['external-use-warning'].open();
            }
            this.$['confirm-delete'].open();
        }
        modalClosed (e) {
            if (e.detail.confirmed) {
                this.removeSelected();
            }
        }
        removeSelected () {
            let index = this.parts.indexOf(this.selected),
                partsCount;
            // Remove the pieces of code matching the part removed
            this.set(`codes.${this.selected.id}`, {});
            this.splice('parts', index, 1);
            partsCount = this.parts.length;
            if (partsCount) {
                this.$.selector.select(this.parts[partsCount - 1]);
            } else {
                this.$.selector.clearSelection();
            }
            this.fire('change');
        }
        onMouseEnter () {
            this.focused = true;
        }
        onMouseLeave () {
            this.focused = false;
        }
        addPartTapped () {
            this.fire('add-part-tap');
        }
        partTapped (e) {
            let part = e.model.get('part'),
                rect = e.target.getBoundingClientRect();
            this.selectPart(part);
            this.fire('part-tap', rect);
        }
        backgroundTapped (e) {
            let rect = e.target.getBoundingClientRect();
            this.fire('background-tap', rect);
        }
        selectPart (part) {
            this.$.selector.select(part);
            this.notifyChange('select-part', { part });
        }
        isSelected (part, selected) {
            return selected && part.id === selected.id;
        }
    }
    Polymer(KanoWorkspaceControls);
</script>
