<dom-module id="kano-workspace-controls">
    <style>
    :host {
        display: block;
        position: relative;
        max-height: 40%;
        min-height: 70px;
        @apply(--layout-vertical);
    }
    :host .content {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        background-color: var(--color-black, black);
    }
    :host .toolbar {
        @apply(--layout-horizontal);
        padding: 5px;
        background-color: #212121;
    }
    :host .toolbar .controls {
        @apply(--layout-flex);
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
    }
    :host .toolbar .controls button {
        @apply(--kano-button-small);
        margin-left: 5px;
    }
    :host .add-ui {
        @apply(--kano-round-button);
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        background: linear-gradient(#7DC243,#358401);
        color: var(--color-white, white);
        position: absolute;
        top: -25px;
        left: 5px;
        box-shadow: 0px 3px 0px 0px rgba(0,0,0,0.11);
    }
    :host .add-ui iron-image {
        width: 25px;
        height: 25px;
        transition: all ease-out 200ms;
    }
    :host .add-ui.opened {
        background: var(--red-gradient, red);
    }
    :host .add-ui.opened iron-image {
        transform: rotate(45deg);
    }
    :host .parts {
        padding: 10px;
        overflow-y: auto;
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
    }
    :host .part {
        padding: 3px;
    }
    :host .share-button {
        background: var(--blue-gradient, blue);
    }
    :host .make-button {
        background: var(--orange-gradient, orange);
    }
    :host .make-button.stop {
        background: var(--red-gradient, red);
    }
    </style>
    <template>
        <button type="button"
                class$="add-ui [[computeAddUiClass(opened)]]"
                on-tap="addTapped">
            <iron-image src="/assets/icons/plus-icon.png"
                        sizing="contain"></iron-image>
        </button>
        <div class="content">
            <div class="toolbar">
                <div class="controls">
                    <button type="button"
                            class="share-button"
                            on-tap="shareTapped">share</button>
                    <button type="button"
                            class$="make-button {{computeRunningClass(running)}}"
                            on-tap="makeTapped">make</button>
                </div>

            </div>
            <div class="parts">
                <template is="dom-repeat"
                            items="{{parts}}"
                            as="part">
                    <div class="part" style$="[[partStyle(part, selected)]]">
                        <kano-ui-item model="[[part]]"
                                      on-tap="selectPart"
                                      size="70"></kano-ui-item>
                    </div>
                </template>
            </div>
        </div>
        <array-selector id="selector" items="{{parts}}" selected="{{selected}}"></array-selector>
    </template>
</dom-module>
<script type="text/javascript">
    class KanoWorkspaceControls {
        beforeRegister () {
            this.is = 'kano-workspace-controls';
            this.properties = {
                running: {
                    type: Boolean
                },
                selected: {
                    type: Object,
                    notify: true
                },
                code: {
                    type: String
                },
                parts: {
                    type: Array,
                    notify: true
                },
                opened: {
                    type: Boolean,
                    value: false
                }
            };
            this.listeners = {
                'mouseenter': 'onMouseEnter',
                'mouseleave': 'onMouseLeave'
            };
        }
        attached () {
            window.addEventListener('keyup', this.onKeyUp.bind(this));
        }

        detached () {
            window.removeEventListener('keyup', this.onKeyUp.bind(this));
        }

        onKeyUp (e) {
            // If the delete key is pressed and an element is selected
            // and the workspace is focused, remove the element
            if (e.keyCode === 8 &&
                    this.selected &&
                    this.focused) {
                let partsCount,
                    index;
                e.preventDefault();
                index = this.parts.indexOf(this.selected);
                this.splice('parts', index, 1);
                partsCount = this.parts.length;
                if (partsCount) {
                    this.$.selector.select(this.parts[partsCount - 1]);
                } else {
                    this.$.selector.clearSelection();
                }
                this.fire('change');
            }
        }
        onMouseEnter () {
            this.focused = true;
        }
        onMouseLeave () {
            this.focused = false;
        }
        computeRunningClass () {
            return this.running ? 'stop' : 'run';
        }
        switchTab (e) {
            let buttons = this.querySelectorAll('.tab-nav button');
            for (let i = 0, len = buttons.length; i < len; i++) {
                buttons[i].classList.remove('selected');
            }
            e.target.classList.add('selected');
        }
        addTapped () {
            this.fire('add-tap');
        }
        shareTapped () {
            this.fire('share-tap');
        }
        makeTapped () {
            this.fire('make-tap');
        }
        selectPart (e) {
            let part = e.model.get('part');
            this.$.selector.select(part);
            this.fire('change', {
                type: 'select-part',
                part
            });
        }
        partStyle (part, selected) {
            if (!selected) {
                return;
            }
            if (part.id === selected.id) {
                return `border: 1px dashed orange;
                        border-radius: 3px;`;
            }
        }
        computeAddUiClass () {
            return this.opened ? 'opened' : 'closed';
        }
    }
    Polymer(KanoWorkspaceControls);
</script>
