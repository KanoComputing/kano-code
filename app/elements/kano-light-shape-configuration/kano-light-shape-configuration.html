<link rel="import" href="../kano-ui-customizer/kano-ui-customizer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/web-components/kano-style/input.html">
<dom-module id="kano-light-shape-configuration">
    <style is="custom-style" include="input-range"></style>
    <style>
    :host {
        @apply --layout-vertical;
        padding: 24px 48px 16px;
    }
    </style>
    <template>
        <kano-input type="text" label="Name" value="[[element.name]]"></kano-input>
        <kano-ui-customizer id="properties"
            customizable="{{element.customizable.properties}}"
            user-values="{{element.userProperties}}">
        </kano-ui-customizer>
        <kano-ui-customizer id="style"
            customizable="{{element.customizable.style}}"
            user-values="{{element.userStyle}}">
        </kano-ui-customizer>
        <kano-input type="range" value="{{position.x}}" label="X Position" min="1" max="[[maxX]]"></kano-input>
        <kano-input type="range" value="{{position.y}}" label="Y Position" min="1" max="[[maxY]]"></kano-input>
    </template>
</dom-module>

<script type="text/javascript">
    /* globals Polymer */

    Polymer({
        is: 'kano-light-shape-configuration',
        properties: {
            element: {
                type: Object,
                notify: true
            },
            position: {
                type: Object,
                value: () => {
                    return {
                        x: 1,
                        y: 1
                    };
                }
            },
            roundPosition: {
                type: Object
            },
            maxX: {
                type: Number,
                computed: '_computeMaxX(element.userProperties.*)',
                value: 16
            },
            maxY: {
                type: Number,
                computed: '_computeMaxY(element.userProperties.*)',
                value: 8
            }
        },
        observers: [
            'computeRoundPosition(element.position.*)',
            '_positionChanged(element.position.*)',
            '_virtualPositionChanged(position.*)'
        ],
        _computeMaxX () {
            if (!this.element || !this.element.userProperties) {
                return 16;
            }
            return 16 - parseInt(this.element.userProperties.width || this.element.userProperties.radius) + 1 || 16;
        },
        _computeMaxY () {
            if (!this.element || !this.element.userProperties) {
                return 8;
            }
            return 8 - parseInt(this.element.userProperties.height || this.element.userProperties.radius) + 1 || 8;
        },
        _positionChanged () {
            if (this.element) {
                this.set('position.x', Math.round(this.element.position.x / 27) + 1);
                this.set('position.y', Math.round(this.element.position.y / 27) + 1);
            }
        },
        _virtualPositionChanged () {
            this.set('element.position.x', (Math.round(this.position.x - 1)) * 27);
            this.set('element.position.y', (Math.round(this.position.y - 1)) * 27);
        },
        computeRoundPosition () {
            let pos;
            if (!this.element) {
                return;
            }
            pos = this.element.position;
            if (!pos) {
                return;
            }
            this.set('roundPosition', {
                x: Math.ceil(pos.x) || 0,
                y: Math.ceil(pos.y) || 0
            });
        }
    });
</script>
