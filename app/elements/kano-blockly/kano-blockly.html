<script src="../../assets/vendor/google-blockly/blockly_compressed.js"></script>
<script src="../../assets/vendor/google-blockly/blocks_compressed.js"></script>
<script src="../../assets/vendor/google-blockly/javascript_compressed.js"></script>
<script src="../../assets/vendor/google-blockly/msg/js/en.js"></script>

<dom-module id="kano-blockly">
    <style>
    :host {
        display: block;
        position: relative;
    }
    :host #workspace {
        position: absolute;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
    }
    </style>
    <template>
        <div id="workspace"></div>
    </template>
</dom-module>

<script>
    class KanoBlockly {
        beforeRegister () {
            this.is = 'kano-blockly';
            this.properties = {
                toolbox: {
                    type: Array,
                    value: () => []
                },
                toolboxXml: {
                    type: String,
                    computed: 'computeToolboxXml(toolbox)'
                },
                code: {
                    type: String,
                    notify: true
                }
            }
        }
        created () {
            Blockly.HSV_SATURATION = 0.8;
            Blockly.HSV_VALUE = 0.8;
        }
        attached () {
            this.workspace = Blockly.inject(this.$.workspace, {
                toolbox: this.toolboxXml
            });
            window.addEventListener('resize', this.onResize.bind(this), false);
            this.workspace.addChangeListener(this.onBlocklyChange.bind(this));
            this.onResize();
        }
        // Wrap around the querySelector, and caches the values to
        // gain performances
        getToolboxElements () {
            if (this.toolboxElements) {
                return this.toolboxElements;
            }
            this.toolboxElements = document.querySelectorAll([
                '.blocklyWidgetDiv',
                '.blocklyTooltipDiv',
                '.blocklyToolboxDiv',
            ].join(','));
            this.toolboxElements = [].slice.call(this.toolboxElements);
            this.toolboxDiv = this.toolboxElements[2];
            return this.toolboxElements;
        }
        hideToolbox () {
            this.getToolboxElements().forEach((el) => {
                el.style.visibility = 'hidden';
            });
        }
        showToolbox () {
            this.getToolboxElements().forEach((el) => {
                el.style.visibility = 'visible';
            });
        }
        detached () {
            // Hack to get rid of the remaining blockly elements
            this.getToolboxElements().forEach((el) => {
                el.parentNode.removeChild(el);
            });
        }
        resize () {
            Blockly.fireUiEvent(window, 'resize');
        }
        onResize () {
            this.debounce('resize', () => {
                let workspace = this.$.workspace;
                workspace.style.top = '0px';
                workspace.style.bottom = '0px';
                workspace.style.left = '0px';
                workspace.style.right = '0px';
                if (this.toolboxDiv) {
                    this.toolboxDiv.style.width = `${this.offsetWidth*0.25}px`;
                }
            }, 50);
        }
        computeToolboxXml (toolbox) {
            if (!this.toolbox || !this.toolbox.length) {
                this.toolbox = [{name: 'Category', blocks: []}]
            }
            let xml;
                categoriesXml = this.toolbox.map((category) => {
                    let blocksXml = category.blocks.map((block) => {
                        return `<block type="${block.id}"></block>`;
                    }).join('');
                    return `<category name="${category.name}" colour="${category.colour}">${blocksXml}</category>`;
                }).join('');
            xml = `<xml>${categoriesXml}</xml>`;
            if (this.workspace) {
                this.workspace.updateToolbox(xml);
                this.onResize();
            }
            return xml;
        }
        onBlocklyChange (e) {
            this.set('code', this.getCode('JavaScript'));
            this.fire('change', e);
        }
        getXml () {
            return Blockly.Xml.workspaceToDom(this.workspace);
        }
        getCode (type) {
            return Blockly[type].workspaceToCode(this.workspace);
        }
        getDom () {
            return Blockly.Xml.workspaceToDom(this.workspace);
        }
    }
    Polymer(KanoBlockly);
</script>
