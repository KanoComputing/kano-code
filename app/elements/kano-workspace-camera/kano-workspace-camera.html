<link rel="import" href="../behaviors/kano-workspace-behavior.html">
<link rel="import" href="../part/kano-ui-behavior.html">
<link rel="import" href="../../../scripts/kano/make-apps/parts-api/camera.html">
<script src="../../scripts/kano/webcam.js"></script>
<dom-module id="kano-workspace-camera">
    <style>
        :host {
            display: block;
            width: 100%;
            height: 100%;
        }
        :host ::content>* {
            position: absolute;
            top: 0px;
            left: 0px
        }
    </style>
    <template>
        <kano-workspace-normal id="screen">
            <kano-part-camera id="camera-part"></kano-part-camera>
            <content></content>
        </kano-workspace-normal>
    </template>
    <script>
        /* globals Polymer, Kano */
        Polymer({
            is: 'kano-workspace-camera',
            behaviors: [Kano.Behaviors.WorkspaceBehavior, Kano.Behaviors.UIBehavior, Kano.MakeApps.PartsAPI.camera],
            setBackgroundColor (color) {
                this.$.screen.style.background = color;
            },
            attached () {
                this.connected = false;
                // Wait for the socket to try to connect
                setTimeout(() => {
                    // Still not connected, start the webcam
                    if (!this.connected) {
                        this._startWebcam();
                    }
                }, 300);
                Kano.AppModules.getModule('camera').connect({
                    name: 'Kano Code'
                });
                Kano.AppModules.getModule('camera').on('connect', () => {
                    this.connected = true;
                    // Stop the webcam if started before
                    this._stopWebcam();
                });
                Kano.AppModules.getModule('camera').on('disconnect', () => {
                    this.connected = false;
                    this._startWebcam();
                });
            },
            _startWebcam () {
                this.webcam = new Kano.Webcam();
                this.webcam.ready.then(_ => {
                    if (this.connected) {
                        this._stopWebcam();
                        return;
                    }
                    this.getCamera().setWebcam(this.webcam);
                }).catch(e => {
                    if (e.name === 'PermissionDeniedError') {
                        this.fire('kano-error', {
                            text: `Kano Code needs permission to use your webcam. You can allow access from your browser settings.`,
                            duration: 0,
                            closeWithButton: true,
                            buttonText: 'OK'
                        });
                    }
                });
                this.webcam.start();
            },
            _stopWebcam () {
                this.webcam.stop();
                this.getCamera().disableWebcam();
            },
            // Support legacy code
            getCamera () {
                return this;
            },
            detached () {
                this._stopWebcam();
            }
        });
    </script>
</dom-module>
