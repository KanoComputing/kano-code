<link rel="import" href="../behaviors/kano-workspace-behavior.html">
<link rel="import" href="../behaviors/kano-emitter-behavior.html">
<link rel="import" href="../behaviors/kano-image-filters-behavior.html">
<link rel="import" href="../part/kano-part-camera/kano-part-camera.html">
<link rel="import" href="../kano-gif-creator/kano-gif-creator.html">
<dom-module id="kano-workspace-camera">
    <style>
        :host {
            display: block;
            width: 100%;
            height: 100%;
        }
        :host ::content>* {
            position: absolute;
            top: 0px;
            left: 0px
        }
        kano-gif-creator, .content {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
        }
    </style>
    <template>
        <kano-gif-creator id="screen" width="[[width]]" height="[[height]]" pictures="[[pictures]]" framerate="[[framerate]]"></kano-gif-creator>
        <kano-part-camera id="camera-part"></kano-part-camera>
        <div class="content">
            <content></content>
        </div>
    </template>
    <script>
        /* globals Polymer, Kano */
        Polymer({
            is: 'kano-workspace-camera',
            behaviors: [Kano.Behaviors.WorkspaceBehavior, Kano.Behaviors.EmitterBehavior, Kano.Behaviors.ImageFiltersBehavior],
            listeners: {
                'picture-taken': '_onPictureTaken'
            },
            ready () {
                // Will contain the listeners attached to the socket
                this.socketListeners = [];
                this.pictures = [];
                this.framerate = 15;
                this.$.screen.setTransformer(this.applyFilters.bind(this));
            },
            setBackgroundColor (color) {
                this.$.screen.style.background = color;
            },
            addFilter () {
                let args = Array.prototype.slice.call(arguments),
                    name = args.shift();
                Kano.Behaviors.ImageFiltersBehavior.addFilter.call(this, name, args);
            },
            attached () {
                Kano.AppModules.getModule('camera').connect({
                    name: 'Kano Code'
                });
            },
            _onPictureTaken (e) {
                this.push('pictures', e.detail);
            },
            getCamera () {
                return this.$['camera-part'];
            },
            flash (color, length) {
                Kano.AppModules.getModule('camera').flash(color, length);
            },
            onShutterDown (cb) {
                this.onKeyDown('shutter-button', cb);
            },
            onShutterTurns (key, callback) {
                let cb = this._shutterCheck(key, callback);
                this.socketListeners.push({
                    name: 'timer-changed',
                    cb
                });
                Kano.AppModules.getModule('camera').on('timer-changed', cb);
            },
            _shutterCheck (key, callback) {
                return (data) => {
                    if (data.direction === key) {
                        callback();
                    }
                };
            },
            onKeyDown (key, callback) {
                let cb = this._keyDownCheck(key, callback);
                this.socketListeners.push({
                    name: 'button-down',
                    cb
                });
                Kano.AppModules.getModule('camera').on('button-down', cb);
            },
            _keyDownCheck (key, callback) {
                return (data) => {
                    if (data['button-id'] === key) {
                        callback();
                    }
                };
            },
            stop () {
                Kano.Behaviors.EmitterBehavior.stop.apply(this, arguments);
                this.reset();
            },
            reset () {
                // Remove all the listeners and reset the listeners array
                this.socketListeners.forEach((listener) => {
                    Kano.AppModules.getModule('camera').removeListener(listener.name, listener.cb);
                });
                this.socketListeners = [];
                Kano.Behaviors.ImageFiltersBehavior.reset.apply(this, arguments);
            }
        });
    </script>
</dom-module>
