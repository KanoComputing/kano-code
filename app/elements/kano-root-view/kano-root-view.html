<link rel="import" href="../kano-blockly/kano-blockly.html">
<link rel="import" href="../kano-style/kano-style.html">
<link rel="import" href="../kano-nav-header/kano-nav-header.html">
<link rel="import" href="../behaviors.html">

<dom-module id="kano-root-view">
    <style>
    :host {
        display: block;
        @apply(--layout-vertical);
        background-color: var(--color-grey-darker, grey);
    }
    :host .content {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        position: relative;
    }
    :host kano-blockly,
    :host kano-code-editor {
        @apply(--layout-flex);
    }
    </style>
    <template>
        <kano-nav-header id="navbar" title="[[title]]"></kano-nav-header>
        <div class="content">
            <kano-blockly id="code-editor"
                    toolbox="[[toolbox]]"
                    on-change="saveCode"></kano-blockly>
        </div>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer, KanoBehaviors, Blockly */

    class KanoRootView {

        get behaviors () {
            return [KanoBehaviors.AppEditorBehavior];
        }

        beforeRegister () {
            this.is = 'kano-root-view';
            this.properties = {
                parts: {
                    type: Array,
                    notify: true
                },
                toolbox: {
                    type: Array
                },
                defaultCategories: {
                    type: Object,
                    value: () => {
                        return {};
                    }
                },
                code: {
                    type: Object,
                    notify: true
                },
                title: {
                    type: String
                }
            };
            this.observers = [
                'computeToolbox(parts.*)',
                'computeBlocks(parts.*)',
                'computeTitle(selectedPage)'
            ];
        }
        ready () {
            this.$['code-editor'].resize();
            this.toolboxReady = false;
        }
        saveCode () {
            this.debounce('saveCode', () => {
                let codeEditor = this.$['code-editor'];

                codeEditor.save().then((snapshot) => {
                    snapshot.pseudo = snapshot.pseudo.trim().length ? snapshot.pseudo : '// Edit me to add code';
                    this.set('code.snapshot', snapshot);
                });
            }, 300);
        }
        computeBlocks () {
            this.parts
                .forEach((part) => {
                    part.blocks.forEach((definition) => {
                        let block = definition.block(part);
                        block.colour = part.colour;
                        block.id = `${part.id}#${block.id}`;
                        Blockly.Blocks[block.id] = {
                            init: function () {
                                this.jsonInit(block);
                            }
                        };
                        Blockly.JavaScript[block.id] = definition.javascript(part);
                        Blockly.Pseudo[block.id] = definition.pseudo(part);
                        return {
                            id: block.id,
                            colour: block.colour,
                            shadow: block.shadow
                        };
                    });
                });
        }
        computeToolbox () {
            this.debounce('computeToolbox', () => {
                let categories,
                    toolbox,
                    parts = this.parts,
                    events = this.defaultCategories.events,
                    blocks,
                    weight;
                if (!parts) {
                    return;
                }
                // Reset events blocks
                events.blocks = [];
                weight = {
                    'ui': 1,
                    'data': 2,
                    'hardware': 3
                };
                categories = parts
                    .map((ui) => {
                        blocks = ui.blocks.map((definition) => {
                            let block = definition.block(ui);
                            block.colour = ui.colour;
                            block.id = `${ui.id}#${block.id}`;
                            return {
                                id: block.id,
                                colour: block.colour,
                                shadow: block.shadow
                            };
                        });
                        ui.events.forEach((event) => {
                            let blockId = `${ui.id}#${event.id}`;
                            events.blocks.push({
                                id: blockId,
                                colour: events.colour
                            });
                        });
                        return {
                            name: ui.name,
                            colour: ui.colour,
                            weight: weight[ui.partType],
                            blocks
                        };
                    })
                    .sort((a, b) => {
                        return a.weight - b.weight;
                    });

                categories = categories || [];
                categories = categories.filter((category) => category.blocks.length);

                Object.keys(this.defaultCategories).forEach((id) => {
                    let cat = this.defaultCategories[id];
                    cat.blocks.forEach((block) => {
                        block.colour = cat.colour;
                    });
                });

                toolbox = Object.keys(this.defaultCategories).filter(id => id !== 'background').map(id => this.defaultCategories[id]);

                toolbox = toolbox
                    .concat({ type: 'separator' })
                    .concat(this.defaultCategories.background)
                    .concat(categories);
                this.set('toolbox', toolbox);
                if (!this.toolboxReady) {
                    this.async(() => {
                        this.$['code-editor'].load(this.code.snapshot);
                    });
                }
                this.toolboxReady = true;
            }, 500);
        }
        computeTitle () {
            let title;
            switch (this.selectedPage) {
                case 'code': {
                    title = 'Code';
                    break;
                }
                case 'default': {
                    title = 'Code';
                    break;
                }
            }
            this.set('title', title);
        }
    }
    Polymer(KanoRootView);
</script>
