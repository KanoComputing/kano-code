<link rel="import" href="../kano-drop-down/kano-drop-down.html">
<link rel="import" href="../kano-notifications/kano-notifications.html">
<link rel="import" href="../kano-user-avatar/kano-user-avatar.html">

<dom-module id='kano-header'>
    <style>
    :host {
        -webkit-font-smoothing: antialiased;
        font-smoothing: antialiased;
        font-size: 18px;
    }

    :host .page-width {
        max-width: 900px;
        margin: auto;
        padding: 0 20px;
        box-sizing: border-box;
        -webkit-box-sizing: border-box;
        height: 70px;
    }

    @media screen and (max-width: 600px) {
        :host .page-width {
            padding: 0 10px;
        }
    }

    :host nav {
        background: #fff;
        display: block;
        width: 100%;
        z-index: 999;
        position: fixed;
        top: 40px;
        left: 0;
        height: 70px;
        -webkit-box-shadow: 0 0 5px rgba(0,0,0,0.15);
        box-shadow: 0 0 5px rgba(0,0,0,0.15);
    }

    :host nav .logo {
        padding: 12px 5px 0 5px;
        margin-right: 10px;
        vertical-align: middle;
        display: inline-block;
        width: 12%;
    }

    :host nav .logo > a:before {
        background-image: url('../../assets/kano.svg');
        background-position: center center;
        background-repeat: no-repeat;
        width: 100px;
        height: 40px;
        display: inline-block;
        content: '';
        margin-bottom: 5px;
    }

    :host nav .nav-menu {
        display: inline-block;
        vertical-align: middle;
        width: 86%;
        height: 70px;
    }

    :host nav .nav-menu ul.nav-menu-items {
        float: left;
        list-style: none;
        margin-top: 0;
        margin-left: 0;
        margin-bottom: 0;
        padding-left: 0;
        height: 100%;
    }

    :host nav .nav-menu ul.nav-menu-items li {
        float: left;
        padding: 0px;
        height: 100%;
        display: inline-block;
        -webkit-tap-highlight-color: transparent;
        position: relative;
    }

    :host #nav-items li:not(.nav-menu-items--separator) {
        margin: 0 10px;
    }

    :host nav .nav-menu ul.nav-menu-items li:hover {
        border-bottom: 4px solid #66bed3;
    }

    :host nav .nav-menu ul.nav-menu-items li a {
        padding: 23px 5px 13px 5px;
        display: inline-block;
        margin: 0px 2px;
        font-size: 19px;
        font-weight: 700;
        text-decoration: none;
        color: #414042;
    }

    :host nav .nav-menu ul.nav-menu-items li:hover {
        cursor: pointer;
    }

    :host nav .nav-menu ul.nav-menu-items li kano-drop-down {
        display: none;
    }

    :host nav .nav-menu ul.nav-menu-items li.nav-menu-items__open {
        border-bottom: 4px solid #66bed3;
    }

    :host nav .nav-menu ul.nav-menu-items.nav-menu-user-items li.nav-menu-items__open {
        border: none;
    }

    :host nav .nav-menu ul.nav-menu-items.nav-menu-user-items li#notifications-menu {
        text-align: center;
    }

    :host nav .nav-menu ul.nav-menu-items li.nav-menu-items__open .icon-chevron-down2:before {
        content: '\e63e'
    }

    :host nav .nav-menu ul.nav-menu-items li .icon-chevron-down2 {
        vertical-align: middle;
        font-size: 15px;
    }

    :host nav .nav-menu ul.nav-menu-items li.nav-menu-items__open kano-drop-down,
    :host ::content nav .nav-menu ul.nav-menu-items li.nav-menu-items__open kano-notifications kano-drop-down,
    :host ::content nav .nav-menu ul.nav-menu-items li kano-notifications.nav-menu-items__open kano-drop-down,
    :host ::content nav .nav-menu ul.nav-menu-items li.nav-menu-items__open kano-user-avatar kano-drop-down {
        display: block;
    }

    :host nav .nav-menu ul.nav-menu-items li.nav-menu-items--separator {
        content: '\00a0';
        border-left: 3px solid #eee;
        pointer-events: none;
        padding: 20px 0px 10px 0px;
        width: auto;
        height: 30px;
        margin-top: 20px;
        margin-left: 20px;
        margin-right: 20px;
    }

    :host  ul.nav-menu-items.nav-menu-user-items {
        float: right !important;
    }

    :host .nav-menu ul.nav-menu-items.nav-menu-user-items li.menu-item {
        padding: 25px 0px 13px 5px;
    }

    @-webkit-keyframes slideInLeft {
        from {
            -webkit-transform: translate3d(-100%, 0, 0);
            transform: translate3d(-100%, 0, 0);
            visibility: visible;
        }

        to {
            -webkit-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);
        }
    }

    @keyframes slideInLeft {
        from {
            -webkit-transform: translate3d(-100%, 0, 0);
            transform: translate3d(-100%, 0, 0);
            visibility: visible;
        }

        to {
            -webkit-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);
        }
    }

    .slideInLeft {
        -webkit-animation-name: slideInLeft;
        animation-name: slideInLeft;
        -webkit-animation-duration: 0.5s;
        animation-duration: 0.5s;
        -webkit-animation-fill-mode: both;
        animation-fill-mode: both;
    }

    :host i {
        pointer-events: none;
    }

    :host nav .nav-menu ul.nav-menu-items.nav-menu-user-items li:hover {
        border: none;
    }

    :host ::content kano-notifications .kano-notifications .drop-down {
        width: 360px;
        right: 285px;
        top: 15px;
    }

    :host ::content kano-notifications img {
        pointer-events: none;
    }

    :host ::content kano-notifications kano-drop-down,
    :host ::content kano-user-avatar kano-drop-down {
        display: none;
    }

    :host ::content nav .nav-menu ul.nav-menu-items li.nav-menu-items__open kano-notifications img {
        pointer-events: none;
    }

    :host .nav-menu ul.nav-menu-items.nav-menu-user-items li.menu-item.menu-item-avatar {
        padding-top: 8px;
        padding-left: 10px;
    }

    :host nav .nav-menu ul.nav-menu-items.nav-menu-user-items li {
        width: 60px;
    }

    :host ::content kano-user-avatar kano-drop-down.kano-user-avatar .drop-down.kano-drop-down {
        margin-top: 6px;
        right: 130px;
        width: 200px;
    }

    :host .make-items ::content kano-drop-down .drop-down > a .notification-info {
        margin-left: 10px;
    }

    :host ::content kano-user-avatar > div {
        pointer-events: none;
    }

    :host ::content kano-notifications .notification-info {
        padding: 0 15px;
    }

    :host ::content kano-notifications kano-drop-down .drop-down.kano-drop-down a.kano-drop-down .drop-down-item.kano-drop-down {
        padding: 0;
    }

    :host ::content kano-notifications kano-drop-down .drop-down {
        margin-top: 13px;
    }

    :host .hamburger {
        display: none;
    }

    :host nav .nav-menu ul.nav-menu-items li.make-nav {
        width: 80px;
    }

    :host nav .nav-menu ul.nav-menu-items li.community-nav {
        width: 125px;
    }

    :host .blue-border {
        border-bottom: 4px solid #66bed3;
    }

    :host .make-nav ::content kano-drop-down .drop-down {
        padding: 15px 0;
    }

    :host .login-menu {
        padding: 23px 5px 15px 5px;
        display: inline-block;
        margin: 0px 2px;
        font-size: 19px;
        font-weight: 700;
        text-decoration: none;
        color: #414042;
        vertical-align: middle;
    }
    @media only screen and (min-width: 768px) and (max-width: 991px) {
        :host #nav-items {
            display: block;
        }
    }

    @media screen and (max-width: 768px) {
        :host {
            width: 100%;
        }

        :host nav {
            position: initial;
        }

        :host nav .page-width {
            height: auto;
        }

        :host nav .page-width {
            position: relative;
            padding: 0;
        }

        :host nav .logo {
            display: inline-block;
            padding: 15px 5px 0 0px;
        }

        :host nav .logo a {
            border: none;
        }

        :host nav .nav-menu {
            width: 100%;
            height: auto;
            padding: 0 30px;
        }

        :host nav .page-width .nav-menu ul.nav-menu-items {
            float: none;
        }

        :host nav .page-width .nav-menu ::content #nav-items > li a {
            padding: 15px 5px 15px 20px;
        }

        :host nav .nav-menu .nav-menu-items .menu-item {
            width: 100%;
            text-align: left;
        }

        :host nav .nav-menu .nav-menu-items .menu-item:hover {
            border-bottom: none;
        }

        :host nav .nav-menu .nav-menu-items .menu-item.nav-menu-items__open {
            border: none;
        }

        :host nav .nav-menu #nav-items {
            display: none;
        }

        :host nav .nav-menu #nav-items .mobile-nav {
            display: block;
        }

        :host nav .nav-menu #nav-items .menu-item.nav-menu-items__open ::content .drop-down {
            width: 100%;
            border-radius: 0;
            background: #eee;
            box-shadow: none;
            margin-top: 0;
            top: 0;
            padding: 5px 0;
        }

        :host nav .nav-menu ul#nav-items.nav-menu-items li.nav-menu-items--separator {
            border-bottom: 3px solid #eee;
            padding: 0px;
            width: 87%;
            height: 0px;
            margin: 10px;
            margin-left: 40px !important;
        }

        :host nav .page-width .nav-menu ul.nav-menu-user-items {
            position: absolute;
            top: 0;
            right: 20px;
        }

        :host .hamburger {
            display: inline-block;
            margin: 0 20px;
            vertical-align: middle;
            cursor: pointer;
            margin-top: 10px;
        }

        :host nav .nav-menu ul.nav-menu-items li {
            float: none;
        }

        :host nav .nav-menu ul.nav-menu-user-items li {
            float: left;
        }

        :host nav .page-width .nav-menu ul#nav-items.nav-menu-items li a {
            padding-left: 30px;
            border-left: 4px solid transparent;
        }

        :host ::content kano-user-avatar kano-drop-down.kano-user-avatar .drop-down.kano-drop-down {
            right: 145px;
        }

        :host nav .nav-menu ul.nav-menu-items li.make-nav, :host nav .nav-menu ul.nav-menu-items li.community-nav {
            width: 100%;
        }

        :host nav .nav-menu ul.nav-menu-items li.community-nav ::content kano-drop-down a {
            height: 40px;
        }

        :host nav .page-width .nav-menu ul#nav-items.nav-menu-items li a.left-indicator-bar {
            border-color: #66bed3;
        }

        :host nav .nav-menu {
            padding: 0;
            padding-bottom: 10px;
        }

        :host nav .nav-menu ul.nav-menu-items li a, :host #nav-items li {
            margin: 0;
        }

    }
    </style>
    <template>
        <nav id="navbar">
            <div class="page-width">
                <div class="hamburger slideInLeft" on-tap="showMenu">
                    <img src="../../assets/icons/hamburger.svg" alt="" />
                </div>
                <div class="logo">
                    <a href="/"></a>
                </div>
                <div class="nav-menu">
                    <ul id="nav-items" class="nav-menu-items">
                        <li class="menu-item make-items make-nav" on-tap="toggleOpen">
                            <a style="pointer-events: none;">Make</a>
                            <i class="icon-chevron-down2"></i>
                            <kano-drop-down items="{{makeItems}}"></kano-drop-down>
                        </li>
                        <li class="menu-item"><a href="{{URL}}/projects">Projects</a></li>
                        <li class="menu-item community-nav" on-tap="toggleOpen">
                            <a style="pointer-events: none;">Community</a>
                            <i class="icon-chevron-down2"></i>
                            <kano-drop-down items="{{communityItems}}"></kano-drop-down>
                        </li>
                        <li class="menu-item nav-menu-items--separator"></li>
                        <li class="menu-item nav-menu-items--products">
                            <a href='http://www.kano.me'>Products</a>
                        </li>
                    </ul>
                    <template is="dom-if" if="{{loggedIn}}">
                        <ul class="nav-menu-user-items nav-menu-items">
                            <li id="notifications-menu" class="menu-item" on-tap="toggleOpen">
                                <kano-notifications user="{{user}}" app="[[app]]"></kano-notifications>
                            </li>
                            <li id="avatar-menu" class="menu-item menu-item-avatar" on-tap="toggleOpen">
                                <kano-user-avatar user="{{user}}" app="[[app]]"></kano-user-avatar>
                            </li>
                        </ul>
                    </template>
                    <template is="dom-if" if="{{!loggedIn}}">
                        <ul class="nav-menu-user-items nav-menu-items">
                            <li class="menu-item login-menu" on-tap="login">
                                Log In
                            </li>
                        </ul>
                    </template>
                </div>
            </div>
        </nav>
        <paper-dialog id="auth-modal" class="auth-modal" modal>
            <kano-auth on-login="onLogin" id="auth"></kano-auth>
        </paper-dialog>
    </template>
    <script>
        class KanoHeader {
            beforeRegister () {
                this.is = 'kano-header'
                this.properties = {
                    dropdownVisible: {
                        type: Boolean,
                        value: false
                    },
                    user: {
                        type: Object
                    },
                    mobileNav: {
                        type: Boolean,
                        value: false
                    },
                    app: {
                        type: Object
                    },
                    loggedIn: {
                        type: Boolean,
                        value: false
                    },
                    loginVisible: {
                        type: Boolean,
                        value: false
                    }
                }
            }

            login () {
                this.set('selectedPage', 'login')
                this.$['auth-modal'].toggle();
                this.set('loginVisible', !this.loginVisible);

            }

            attached () {
                document.addEventListener('tap', (ev) => {
                    if (!ev.target.classList.contains('nav-menu-items__open') ||
                        !this.$$('#avatar-menu').classList.contains('nav-menu-items__open') &&
                        this.dropdownVisible) {
                        this.closeDropDown()
                    }
                })

                window.addEventListener('resize', (ev) => {

                    if (window.innerWidth > 768) {
                        this.$$('#nav-items').style.display = 'block';
                    }

                    if (window.innerWidth < 769) {
                        this.$$('#nav-items').style.display = 'none';
                        this.$$('#navbar').style.height = '70px';
                    }
                })

                this.app.sdk.auth.initSession((err, user) => {
                    if (user) {
                        this.set('user', user);
                        this.set('loggedIn', true);
                    }
                });
            }

            showMenu () {
                this.$$('#navbar').style.height = this.mobileNav ? '70px' : 'auto';
                this.$$('#nav-items').style.display = this.mobileNav ? 'none' : 'block';
                this.mobileNav = !this.mobileNav;
            }

            closeDropDown () {
                let elem = this.$$('.nav-menu-items__open');
                if (elem) {
                    elem.classList.remove('nav-menu-items__open');
                    this.dropdownVisible = false;
                }
            }

            toggleOpen (ev) {
                let wasOpened,
                    isUserAvatar,
                    isUserNotif,
                    elem;

                ev.stopPropagation();

                isUserAvatar = ev.target.localName === 'kano-user-avatar';
                isUserNotif = ev.target.localName === 'kano-notifications';

                elem = isUserAvatar
                    ? this.$$('#avatar-menu')
                    : (isUserNotif
                        ? this.$$('#notifications-menu')
                        : ev.target);

                wasOpened = elem.classList.contains('nav-menu-items__open')

                if (!ev.target.classList.contains('menu-item') && !(isUserAvatar || isUserNotif)) {
                    return;
                }

                if (this.dropdownVisible) {
                    this.closeDropDown();
                }

                if (!wasOpened) {
                    if (isUserAvatar || isUserNotif) {
                        elem.classList.add('nav-menu-items__open');
                    } else {
                        ev.target.classList.add('nav-menu-items__open')
                    }

                    this.dropdownVisible = true;
                }

            }

            ready () {
                this.URL = this.app.config.WORLD_URL;
                this.communityItems = [
                    {
                        name: 'Users',
                        url: this.URL + '/users'
                    },
                    {
                        name: "Creations",
                        url: this.URL + '/shares'
                    },
                    {
                        name: "Leaderboard",
                        url: this.URL + '/leaderboards'
                    },
                    {
                        name: "Forum",
                        url: this.URL + '/forum'
                    },
                    {
                        name: "Blog",
                        url: 'http://blog.kano.me'
                    },
                    {
                        name: "Help Center",
                        url: '//help.kano.me'
                    }
                ]

                this.makeItems = [
                    {
                        name: 'Make Apps',
                        url: '//apps.kano.me',
                        img: '/assets/navbar/make-apps.svg'
                    },
                    {
                        name: 'Make Art',
                        url: '//art.kano.me',
                        img: '../../assets/navbar/make-art.svg'
                    },
                    {
                        name: 'Make Adventures',
                        url: 'http://adventures.kano.me',
                        img: '../../assets/navbar/make-adventures.svg'
                    },
                    {
                        name: 'Kano OS Apps',
                        url: '//world.kano.me/apps',
                        img: '../../assets/navbar/osapps.svg'
                    }
                ]

                if (window.location.pathname === '/') {
                    this.$$('.logo a').classList.add('blue-border');
                }

                if (window.location.hostname === 'localhost') {
                    this.$$('.make-nav a').classList.add('left-indicator-bar');
                }
            }

            onLogin (e) {
                let data = e.detail;
                this.app.sdk.auth.setToken(data.token);
                this.user = data.user;
                this.loggedIn = !this.loggedIn;
                this.$['auth-modal'].close();
            }
        }
        Polymer(KanoHeader);
    </script>
</dom-module>
