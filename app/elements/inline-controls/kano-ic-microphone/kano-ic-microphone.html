<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../scripts/kano/make-apps/parts-api/microphone.html">
<dom-module id="kano-ic-microphone">
    <template>
        <style>
            :host {
                display: block;
                @apply --layout-horizontal;
                @apply --layout-end-justified;
                color: white;
            }
            .visuals {
                @apply --layout-wrap;
                @apply --layout-horizontal;
                border-right: 1px solid #202428;
                border-left: 1px solid #202428;
            }
            .data {
                @apply --layout-horizontal;
                @apply --layout-center;
                @apply --layout-center-justified;
                width: 32px;
                border-right: 1px solid #202428;
            }
            canvas {
                width: 200px;
                height: 32px;
            }
        </style>
        <div class="visuals" id="visuals">
            <canvas id="canvas" width="200" height="32"></canvas>
        </div>
        <div class="data">
            <span>[[value]]</span>
        </div>
    </template>
    <script>
        Polymer({
            is:'kano-ic-microphone',
            behaviors: [Kano.MakeApps.PartsAPI.microphone],
            properties: {
                model: Object
            },
            attached () {
                this.ctx = this.$.canvas.getContext('2d');
                this.values = [];
                this._update();
                this._render();
            },
            _update () {
                this._updateInterval = setInterval(() => {
                    this.values.push(this.model.volume);
                    if (this.values.length > 30) {
                        this.values.shift();
                    }
                    this.set('value', Math.round(this.model.volume));
                }, 100);
            },
            _render () {
                let step = this.$.canvas.width / 30,
                    height = 32,
                    spacing = 2,
                    barHeight;
                this.ctx.clearRect(0, 0, this.$.canvas.width, this.$.canvas.height);
                this.ctx.save();
                this.ctx.translate(0.5, 0.5);
                this.ctx.fillStyle = '#8F9195';
                for (let i = 0; i < this.values.length; i++) {
                    barHeight = this.values[i] / 100 * height;
                    this._fillRoundedRect(this.ctx, i * step - spacing, height / 2 - barHeight / 2, step - spacing * 2, barHeight, 1);
                }
                this.ctx.restore();

                this._nextFrameId = requestAnimationFrame(this._render.bind(this));
            },
            _fillRoundedRect (ctx, x, y, width, height, radius) {
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.lineTo(x + width - radius, y);
                ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
                ctx.lineTo(x + width, y + height - radius);
                ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                ctx.lineTo(x + radius, y + height);
                ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
                ctx.lineTo(x, y + radius);
                ctx.quadraticCurveTo(x, y, x + radius, y);
                ctx.closePath();
                ctx.fill();
            },
            _detached () {
                clearInterval(this._updateInterval);
                cancelAnimationFrame(this._nextFrameId);
            }
        });
    </script>
</dom-module>