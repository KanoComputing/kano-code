<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/prism-element/prism-highlighter.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="./kano-prism-theme.html">

<dom-module id="kano-code-view">
	<template>
		<style include="kano-prism-theme">
			:host {
				box-sizing: border-box;
				padding: 8px;
				@apply --layout-horizontal;
			}
			:host pre {
				color: #fff;
				white-space: pre-wrap;
				padding: 0;
				margin: 0 0 0 10px;
				font-size: 14px;
				line-height: 20px;
				counter-reset: line;
			}
			:host .line-number-container {
				color: #fff;
				opacity: 0.1;
				margin-right: 8px;
				@apply --layout-vertical;
			}
			:host .line-number {
				height: 20px;
				counter-increment: line;
			}
			:host .line-number:before {
				line-height: 20px;
				font-family: var(--font-body);
				font-size: 14px;
				content: counter(line);
			}
		</style>
		<prism-highlighter></prism-highlighter>
		<div class="line-number-container">
			<template id="dodge" is="dom-repeat" items="[[lines]]">
				<span class="line-number"></span>
			</template>
		</div>
		<div class="code-display">
			<pre id="output"></pre>	
		</div>
	</template>

	<script>
		/* globals Polymer, Kano */
		const CODE_VIEW_LINE_HEIGHT = 20;
		Polymer({
		    is: 'kano-code-view',
		    behaviors: [Polymer.IronResizableBehavior],
		    properties: {
				code: {
					type: String,
					observer: '_render'
				},
				lang: {
					type: String
				},
				lines: {
					type: Array,
					value: () => []
				}
			},
			listeners: {
				'iron-resize': '_computeLineNumbers'
			},
			_render (code) {
				if (!code) {
					return;
				}
				this.$.output.innerHTML = this._highlight(this.code, this.lang);
				this._refreshLineNumbers();
			},
			_highlight (code, lang) {
				//prism-highlighter adds an event listener to its parent (i.e. kano-code-view) for 'syntax-highlight'
				return this.fire('syntax-highlight', { code: code, lang: lang }).detail.code;
			},
			_computeLineNumbers () {
			    let codeSpaceHeight = this.$.output.scrollHeight,
			    	lines = Math.round(codeSpaceHeight / CODE_VIEW_LINE_HEIGHT);
			    this.set('lines', new Array(lines));
			}
		});
	</script>
</dom-module>
