<dom-module id="kano-workspace">
    <style>
    :host {
        position: relative;
        @apply(--layout-vertical);
        background-color: var(--color-white);
        border: 0px;
        transition: box-shadow linear 100ms;
        box-shadow: 0px 0px 0px 4px transparent inset;
        overflow: hidden;
    }
    :host.pulsing {
        box-shadow: 0px 0px 0px 4px var(--primary-color) inset;
    }
    :host .content {
        position: relative;
        @apply(--layout-flex);
        background-color: transparent;
        height: 100%;
        background-size: 50px 50px;
        overflow: auto;
    }
    :host .content.running {
        border: 3px solid var(--color-red);
    }
    :host kano-ui {
        position: absolute;
        top: 0px;
        left: 0px;
    }
    :host .trash {
        position: absolute;
        right: -150px;
        bottom: -150px;
        width: 300px;
        height: 300px;
        transition: all 100ms ease-out;
        background: radial-gradient(rgba(255, 255, 255, 0.3), transparent);
        border-radius: 50%;
    }
    :host .trash.open {
        width: 500px;
        height: 500px;
        right: -250px;
        bottom: -250px;
    }
    :host .drawer-content {
        @apply(--layout-vertical);
        background-color: var(--color-grey-lighter);
        padding: 15px;
    }
    :host .drawer-content kano-ui-customizer {
        @apply(--layout-flex);
    }
    </style>
    <template>
        <div class="content" id="content" on-tap="resetSelectedUiElement">
            <template is="dom-repeat" items="{{uiElements}}" as="model">
                <kano-ui model="{{model}}"
                        running="[[running]]"
                        style$="{{computePositionStyle(model)}}"
                        selected="[[isSelected(index, selectedUiIndex)]]"
                        on-tap="selectUiElement"></kano-ui>
            </template>
        </div>
        <div class="trash"
                id="trash"
                on-mouseenter="trashEnter"
                on-mouseleave="trashLeave"></div>
        <kano-drawer position="right"
                    overlapse="30"
                    opened="{{isCustomizationOpened(selectedUiIndex, running)}}">
            <div class="drawer-content">
                <label>Style</label>
                <kano-ui-customizer
                    customizable="{{getStyleConfig(selected.customizable.style)}}"
                    user-values="{{selected.userStyle}}">
                </kano-ui-customizer>
                <label>Properties</label>
                <kano-ui-customizer
                    customizable="{{selected.customizable.properties}}"
                    user-values="{{selected.userProperties}}">
                </kano-ui-customizer>
            </div>
        </kano-drawer>
    </template>
</dom-module>

<script type="text/javascript">
    const STYLE_CONF = {
        'background-color': {
            key: 'background-color',
            type: 'color',
            label: 'Background color'
        },
        'width': {
            key: 'width',
            type: 'size',
            label: 'Width'
        },
        'height': {
            key: 'height',
            type: 'size',
            label: 'Height'
        }
    };
    class KanoWorkspace {
        beforeRegister () {
            this.is = 'kano-workspace';
            this.properties = {
                uiElements: {
                    type: Array,
                    notify: true
                },
                running: {
                    type: Boolean,
                    value: false
                },
                pulsing: {
                    type: Boolean,
                    value: false,
                    observer: 'pulsingChanged'
                },
                selectedUiIndex: {
                    type: Number,
                    value: null
                },
                selected: {
                    type: Object,
                    notify: true,
                    computed: 'computeSelected(selectedUiIndex)'
                }
            };
            this.observers = [
                'userValuesChanged(selected.*)'
            ];
        }
        attached () {
            this.uiElements = [];
        }
        addUi (model, position) {
            let rect = this.getBoundingClientRect(),
                el;
            position.x = position.x - rect.left;
            position.y = position.y - rect.top;
            model.position = position;

            this.push('uiElements', model);
        }
        computePositionStyle (model) {
            return `position: absolute;
                    left: ${model.position.x}px;
                    top: ${model.position.y}px;`;
        }
        removeUi (id) {
            for (let i in this.uiElements) {
                if (this.uiElements[i].id === id) {
                    this.splice('uiElements', i, 1);
                }
            }
        }
        pulsingChanged () {
            this.toggleClass('pulsing', this.pulsing);
        }
        getTrashElement () {
            return this.$.trash;
        }
        trashEnter () {
            this.toggleClass('open', true, this.$.trash);
        }
        trashLeave () {
            this.toggleClass('open', false, this.$.trash);
        }
        isSelected (index, selectedIndex) {
            return !this.running && index === selectedIndex;
        }
        selectUiElement (e) {
            e.stopPropagation();
            if (!this.running) {
                this.set('selectedUiIndex', e.model.get('index'));
            }
        }
        resetSelectedUiElement (e) {
            if (e.target.getAttribute('id') === 'content') {
                this.set('selectedUiIndex', null);
            }
        }
        computeSelected () {
            if (!this.uiElements) {
                return;
            }
            this.fire('selected', this.uiElements[this.selectedUiIndex]);
            return this.uiElements[this.selectedUiIndex];
        }
        isCustomizationOpened () {
            return !this.running && !(this.selectedUiIndex === null);
        }
        getStyleConfig (keys) {
            keys = keys || [];
            return keys.map((key) => {
                return STYLE_CONF[key];
            });
        }
        userValuesChanged (e) {
            if (e.path.indexOf('userStyle') === -1
                && e.path.indexOf('userProperties') === -1) {
                return;
            }
            let path = e.path.replace('selected.',
                        `uiElements.${this.selectedUiIndex}.`);
            this.set(path, e.value);
        }
    }
    Polymer(KanoWorkspace);
</script>
