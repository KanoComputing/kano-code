<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../behaviors/kano-app-editor-behavior.html">
<link rel="import" href="../behaviors/kano-app-element-registry-behavior.html">
<link rel="import" href="../behaviors/kano-sound-player-behavior.html">
<link rel="import" href="../behaviors/kano-cover-generator-behavior.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../kano-workspace-normal/kano-workspace-normal.html">
<link rel="import" href="../kano-workspace-lightboard/kano-workspace-lightboard.html">
<link rel="import" href="../kano-workspace-camera/kano-workspace-camera.html">
<link rel="import" href="../kano-workspace-toolbar/kano-workspace-toolbar.html">
<link rel="import" href="../kano-workspace-head/kano-workspace-head.html">
<link rel="import" href="../ui/kano-ui/kano-ui.html">

<dom-module id="kano-workspace">
    <style>
    :host {
        position: relative;
        @apply(--layout-vertical);
        border: 0px;
        overflow: hidden;
    }
    :host #content {
        position: relative;
        @apply(--layout-flex);
        transition: background linear 150ms;
    }
    :host.running #content {
        --kano-ui-viewport: {
            border: none;
        };
    }
    :host(.fullscreen) #content {
        position: fixed;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
        z-index: 100;
        background-color: rgba(0, 0, 0, 0.8);
    }
    :host ::slotted(#dropzone) {
        margin: auto;
        position: relative;
    }
    #workspace-placeholder {
        height: 100%;
    }
    :host kano-workspace-head {
        position: absolute;
        right: 10px;
        top: 10px;
    }
    :host .fullscreen-close {
        position: fixed;
        top: 0px;
        right: 0px;
        color: white;
        background-color: transparent;
        z-index: 101;
        border: none;
        width: 56px;
        height: 56px;
        font-size: 50px;
        outline: none;
        cursor: pointer;
    }
    :host .fullscreen-close div {
        transition: all 0.3s ease;
        transform: translate(0, -7px);
    }
    :host .fullscreen-close div:hover {
        transform: translate(0, -9px);
        color: #eaeaea;
    }
    :host kano-workspace-lightboard {
        margin-top: -35px;
    }
    :host(.fullscreen) kano-workspace-lightboard {
        margin-top: 0;
    }
    .pause-overlay {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-center-justified);
    }
    .pause-overlay iron-image {
        width: 40%;
        height: 40%;
        cursor: pointer;
    }
    .editable-layout {
        opacity: 0.5;
        pointer-events: none;
    }
    *[hidden] {
        display: none !important;
    }
    </style>
    <template>
        <button class="fullscreen-close" hidden$="[[!fullscreen]]" on-tap="_toggleFullscreen">
            <div>&times;</div>
        </button>
        <kano-ui-viewport mode="scaled"
                    view-width="[[mode.workspace.viewport.width]]"
                    view-height="[[mode.workspace.viewport.height]]"
                    id="content"
                    on-tap="onTap">
            <!-- The variable workspace component will be inserted here -->
            <div id="workspace-placeholder">

            </div>
            <div class="pause-overlay" hidden$="[[_isPauseOverlayHidden(running, editableLayout)]]">
                <iron-image src="/assets/icons/play-btn-overlay.svg" sizing="contain" on-tap="_runButtonClicked"></iron-image>
            </div>
            <kano-workspace-toolbar
                id="toolbar"
                show-mouse-position="{{showMousePosition}}"
                mouse-x="[[mouseX]]"
                mouse-y="[[mouseY]]"
                running="[[running]]"
                editable-layout="[[editableLayout]]"
                parts-menu-open="[[partsMenuOpen]]"
                on-pause-run-button-clicked="_runButtonClicked"
                on-fullscreen-button-clicked="_toggleFullscreen"
                on-reset-button-clicked="_resetAppState"
                on-edit-layout-button-clicked="_editLayoutClicked" 
                no-player-bar="[[simpleMode]]"
                no-part-controls="[[simpleMode]]"></kano-workspace-toolbar>
        </kano-ui-viewport>
        <kano-workspace-head challenge-state="[[challengeState]]"
        no-save="[[simpleMode]]"
        no-settings="[[simpleMode]]"></kano-workspace-head>
        <array-selector id="selector" items="{{parts}}" selected="{{selected}}"></array-selector>
        <iron-a11y-keys keys="alt+shift+f" on-keys-pressed="_toggleFullscreen" target="[[target]]"></iron-a11y-keys>
        <iron-a11y-keys keys="alt+t" on-keys-pressed="_onAltT" target="[[target]]"></iron-a11y-keys>
        <iron-a11y-keys keys="esc" on-keys-pressed="_cancel" target="[[target]]"></iron-a11y-keys>
        <iron-a11y-keys keys="tab" on-keys-pressed="_selectNextPart" target="[[target]]"></iron-a11y-keys>
        <iron-a11y-keys keys="shift+tab" on-keys-pressed="_selectPrevPart" target="[[target]]"></iron-a11y-keys>
        <iron-a11y-keys keys="shift+left left" on-keys-pressed="_moveLeft" target="[[target]]"></iron-a11y-keys>
        <iron-a11y-keys keys="shift+right right" on-keys-pressed="_moveRight" target="[[target]]"></iron-a11y-keys>
        <iron-a11y-keys keys="shift+up up" on-keys-pressed="_moveUp" target="[[target]]"></iron-a11y-keys>
        <iron-a11y-keys keys="shift+down down" on-keys-pressed="_moveDown" target="[[target]]"></iron-a11y-keys>

    </template>
</dom-module>

<script type="text/javascript">
    /* globals Polymer, Kano */
    Polymer({
        is: 'kano-workspace',
        behaviors: [
            Kano.Behaviors.AppEditorBehavior,
            Kano.Behaviors.CoverGeneratorBehavior,
            Kano.Behaviors.SoundPlayerBehavior,
            Kano.Behaviors.AppElementRegistryBehavior
        ],
        properties: {
            parts: {
                type: Array,
                notify: true
            },
            running: {
                type: Boolean,
                value: false,
                observer: 'runningChanged',
                notify: true
            },
            editableLayout: {
                type: Boolean,
                value: false,
                notify: true
            },
            selected: {
                type: Object,
                observer: '_selectedChanged',
                notify: true
            },
            internalSelection: {
                type: Object,
                value: null
            },
            code: {
                type: Object
            },
            mode: {
                type: Object,
                observer: '_modeChanged'
            },
            background: {
                type: String
            },
            partsMenuOpen: {
                type: Boolean
            },
            challengeState: {
                type: Object
            },
            simpleMode: {
                type: Boolean,
                computed: 'isModeSimple(mode)'
            }
        },
        observers: [
            'partsChanged(parts.*)',
            'backgroundChanged(background)',
            'viewportDimensionsChanged(mode.workspace.viewport.*)'
        ],
        listeners: {
            'part-tapped': 'onPartTapped'
        },
        isModeSimple (mode) {
            return mode.id === "simple";
        },
        ready () {
            this.elements = {};
            this.tappedElement = null;
            this.dropzone = null;

            this.pixels = {
                0: '#ff0000',
                1: '#00ff00',
                2: '#0000ff'
            };
            this.devices = {};
            this.devices.get = this._getPartById.bind(this);

            this.showMousePosition = false;
            this.mouseX = 250;
            this.mouseY = 250;

            this.fullscreen = false;
        },
        attached () {
            this.target = document.body;
            // Enable pop on drop part only after initialisation
            this.async(() => {
                this.soundReady = true;
            }, 500);
        },
        _editLayoutClicked () {
            this.toggleEditableLayout();
        },
        _onAltT () {
            this.toggleEditableLayout();
        },
        _toggleFullscreen () {
            this.toggleClass('fullscreen');
            this.$.content.resizeView();
            this.fullscreen = !this.fullscreen;
        },
        _isPauseOverlayHidden (running, editableLayout) {
            return running || editableLayout;
        },
        _moveLeft (e) {
            this._movePart('left', e.detail.keyboardEvent.shiftKey);
        },
        _moveRight (e) {
            this._movePart('right', e.detail.keyboardEvent.shiftKey);
        },
        _moveUp (e) {
            this._movePart('up', e.detail.keyboardEvent.shiftKey);
        },
        _moveDown (e) {
            this._movePart('down', e.detail.keyboardEvent.shiftKey);
        },
        _movePart (dir, shift) {
            let movement, axis, partElem, x, y;
            if (!this.selected || !this.dropzone) {
                return;
            }
            movement = (dir === 'right' || dir === 'down') ? 1 : -1;
            if (shift) {
                movement *= 10;
            }
            x = (dir === 'right' || dir === 'left') ? movement : 0;
            y = (dir === 'up' || dir === 'down') ? movement : 0;
            partElem = this.dropzone.querySelector(`#${this.selected.id}`);
            partElem.move(x, y);
        },
        _cancel () {
            this.toggleEditableLayout(false);
        },
        _selectNextPart (e) {
            if (this.editableLayout) {
                let selectedIndex = this.parts.indexOf(this.selected),
                    nextPartIndex;
                if (this.parts.length) {
                    nextPartIndex = selectedIndex + 1;
                    if (nextPartIndex >= this.parts.length) {
                        nextPartIndex = 0;
                    }
                    this.clearSelection();
                    this.$.selector.select(this.parts[nextPartIndex]);
                }
                e.detail.keyboardEvent.preventDefault();
                e.detail.keyboardEvent.stopPropagation();
            }
        },
        _selectPrevPart (e) {
            if (this.editableLayout) {
                let selectedIndex = this.parts.indexOf(this.selected),
                    prevPartIndex;
                if (this.parts.length) {
                    if (selectedIndex <= -1) {
                        selectedIndex = this.parts.length;
                    }
                    prevPartIndex = selectedIndex - 1;
                    this.clearSelection();
                    this.$.selector.select(this.parts[prevPartIndex]);
                }
                e.detail.keyboardEvent.preventDefault();
                e.detail.keyboardEvent.stopPropagation();
            }
        },
        toggleEditableLayout (value) {
            this.set('editableLayout', typeof value !== 'boolean' ? !this.editableLayout : value);
            if (this.editableLayout) {
                this.prevRunningState = this.running;
                this.set('running', false);
                this.fire('open-settings');
            } else {
                this.set('running', this.prevRunningState);
                this.fire('close-settings');
            }
        },
        _getPartById (id) {
            if (id === this.dropzone.getAttribute('id') || id === 'dropzone') {
                return this.dropzone;
            }
            return this.dropzone.querySelector(`#${id}`);
        },
        backgroundChanged (bg) {
            if (this.dropzone && this.dropzone.setBackgroundColor) {
                this.dropzone.setBackgroundColor(bg);
            }
        },
        _modeChanged (mode) {
            let oldDropzone = this.dropzone,
                placeholder = this.$$('#workspace-placeholder'),
                newDropzone;

            if (mode && mode.workspace.component) {
                newDropzone = document.createElement(mode.workspace.component);
            } else {
                newDropzone = document.createElement('kano-workspace-normal');
            }

            newDropzone.setAttribute('id', this.mode.id);
            newDropzone.setAttribute('class', 'dropzone');
            newDropzone.setAttribute('width', this.mode.workspace.viewport.width);
            newDropzone.setAttribute('height', this.mode.workspace.viewport.height);

            newDropzone.addEventListener('mouse-position-x-changed', this.mouseXChanged.bind(this));
            newDropzone.addEventListener('mouse-position-y-changed', this.mouseYChanged.bind(this));
            this.showMousePosition = mode.id === 'normal';

            if (newDropzone.setBackgroundColor) {
                newDropzone.setBackgroundColor(this.background);
            }

            /* Remove old dropzone and add new one */
            if (oldDropzone) {
                placeholder.removeChild(oldDropzone);
            }
            placeholder.appendChild(newDropzone);

            /* Update dropzone reference */
            this.dropzone = newDropzone;

            this.parts.forEach((model, index) => {
                this.insertPart(`#${index}`);
            });

        },
        viewportDimensionsChanged () {
            this.dropzone.setAttribute('width', this.mode.workspace.viewport.width);
            this.dropzone.setAttribute('height', this.mode.workspace.viewport.height);
            this.$.content.resizeView();
        },
        mouseXChanged (e) {
            this.mouseX = e.detail.value;
        },
        mouseYChanged (e) {
            this.mouseY = e.detail.value;
        },
        onTap (e) {
            let target;
            if (this.running) {
                return;
            }
            target = e.target;
            if (target === this.dropzone) {
                this.clearSelection();
            } else if (target === this.$.content) {
                this.clearSelection();
                this.fire('close-settings');
            }
        },
        clearSelection () {
            if (this.dropzone) {
                let selectedPartElement = this.dropzone.querySelector('.selected');
                this.toggleClass('selected', false, selectedPartElement);
            }
            this.$.selector.clearSelection();
        },
        partFromElement () {
            let model = this.tappedElement.model;
            for (let i = 0; i <= this.parts.length; i++) {
                let part = this.parts[i];
                if (model.id === part.id) {
                    return part;
                }
            }
        },
        onPartTapped (e) {
            if (!this.editableLayout) {
                return;
            }
            this.clearSelection();
            this.$.selector.select(e.detail.model);
        },
        _selectedChanged (part) {
            let partElement;
            if (!this.dropzone || !part) {
                return;
            }
            partElement = this.dropzone.querySelector(`#${part.id}`);
            this.toggleClass('selected', true, partElement);
            this.fire('open-settings');
        },
        partsChanged (e) {
            let path;
            if (!e) {
                return;
            }
            path = e.path;
            if (path === 'parts.splices') {
                let keySplices = e.value.keySplices,
                    indexSplices = e.value.indexSplices;
                if (keySplices) {
                    keySplices.forEach((splice) => {
                        splice.added.forEach(this.insertPart.bind(this));
                        splice.removed.forEach(this.removePart.bind(this));
                    });
                } else {
                    if (indexSplices) {
                        indexSplices.forEach((idxSplice)=> {
                            for (let  i = 0; i < idxSplice.addedCount; i++) {
                                this.insertPart.bind(this)(`#${idxSplice.index + i}`);
                            }
                        });
                    }
                }

            } else if (path === 'parts') {
                if (this.elements) {
                    // Clean the dropzone
                    Object.keys(this.elements).forEach(this.removePart.bind(this));
                }
                if (!this.parts) {
                    return;
                }
                // Insert the elements from the models
                this.parts.forEach((model, index) => {
                    this.insertPart(`#${index}`);
                });
            } else if (path === 'parts.length') {
                return;
            } else {
                let pieces = path.split('.'),
                    key = pieces[1],
                    subPath;
                if (!key) {
                    return;
                }
                subPath = pieces.slice(2, pieces.length);
                subPath.unshift('model');
                subPath = subPath.join('.');
                this.propagateChange(key, subPath, e.value);
            }
        },
        propagateChange (key, path, value) {
            let element = this.elements[key];
            if (!element) {
                return;
            }
            element.set(path, value);
        },
        insertPart (key) {
            let model = this.get(`parts.${key}`),
                tagName,
                element;
            tagName = model.tagName;
            element = document.createElement(tagName);
            element.setAttribute('id', model.id);
            element.addEventListener('model-changed', (e) => {
                let detail = e.detail,
                    path;
                if (!detail.path) {
                    path = `parts.${key}`;
                } else {
                    path = detail.path.replace('model', `parts.${key}`);
                }
                this.set(path, detail.value);
            });
            element.model = model;
            this.elements[key] = element;
            this.dropzone.appendChild(element);
            if (this.soundReady) {
                this.playSound('/assets/audio/sounds/pop.wav');
            }
            this._registerElement(`workspace-part-${model.id}`, element);
        },
        removePart (key) {
            let element = this.elements[key];
            if (!element) {
                return;
            }
            this.dropzone.removeChild(element);
            delete this.elements[key];
        },
        getPartsDict () {
            let dict = Object.keys(this.elements).reduce((acc, key) => {
                // Get the model linked to the element
                let model = this.get(`parts.${key}`);
                acc[model.id] = this.elements[key];
                return acc;
            }, {});
            dict[this.mode.id] = this.dropzone;
            // Support legacy apps
            dict['dropzone'] = this.dropzone;
            return dict;
        },
        runningChanged () {
            if (this.running) {
                this.classList.add('running');
                this.clearSelection();
            } else {
                this.classList.remove('running');
            }
        },
        getPartIndexById (id) {
            let elements = this.parts;
            for (let i = 0, len = elements.length; i < len; i++) {
                if (elements[i].id === id) {
                    return i;
                }
            }
        },
        getViewport () {
            return this.dropzone;
        },
        getViewportScale () {
            return this.$.content.getScale();
        },
        generateCover () {
            return Kano.Behaviors.CoverGeneratorBehavior.generateCover(
                this.dropzone,
                this.parts,
                this.mode.workspace.viewport.width,
                this.mode.workspace.viewport.height
            )
        },
        reset () {
            if (this.dropzone) {
                this.dropzone.clear();
            }
        },
        _runButtonClicked () {
            this.fire('run-button-clicked');
        },
        _resetAppState () {
            this.fire('reset-app-state');
        }
    });
</script>
