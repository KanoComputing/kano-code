<dom-module id="kano-workspace">
    <style>
    :host {
        position: relative;
        @apply(--layout-vertical);
        background-color: var(--color-grey, grey);
        border: 0px;
        transition: box-shadow linear 100ms;
        box-shadow: 0px 0px 0px 4px transparent inset;
        overflow: hidden;
    }
    :host.pulsing {
        box-shadow: 0px 0px 0px 4px var(--primary-color) inset;
    }
    :host .content {
        position: relative;
        overflow: auto;
        @apply(--layout-flex);
        --kano-ui-viewport: {
            background-color: white;
        };
    }
    :host .content.running {
        border: 3px solid var(--color-red);
    }
    :host kano-ui {
        position: absolute;
        top: 0px;
        left: 0px;
    }
    </style>
    <template>
        <kano-ui-viewport mode="scaled"
                    view-width="[[size.width]]"
                    view-height="[[size.height]]"
                    class="content"
                    id="content">
            <template is="dom-repeat" items="{{uiElements}}" as="model">
                <kano-ui model="{{model}}"
                        running="[[running]]"
                        style$="{{computePositionStyle(model)}}"></kano-ui>
            </template>
        </kano-ui-viewport>
    </template>
</dom-module>

<script type="text/javascript">
    const STYLE_CONF = {
        'background-color': {
            key: 'background-color',
            type: 'color',
            label: 'Background color'
        },
        'width': {
            key: 'width',
            type: 'size',
            label: 'Width'
        },
        'height': {
            key: 'height',
            type: 'size',
            label: 'Height'
        },
        'color': {
            key: 'color',
            type: 'color',
            label: 'Text Color'
        },
        'font-size': {
            key: 'font-size',
            type: 'size',
            label: 'Font size'
        }
    };
    class KanoWorkspace {
        beforeRegister () {
            this.is = 'kano-workspace';
            this.properties = {
                size: {
                    type: Object
                },
                uiElements: {
                    type: Array,
                    notify: true,
                    value: () => []
                },
                running: {
                    type: Boolean,
                    value: false
                },
                pulsing: {
                    type: Boolean,
                    value: false,
                    observer: 'pulsingChanged'
                },
                selected: {
                    type: Object
                }
            };
            this.observers = [
                'selectedChanged(selected.*)'
            ];
            this.listeners = {
                'mouseenter': 'onMouseEnter',
                'mouseleave': 'onMouseLeave'
            };
        }
        attached () {
            window.addEventListener('keyup', this.onKeyUp.bind(this));
        }
        detached () {
            window.removeEventListener('keyup', this.onKeyUp.bind(this));
        }
        onMouseEnter () {
            this.focused = true;
        }
        selectedChanged (e) {
            let index,
                path;
            if (!this.selected) {
                return;
            }
            index = this.getPartIndexById(this.selected.id);
            path = e.path.replace('selected', `uiElements.${index}`);
            this.set(path, e.value);
        }
        getPartIndexById (id) {
            let elements = this.uiElements;
            for (let i = 0, len = elements.length; i < len; i++) {
                if (elements[i].id === id) {
                    return i;
                }
            }
        }
        loadBatch (models) {
            models.forEach((model) => {
                this.push('uiElements', model);
            });
        }
        computePositionStyle (model) {
            if (!model.position) {
                model.position = {
                    x: this.size.width / 2,
                    y: this.size.height / 2
                };
            }
            return `position: absolute;
                    left: ${model.position.x}px;
                    top: ${model.position.y}px;`;
        }
        removeUi (id) {
            for (let i in this.uiElements) {
                if (this.uiElements[i].id === id) {
                    this.splice('uiElements', i, 1);
                    // i here will be a string since we use for in
                    if (this.selectedUiIndex == i) {
                        this.set('selectedUiIndex', null);
                    }
                }
            }
        }
        pulsingChanged () {
            this.toggleClass('pulsing', this.pulsing);
        }
        getTrashElement () {
            return this.$.trash;
        }
        trashEnter () {
            this.toggleClass('open', true, this.$.trash);
        }
        trashLeave () {
            this.toggleClass('open', false, this.$.trash);
        }
        getRect () {
            return this.$.content.getRect();
        }
    }
    Polymer(KanoWorkspace);
</script>
