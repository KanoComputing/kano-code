<dom-module id="kano-view">
    <style>
    :host {
        display: block;
        @apply(--layout-vertical);
    }
    </style>
    <template>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer */
    class KanoView {
        beforeRegister () {
            this.is = 'kano-view';
            this.properties = {
                viewName: {
                    type: String
                },
                location: {
                    type: String,
                    value: 'views'
                },
                attributes: {
                    type: Object,
                    value: () => {
                        return {};
                    },
                    notify: true
                },
                flexEnabled: {
                    type: Boolean,
                    value: true
                },
                ready: {
                    type: Boolean,
                    value: false,
                    notify: true
                }
            };
            this.observers = [
                'viewChanged(viewName)',
                'attributesChanged(attributes.*)'
            ];
        }
        getComponent () {
            return this.viewComponent;
        }
        /**
         * Apply the attributes to the loaded component
         */
        attributesChanged (e) {
            let path;
            if (!this.viewComponent) {
                return;
            }
            path = e.path.split('.');
            path.shift();
            if (!path.length) {
                return;
            }
            path = path.join('.');
            this.viewComponent.set(path, e.value);
        }
        viewChanged () {
            if ((this.viewName && !this.viewName.length) || !this.location) {
                return;
            }
            this.loadView(this.viewName)
                .then(this.displayView.bind(this))
                .catch((e) => {
                    this.fire('kano-error', new Error(`Could not load view ${this.viewName}`));
                });
            this.set('ready', false);
        }
        reloadView () {
            this.viewChanged();
        }
        displayView () {
            let view = this.create(this.viewName, this.attributes);
            this.mountComponent(view);
        }
        mountComponent (component) {
            component.style.flex = this.flexEnabled ? 1 : 'none';

            while (this.firstChild) {
                this.removeChild(this.firstChild);
            }
            this.appendChild(component);
            this.viewComponent = component;
            this.set('ready', true);
        }
        /**
         * Import the view component
         * @param  {String} partial   Name of the component to import
         * @return {Promise}          Will resolve when the element is loaded
         */
        loadView (partial) {
            return new Promise((resolve, reject) => {
                this.importHref(`./${this.location}/${partial}/${partial}.html`, resolve, reject);
            });
        }
        end () {
            if (this.viewComponent && typeof this.viewComponent.end == 'function') {
                return this.viewComponent.end();
            }
            return Promise.resolve();
        }
    }
    Polymer(KanoView);
</script>
