<dom-module id="kano-view">
    <template>
        <style>
            :host {
                display: block;
                @apply(--layout-vertical);
            }
        </style>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer */

    Polymer({
        is: 'kano-view',
        properties: {
            viewName: {
                type: String
            },
            location: {
                type: String,
                value: 'views'
            },
            attributes: {
                type: Object,
                value: () => {
                    return {};
                },
                notify: true
            },
            flexEnabled: {
                type: Boolean,
                value: true
            },
            ready: {
                type: Boolean,
                value: false,
                notify: true
            }
        },
        observers: [
            'viewChanged(viewName)',
            'attributesChanged(attributes.*)'
        ],
        getComponent () {
            return this.viewComponent;
        },
        /**
         * Apply the attributes to the loaded component
         */
        attributesChanged (e) {
            let path;
            if (!this.viewComponent) {
                return;
            }
            path = e.path.split('.');
            path.shift();
            if (!path.length) {
                Object.keys(this.attributes).forEach((key) => {
                    this.viewComponent.set(key, this.attributes.key);
                });
                return;
            }
            path = path.join('.');
            this.viewComponent.set(path, e.value);
        },
        viewChanged () {
            if (!this.viewName || (this.viewName && !this.viewName.length) || !this.location) {
                return;
            }
            this.loadView(this.viewName)
                .then(this.displayView.bind(this))
                .catch((e) => {
                    this.fire('kano-error', new Error(`Could not load view ${this.viewName}`));
                });
            this.set('ready', false);
        },
        reloadView () {
            this.viewChanged();
        },
        displayView () {
            let view = this.create(this.viewName, this.attributes);
            this.mountComponent(view);
        },
        mountComponent (component) {
            let root = Polymer.dom(this.root);
            component.style.flex = this.flexEnabled ? 1 : 'none';
            component.style.height = '100%';

            while (root.firstChild) {
                root.removeChild(root.firstChild);
            }
            root.appendChild(component);
            this.viewComponent = component;
            this.set('ready', true);
        },
        /**
         * Import the view component
         * @param  {String} partial   Name of the component to import
         * @return {Promise}          Will resolve when the element is loaded
         */
        loadView (partial) {
            return new Promise((resolve, reject) => {
                this.importHref(`./${this.location}/${partial}/${partial}.html`, resolve, reject);
            });
        },
        end () {
            if (this.viewComponent && typeof this.viewComponent.end == 'function') {
                return this.viewComponent.end();
            }
            return Promise.resolve();
        }
    });
</script>
