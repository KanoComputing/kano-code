<dom-module id="kano-focus-on">
    <style>
    :host {
        display: block;
        visibility: hidden;
        position: fixed;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
        opacity: 0;
        transition: opacity 200ms;
    }
    :host.show {
        opacity: 0.6;
    }
    :host,
    :host canvas {
        pointer-events: none;
    }
    </style>
    <template>
        <canvas id="canvas"></canvas>
    </template>
</dom-module>

<script type="text/javascript">
    const ANIMATION_DELAY = 200;
    class KanoFocusOn {
        beforeRegister () {
            this.is = 'kano-focus-on';
            this.properties = {
                padding: {
                    type: Number,
                    value: 3
                }
            };
        }
        ready () {
            let canvas = this.$.canvas,
                ctx = canvas.getContext('2d');

            canvas.width = ctx.width = window.innerWidth;
            canvas.height = ctx.height = window.innerHeight;

            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';

            this.ctx = ctx;
            this.targets = [];
            this.animating = false;
        }
        show (elements) {
            if (this.animating) {
                let defer = (() => {
                    this.show(elements);
                    this.removeEventListener('animation-finish', defer);
                }).bind(this);
                return this.addEventListener('animation-finish', defer);
            }
            this.targets = Array.isArray(elements) ? elements : [elements];

            window.addEventListener('resize', this.drawCanvas.bind(this));
            this.drawCanvas(elements);

            this.style.visibility = 'visible';
            this.toggleClass('show', true);
        }
        drawCanvas () {
            let padding = this.padding,
                ctx = this.ctx,
                rect;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, ctx.width, ctx.height);

            this.targets.forEach((el) => {
                rect = el.getBoundingClientRect();
                ctx.clearRect(
                    rect.left,
                    rect.top,
                    rect.width,
                    rect.height
                );
            });
        }
        hide () {
            window.removeEventListener('resize', this.drawCanvas.bind(this));
            this.toggleClass('show', false);
            this.animating = true;
            setTimeout(() => {
                this.style.visibility = 'hidden';
                this.animating = false;
                this.fire('animation-finish');
            }, ANIMATION_DELAY);
        }
    }
    Polymer(KanoFocusOn);
</script>
