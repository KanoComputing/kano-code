<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/web-components/kano-progress-bar/kano-progress-bar.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">
<link rel="import" href="../../bower_components/web-components/kano-modal/kano-modal.html">
<link rel="import" href="../kano-glint-animation/kano-glint-animation.html">

<!--
`kano-xp-modal` is a reward dialog to be displayed at the end of a Kano Code challenge.
@group Kano Elements
@demo demo/kano-xp-modal.html
-->

<dom-module id="kano-xp-modal">
    <style>
        :host {
            display: block;
            --color-progress-bg: #e5e5e5;
            --color-dark-yellow: #996b00;
            --color-orange: #ff6b00;
            --color-orange-darker: #d15727;
            --color-gold: #ffb300;
            --color-gold-darker: #eca600;
            --color-pale-grey: #f4f5f6;
            --color-light-grey: #C1C2C3;
            --color-medium-grey: #a7aeb2;
            --kano-progress-bar-color: linear-gradient(to bottom, var(--color-gold) 50%, var(--color-gold-darker) 50%);
            --kano-progress-bar-label: {
                top: 10px;
                left: 2px;
            }
        }
        :host [hidden] {
            display: none !important;
        }
        :host #content {
            width: 285px;
            padding: 50px 65px 40px;
            background-color: #fff;
            margin-top: 85px;
            font-family: 'Bariol', Helvetica, Arial, sans-serif;
        }
        :host iron-pages {
        }
        :host iron-pages[selected="levelup"] {
            padding-top: 20px;
        }
        :host([second-label]) #content {
            height: 240px;
            width: 360px;
        }
        :host([second-label]) iron-pages {
            height: 60%;
        }

        /*New XP section*/

        :host .level {
            text-transform: uppercase;
            font-weight: bold;
            animation: 400ms ease-in forwards bounceIn;
            color: var(--color-medium-grey, #a7aeb2);
            font-size: 16px;
            opacity: 0;
            margin: 10px 0 5px;
        }
        :host #progress .level, :host #progress h1 {
            opacity: 1;
        }
        :host h1.username {
            font-size: 24px;
            margin: 10px 0 0;
            opacity: 0;
        }
        :host .xp {
            opacity: 0;
            padding: 0 5px;
            text-align: center;
            margin-top: 30px;
        }
        :host .xp-prefix {
            color: var(--color-gold);
            display: inline-block;
            font-size: 35px;
            font-weight: bold;
            line-height: 1em;
            margin-right: 6px;
            vertical-align: 15%;
        }
        :host .xp-value {
            display: inline-block;
            font-size: 36px;
            font-weight: bold;
        }
        :host .xp-suffix-medium {
            width: 35px;
            height: 20px;
            margin-bottom: 2px;
        }
        :host .icon-light {
            fill: var(--color-gold);
        }
        :host .icon-dark {
            fill: var(--color-dark-yellow);
        }

        /*Progress section*/

        kano-progress-bar {
            height: 12px;
        }
        :host .progress-overlay {
            position: relative;
            opacity: 0;
            top: 12px;
            right: -29px;
            border-radius: 3px;
            background-color: #333333;
            float: right;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            min-width: 45px;
            padding: 6px 10px;
            @apply --layout-horizontal;
            @apply --layout-center;
            @apply --layout-justified;
        }
        :host .progress-overlay::before {
            background-color: #333333;
            content: '';
            height: 10px;
            left: 0;
            margin: auto;
            position: absolute;
            right: 0;
            top: -4px;
            transform: rotate(45deg);
            width: 10px;
        }
        :host .overlay-xp {
            width: 20px;
        }
        :host .progress-value {
            display: inline-block;
            color: white;
            font-size: 16px;
            font-weight: bold;
            margin-left: 6px;
        }
        :host .slider-container {
            height: 100%;
            width: 100%;
            position: relative;
            margin: 35px 0 50px;
        }
        :host .start-level,
        :host .end-level {
            position: absolute;
            top: -25px;
            color: var(--color-medium-grey);
            font-weight: bold;
            margin: 0;
        }
        :host .start-level {
            left: 0;
        }
        :host .end-level {
            right: 0;
        }

        /*Level up section*/

        :host #levelup {
            height: 100%;
            position: relative;
            @apply --layout-vertical;
            @apply --layout-center;
        }
        :host .levelup-header {
            margin: 0 0 20px;
            text-transform: uppercase;
            z-index: 2;
        }
        :host h1.levelup-heading {
            font-size: 32px;
            margin: 10px 0 0;
            z-index: 2;
        }
        :host h1.levelup-heading ~ p {
            font-size: 16px;
            z-index: 2;
        }
        :host .newlevel-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        :host .newlevel-display {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("/assets/icons/new-level.svg") no-repeat center;
            color: white;
            font-size: 50px;
            font-weight: bold;
            z-index: 1;
            text-shadow: 2px 3px 2px rgba(0,0,0,0.3);
            @apply --layout-vertical;
            @apply --layout-center;
            @apply --layout-center-justified;
        }
        :host .radial-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            @apply --layout-vertical;
            @apply --layout-center;
            @apply --layout-center-justified;
        }
        :host .radial-svg {
            background: url("/assets/icons/levelup-radial.svg") no-repeat center;
            background-size: 200%;
            border-radius: 50%;
            width: 380px;
            height: 380px;
            flex: 1 0 auto;
            animation: 25s linear infinite spin;
        }
        :host .radial-svg:before {
            content: "";
            width: 100%;
            height: 100%;
            position: absolute;
            z-index: -1;
            top: 0;
            left: 0;
            background: radial-gradient(rgba(255,255,255,0) 0%, rgba(255,255,255,0) 40%, #fff 70%);
        }
        :host .button {
            opacity: 0;
            border: 0;
            border-radius: 3px;
            cursor: pointer;
            display: inline-block;
            font-family: 'Bariol', sans-serif;
            font-size: 14px;
            font-weight: bold;
            margin: 0;
            outline: 0;
            text-transform: uppercase;
            background-color: var(--color-pale-grey);
            color: var(--color-grey);
            padding: 9px 25px;
        }
        :host .button:hover {
            background-color: var(--color-light-grey);
        }
        :host kano-glint-animation:first-child .button,
        :host kano-glint-animation[hidden] ~ kano-glint-animation .button {
            background-color: var(--color-orange);
            color: #fff;
            padding: 12px 60px 13px;
            font-size: 16px;
        }
        :host kano-glint-animation:first-child .button:hover,
        :host kano-glint-animation[hidden] ~ kano-glint-animation .button:hover {
            background-color: var(--color-orange-darker);
        }
        .level-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }
        /* Flip animation, credit to David Walsh https://davidwalsh.name/css-flip*/
        #flip-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            perspective: 1000px;
        }
        /* Flip action */
        #flip-container.flip .flipper {
            transform: rotateY(-180deg);
        }
        #flip-container, .front, .back {
            width: 100%;
            height: 100%;
        }
        .flipper {
            position: relative;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: 0.6s;
            transform-style: preserve-3d;
            position: relative;
        }
        .front, .back {
            backface-visibility: hidden;
            position: absolute;
            top: 0;
            left: 0;
        }
        .front {
            z-index: 2;
            transform: rotateY(0deg);
        }
        .back {
            transform: rotateY(-180deg);
        }
        /*Cta section*/
        :host .action {
            @apply --layout-vertical;
            @apply --layout-center-justified;
            min-height: 60px;
            margin: 0;
        }
        :host .second-action {
            margin-bottom: 13px;
        }
        :host .button .icon ~ .action-text,
        :host .button .action-text ~ .icon {
            margin-left: 3px;
        }
        /*Animations*/
        :host .float-in-level {
            animation: floatIn 200ms 300ms ease-out forwards;
        }
        :host .float-in-name {
            animation: floatIn 200ms 400ms ease-out forwards;
        }
        :host .float-in-xp {
            animation: floatIn 180ms 500ms forwards,
                    floatOut 200ms 1800ms ease-in-out forwards;
        }
        :host .float-in-label {
            animation: floatIn 110ms 260ms linear forwards;
        }
        :host .float-in-button-first {
            animation: floatIn 150ms 200ms forwards;
        }
        :host .float-in-button-second {
            animation: floatIn 150ms 400ms forwards;
        }
        @keyframes floatIn {
            0% {transform: scale(0.4); opacity: 0;}
            70% {opacity: 1;}
            100% { transform: scale(1); opacity: 1;}
        }
        @keyframes floatOut {
            0% {transform: scale(1); opacity: 1;}
            70% {opacity: 0;}
            100% { transform: scale(0.4); opacity: 0};
        }
        @keyframes spin {
            0% {transform: rotate(0deg);}
            100% {transform: rotate(360deg);}
        }
    </style>
    <template>
        <kano-modal id="modal" opened="{{opened}}" assets-path="/assets">
            <div id="content">
                <iron-pages attr-for-selected="id" selected$="[[panel]]">
                    <div id="xp">
                        <p class="level float-in-level">Level [[progress.currentLevel]]</p>
                        <h1 class="username float-in-name">[[header]]</h1>
                        <div class="xp float-in-xp">
                            <span class="xp-prefix">+</span>
                            <span class="xp-value">[[progress.gainedXp]]</span>
                            <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                                 viewBox="0 0 31.3 24.6" xml:space="preserve" class="xp-suffix-medium">
                                <g>
                                    <g>
                                        <path class="icon-light" d="M27.6,0H3.7C1.7,0,0,1.7,0,3.7v17.1c0,2.1,1.7,3.7,3.7,3.7h23.9c2.1,0,3.7-1.7,3.7-3.7V3.7
                                            C31.3,1.7,29.7,0,27.6,0z"/>
                                        <g>
                                            <path class="icon-dark" d="M11.6,14l-2.7,4.1c-0.2,0.3-0.5,0.5-0.9,0.5c-0.6,0-1-0.5-1-1c0-0.2,0.1-0.4,0.2-0.6l3.3-4.7L7.4,7.9
                                                C7.2,7.7,7.2,7.5,7.2,7.3c0-0.6,0.5-1,1-1c0.4,0,0.6,0.1,0.8,0.4l2.5,3.8L14,6.7c0.2-0.3,0.5-0.4,0.8-0.4c0.6,0,1,0.5,1,1
                                                c0,0.2-0.1,0.4-0.2,0.6l-3.1,4.4l3.3,4.7c0.1,0.1,0.2,0.3,0.2,0.6c0,0.6-0.5,1-1,1c-0.4,0-0.6-0.2-0.9-0.5L11.6,14z"/>
                                            <path class="icon-dark" d="M19.5,13.7v3.8c0,0.6-0.5,1-1,1s-1-0.5-1-1V7.4c0-0.6,0.5-1,1-1h3.4c2.1,0,3.7,1.2,3.7,3.6
                                                c0,2.5-1.6,3.7-3.7,3.7H19.5z M19.5,8.2v3.6h2.2c1.1,0,1.8-0.7,1.8-1.8c0-1.2-0.7-1.8-1.8-1.8C21.7,8.2,19.5,8.2,19.5,8.2z"/>
                                        </g>
                                    </g>
                                </g>
                            </svg>
                        </div>
                    </div>
                    <div id="progress">
                        <p class="level">Level [[progress.currentLevel]]</p>
                        <h1 class="username">[[header]]</h1>
                        <div class="slider-container">
                            <p class="start-level">LV.{{progress.currentLevel}}</p>
                            <p class="end-level">LV.{{progress.nextLevel}}</p>
                            <kano-progress-bar id="progress-bar"
                                               immediate-value="{{immediateValue}}"
                                               with-display>
                            <div id="progress-label" slot="label">
                                <div class="progress-overlay float-in-label">
                                    <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                                         viewBox="0 0 31.3 24.6" xml:space="preserve" class="overlay-xp">
                                        <g>
                                            <g>
                                                <path class="icon-light" d="M27.6,0H3.7C1.7,0,0,1.7,0,3.7v17.1c0,2.1,1.7,3.7,3.7,3.7h23.9c2.1,0,3.7-1.7,3.7-3.7V3.7
                                                    C31.3,1.7,29.7,0,27.6,0z"/>
                                                <g>
                                                    <path class="icon-dark" d="M11.6,14l-2.7,4.1c-0.2,0.3-0.5,0.5-0.9,0.5c-0.6,0-1-0.5-1-1c0-0.2,0.1-0.4,0.2-0.6l3.3-4.7L7.4,7.9
                                                        C7.2,7.7,7.2,7.5,7.2,7.3c0-0.6,0.5-1,1-1c0.4,0,0.6,0.1,0.8,0.4l2.5,3.8L14,6.7c0.2-0.3,0.5-0.4,0.8-0.4c0.6,0,1,0.5,1,1
                                                        c0,0.2-0.1,0.4-0.2,0.6l-3.1,4.4l3.3,4.7c0.1,0.1,0.2,0.3,0.2,0.6c0,0.6-0.5,1-1,1c-0.4,0-0.6-0.2-0.9-0.5L11.6,14z"/>
                                                    <path class="icon-dark" d="M19.5,13.7v3.8c0,0.6-0.5,1-1,1s-1-0.5-1-1V7.4c0-0.6,0.5-1,1-1h3.4c2.1,0,3.7,1.2,3.7,3.6
                                                        c0,2.5-1.6,3.7-3.7,3.7H19.5z M19.5,8.2v3.6h2.2c1.1,0,1.8-0.7,1.8-1.8c0-1.2-0.7-1.8-1.8-1.8C21.7,8.2,19.5,8.2,19.5,8.2z"/>
                                                </g>
                                            </g>
                                        </g>
                                    </svg>
                                    <div class="progress-value">[[immediateValue]]</div>
                                </div>
                            </div>
                            </kano-progress-bar>
                        </div>
                    </div>
                    <div id="levelup" float-in-name>
                        <h4 class="levelup-header">New Level</h4>
                        <div class="level-wrapper">
                            <div id="flip-container">
                                <div class="flipper">
                                    <div class="front newlevel-container">
                                        <div class="newlevel-display">[[progress.currentLevel]]</div>
                                    </div>
                                    <div class="back newlevel-container">
                                        <div class="newlevel-display">[[progress.nextLevel]]</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="radial-background">
                            <div class="radial-svg" preload sizing="cover"></div>
                        </div>

                        <h1 class="levelup-heading">Congratulations!</h1>
                        <p>You have earned a new level</p>
                    </div>
                </iron-pages>
                <template is="dom-if" if="[[buttonsVisible]]">
                    <div class="action">
                        <kano-glint-animation hidden$="[[!secondLabel]]" running class="second-action">
                            <button class="button float-in-button-first" on-tap="_secondActionTapped">
                                <span class="action-text">[[secondLabel]]</span>
                            </button>
                        </kano-glint-animation>
                        <kano-glint-animation running>
                            <button class="button float-in-button-second" on-tap="_confirmTapped">
                                <span class="action-text">[[confirmLabel]]</span>
                            </button>
                        </kano-glint-animation>
                    </div>
                </template>
            </div>
        </kano-modal>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'kano-xp-modal',
        properties: {
            progress: {
                type: Object,
                readOnly: true,
                observer: '_launchReward'
            },
            panel: {
                type: String,
                value: null
            },
            header: {
                type: String,
                value: null
            },
            /**
             * Button label for main action
             */
            confirmLabel: {
                type: String,
                value: "OK I've got it"
            },
            /**
             * Button label for secondary action
             */
            secondLabel: {
                type: String,
                value: null,
                reflectToAttribute: true
            },
            opened: {
                type: Boolean,
                notify: true
            },
            levelUp: {
                type: Boolean,
                value: false
            }
        },
        _launchReward (progress) {
            this.panel = 'xp';
            this.async(() => this.$.modal.transitionImage('/assets/icons/xp-star.svg'), 280);
            this.async(() => this.$.modal.transitionImage('/assets/avatar/judoka-smile.svg'), 2100);
            this.async(() => this._launchProgress(progress), 2800);
        },
        _launchProgress (progress) {
            this.panel = 'progress';
            this.async(() => this.$['progress-bar'].addValue(progress.gainedXp), 1200);
            this.async(() => this.$.modal.motif = '/assets/avatar/judoka-face.svg', 2000);

            if (progress.levelup) {
                this.async(() => this._launchLevelUp(), 2800);
            } else {
                this.async(() => this.buttonsVisible = true, 2400);
            }
        },
        _launchLevelUp (newRate) {
            this.panel = 'levelup';
            this.$.modal.motif = null;
            this.async(() => this.buttonsVisible = true, 2000);
            this.async(() => this.$['flip-container'].classList.toggle("flip"), 1400);
        },
        _secondActionTapped () {
            this.fire('second-action');
            this.$.modal.close();
        },
        _confirmTapped () {
            this.fire('confirm');
            this.$.modal.close();
        },
        _computeHeader (username) {
            return username ? username : 'Nice work!';
        },
        _reset () {
            this.panel = null;
            this.$.modal.motif = null;
        },
        _computeProgress (data) {
            let currentState = data.update.levels.progress,
                changes = data.update.levels.changes,
                currentLevel = changes.level ? changes.level.oldValue : currentState.level;
            this._setupProgressBar(currentState, changes);
            //Polymer convenient method to set private property
            this._setProgress({
                currentLevel: currentLevel,
                nextLevel: currentLevel + 1,
                gainedXp: changes['total-xp'].newValue - changes['total-xp'].oldValue,
                levelup: !!changes.level
            });
        },
        _setupProgressBar (currentState, changes) {
            let progressBar = this.$['progress-bar'],
                xp = changes['total-xp'].oldValue,
                offset = changes['xp-offset'] ? changes['xp-offset'].oldValue : currentState['xp-offset'],
                nextThreshold = changes['next-threshold'] ? changes['next-threshold'].oldValue : currentState['next-threshold'];
            progressBar.startValue = xp;
            progressBar.min = xp - offset;
            progressBar.max = nextThreshold;   
        },
        open (data, user) {
            this._reset();
            if (!data) {
                return;
            }
            this._computeProgress(data);
            this.header = user ? user.username : 'Nice work';
            this.$.modal.open();
        },
        close () {
            this.$.modal.close();
        }
    });
</script>
