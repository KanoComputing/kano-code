<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../behaviors/kano-i18n-behavior.html">

<link rel="import" href="../../scripts/kano/make-apps/sdk.html">

<dom-module id="kano-side-menu">
    <style>
        :host {
            display: block;
        }
        :host ul {
            margin: 0px;
            padding: 0px;
        }
        *[hidden] {
            display: none !important;
        }
        :host ul li {
            list-style-type: none;
        }
        :host ul li.separated {
            border-bottom: 2px solid var(--color-grey-lightest);
        }
        li {
            display: block;
            width: 100%;
            height: 100%;

            @apply(--layout-horizontal);
            align-items: center;

            cursor: pointer;
            text-decoration: none;
            color: black;
            box-sizing: border-box;
        }
        li a:hover, li.login:hover {
            background: var(--color-grey-lightest);
        }
        li.login a {
            background-color: transparent;
        }
        li a {
            @apply(--layout-flex);
            @apply(--layout-horizontal);

            text-decoration: none;
            color: black;
            padding: 10px;

            background-color: #ffffff;

            transition: transform 0.3s ease-in-out;

            position: relative;
        }
        li a.reveal {
            transform: translateX(71px);
        }
        li.user {
            @apply(--layout-horizontal);
            align-items: center;
            cursor: default;
            padding: 10px;
        }
        li.user iron-image {
            background-color: var(--color-grey-lighter);

            width: 50px;
            height: 50px;
            border-radius: 25px;
            margin: 0px 10px;
        }
        li a iron-image {
            width: 24px;
            height: 20px;

            margin: 0px 15px 0px 5px;
        }
        .userInfo {
            @apply(--layout-flex);
            @apply(--layout-vertical);
        }
        .userInfo .userName {
            font-size: 1.2em;
            font-weight: bold;
            text-transform: capitalize;
        }
        .userInfo .userLevel {
            color: var(--color-grey-light);
        }
        .close-menu {
            cursor: pointer;
            font-size: 1.8em;
            color: var(--color-grey);
            transition: all 0.2s ease;
            margin-bottom: 10px;
            margin-right: 10px;
        }
        .close-menu:hover {
            color: black;
            transform: translateY(-1px);
        }
        a>* {
            pointer-events: none;
        }
        .reset-confirmation {
            background-color: var(--color-red);
            color: #ffffff;
            padding: 10px;
            position: absolute;
        }
        .reset-confirmation:hover {
            background-color: var(--color-lighter-red);
        }
    </style>
    <template>
        <ul>
            <li class="login separated" hidden$="[[isUserLoggedIn(user)]]">
                <a on-tap="login">
                    <iron-image class="icon" src="/assets/icons/login.png" sizing="contain"></iron-image>
                    <div class="label">[[localize('LOGIN', 'Login')]]</div>
                </a>
                <div class="close-menu" on-tap="toggleMenu">&times;</div>
            </li>
            <li class="user separated" hidden$="[[!isUserLoggedIn(user)]]">
                <iron-image src="[[getUserAvatar(user.avatar.urls.circle)]]" preload sizing="contain"></iron-image>
                <div class="userInfo">
                    <div class="userName">[[user.username]]</div>
                    <div class="userLevel">[[localize('LEVEL', 'Level')]] [[profile.level]] | [[profile.xp]]XP</div>
                </div>
                <div>
                    <div class="close-menu" on-tap="toggleMenu">&times;</div>
                </div>
            </li>
            <li>
                <div on-tap="resetWorkspace" class="reset-confirmation">
                    Confirm
                </div>
                <a on-tap="confirmReset" id="reset">
                    <iron-image class="icon" src="/assets/icons/reset.png" sizing="contain"></iron-image>
                    <div class="label">[[localize('RESET_WORKSPACE', 'Reset Workspace')]]</div>
                </a>
            </li>
            <li>
                <a on-tap="_exportApp">
                    <iron-image class="icon" src="/assets/icons/export.png" sizing="contain"></iron-image>
                    <div class="label">[[localize('EXPORT', 'Export')]]</div>
                </a>
            </li>
            <li>
                <a on-tap="_importApp">
                    <iron-image class="icon" src="/assets/icons/import.png" sizing="contain"></iron-image>
                    <div class="label">[[localize('IMPORT', 'Import')]]</div>
                </a>
            </li>
            <li>
                <a href$="[[worldUrl]]/projects" on-tap="backToProjects">
                    <iron-image class="icon" src="/assets/icons/projects.png" sizing="contain"></iron-image>
                    <div class="label">[[localize('BACK_TO_PROJECTS', 'Back to Projects')]]</div>
                </a>
            </li>
            <li>
                <a href="https://insights.hotjar.com/s?siteId=119134&surveyId=9857" target="_blank">
                    <iron-image class="icon" src="/assets/icons/feedback.png" sizing="contain"></iron-image>
                    <div class="label">[[localize('GIVE_FEEDBACK', 'Give Feedback')]]</div>
                </a>
            </li>
            <li hidden$="{{!isUserLoggedIn(user)}}" on-tap="logout">
                <a on-tap="logout">
                    <iron-image class="icon" src="/assets/icons/logout.png" sizing="contain"></iron-image>
                    <div class="label">{{_getLogoutLabel(offline)}}</div>
                </a>
            </li>
        </ul>
        <iron-a11y-keys keys="ctrl+s meta+s" on-keys-pressed="_exportApp" target="[[target]]"></iron-a11y-keys>
        <iron-a11y-keys keys="ctrl+o meta+o" on-keys-pressed="_importApp" target="[[target]]"></iron-a11y-keys>
        <iron-a11y-keys keys="alt+d" on-keys-pressed="resetWorkspace" target="[[target]]"></iron-a11y-keys>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer, Kano */

    Polymer({
        is: 'kano-side-menu',
        behaviors: [Kano.Behaviors.I18nBehavior],
        properties: {
            user: {
                type: Object,
                value: null,
                observer: 'userChanged'
            },
            profile: {
                type: Object
            },
            offline: {
                type: Boolean,
                value: false
            },
            worldUrl: {
                type: String,
                value: '//world.kano.me'
            }
        },
        attached () {
            this.target = document.body;
        },
        login () {
            this.fire('login');
        },
        logout () {
            this.offline ? this.fire('shutdown') : this.fire('logout');
        },
        // Hack to make the app work on safari
        getUserAvatar (avatar) {
            return avatar || '';
        },
        _exportApp (e) {
            let keyboardEvent = e.detail.keyboardEvent;
            if (keyboardEvent) {
                keyboardEvent.stopPropagation();
                keyboardEvent.preventDefault();
            }
            this.fire('iron-signal', { name: 'export-app' });
            this.fire('toggle-menu', false);
        },
        _importApp (e) {
            let keyboardEvent = e.detail.keyboardEvent;
            if (keyboardEvent) {
                keyboardEvent.stopPropagation();
                keyboardEvent.preventDefault();
            }
            this.fire('iron-signal', { name: 'import-app' });
            this.fire('toggle-menu', false);
        },
        userChanged (newValue, old) {
            if (newValue) {
                Kano.MakeApps.sdk.api.users.get.byId({id: this.user.id}).then((res) => {
                    if (res.status == 200) {
                        let xp = res.body.user.profile.xp;
                        this.profile = {
                            xp: xp,
                            level: this.calculateLevel(xp)
                        };
                    }
                }).catch((err) => console.error(err));
            } else {
                this.profile = {
                    xp: "-",
                    level: "-"
                };
            }
        },
        isUserLoggedIn () {
            return !!this.user;
        },
        toggleMenu (e) {
            this.$.reset.classList.remove('reveal');
            this.fire('toggle-menu', false);
            e.stopPropagation();
        },
        confirmReset () {
            this.$.reset.classList.toggle('reveal');
        },
        resetWorkspace (e) {
            this.fire('iron-signal', { name: 'reset-workspace' });
            this.toggleMenu(e)
        },
        /* FIXME: This was copied out of Kano World. We need to put this
                  functionality into the API. */
        calculateLevel (xp) {
            var current = '1',
                levelsMap = {
                    1: 0,
                    2: 150,
                    3: 300,
                    4: 500,
                    5: 800,
                    6: 1300,
                    7: 1600,
                    8: 2200,
                    9: 3000
                };

            if (typeof xp !== 'number') {
                return null;
            }

            for (let lvl in levelsMap) {
                if (levelsMap.hasOwnProperty(lvl)) {
                    if (xp < levelsMap[lvl]) {
                        return current;
                    }
                    current = lvl;
                }
            }

            return current;
        },
        _getLogoutLabel (offline) {
            return offline ? this.localize('EXIT', 'Exit') : this.localize('LOG_OUT', 'Log Out');
        }
    });
</script>
