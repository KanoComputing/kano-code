<link rel="import" href="../behaviors.html">
<link rel="import" href="../../kano-fs/kano-fs.html">
<link rel="import" href="../kano-file-picker-modal/kano-file-picker-modal.html">
<link rel="import" href="../../bower_components/web-components/kano-style/kano-style.html">

<dom-module id="kano-input-image">
    <style>
    :host {
        display: block;
        @apply(--layout-vertical);
        @apply(--layout-center);
    }
    :host button {
        @apply(--kano-button);
    }
    :host .actions button {
        margin: 7px;
        font-weight: bold;
        font-family: var(--font-body);
    }
    :host .change-button {
        background-color: var(--color-grassland);
    }
    :host .change-button:hover {
        background-color: var(--color-apple);
    }
    :host .remove-button {
        background-color: var(--color-chateau);
    }
    :host .remove-button:hover {
        background-color: var(--color-abbey);
    }
    :host .buttons button {
        margin-left: 5px;
    }
    :host kano-fs {
        margin: 20px;
    }
    :host paper-dialog h2 {
        text-align: center;
        font-weight: 500;
    }
    [hidden] {
        display: none !important;
    }
    </style>
    <template>
        <h4 hidden$="[[!title]]">[[title]]</h4>
        <div class="actions">
            <button type="button" on-tap="openModal" class="change-button">Change image</button>
            <button type="button" on-tap="removeImage" class="remove-button" hidden$="[[!src]]">Remove image</button>
        </div>
        <kano-file-picker-modal files="[[flatFiles]]" id="modal" on-select-file="fileSelected"></kano-file-picker-modal>
    </template>
</dom-module>
<script type="text/javascript">
    /* globals Polymer, Kano */

    Polymer({
        is: 'kano-input-image',
        behaviors: [Kano.Behaviors.Input],
        properties: {
            title: {
                type: String,
                value: null
            },
            size: {
                type: String,
                value: '50px'
            },
            src: {
                type: String,
                value: null
            },
            options: {
                type: Object,
                observer: '_optionsChanged'
            },
            flatFiles: {
                type: Array,
                value: () => {
                    return [];
                }
            }
        },
        observers: [
            'valueChanged(src, size)'
        ],
        attached () {
            document.body.appendChild(this.$.modal);
        },
        detached () {
            document.body.removeChild(this.$.modal);
        },
        _optionsChanged (options) {
            let files = options.files,
                group,
                groupFiles,
                allFiles;
            allFiles = Object.keys(Kano.MakeApps.Files[files]).reduce((acc, groupKey) => {
                group = Kano.MakeApps.Files[files][groupKey];
                groupFiles = Object.keys(group).map((key) => {
                    return {
                        name: group[key],
                        type: 'image',
                        data: {
                            src: Kano.MakeApps.Files.generators[files](groupKey, key)
                        }
                    };
                });
                return acc.concat(groupFiles);
            }, []);
            this.set('flatFiles', allFiles);
        },
        openModal () {
            this.$.modal.open();
        },

        fileSelected (e) {
            let file = e.detail;
            this.set('src', file.data.src);
            this.set('title', file.name);
            this.$.modal.close();
        },

        valueChanged () {
            this.set('value', this.src);
        },

        removeImage () {
            this.set('title', null);
            this.set('src', null);
        }
    });
</script>
