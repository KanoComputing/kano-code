<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-lazy-pages/iron-lazy-pages.html">
<link rel="import" href="../../bower_components/web-components/kano-alert/kano-alert.html">
<link rel="import" href="../../scripts/kano/make-apps/store.html">
<link rel="import" href="../../scripts/kano/make-apps/actions/config.html">
<link rel="import" href="../../scripts/kano/make-apps/actions/routing.html">
<link rel="import" href="../../scripts/kano/make-apps/utils.html">
<link rel="import" href="../../scripts/kano/util/router.html">
<link rel="import" href="../../scripts/kano/make-apps/actions/editor.html">
<link rel="import" href="../kano-animation/animations/from-big-animation.html">
<script src="../../scripts/util/client.js"></script>
<script src="../../bower_components/page/page.js"></script>

<dom-module id="kano-routing">
    <link rel="lazy-import" href="/views/kano-view-story/kano-view-story.html">
    <link rel="lazy-import" href="/views/kano-view-tutorial/kano-view-tutorial.html">
    <link rel="lazy-import" href="/views/kano-view-editor/kano-view-editor.html">
    <link rel="lazy-import" href="/views/kano-view-flags/kano-view-flags.html">
    <link rel="lazy-import" href="/views/kano-view-demo/kano-view-demo.html">
    <template>
        <style>
            :host {
                display: block;
                @apply --layout-vertical;
            }

            :host iron-lazy-pages {
                @apply --layout-vertical;
                @apply --layout-flex;
            }

            :host iron-lazy-pages>* {
                @apply --layout-flex;
                overflow: auto;
            }
        </style>
        <kano-alert id="mobile-info-dialog" heading="Coding on your mobile?" text="Weâ€™ve got something just for you!"
            entry-animation="from-big-animation" with-backdrop>
            <button class="kano-alert-primary" slot="actions" on-tap="_goToTapcode">Try it</button>
        </kano-alert>
        <iron-lazy-pages selected="[[page]]" attr-for-selected="data-route" loading="{{loading}}" hide-immediately>
            <template is="dom-if" data-route="story" data-path="/views/kano-view-story/kano-view-story.html" restamp>
                <kano-view-story show-save-prompt={{leaveAlert}}></kano-view-story>
            </template>
            <template is="dom-if" data-route="tutorial" data-path="/views/kano-view-tutorial/kano-view-tutorial.html" restamp>
                <kano-view-tutorial ></kano-view-tutorial>
            </template>
            <template is="dom-if" data-route="editor" data-path="/views/kano-view-editor/kano-view-editor.html" restamp>
                <kano-view-editor show-save-prompt={{leaveAlert}}></kano-view-editor>
            </template>
            <template is="dom-if" data-route="flags" data-path="/views/kano-view-flags/kano-view-flags.html" restamp>
                <kano-view-flags ></kano-view-flags>
            </template>
            <template is="dom-if" data-route="demo" data-path="/views/kano-view-demo/kano-view-demo.html" restamp>
                <kano-view-demo></kano-view-demo>
            </template>
        </iron-lazy-pages>
    </template>
    <script>
        class KanoRouting extends Kano.MakeApps.Store.StateReceiver(Polymer.Element) {
            static get is() { return 'kano-routing'; }
            static get properties() {
                return {
                    context: {
                        type: Object,
                        linkState: 'routing.context',
                    },
                    user: {
                        type: Object
                    },
                    page: {
                        type: String,
                        reflectToAttribute: true,
                        observer: '_onPageChanged',
                        linkState: 'routing.page',
                    },
                    loading: {
                        type: Boolean,
                        observer: '_loadingChanged'
                    },
                    leaveAlert: {
                        type: Boolean,
                        value: true,
                        observer: '_onLeaveAlertChanged'
                    },
                };
            }
            constructor() {
                super();
                this._exit = this._exit.bind(this);
                const { config } = this.getState();
                page('/', this._showPageThunk('editor'));
                page('/remix/:slug', this._showPageThunk('editor'));
                page('/demo', this._showPageThunk('demo'));
                page('/story/:id', this._showPageThunk('story'));
                page('/tutorial', this._showPageThunk('tutorial'));
                page('/app/:slug', (ctx) => {
                    window.location = config.WORLD_URL + "/shared/" + ctx.params.slug;
                });
                // Add the flags page when not in production
                if (config.ENV !== 'production') {
                    page('/flags', this._showPageThunk('flags'));
                }
                // Fallback to / if no match is found
                page('*', () => {
                    page.redirect('/' + document.location.search);
                });
            }
            connectedCallback() {
                super.connectedCallback();
                this.addEventListener('exit-confirmed', this._exit);
                page(); // force trigger the initial root page
            }
            disconnectedCallback() {
                super.disconnectedCallback();
                this.removeEventListener('exit-confirmed', this._exit);
            }
            /**
             * Creates a function to be used by page.js
             * @param  {String} name  Name of the view component to load
             * @return {Function}     A function ready to be used in page.js
             */
            _showPageThunk(name) {
                return (ctx) => {
                    this.dispatch({ type: 'UPDATE_CONTEXT', context: ctx });
                    // Set the page to null, before the real value to force a restamp of the view
                    if (this.page === name) {
                        this.dispatch({ type: 'UPDATE_PAGE', page: null });
                    }
                    this.dispatch({ type: 'UPDATE_PAGE', page: name });
                };
            }
            _computeLoadingClass(loading) {
                return loading ? 'loading' : '';
            }
            _isMobile() {
                let viewportWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
                return viewportWidth < 600;
            }
            _loadingChanged(newValue, oldValue) {
                // When loading goes from true to false, trigger an event to notify a page load end
                if (oldValue === true && newValue === false) {
                    this.dispatchEvent(new CustomEvent('kano-routing-load-finish', { bubbles: true, composed: true }));
                    if (this._isMobile()) {
                        this.$['mobile-info-dialog'].open();
                    }
                }
            }
            _onLeaveAlertChanged(alert) {
                if (alert) {
                    window.onbeforeunload = () => {
                        return 'Any unsaved changes to your app will be lost. Continue?';
                        return false;
                    }
                } else {
                    window.onbeforeunload = null;
                }
            }
            _onPageChanged() {
                let disableLogout;

                const { config, editor } = this.getState();

                const host = Kano.Util.Router.parseQsParam(this.context.querystring, 'host');
                const port = Kano.Util.Router.parseQsParam(this.context.querystring, 'port');
                const worldUrl = Kano.Util.Router.parseQsParam(this.context.querystring, 'worldUrl');
                const projectsUrl = Kano.Util.Router.parseQsParam(this.context.querystring, 'projectsUrl');
                const disableLogoutQuery = Kano.Util.Router.parseQsParam(this.context.querystring, 'disableLogout');

                Kano.MakeApps.Actions.Config.updateConfigKey('HOST', host, config.HOST);
                Kano.MakeApps.Actions.Config.updateConfigKey('PORT', port, config.PORT);
                Kano.MakeApps.Actions.Config.updateConfigKey('WORLD_URL', worldUrl, config.WORLD_URL);
                Kano.MakeApps.Actions.Config.updateConfigKey('PROJECTS_URL', projectsUrl, config.PROJECTS_URL);
                
                
                if (disableLogoutQuery === null) {
                    disableLogout = !editor.logoutEnabled;
                } else if (disableLogoutQuery === 'false' || disableLogoutQuery === '0') {
                    disableLogout = false;
                }
                
                Kano.MakeApps.Actions.Editor.updateLogoutEnabled(!disableLogout);
                
                /* For compatibility with old Kano2 App we enable the Hardware API when
                * Kano Code runs within electron.
                *
                * WARNING: This will be removed in the future. For future applications,
                *          always explicitely use the query string to enable hardware support.
                */
                Kano.MakeApps.Actions.Config.updateConfigKey('USE_HARDWARE_API', ClientUtil.runningInKanoApp(), config.USE_HARDWARE_API);
               
                const hardwareQuery = Kano.Util.Router.parseQsParam(this.context.querystring, 'hardware');
                if (hardwareQuery) {
                    Kano.MakeApps.Actions.Config.updateConfigKey('USE_HARDWARE_API', hardware !== 'false', config.USE_HARDWARE_API);
                }
            }
            _goToTapcode() {
                const { config } = this.getState();
                this.leaveAlert = false;
                location.href = `${config.TAPCODE_URL}/challenge/line_burst`;
            }
            _exit() {
                const { config } = this.getState();
                this.leaveAlert = false;
                location.href = config.PROJECTS_URL;
            }
        }
        customElements.define(KanoRouting.is, KanoRouting);
    </script>
</dom-module>