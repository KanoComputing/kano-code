<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-lazy-pages/iron-lazy-pages.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<script src="../../bower_components/page/page.js"></script>

<dom-module id="kano-routing">
  <template>
    <style>
      :host {
          display: block;
          @apply(--layout-vertical);
      }
      :host iron-lazy-pages {
          @apply(--layout-vertical);
          @apply(--layout-flex);
      }
      :host iron-lazy-pages>* {
          @apply(--layout-flex);
          overflow: auto;
      }
      paper-progress {
          --paper-progress-active-color: var(--color-orange);
          --paper-progress-transition-duration: 0.05s;
          position: fixed;
          top: -2px;
          opacity: 0;
          width: 100%;
          transition: top linear 100ms;
          transition: opacity linear 100ms;
          height: 2px;
      }
      :host paper-progress.loading {
          top: 0px;
          opacity: 1;
      }
    </style>
    <iron-lazy-pages selected="[[page]]" attr-for-selected="name" loading="{{loading}}" restamp>
        <template is="iron-lazy-page" name="story" path="/views/kano-view-story/kano-view-story.html">
            <kano-view-story context="[[context]]" user="{{user}}"></kano-view-story>
        </template>
        <template is="iron-lazy-page" name="tutorial" path="/views/kano-view-tutorial/kano-view-tutorial.html">
            <kano-view-tutorial context="[[context]]" user="{{user}}"></kano-view-tutorial>
        </template>
        <template is="iron-lazy-page" name="editor" path="/views/kano-view-editor/kano-view-editor.html">
            <kano-view-editor context="[[context]]" user="{{user}}"></kano-view-editor>
        </template>
        <template is="iron-lazy-page" name="onboarding" path="/views/kano-view-onboarding/kano-view-onboarding.html">
            <kano-view-onboarding context="[[context]]" user="{{user}}"></kano-view-onboarding>
        </template>
        <template is="iron-lazy-page" name="play" path="/views/kano-view-play/kano-view-play.html">
            <kano-view-play context="[[context]]" user="{{user}}"></kano-view-play>
        </template>
        <template is="iron-lazy-page" name="flags" path="/views/kano-view-flags/kano-view-flags.html">
            <kano-view-flags context="[[context]]" user="{{user}}"></kano-view-flags>
        </template>
        <template is="iron-lazy-page" name="demo" path="/views/kano-view-demo/kano-view-demo.html">
            <kano-view-demo context="[[context]]"></kano-view-demo>
        </template>
    </iron-lazy-pages>
    <paper-progress indeterminate class$="[[_computeLoadingClass(loading)]]"></paper-progress>
  </template>
  <script>
  /* globals Polymer, page, Kano */
  Polymer({
      is: 'kano-routing',
      properties: {
          context: {
              type: Object
          },
          user: {
              type: Object
          },
          page: {
              type: String,
              reflectToAttribute: true,
              notify: true
          },
          loading: {
              type: Boolean,
              observer: '_loadingChanged'
          }
      },
      /**
       * Initialize the views
       */
      ready () {
          page('/',                  this._showPageThunk('editor'));
          page('/remix/:slug',       this._showPageThunk('editor'));
          page('/demo',              this._showPageThunk('demo'));
          page('/story/:id',         this._showPageThunk('story'));
          page('/tutorial/:slug',    this._showPageThunk('tutorial'));
          page('/onboarding/:stage', this._showPageThunk('onboarding'));
          page('/app/:slug', (ctx) => {
              window.location = Kano.MakeApps.config.WORLD_URL + "/shared/" + ctx.params.slug;
          });
          // Add the flags page when not in production
          if (Kano.MakeApps.config.ENV !== 'production') {
              page('/flags', this._showPageThunk('flags'));
          }
          // Fallback to /make if no match is found
          page('*', () => {
              page.redirect('/' + document.location.search);
          });
          page(); // force trigger the initial root page
      },
      /**
       * Creates a function to be used by page.js
       * @param  {String} name  Name of the view component to load
       * @return {Function}     A function ready to be used in page.js
       */
      _showPageThunk (name) {
          return (ctx) => {
              this.context = ctx;
              // Set the page to null, before the real value to force a restamp of the view
              if (this.page === name) {
                  this.page = null;
              }
              this.page = name;
          };
      },
      _computeLoadingClass (loading) {
          return loading ? 'loading' : '';
      },
      _loadingChanged (newValue, oldValue) {
          // When loading goes from true to false, trigger an event to notify a page load end
          if (oldValue === true && newValue === false) {
              this.fire('kano-routing-load-finish');
          }
      }
  });
  </script>
</dom-module>
